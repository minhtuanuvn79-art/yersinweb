<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trạm Vũ Trụ Yersin - Galaxy Smart Edition</title>
<link rel="icon" href="logo.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
    --bg-space: radial-gradient(circle at 50% 0%, #0a0a2a 0%, #050515 60%, #000005 100%);
    --sidebar-bg: rgba(10, 10, 42, 0.98); /* Đậm hơn chút để che nội dung khi trượt ra */
    --glass-bg: rgba(255, 255, 255, 0.03);
    --glass-border: rgba(255, 255, 255, 0.08);
    --neon-purple: #bd00ff; 
    --neon-blue: #00eaff;   
    --neon-cyan: #00ffcc;
    --neon-gold: #fbbf24;
    --neon-green: #4ade80;
    --neon-red: #f43f5e;
    --text: #e2e8f0; 
}

body { 
    margin: 0; 
    font-family: 'Quicksand', sans-serif; 
    background: var(--bg-space); 
    background-size: cover; 
    background-position: center; 
    background-attachment: fixed; 
    color: var(--text); 
    height: 100vh; 
    /* --- SỬA ĐỔI QUAN TRỌNG 1: Bỏ flex, dùng block --- */
    display: block; 
    overflow-x: hidden; /* Chặn thanh cuộn ngang */
    transition: background 0.5s ease, color 0.5s ease; 
}

/* Scrollbar đẹp */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--neon-purple), var(--neon-blue)); border-radius: 10px; box-shadow: 0 0 10px var(--neon-purple); }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

/* --- SIDEBAR MỚI (TRƯỢT) --- */
.sidebar { 
    width: 260px; 
    height: 100%; 
    background: var(--sidebar-bg); 
    border-right: 1px solid var(--neon-blue); 
    /* Cấu hình vị trí cố định để ẩn */
    position: fixed;
    top: 0;
    left: -280px; /* Ẩn hẳn sang trái */
    z-index: 9999; /* Luôn nằm trên cùng */
    transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1); 
    box-shadow: 5px 0 30px rgba(0, 0, 0, 0.8);
    
    display: flex; 
    flex-direction: column; 
    padding: 20px; 
    box-sizing: border-box; 
    backdrop-filter: blur(15px);

    /* --- CẬP NHẬT: THÊM 2 DÒNG NÀY ĐỂ KÍCH HOẠT THANH CUỘN --- */
    overflow-y: auto;   /* Cho phép cuộn dọc */
    overflow-x: hidden; /* Ẩn cuộn ngang */
}
.sidebar::-webkit-scrollbar { width: 4px; }
.sidebar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
.sidebar::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--neon-blue), var(--neon-purple)); border-radius: 10px; }

/* VÙNG CẢM ỨNG (TRIGGER ZONE) */
.sidebar-trigger {
    position: fixed;
    top: 0;
    left: 0;
    width: 20px; /* Vùng rộng 20px sát mép trái */
    height: 100vh;
    z-index: 10000; /* Cao hơn cả sidebar */
    background: transparent;
}

/* LOGIC HIỆN MENU: Khi hover vào trigger HOẶC sidebar */
.sidebar-trigger:hover ~ .sidebar,
.sidebar:hover {
    left: 0; /* Trượt ra */
}

/* Sidebar Brand */
.brand { font-size: 20px; font-weight: 700; color: var(--text); text-transform: uppercase; margin-bottom: 30px; text-shadow: 0 0 15px var(--neon-blue); letter-spacing: 2px; display: flex; justify-content: space-between; align-items: center; }

/* Nav Items */
.nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text); opacity: 0.7; font-weight: 600; transition: all 0.2s; border: 1px solid transparent; }
.nav-item:hover { background: var(--glass-bg); opacity: 1; transform: translateX(5px); box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); }
.nav-item.active.hk-mode { background: linear-gradient(90deg, rgba(255,255,255, 0.1), transparent); border-left: 3px solid var(--neon-purple); color: var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple); opacity: 1; }
.nav-item.active.acad-mode { background: linear-gradient(90deg, rgba(251, 191, 36, 0.2), transparent); border-left: 3px solid var(--neon-gold); color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold); opacity: 1; }
.nav-item.active.tkb-mode { background: linear-gradient(90deg, rgba(0, 255, 204, 0.2), transparent); border-left: 3px solid var(--neon-cyan); color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); opacity: 1; }
.nav-icon { width: 24px; text-align: center; font-size: 18px; }

/* --- SIDEBAR FOOTER (DỒN CẤU HÌNH) --- */
.sidebar-footer {
    margin-top: auto;
    padding-top: 15px;
    border-top: 1px solid var(--glass-border);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}
.sidebar-footer .nav-item {
    flex-direction: column; /* Icon trên chữ dưới */
    justify-content: center;
    text-align: center;
    font-size: 10px;
    padding: 8px 5px;
    margin-bottom: 0;
    height: 60px;
}
.sidebar-footer .nav-icon {
    font-size: 20px;
    margin-bottom: 5px;
    width: auto;
}
.reset-btn {
    grid-column: span 2; /* Nút Reset dài hết khổ */
    border: 1px dashed var(--neon-red);
    background: rgba(244, 63, 94, 0.05);
    height: 40px !important;
    flex-direction: row !important;
    gap: 10px;
}
.reset-btn:hover {
    background: var(--neon-red) !important;
    color: white !important;
}

/* MAIN CONTENT */
.main-content { 
    /* --- SỬA ĐỔI QUAN TRỌNG 2: Full màn hình --- */
    width: 100vw;
    height: 100vh;
    margin-left: 0;
    
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    position: relative; 
    transition: 0.3s;
}

/* Hiệu ứng làm mờ nội dung khi mở menu */
.sidebar-trigger:hover ~ .main-content,
.sidebar:hover ~ .main-content {
    filter: blur(3px) brightness(0.7);
    pointer-events: none; /* Không cho click lung tung */
}

/* HEADER */
.header { padding: 15px 25px; border-bottom: 1px solid var(--neon-blue); box-shadow: 0 4px 15px rgba(0, 234, 255, 0.1); background: rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; backdrop-filter: blur(10px); position: relative; z-index: 500; overflow: visible !important; }
.search-box { padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); background: var(--glass-bg); color: var(--text); min-width: 150px; font-weight: 600; transition: 0.3s;}
.search-box:focus { border-color: var(--neon-gold) !important; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4) !important; }
.search-box option { background: var(--sidebar-bg); color: var(--text); }
.btn { padding: 10px 20px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text); cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; white-space: nowrap; position: relative; overflow: hidden;}
.btn:hover { background: rgba(255,255,255,0.2); color: var(--text); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.btn:active { transform: scale(0.95); filter: brightness(1.2); }
.btn.green { border-color: var(--neon-green); color: var(--neon-green); }
.btn.green:hover { background: var(--neon-green); color: black; }
.btn.red { border-color: var(--neon-red); color: var(--neon-red); }
.btn.red:hover { background: var(--neon-red); color: white; }
.btn.purple { border-color: var(--neon-purple); color: var(--neon-purple); }
.btn.purple:hover { background: var(--neon-purple); color: white; }

/* PAGE VIEW */
.page-view { display: none; padding: 25px; height: 100%; overflow-y: auto; box-sizing: border-box; padding-bottom: 100px; animation: slideUpFade 0.4s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; z-index: 1; position: relative; }
.page-view.active { display: block; }
@keyframes slideUpFade { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

/* GRID & CARDS */
.grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
.student-card { background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; text-align: center; cursor: pointer; transition: .3s; position: relative; backdrop-filter: blur(5px); overflow: hidden;}
.student-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.05); }
.student-card.hk-theme:hover { border-color: var(--neon-purple); box-shadow: 0 0 25px var(--neon-purple); }
.student-card.acad-theme:hover { border-color: var(--neon-gold); box-shadow: 0 0 25px rgba(251, 191, 36, 0.3); }
.card-checkbox { position: absolute; top: 15px; left: 15px; z-index: 20; width: 20px; height: 20px; cursor: pointer; accent-color: var(--neon-purple); transform: scale(1.3); }

/* AVATAR & GALAXY EFFECT */
.avatar-container { width: 70px; height: 70px; margin: 0 auto 15px; border-radius: 50%; position: relative; z-index: 1; display: flex; justify-content: center; align-items: center; background: transparent !important; box-shadow: none !important; padding: 0; transform-style: preserve-3d; }
.avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #0a0a2a; position: relative; z-index: 10; border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 0 25px rgba(0, 234, 255, 0.5); }
.galaxy-system { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
.g-layer-1 { position: absolute; top: 50%; left: 50%; width: 220%; height: 220%; background: conic-gradient(from 45deg, transparent 0%, rgba(0, 51, 204, 0.3) 15%, rgba(189, 0, 255, 0.2) 30%, transparent 50%, rgba(0, 234, 255, 0.3) 65%, rgba(0, 51, 204, 0.2) 85%, transparent 100%); border-radius: 50%; filter: blur(12px); mix-blend-mode: screen; animation: galaxy-spin-slow 45s linear infinite; }
.g-dust { position: absolute; top: 50%; left: 50%; width: 250%; height: 250%; border-radius: 50%; background-image: radial-gradient(white 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(circle, transparent 25%, black 55%, transparent 85%); -webkit-mask-image: radial-gradient(circle, transparent 25%, black 55%, transparent 85%); opacity: 0.9; mix-blend-mode: screen; animation: galaxy-spin-slow 60s linear infinite; }
.card-score-badge { padding: 6px 15px; border-radius: 20px; font-weight: 700; font-size: 14px; background: rgba(0,0,0,0.4); margin-top: 25px; display: inline-block; border: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.acad-theme .card-score-badge { color: var(--neon-gold); border-color: var(--neon-gold); box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
@keyframes galaxy-spin-slow { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

/* BULK ACTION BAR */
.bulk-action-bar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--sidebar-bg); border: 1px solid var(--neon-blue); padding: 15px 30px; border-radius: 50px; display: none; align-items: center; gap: 15px; box-shadow: 0 0 30px rgba(0, 234, 255, 0.3); z-index: 1000; animation: slideUp 0.3s; }
@keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

/* MODALS */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(15px); animation: fadeIn 0.3s; }
.profile-window { background: var(--sidebar-bg); width: 1000px; max-width: 95vw; height: 85vh; border-radius: 24px; display: flex; flex-direction: column; border: 1px solid var(--neon-purple); box-shadow: 0 0 30px rgba(189, 0, 255, 0.3), inset 0 0 20px rgba(189, 0, 255, 0.05); overflow: hidden; position: relative; color: var(--text); }
.pw-header { padding: 20px 30px; border-bottom: 1px solid rgba(189, 0, 255, 0.3); box-shadow: 0 2px 10px rgba(189, 0, 255, 0.1); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent); }
.pw-body { flex: 1; display: grid; grid-template-columns: 350px 1fr; overflow: hidden; }
.pw-left { padding: 30px; background: rgba(0,0,0,0.1); border-right: 1px solid rgba(189, 0, 255, 0.3); box-shadow: 2px 0 10px rgba(189, 0, 255, 0.1); overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
.pw-right { padding: 30px; overflow-y: auto; background: rgba(255,255,255,0.01); }
.score-inner { position: absolute; text-align: center; display: flex; flex-direction: column; align-items: center; }
.score-value { font-size: 48px; font-weight: 700; line-height: 1; color: var(--text); text-shadow: 0 0 20px var(--score-color); }
.score-label { font-size: 12px; font-weight: bold; margin-top: 5px; opacity: 0.7; letter-spacing: 2px; }
.timeline-container { width: 100%; flex: 1; overflow-y: auto; padding-right: 5px; }
.timeline-item { position: relative; padding-left: 20px; margin-bottom: 20px; border-left: 2px solid rgba(255,255,255,0.1); }
.timeline-item::before { content: ''; position: absolute; left: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: #334155; }
.timeline-item.pos::before { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
.timeline-item.neg::before { background: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); }
.t-desc { font-weight: bold; font-size: 14px; }
.t-val { font-size: 13px; font-weight: bold; margin: 2px 0; }
.t-time { font-size: 11px; opacity: 0.5; }

.holo-grid {
    /* Cấu hình lưới (Giữ nguyên nút nhỏ 100px) */
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;

    /* --- QUAN TRỌNG: CẤU HÌNH THANH TRƯỢT --- */
    max-height: 300px;       /* Giới hạn chiều cao (khoảng 3 hàng nút) */
    overflow-y: auto;        /* Tự động hiện thanh trượt khi nút nhiều */
    overflow-x: hidden;      /* Ẩn thanh trượt ngang */
    
    /* Trang trí khung chứa */
    padding: 5px;            /* Đệm nhẹ để bóng đổ của nút không bị cắt */
    background: rgba(0, 0, 0, 0.15); /* Nền tối nhẹ để phân vùng */
    border-radius: 12px;     /* Bo góc khung */
    border: 1px solid rgba(255, 255, 255, 0.05);
    align-content: start;    /* Dồn các nút lên trên cùng */
}

/* --- TÙY CHỈNH THANH TRƯỢT (SCROLLBAR) SIÊU NHỎ --- */
.holo-grid::-webkit-scrollbar {
    width: 4px; /* Thanh trượt mảnh dẻ */
}
.holo-grid::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}
.holo-grid::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2); /* Màu thanh trượt */
    border-radius: 4px;
}
.holo-grid:hover::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.4); /* Sáng lên khi di chuột vào */
}
.holo-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px;}
.holo-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.08); }
.holo-card.good:hover { border-color: var(--neon-green); box-shadow: 0 0 20px rgba(74, 222, 128, 0.2); }
.holo-card.bad:hover { border-color: var(--neon-red); box-shadow: 0 0 20px rgba(244, 63, 94, 0.2); }
.holo-card.acad:hover { border-color: var(--neon-gold); box-shadow: 0 0 20px rgba(251, 191, 36, 0.2); }
.hc-icon { font-size: 24px; margin-bottom: 8px; display: block; }
.hc-label small { display: block; font-size: 10px; opacity: 0.7; margin-top: 3px; }
@keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }
.shake-anim { animation: shake 0.3s infinite; border: 1px dashed white !important; cursor: context-menu !important; opacity: 0.8; }

.confirm-box { background:var(--sidebar-bg); border-radius:20px; width:400px; border:1px solid var(--neon-cyan); box-shadow:0 0 25px rgba(0, 255, 204, 0.3), inset 0 0 15px rgba(0, 255, 204, 0.05); overflow:hidden; animation: zoomIn 0.2s; }
.confirm-header { padding:20px; text-align:center; background: rgba(255,255,255,0.05); font-weight:bold; letter-spacing:2px; font-size: 18px; text-shadow: 0 0 10px rgba(255,255,255,0.3);}
.confirm-body { padding:30px; display:flex; flex-direction:column; gap:20px; }
.confirm-footer { padding: 20px; display: flex; justify-content: flex-end; gap: 10px; background: rgba(0,0,0,0.3);}
.input-group label { display: block; font-size: 12px; color: var(--text); opacity:0.6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;}
.input-group input { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255, 255, 255, 0.2); background:rgba(0,0,0,0.1); color:var(--text); box-sizing:border-box; font-size: 16px; transition: 0.3s;}
.input-group input:focus { border-color: var(--neon-gold) !important; outline: none; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4) !important; }

/* TKB & Others */
.tkb-container { background: transparent; border-radius: 24px; padding: 0; overflow-x: auto; }
.tkb-controls { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px); }
.tkb-wrapper { background: #ffffff !important; border-radius: 8px; padding: 10px; border: 1px solid #ccc; width: 100%; overflow: hidden; font-family: 'Quicksand', sans-serif; color: #333; }
.tkb-wrapper h3 { color: #00796b; text-transform: uppercase; text-align: center; background: #e0f2f1; padding: 8px 20px; border-radius: 4px; display: table; margin: 0 auto 10px auto !important; border: 1px solid #b2dfdb; font-size: 15px; font-weight: 700; }
.tkb-table { width: 100%; border-collapse: separate !important; border-spacing: 4px !important; table-layout: fixed; }
.tkb-table th { background: #009688; color: #fff; padding: 8px 0; font-size: 12px; border-radius: 4px; text-align: center; border: none; text-transform: uppercase; font-weight: bold; }
.tkb-table th.is-today { background: #ff9800; }
.tkb-table tr td:first-child { width: 35px !important; min-width: 35px !important; vertical-align: middle; padding: 0; border: none; background: transparent !important; }
.tkb-period-badge { display: flex !important; justify-content: center; align-items: center; width: 26px !important; height: 26px !important; background: #455a64 !important; color: #ffffff !important; border-radius: 50%; font-weight: bold; font-size: 12px; margin: 0 auto; box-shadow: none !important; }
.session-row td { height: 25px !important; background: #fff3e0 !important; color: #e65100 !important; font-weight: 900 !important; font-size: 11px !important; text-align: center; border: 1px solid #ffe0b2 !important; border-radius: 4px; letter-spacing: 1px; text-transform: uppercase; }
.tkb-table td { height: 40px; padding: 0; vertical-align: middle; }
.tkb-cell-edit { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #ffffff !important; border: 1px solid #e0e0e0 !important; border-radius: 4px; box-shadow: none !important; transform: none !important; backdrop-filter: none !important; padding: 0 2px; margin: 0 !important; }
.c-subj { font-size: 17px !important; font-weight: 700 !important; color: #000000 !important; text-transform: uppercase; text-align: center; line-height: 1.1; white-space: normal !important; overflow: hidden; text-shadow: none !important; }
.c-teach { font-size: 15px !important; font-weight: 500 !important; color: #555555 !important; font-style: italic; margin-top: 1px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: none !important; }
.subj-math, .subj-lit, .subj-eng, .subj-sci, .subj-soc, .subj-pe { background: #ffffff !important; border: 1px solid #e0e0e0 !important; box-shadow: none !important; }
.tkb-cell-edit:hover { background: #f5f5f5 !important; border-color: #999 !important; z-index: 5; }
.tkb-cell-edit.now-active { border: 2px solid #f44336 !important; background: #fff !important; }

/* Fireworks & Effects */
.celebrate-box { background: radial-gradient(circle, #2d1b4e 0%, #000 100%); width: 600px; padding: 40px; border-radius: 30px; text-align: center; position: relative; border: 2px solid var(--neon-gold); box-shadow: 0 0 50px var(--neon-gold), 0 0 100px rgba(189, 0, 255, 0.5); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2500; }
@keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.cel-winner { font-size: 45px; font-weight: 900; background: linear-gradient(to right, #ff00cc, #333399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 20px 0; text-transform: uppercase; filter: drop-shadow(0 0 15px rgba(255, 0, 204, 0.8)); animation: pulseText 1s infinite alternate; }
@keyframes pulseText { from { transform: scale(1); } to { transform: scale(1.1); } }
.ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple-animation 0.6s linear; background: rgba(255, 255, 255, 0.3); pointer-events: none; z-index: 100; }
@keyframes ripple-animation { to { transform: scale(4); opacity: 0; } }

/* Other components (Toast, Game, Trash, Stats...) */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
.toast { min-width: 250px; padding: 15px 20px; border-radius: 12px; background: rgba(10, 10, 42, 0.95); backdrop-filter: blur(10px); border-left: 5px solid; box-shadow: 0 5px 15px rgba(0,0,0,0.5); color: #fff; font-family: 'Quicksand', sans-serif; font-weight: 600; display: flex; align-items: center; gap: 15px; animation: toastSlideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); transition: 0.3s; opacity: 0; }
.toast.show { opacity: 1; transform: translateX(0); }
.toast.hide { opacity: 0; transform: translateX(100%); }
.toast.success { border-color: var(--neon-green); box-shadow: 0 0 10px rgba(74, 222, 128, 0.2); } .toast.success .t-icon { color: var(--neon-green); font-size: 20px; }
.toast.error { border-color: var(--neon-red); box-shadow: 0 0 10px rgba(244, 63, 94, 0.2); } .toast.error .t-icon { color: var(--neon-red); font-size: 20px; }
.toast.info { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 234, 255, 0.2); } .toast.info .t-icon { color: var(--neon-blue); font-size: 20px; }
@keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Stats & Trash Grid */
.stats-wrapper { padding: 20px; height: 100%; overflow-y: auto; animation: fadeIn 0.5s; }
.stats-grid-top { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-summary-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: 0.3s; }
.stat-summary-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); }
.stat-value { font-size: 32px; font-weight: 700; margin: 10px 0; text-shadow: 0 0 15px currentColor; }
.stat-label { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 50px; }
.chart-container { background: rgba(10, 10, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; position: relative; height: 350px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.chart-title { position: absolute; top: 15px; left: 20px; font-size: 14px; font-weight: bold; color: var(--text); opacity: 0.8; text-transform: uppercase; }

.trash-toolbar { display: flex; gap: 15px; margin-bottom: 25px; background: rgba(244, 63, 94, 0.05); padding: 20px; border-radius: 16px; border: 1px solid rgba(244, 63, 94, 0.3); align-items: center; flex-wrap: wrap; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.trash-title { font-weight: 800; color: var(--neon-red); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 10px rgba(244, 63, 94, 0.4); margin-right: auto; display: flex; align-items: center; gap: 10px; }
.trash-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding-bottom: 50px; }
.trash-card { background: rgba(20, 10, 20, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; position: relative; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; align-items: center; text-align: center; overflow: hidden; }
.trash-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, transparent 0%, rgba(244, 63, 94, 0.05) 100%); z-index: 0; }
.trash-card:hover { border-color: var(--neon-red); transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
.trash-card.selected { border-color: var(--neon-green); background: rgba(74, 222, 128, 0.05); box-shadow: 0 0 15px rgba(74, 222, 128, 0.2), inset 0 0 10px rgba(74, 222, 128, 0.05); }
.trash-avatar { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 15px; filter: grayscale(100%) brightness(0.8); border: 2px solid rgba(255,255,255,0.1); transition: 0.3s; object-fit: cover; z-index: 1; }
.trash-card:hover .trash-avatar { filter: grayscale(0%); border-color: var(--neon-red); }
.trash-card.selected .trash-avatar { filter: grayscale(0%); border-color: var(--neon-green); }
.trash-name { font-weight: 700; color: #cbd5e1; font-size: 14px; margin-bottom: 5px; z-index: 1; }
.trash-class { font-size: 12px; color: var(--neon-red); opacity: 0.8; z-index: 1; }
.trash-check-icon { position: absolute; top: 10px; right: 10px; background: var(--neon-green); color: black; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 0 10px var(--neon-green); animation: popIn 0.2s; z-index: 2; }

/* Custom Dropdown */
.custom-dropdown { position: relative; width: 200px; z-index: 1000; }
.dropdown-selected { background: rgba(16, 18, 27, 0.6); border: 1px solid rgba(0, 234, 255, 0.3); color: var(--neon-cyan); padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(5px); transition: 0.3s; box-shadow: 0 0 10px rgba(0, 234, 255, 0.1); }
.dropdown-selected:hover { background: rgba(0, 234, 255, 0.1); box-shadow: 0 0 15px rgba(0, 234, 255, 0.3); border-color: var(--neon-cyan); }
.dropdown-options { display: none; position: absolute; top: 110%; left: 0; width: 250px; background: rgba(10, 10, 35, 0.95); border: 1px solid var(--neon-purple); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8); backdrop-filter: blur(15px); max-height: 400px; overflow-y: auto; animation: slideDown 0.2s ease-out; z-index: 10000 !important; }
.dropdown-options.show { display: block; }
.class-option { padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; border-bottom: 1px dashed rgba(255,255,255,0.05); }
.class-option:hover { background: rgba(189, 0, 255, 0.2); padding-left: 20px; }
.class-option.active { background: var(--neon-purple); color: white; }
.opt-group-label { padding: 8px 15px; font-size: 11px; color: var(--neon-gold); text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); font-weight: bold; letter-spacing: 1px; }
.del-class-btn { opacity: 0; color: var(--neon-red); font-size: 14px; padding: 5px; transition: 0.2s; }
.class-option:hover .del-class-btn { opacity: 1; }
/* --- GIAO DIỆN CỬA SỔ THÊM LỚP (MỚI) --- */
/* --- KHU VỰC NÚT THÊM LỚP (STICKY) --- */
.add-class-area {
    position: sticky;
    bottom: 0;
    z-index: 20;
    background: rgba(10, 10, 35, 0.98); /* Nền tối trùng menu */
    border-top: 1px solid rgba(255,255,255,0.1);
    padding: 10px;
    margin-top: 5px;
    box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
}

/* Tùy chỉnh cho giao diện Sáng (Yersin Light) */
body.theme-yersin-light .add-class-area {
    background: #f8fafc !important;
    border-top: 1px solid #e0e0e0 !important;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.05) !important;
}
/* Tiêu đề nhỏ của cửa sổ */
.add-class-header {
    font-size: 11px;
    font-weight: 800;
    color: var(--neon-green);
    text-transform: uppercase;
    text-align: center;
    letter-spacing: 1px;
    margin-bottom: 5px;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 5px;
}
.add-class-header::before, .add-class-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(255,255,255,0.1);
}

/* Các ô nhập liệu trong cửa sổ */
.add-class-row {
    display: flex;
    gap: 8px;
}

.add-class-input {
    background: rgba(255,255,255,0.1) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: white !important;
    padding: 8px !important;
    border-radius: 6px !important;
    font-size: 12px !important;
}
.add-class-input:focus {
    border-color: var(--neon-green) !important;
    background: rgba(0,0,0,0.5) !important;
}

/* --- TÙY CHỈNH CHO GIAO DIỆN YERSIN LIGHT --- */
body.theme-yersin-light .add-class-area {
    background: #f8fafc !important; /* Nền trắng xám */
    border-top: 2px solid #e0e0e0 !important;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.05) !important;
}
body.theme-yersin-light .add-class-header {
    color: #d84315 !important; /* Màu cam đậm */
}
body.theme-yersin-light .add-class-header::before, 
body.theme-yersin-light .add-class-header::after {
    background: #e0e0e0 !important;
}
body.theme-yersin-light .add-class-input {
    background: #ffffff !important;
    border: 1px solid #cfd8dc !important;
    color: #333 !important;
}
body.theme-yersin-light .add-class-input:focus {
    border-color: #d84315 !important;
    box-shadow: 0 0 0 2px rgba(216, 67, 21, 0.1) !important;
}
.add-class-input { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 6px; font-size: 12px; }

/* Settings Modal & Check Badge & Marquee */
.red-tick-badge { position: absolute; top: 6px; right: 10px; width: 32px; height: 32px; background: linear-gradient(135deg, var(--neon-red), #ff6b6b); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: 900; border: 2px solid rgba(255, 255, 255, 0.8); box-shadow: 0 0 15px var(--neon-red), inset 0 0 5px rgba(0,0,0,0.2); z-index: 15; opacity: 0; transform: scale(0.5) rotate(-45deg); transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
.student-card.has-monthly-check .red-tick-badge { opacity: 1; transform: scale(1) rotate(0deg); }
.student-card.has-monthly-check { background: linear-gradient(160deg, rgba(244, 63, 94, 0.25) 0%, rgba(45, 10, 30, 0.9) 100%) !important; border-color: var(--neon-red) !important; box-shadow: 0 5px 25px rgba(244, 63, 94, 0.4) !important; transform: translateY(-3px); }
.marquee-container { height: 0; overflow: hidden; margin: 8px 0 4px 0; white-space: nowrap; position: relative; border-top: 1px dashed rgba(244, 63, 94, 0.3); padding-top: 4px; transition: height 0.3s ease; }
.student-card.has-monthly-check .marquee-container { height: 22px; }
.marquee-text { display: inline-block; font-size: 13px; color: #ffbdc7; font-style: italic; text-shadow: 0 0 5px rgba(244, 63, 94, 0.5); padding-left: 100%; animation: marqueeScroll 15s linear infinite; }
@keyframes marqueeScroll { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

/* Right Sidebar & Print CSS */
.right-sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 2999; }
.right-sidebar-panel { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: var(--sidebar-bg); border-left: 1px solid var(--neon-purple); box-shadow: -5px 0 30px rgba(0,0,0,0.5); z-index: 3000; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
.right-sidebar-panel.open { right: 0; }
.rs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
.rs-section { margin-bottom: 25px; }
.rs-label { font-size: 12px; text-transform: uppercase; color: var(--neon-gold); margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; }

@media print {
    body * { visibility: hidden; }
/* --- FIX LỖI IN ẤN (CÓ THANH CUỘN) --- */
#printPreviewModal .confirm-box {
    width: 900px !important;
    max-width: 100vw;
    height: 100vh;
    max-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 0 !important;
    background: #525659;
}

#printArea {
    flex: 1;
    overflow-y: auto; /* Bật thanh cuộn dọc */
    padding: 30px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.a4-page {
    width: 210mm;
    min-height: 297mm;
    padding: 20mm;
    margin: 0 auto 20px auto;
    background: white;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    color: black;
}    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; left: 0; top: 0; width: 100%; }
    .hk-report-page { box-shadow: none; margin: 0; width: 100%; page-break-after: always; }
    .confirm-footer, .confirm-header { display: none; }
}

/* Compact Settings UI */
#settingsModal .confirm-box { width: 500px; max-width: 95vw; background: rgba(16, 18, 27, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); border-radius: 16px; }
#settingsModal .confirm-header { background: transparent; border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 15px 20px; font-size: 16px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
#settingsModal .confirm-body { padding: 20px; gap: 20px; max-height: 70vh; overflow-y: auto; }
.setting-group { margin-bottom: 20px; }
.setting-title { font-size: 12px; text-transform: uppercase; color: var(--neon-blue); margin-bottom: 10px; font-weight: 800; letter-spacing: 1px; opacity: 0.8; }
.modern-input { width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px 12px; border-radius: 6px; color: white; font-family: 'Quicksand', sans-serif; font-size: 14px; box-sizing: border-box; }
.modern-input:focus { border-color: var(--neon-blue); outline: none; background: rgba(0, 0, 0, 0.5); }
.switch-container { display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.03); padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; }
.switch-container:hover { background: rgba(255, 255, 255, 0.06); }
.switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--neon-green); }
input:checked + .slider:before { transform: translateX(18px); }
.theme-grid-modern { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.theme-card { position: relative; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: 0.2s; background: rgba(0,0,0,0.2); }
.theme-card:hover { transform: translateY(-2px); }
.theme-card.selected { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 234, 255, 0.2); }
.theme-bg-preview { height: 50px; width: 100%; background-size: cover; background-position: center; }
.theme-name { padding: 5px; text-align: center; font-size: 11px; font-weight: bold; background: rgba(0,0,0,0.6); color: white; }
.theme-check { width: 16px; height: 16px; font-size: 10px; top: 3px; right: 3px; position: absolute; background: var(--neon-blue); color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0); transition: 0.3s; }
.theme-card.selected .theme-check { opacity: 1; transform: scale(1); }
#settingsModal .confirm-footer { padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px; }

/* Comment Tab & Others */
.cmt-tab.active { background: rgba(255,255,255,0.05); }
.cmt-item { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; border: 1px solid transparent; }
.cmt-item:hover { background: rgba(255,255,255,0.1); }
.cmt-item.active { background: rgba(251, 191, 36, 0.2); border-color: var(--neon-gold); }
.cmt-item.done-item { opacity: 0.6; }

/* Game Area */
.game-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 100%; overflow: hidden; }
.game-sidebar { background: rgba(0,0,0,0.3); border-right: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
.game-main { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
.game-tab-btn { padding: 15px; margin-bottom: 10px; border-radius: 12px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-weight: bold; border: 1px solid transparent; }
.game-tab-btn:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
.game-tab-btn.active { background: linear-gradient(90deg, rgba(189, 0, 255, 0.2), transparent); border-left: 4px solid var(--neon-purple); color: var(--neon-purple); box-shadow: 0 0 15px rgba(189, 0, 255, 0.1); }
.game-content { display: none; animation: fadeIn 0.4s; height: 100%; }
.game-content.active { display: block; }
.race-track { width: 100%; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; margin-top: 20px; overflow-y: auto; max-height: 500px; border: 1px solid var(--glass-border); }
.racer-lane { position: relative; height: 50px; border-bottom: 1px dashed rgba(255,255,255,0.1); margin-bottom: 10px; display: flex; align-items: center; }
.racer-lane:last-child { border: none; }
.racer-ship { position: absolute; left: 0; top: 5px; font-size: 30px; transition: left 0.5s linear; z-index: 10; filter: drop-shadow(0 0 5px var(--neon-cyan)); display: flex; flex-direction: column; align-items: center; width: 60px;}
.racer-name { font-size: 10px; position: absolute; top: -15px; width: 100px; text-align: center; color: var(--text); font-weight: bold; white-space: nowrap; }
.finish-line { position: absolute; right: 20px; top: 0; bottom: 0; width: 4px; background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px); z-index: 5; }
.group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
.group-box { background: rgba(255,255,255,0.05); border: 1px solid var(--neon-blue); border-radius: 15px; padding: 15px; box-shadow: 0 0 15px rgba(0, 234, 255, 0.1); animation: zoomIn 0.3s; }
.group-title { text-align: center; font-weight: bold; color: var(--neon-gold); margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
.group-list { list-style: none; padding: 0; margin: 0; font-size: 14px; }
.group-list li { padding: 5px 0; border-bottom: 1px dashed rgba(255,255,255,0.05); }
.timer-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80%; }
.digital-clock { font-size: 120px; font-weight: 700; color: var(--neon-red); text-shadow: 0 0 30px var(--neon-red); font-family: 'Courier New', monospace; letter-spacing: 5px; margin: 30px 0; }
.timer-controls { display: flex; gap: 20px; }
.timer-input { background: transparent; border: 2px solid var(--glass-border); color: white; padding: 10px; font-size: 20px; width: 80px; text-align: center; border-radius: 10px; }
.game-input-area { width: 100%; height: 150vh; background: rgba(10, 10, 42, 0.6) !important; color: #00eaff !important; border: 1px solid rgba(189, 0, 255, 0.5); border-radius: 12px; padding: 15px; font-family: 'Quicksand', sans-serif; font-size: 14px; line-height: 1.6; resize: vertical; outline: none; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); transition: all 0.3s ease; box-sizing: border-box; min-height: 150px; max-height: 90vh; }
.game-input-area:focus { border-color: #00eaff; background: rgba(10, 10, 42, 0.8) !important; box-shadow: 0 0 15px rgba(0, 234, 255, 0.3), inset 0 0 10px rgba(0,0,0,0.8); color: #fff !important; }
.game-input-area::-webkit-scrollbar { width: 6px; }
.game-input-area::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
.game-input-area::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, #bd00ff, #00eaff); border-radius: 4px; }
.teacher-note-area { width: 100%; margin-top: 20px; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 15px; color: var(--text); font-family: 'Quicksand', sans-serif; resize: none; transition: 0.3s; box-sizing: border-box; }
.teacher-note-area:focus { border-color: var(--neon-gold) !important; outline: none; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4) !important; }
.section-label { font-size: 12px; text-transform: uppercase; opacity: 0.7; margin-bottom: 10px; display:flex; align-items:center; gap:5px; letter-spacing: 1px; font-weight: 700; }
.wheel-wrapper { position: relative; width: 320px; height: 320px; margin: 0 auto; display: flex; justify-content: center; align-items: center; }
.wheel-pointer { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); z-index: 50; width: 40px; height: 40px; background-image: url('https://cdn-icons-png.flaticon.com/512/1356/1356479.png'); background-size: cover; filter: drop-shadow(0 0 10px var(--neon-red)); transition: 0.3s; }
.wheel-center { position: absolute; width: 50px; height: 50px; background: radial-gradient(circle, #ffffff 0%, #fbbf24 40%, #d97706 100%); border-radius: 50%; z-index: 40; box-shadow: 0 0 20px var(--neon-gold); border: 4px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 20px; }
.wheel-wrapper canvas { transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); border-radius: 50%; box-shadow: 0 0 30px rgba(189, 0, 255, 0.2); border: 5px solid rgba(255,255,255,0.1); }
.week-nav-bar { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 234, 255, 0.1); }
.week-nav-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: 0.2s; }
.week-nav-btn:hover { background: var(--neon-cyan); color: black; }
.week-display { font-weight: bold; color: var(--neon-cyan); font-size: 16px; text-transform: uppercase; min-width: 80px; text-align: center; }
.date-range-picker { background: transparent; border: none; color: white; font-family: 'Quicksand', sans-serif; font-size: 13px; border-bottom: 1px dashed rgba(255,255,255,0.3); padding: 3px; width: 130px; text-align: center; }
.date-locked { opacity: 0.6; pointer-events: none; border-bottom: none; }
.lock-toggle-container { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 8px; transition: 0.3s; }
.lock-toggle-container:hover { background: rgba(255,255,255,0.05); }
.lock-icon { font-size: 18px; transition: 0.3s; }
.lock-active .lock-icon { color: var(--neon-red); text-shadow: 0 0 10px var(--neon-red); }
.lock-open .lock-icon { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
.lock-status-text { font-size: 12px; opacity: 0.8; font-weight: bold; }
.week-header-btn { background: transparent; border: none; color: var(--text); font-size: 14px; cursor: pointer; padding: 2px 8px; transition: 0.2s; border-radius: 4px; }
.week-header-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 10px var(--neon-cyan); }
.week-header-input { background: transparent; border: none; color: var(--text); font-family: 'Quicksand', sans-serif; font-size: 10px; text-align: center; width: 100px; opacity: 0.7; padding: 0; }
.week-header-input:focus { outline: none; color: var(--neon-gold); opacity: 1; }

/* --- TÍNH NĂNG CHUỘT PHẢI & QUÉT CHỌN (NEW) --- */

/* 1. Ẩn checkbox cũ đi vì giờ dùng click chọn */
.card-checkbox { display: none !important; }


/* 3. Menu chuột phải (Context Menu) */
#contextMenu {
    display: none;
    position: fixed;
    z-index: 10000;
    width: 220px;
    background: rgba(10, 10, 35, 0.98);
    border: 1px solid var(--neon-purple);
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.8), 0 0 10px rgba(189, 0, 255, 0.2);
    backdrop-filter: blur(15px);
    overflow: hidden;
    animation: fadeIn 0.1s ease-out;
}

.ctx-item {
    padding: 12px 15px;
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: 0.2s;
    font-size: 14px;
    font-weight: 600;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.ctx-item:last-child { border-bottom: none; }
.ctx-item:hover { background: var(--neon-purple); color: white; }
.ctx-icon { width: 20px; text-align: center; }

/* 4. Khung quét chọn (Selection Box) */
/* --- SỬA LỖI KHUNG QUÉT --- */

/* --- CẤU HÌNH GIAO DIỆN XEM TRƯỚC (PREVIEW) - CÓ CUỘN --- */
#printPreviewModal .confirm-box {
    width: 900px !important;
    max-width: 100vw;
    height: 100vh;           /* Full chiều cao màn hình */
    max-height: 100vh;
    border-radius: 0;
    display: flex;
    flex-direction: column;  /* Xếp dọc */
    background: #525659;     /* Nền xám tối chuyên nghiệp */
    padding: 0 !important;
    border: none;
}

#printPreviewModal .confirm-header,
#printPreviewModal .confirm-footer {
    background: #323639;     /* Thanh công cụ màu tối */
    color: white;
    padding: 10px 20px;
    flex-shrink: 0;
    z-index: 10;
}

#printArea {
    flex: 1;                 /* Chiếm phần còn lại */
    overflow-y: auto;        /* BẬT THANH CUỘN DỌC */
    padding: 30px 0;
    background: #525659;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* Tờ giấy A4 hiển thị trên màn hình */
.a4-page {
    width: 210mm;
    min-height: 297mm;
    padding: 20mm;
    margin: 0 auto 20px auto;
    background: white;
    color: black;
    font-family: "Times New Roman", Times, serif;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    position: relative;
    box-sizing: border-box;
}

/* Khi in thật sự */
@media print {
    @page { margin: 0; size: A4; }
    body * { visibility: hidden; }
    #printPreviewModal { display: block !important; position: absolute; inset: 0; background: white; z-index: 9999; }
    #printArea, #printArea * { visibility: visible; }
    #printArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; display: block; overflow: visible; background: white; }
    .a4-page { width: 100%; margin: 0; box-shadow: none; page-break-after: always; border: none; }
    .confirm-header, .confirm-footer { display: none !important; }
}

/* Các thành phần nội dung phiếu (Giữ nguyên style đẹp) */
.report-header { text-align: center; margin-bottom: 20px; }
.report-school { font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
.report-title { font-size: 18px; font-weight: bold; text-transform: uppercase; margin-top: 15px; }
.report-info { margin-bottom: 15px; font-size: 14px; line-height: 1.5; }
.report-info-row { display: flex; justify-content: space-between; }
.report-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; }
.report-table th, .report-table td { border: 1px solid #000; padding: 8px; vertical-align: middle; }
.report-table th { font-weight: bold; text-align: center; background: #f0f0f0; }
.report-summary { margin-top: 10px; font-size: 14px; font-weight: bold; }
.report-note { margin-top: 10px; font-size: 14px; font-style: italic; border-bottom: 1px dotted #000; padding-bottom: 5px; min-height: 40px; }
.report-footer { margin-top: 30px; display: flex; justify-content: space-between; text-align: center; }
.sign-block { width: 45%; }
.sign-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
.sign-note { font-style: italic; font-size: 12px; margin-bottom: 60px; }
.sign-name { font-weight: bold; font-size: 14px; }
/* 1. Ngăn bôi đen chữ khi đang quét (QUAN TRỌNG) */
#home, .student-card {
    -webkit-user-select: none; /* Chrome/Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* IE/Edge */
    user-select: none;         /* Chuẩn */
}

/* 2. Giao diện khung quét (Màu xanh neon dễ nhận biết) */

/* 3. Hiệu ứng khi thẻ được chọn trúng */
.student-card.selected-active {
    background: rgba(0, 234, 255, 0.15) !important;
    border-color: var(--neon-cyan) !important;
    box-shadow: 0 0 15px rgba(0, 234, 255, 0.4) !important;
    transform: scale(1.02);
}
/* --- TÙY CHỈNH RIÊNG CHO GIAO DIỆN YERSIN 2025 (LIGHT) --- */
body.theme-yersin-light .galaxy-system {
    display: none !important; /* Ẩn hiệu ứng vòng xoay Galaxy quanh avatar */
}

/* Loại bỏ bóng Neon và Text Shadow gây lóa trên nền sáng */
body.theme-yersin-light .student-card,
body.theme-yersin-light .btn,
body.theme-yersin-light .sidebar,
body.theme-yersin-light .header,
body.theme-yersin-light .nav-item {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important; /* Bóng đen mờ nhẹ thay vì bóng màu */
    text-shadow: none !important; /* Bỏ chữ phát sáng */
}

/* Chỉnh lại viền thẻ cho rõ nét (Solid) thay vì phát sáng */
body.theme-yersin-light .student-card {
    border: 1px solid #e2e8f0 !important; /* Viền xám nhạt tinh tế */
    background: rgba(255,255,255,0.6) !important;
}

/* Chỉnh lại nút bấm cho phẳng */
body.theme-yersin-light .btn {
    border: 1px solid rgba(0,0,0,0.1) !important;
}

/* Chỉnh màu tiêu đề cho đậm đà, dễ đọc */
body.theme-yersin-light #pageTitle {
    text-shadow: none !important;
    font-weight: 800;
}
/* --- TÙY CHỈNH CHI TIẾT MÀU SẮC CHO GIAO DIỆN YERSIN (LIGHT) --- */

/* 1. NÚT BẤM (BUTTONS) - Style Cam hiện đại */
body.theme-yersin-light .btn {
    /* Màu nền: Gradient Cam Đậm sang Vàng Cam */
    background: linear-gradient(135deg, #fb8c00 0%, #e65100 100%) !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important; /* Bo góc tròn trịa hơn */
    font-weight: 700 !important;    /* Chữ đậm rõ ràng */
    box-shadow: 0 4px 10px rgba(230, 81, 0, 0.25) !important; /* Bóng đổ màu cam nhẹ */
    transition: all 0.2s ease !important;
    text-transform: uppercase;      /* Chữ in hoa cho giống nút chức năng */
    font-size: 13px !important;
    padding: 8px 16px !important;
}

/* Hiệu ứng khi di chuột vào nút */
body.theme-yersin-light .btn:hover {
    transform: translateY(-2px);    /* Nút nổi lên nhẹ */
    box-shadow: 0 6px 15px rgba(230, 81, 0, 0.4) !important;
}

/* Riêng nút "Xóa" hoặc nút màu đỏ thì giữ màu đỏ cho cảnh báo */
body.theme-yersin-light .btn.red {
    background: linear-gradient(135deg, #ff5252, #c62828) !important;
    box-shadow: 0 4px 10px rgba(198, 40, 40, 0.25) !important;
}

/* 2. KHUNG CHỌN LỚP & Ô NHẬP LIỆU (INPUT/SELECT) */
body.theme-yersin-light select,
body.theme-yersin-light input,
body.theme-yersin-light textarea {
    background-color: #ffffff !important; /* Nền trắng tinh */
    color: #333333 !important;            /* Chữ đen rõ nét */
    border: 2px solid #ffe0b2 !important; /* Viền màu Cam Pastel nhạt */
    border-radius: 8px !important;
    padding: 8px 12px !important;
    font-weight: 600 !important;
}

/* Khi bấm vào ô nhập liệu */
body.theme-yersin-light select:focus,
body.theme-yersin-light input:focus,
body.theme-yersin-light textarea:focus {
    border-color: #fb8c00 !important; /* Viền chuyển màu Cam đậm */
    box-shadow: 0 0 0 4px rgba(251, 140, 0, 0.15) !important; /* Viền sáng bao quanh */
    outline: none !important;
}

/* 3. MÀU CHỮ & TIÊU ĐỀ */
/* Màu chữ chung */
body.theme-yersin-light {
    color: #2c3e50 !important; /* Màu xám xanh đậm (dễ đọc hơn đen tuyền) */
}

/* Các tiêu đề lớn (H1, H2...) */
body.theme-yersin-light h1, 
body.theme-yersin-light h2,
body.theme-yersin-light #pageTitle {
    color: #e65100 !important; /* Màu Cam Cháy (Burnt Orange) nổi bật */
    font-weight: 800 !important;
    text-shadow: none !important;
}

/* Các tiêu đề nhỏ hoặc nhãn (Label) */
body.theme-yersin-light label,
body.theme-yersin-light .section-title {
    color: #ef6c00 !important;
    font-weight: 700 !important;
}

/* Chữ trong thẻ học sinh */
body.theme-yersin-light .student-card div {
    color: #1e293b !important; /* Màu chữ tối trong thẻ */
}
/* --- GIAO DIỆN TKB MẪU CUTE (THEO ẢNH) --- */
.tkb-cute-wrapper {
    background-color: #e0f7fa; /* Nền xanh nhạt */
    border: 5px solid #b2ebf2; /* Viền xanh đậm hơn chút */
    border-radius: 20px;
    padding: 20px;
    font-family: 'Quicksand', sans-serif;
    color: #333;
    position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    max-width: 1200px;
    margin: 0 auto;
}

/* Phần Header trang trí */
.tkb-cute-header {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    margin-bottom: 20px;
    background: #ffffff;
    border-radius: 15px;
    padding: 15px;
    border: 2px dashed #b2ebf2;
}

.tkb-cute-icon {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 50px;
}

.tkb-cute-title {
    font-size: 40px;
    font-weight: 900;
    text-transform: uppercase;
    /* Hiệu ứng chữ bong bóng xanh lá như ảnh */
    color: #b2dfdb; 
    -webkit-text-stroke: 1.5px #00796b;
    text-shadow: 3px 3px 0px #004d40;
    letter-spacing: 2px;
    margin: 0;
}

.tkb-cute-info {
    text-align: center;
    font-weight: bold;
    color: #006064;
    font-size: 16px;
    margin-top: 5px;
}

/* Phần Bảng */
.tkb-cute-table {
    width: 100%;
    border-collapse: separate; 
    border-spacing: 4px; /* Khoảng cách giữa các ô */
}

/* Hàng tiêu đề (Thứ 2, Thứ 3...) - Màu Vàng Cam */
.tkb-cute-table th {
    background-color: #ffcc80; /* Màu vàng cam giống ảnh */
    color: #5d4037; /* Chữ nâu đậm */
    padding: 12px;
    border-radius: 8px;
    font-weight: 800;
    text-transform: uppercase;
    font-size: 14px;
    border: 2px solid #ffb74d;
}

/* Cột đầu tiên (Thời gian/Tiết) */
.tkb-cute-table tr td:first-child {
    background-color: #ffe0b2;
    color: #e65100;
    font-weight: bold;
    border-radius: 8px;
    border: 1px solid #ffcc80;
    width: 50px !important;
}

/* Các ô nội dung */
.tkb-cute-table td {
    background-color: #ffffff;
    border: 1px solid #b2ebf2; /* Viền xanh nhạt */
    border-radius: 6px;
    height: 50px;
    vertical-align: middle;
    padding: 2px;
    transition: 0.2s;
    color: #333;
}

.tkb-cute-table td:hover {
    background-color: #e1f5fe;
    border-color: #0288d1;
}

/* Nội dung trong ô */
.cute-cell-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    width: 100%;
}

.cute-subj {
    font-weight: 800;
    color: #00838f; /* Màu chữ môn học */
    font-size: 13px;
    text-transform: uppercase;
    text-align: center;
}

.cute-teach {
    font-size: 10px;
    color: #f57c00; /* Màu tên GV */
    font-style: italic;
    font-weight: bold;
    margin-top: 2px;
}

/* Ẩn bớt các hiệu ứng cũ nếu bị xung đột */
.tkb-cute-wrapper .tkb-cell-edit {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}
/* ====================================================== */
/* GIAO DIỆN TKB MẪU CUTE (THEO ẢNH YÊU CẦU) */
/* ====================================================== */

/* 1. Bao ngoài: Nền xanh nhạt, bo góc */
.cute-tkb-wrapper {
    background-color: #e0f7fa; /* Nền xanh pastel */
    border: 8px solid #b2ebf2; /* Viền xanh đậm hơn */
    border-radius: 25px;
    padding: 20px;
    font-family: 'Quicksand', sans-serif;
    color: #4a4a4a; /* Chữ màu xám đậm (ghi đè màu trắng của app) */
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

/* 2. Tiêu đề: Chữ bong bóng xanh ngọc */
.cute-header-section {
    text-align: center;
    position: relative;
    margin-bottom: 20px;
    background: #ffffff;
    border-radius: 15px;
    padding: 15px;
    border: 3px dashed #80deea;
}

.cute-title {
    font-size: 45px;
    font-weight: 900;
    color: #b2dfdb; /* Màu trong chữ */
    text-transform: uppercase;
    /* Tạo viền chữ bong bóng */
    -webkit-text-stroke: 2px #00695c; 
    text-shadow: 4px 4px 0px #004d40;
    letter-spacing: 2px;
    margin: 0;
    line-height: 1.2;
}

.cute-subtitle {
    font-size: 16px;
    font-weight: bold;
    color: #00838f;
    margin-top: 5px;
    text-transform: uppercase;
}

/* Icon sách vở trang trí (Emoji) */
.cute-icon-decor {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 50px;
}

/* 3. Bảng: Header Vàng Cam, Thân Trắng */
.cute-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 4px; /* Khoảng cách giữa các ô */
}

/* Hàng tiêu đề (Thứ) */
.cute-table thead th {
    background-color: #ffcc80; /* Màu vàng cam giống ảnh */
    color: #5d4037; /* Chữ nâu đất */
    padding: 12px 5px;
    border-radius: 8px;
    font-weight: 800;
    text-transform: uppercase;
    border: 2px solid #ffa726;
    font-size: 14px;
    text-align: center;
}

/* Cột Tiết (Bên trái) */
.cute-table tbody td:first-child {
    background-color: #ffe0b2; /* Cam nhạt */
    color: #e65100;
    font-weight: bold;
    border: 2px solid #ffb74d;
    border-radius: 8px;
    text-align: center;
}

/* Các ô nội dung */
.cute-table tbody td {
    background-color: #ffffff;
    border: 2px solid #b2ebf2; /* Viền xanh nhạt */
    border-radius: 10px;
    height: 50px;
    vertical-align: middle;
    padding: 2px;
    transition: 0.2s;
}

.cute-table tbody td:hover {
    background-color: #e1f5fe;
    border-color: #0288d1;
    transform: scale(1.02);
}

/* Nội dung bên trong ô (Môn + GV) */
.cute-cell {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    width: 100%;
    cursor: text;
}

.cute-subj {
    font-weight: 800;
    color: #00838f; /* Màu xanh đậm cho tên môn */
    font-size: 13px;
    text-transform: uppercase;
    text-align: center;
    line-height: 1.1;
}

.cute-teach {
    font-size: 10px;
    color: #f57c00; /* Màu cam đậm cho tên GV */
    font-weight: bold;
    font-style: italic;
    margin-top: 2px;
    text-align: center;
}

/* Ẩn các style cũ xung đột */
.cute-tkb-wrapper .tkb-cell-edit {
    border: none !important;
    background: transparent !important;
    box-shadow: none !important;
}

/* Phân cách buổi sáng/chiều */
.cute-separator td {
    background: transparent !important;
    border: none !important;
    height: 10px !important;
}
/* ====================================================== */
/* CẬP NHẬT: TĂNG KÍCH THƯỚC CHỮ TKB */
/* ====================================================== */

/* 1. Tăng cỡ chữ tên Môn Học (Ví dụ: TOÁN, VĂN...) */
.cute-subj {
    font-size: 18px !important; /* Cũ là 13px -> Tăng lên 18px */
    line-height: 1.2;
}

/* 2. Tăng cỡ chữ tên Giáo Viên */
.cute-teach {
    font-size: 14px !important; /* Cũ là 10px -> Tăng lên 14px */
    margin-top: 4px;
}

/* 3. Tăng cỡ chữ hàng Tiêu đề (Thứ 2, Thứ 3...) */
.cute-table thead th {
    font-size: 18px !important; /* Cũ là 14px */
    padding: 15px 5px; /* Tăng khoảng trống cho thoáng */
}

/* 4. Tăng cỡ chữ cột Tiết (1, 2, 3...) */
.cute-table tbody td:first-child {
    font-size: 20px !important;
    width: 60px !important; /* Mở rộng cột tiết một chút */
}

/* 5. Tăng chiều cao ô để chứa chữ to không bị chật */
.cute-table tbody td {
    height: 60px !important; /* Cũ là 50px */
}
/* Style cho hàng phân chia buổi */
.cute-session-row td {
    background-color: #fff3e0 !important; /* Nền cam nhạt */
    color: #ef6c00 !important; /* Chữ cam đậm */
    font-weight: 900 !important;
    text-align: center !important;
    padding: 10px !important;
    font-size: 16px !important;
    letter-spacing: 3px;
    text-transform: uppercase;
    border: 2px solid #ffb74d !important;
    border-radius: 8px;
}
/* --- TRẠNG THÁI TIẾT QUAN TRỌNG (HIGHLIGHT) --- */
.cute-important {
    /* Nền vàng rực rỡ */
    background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%) !important; 
    /* Viền đỏ gây chú ý */
    border: 2px solid #ff1744 !important; 
    /* Đổ bóng đỏ nhẹ */
    box-shadow: 0 0 15px rgba(255, 23, 68, 0.4) !important;
    /* Hiệu ứng nổi lên */
    transform: scale(1.05);
    z-index: 10;
    position: relative;
    border-radius: 12px !important;
}

/* Đổi màu chữ bên trong cho hợp với nền vàng */
.cute-important .cute-subj { color: #d50000 !important; font-weight: 900 !important; }
.cute-important .cute-teach { color: #b71c1c !important; }
/* ====================================================== */
/* CẤU HÌNH: TẮT NEON & CHUYỂN SANG PHẲNG (FLAT STYLE) */
/* (Chỉ áp dụng cho giao diện Yersin Light) */
/* ====================================================== */

body.theme-yersin-light * {
    text-shadow: none !important; /* TẮT TOÀN BỘ NEON */
    font-family: 'Quicksand', sans-serif !important; /* Ép font tròn trịa dễ đọc */
}

/* 1. Thanh Menu bên trái (Sidebar) */
body.theme-yersin-light .sidebar {
    background: #ffffff !important;
    border-right: 1px solid #e0e0e0 !important;
    box-shadow: 2px 0 10px rgba(0,0,0,0.05) !important; /* Bóng đen mờ nhẹ */
}

/* Mục menu đang chọn -> Màu cam đậm, nền xám nhạt */
body.theme-yersin-light .nav-item.active {
    color: #d84315 !important; /* Cam đậm */
    background: #fbe9e7 !important; /* Nền cam rất nhạt */
    border-left: 4px solid #d84315 !important; /* Viền trái đặc */
    font-weight: 800 !important;
}

/* Mục menu thường -> Màu xám */
body.theme-yersin-light .nav-item {
    color: #546e7a !important;
    font-weight: 600 !important;
}

/* 2. Tiêu đề trang */
body.theme-yersin-light #pageTitle {
    color: #bf360c !important; /* Đỏ cam đậm */
    font-weight: 900 !important;
}

/* 3. Thẻ học sinh (Student Card) */
body.theme-yersin-light .student-card {
    background: #ffffff !important;
    border: 1px solid #cfd8dc !important; /* Viền xám */
    box-shadow: 0 2px 5px rgba(0,0,0,0.05) !important;
    color: #263238 !important; /* Chữ đen xám */
}

/* Tên học sinh trong thẻ */
body.theme-yersin-light .student-card div:nth-child(4) { /* Dòng tên */
    color: #263238 !important;
    font-weight: 800 !important;
}

/* 4. Các nút bấm (Button) - Phẳng hoàn toàn */
body.theme-yersin-light .btn {
    box-shadow: none !important;
    border-bottom: 2px solid rgba(0,0,0,0.2) !important; /* Giả lập nút bấm nhẹ */
}
body.theme-yersin-light .btn:active {
    border-bottom: none !important;
    transform: translateY(2px);
}

/* 5. Điểm số (Badge) */
body.theme-yersin-light .card-score-badge {
    background: #eceff1 !important; /* Nền xám */
    border: 1px solid #b0bec5 !important;
    color: #37474f !important;
    font-weight: 800 !important;
    box-shadow: none !important;
}

/* 6. Fix lại Tiêu đề TKB Cute cho nét hơn (bỏ viền bong bóng mờ nếu muốn) */
body.theme-yersin-light .cute-title {
    -webkit-text-stroke: 0px !important; /* Bỏ viền chữ */
    color: #00695c !important; /* Màu xanh đậm đặc */
    text-shadow: none !important;
}
/* ====================================================== */
/* CẤU HÌNH BỔ SUNG: XÓA NEON AVATAR & THANH TUẦN */
/* (Chỉ áp dụng cho giao diện Yersin Light) */
/* ====================================================== */

/* 1. Xử lý Avatar (Giáo viên & Học sinh) */
body.theme-yersin-light .avatar-container,
body.theme-yersin-light #profileAvatarContainer {
    box-shadow: none !important; /* Tắt bóng phát sáng bao quanh */
    background: transparent !important;
}

body.theme-yersin-light .avatar-img {
    border: 3px solid #e0e0e0 !important; /* Đổi viền neon thành viền xám nhẹ */
    box-shadow: none !important; /* Tắt bóng đổ của ảnh */
}

/* Ẩn hiệu ứng Galaxy xoay xoay (nếu còn) */
body.theme-yersin-light .galaxy-system {
    display: none !important;
}

/* 2. Xử lý Thanh Chọn Tuần (Trên Header) */
body.theme-yersin-light #headerWeekNav {
    background-color: #ffffff !important; /* Nền trắng sạch */
    border: 1px solid #bdbdbd !important; /* Viền xám mảnh (thay vì neon) */
    box-shadow: none !important; /* Tắt bóng phát sáng */
    color: #424242 !important;
}

/* Chữ "TUẦN ..." */
body.theme-yersin-light #headerWeekTitle {
    color: #e65100 !important; /* Màu Cam Đất đậm đà */
    text-shadow: none !important; /* Tắt chữ phát sáng */
    font-weight: 800 !important;
}

/* Các nút mũi tên (< >) */
body.theme-yersin-light .week-header-btn {
    color: #616161 !important; /* Mũi tên màu xám */
    background: transparent !important;
    box-shadow: none !important;
    border: 1px solid transparent !important;
}

body.theme-yersin-light .week-header-btn:hover {
    background-color: #f5f5f5 !important; /* Hover hiện nền xám nhẹ */
    color: #000 !important;
}

/* Ô ngày tháng bên trong */
body.theme-yersin-light .week-header-input {
    color: #424242 !important; /* Chữ xám đậm */
    opacity: 1 !important;
    text-shadow: none !important;
    font-weight: 600 !important;
}
/* ====================================================== */
/* NÂNG CẤP: BIẾN TAB THÀNH NÚT BẤM (BUTTON STYLE) */
/* (Áp dụng cho cả giao diện Tối & Sáng) */
/* ====================================================== */

/* 1. Cấu hình chung cho 3 nút (Giống class .btn) */
#btnTkbTeacher, #btnTkbStudent, #btnTkbGrad {
    border-radius: 10px !important;  /* Bo góc tròn như nút chính */
    padding: 10px 20px !important;   /* Nút dày dặn hơn */
    font-weight: 700 !important;
    text-transform: uppercase;
    border: none !important;         /* Bỏ viền mảnh */
    color: white !important;         /* Chữ trắng nổi bật */
    margin-right: 8px !important;    /* Cách nhau ra một chút */
    box-shadow: 0 4px 6px rgba(0,0,0,0.2) !important; /* Đổ bóng nhẹ */
    transition: all 0.2s ease !important;
    opacity: 0.7; /* Mờ nhẹ khi chưa chọn */
    filter: grayscale(30%); /* Hơi xám khi chưa chọn */
}

/* Hiệu ứng khi di chuột */
#btnTkbTeacher:hover, #btnTkbStudent:hover, #btnTkbGrad:hover {
    transform: translateY(-2px);
    opacity: 1;
    filter: grayscale(0%);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
}

/* Khi đang chọn (Active) -> Sáng rõ hoàn toàn */
#btnTkbTeacher.active, #btnTkbStudent.active, #btnTkbGrad.active {
    opacity: 1;
    filter: grayscale(0%);
    transform: scale(1.05); /* Phóng to nhẹ */
    box-shadow: 0 0 15px currentColor !important; /* Phát sáng theo màu nút */
}

/* --- 2. MÀU SẮC RIÊNG TỪNG NÚT (GRADIENT) --- */

/* Nút Giáo Viên: Xanh Dương (Tri thức) */
#btnTkbTeacher {
    background: linear-gradient(135deg, #039be5 0%, #01579b 100%) !important;
    /* Màu để đổ bóng phát sáng (currentColor) */
    color: #039be5 !important; 
    /* Fix lại màu chữ trắng đè lên background */
    -webkit-text-fill-color: white !important; 
}

/* Nút Lớp Học: Xanh Lá (Tươi mới) */
#btnTkbStudent {
    background: linear-gradient(135deg, #43a047 0%, #1b5e20 100%) !important;
    color: #43a047 !important;
    -webkit-text-fill-color: white !important;
}

/* Nút Ôn Tốt Nghiệp: Đỏ Cam (Quan trọng) */
#btnTkbGrad {
    background: linear-gradient(135deg, #ff5722 0%, #bf360c 100%) !important;
    color: #ff5722 !important;
    -webkit-text-fill-color: white !important;
}

/* --- 3. TINH CHỈNH RIÊNG CHO GIAO DIỆN YERSIN LIGHT (PHẲNG) --- */
/* (Để bóng đổ không bị quá lố trong nền sáng) */
body.theme-yersin-light #btnTkbTeacher.active, 
body.theme-yersin-light #btnTkbStudent.active, 
body.theme-yersin-light #btnTkbGrad.active {
    box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important; /* Bóng đen mờ thay vì bóng màu */
    transform: translateY(-2px);
}

/* ====================================================== */
/* TÙY CHỈNH RIÊNG CHO GIAO DIỆN YERSIN LIGHT (PHẲNG) */
/* (Tắt Neon, dùng màu nền đặc cho dễ nhìn) */
/* ====================================================== */

body.theme-yersin-light .sub-tab-btn {
    border: 1px solid #e0e0e0 !important;
    color: #546e7a !important; /* Màu chữ xám khi chưa chọn */
    background: #ffffff !important;
    font-weight: 600 !important;
    box-shadow: none !important;
    text-shadow: none !important;
}

/* Active: Giáo Viên -> Nền Xanh Đậm */
body.theme-yersin-light #btnTkbTeacher.active {
    background-color: #0288d1 !important; 
    color: #ffffff !important; /* Chữ trắng */
    border-color: #0288d1 !important;
}

/* Active: Lớp Học -> Nền Xanh Lá Đậm */
body.theme-yersin-light #btnTkbStudent.active {
    background-color: #2e7d32 !important;
    color: #ffffff !important;
    border-color: #2e7d32 !important;
}

/* Active: Ôn Tốt Nghiệp -> Nền Cam Đậm */
body.theme-yersin-light #btnTkbGrad.active {
    background-color: #d84315 !important;
    color: #ffffff !important;
    border-color: #d84315 !important;
}
/* ====================================================== */
/* NÂNG CẤP: NÚT CHỌN LỚP (DROPDOWN) SIÊU ĐẸP */
/* ====================================================== */

/* 1. Cấu hình chung cho nút Select */
#classSelect {
    /* Xóa giao diện mặc định xấu xí của trình duyệt */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    
    /* Kích thước và font chữ */
    padding: 10px 45px 10px 20px; /* Chừa chỗ bên phải cho mũi tên */
    font-family: 'Quicksand', sans-serif;
    font-weight: 800;
    font-size: 16px;
    border-radius: 12px; /* Bo góc mềm mại */
    cursor: pointer;
    outline: none;
    transition: all 0.3s ease;
    
    /* Mũi tên tùy chỉnh (Dùng ảnh SVG mã hóa để không cần file ngoài) */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300e5ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
}

/* 2. Style cho Giao diện Vũ trụ (Mặc định) */
#classSelect {
    background-color: rgba(10, 25, 60, 0.8); /* Nền tối trong suốt */
    border: 2px solid #00e5ff; /* Viền neon xanh */
    color: #00e5ff; /* Chữ neon */
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
}

/* Hiệu ứng khi di chuột vào */
#classSelect:hover {
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
    background-color: rgba(0, 229, 255, 0.1);
}

/* Hiệu ứng khi bấm vào (Focus) */
#classSelect:focus {
    border-color: #ff4081; /* Đổi màu viền sang hồng */
    color: #ff4081;
    /* Đổi màu mũi tên sang hồng (SVG code khác) */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ff4081%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
}

/* Style cho các dòng tùy chọn bên trong (Dropdown list) */
#classSelect option {
    background-color: #0a0a2a;
    color: #fff;
    padding: 10px;
}

/* ====================================================== */
/* 3. Style cho Giao diện Yersin Light (Hiện đại, Phẳng) */
/* ====================================================== */
body.theme-yersin-light #classSelect {
    background-color: #ffffff !important;
    border: 2px solid #cfd8dc !important; /* Viền xám nhạt */
    color: #37474f !important; /* Chữ xám đậm */
    box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
    
    /* Mũi tên màu xám đậm cho nền sáng */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23455a64%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") !important;
}

body.theme-yersin-light #classSelect:hover {
    border-color: #0288d1 !important; /* Hover ra màu xanh */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1) !important;
}

body.theme-yersin-light #classSelect:focus {
    border-color: #d84315 !important; /* Focus ra màu cam */
    
    /* Mũi tên cam khi focus */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d84315%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") !important;
}

body.theme-yersin-light #classSelect option {
    background-color: #ffffff;
    color: #333;
}
/* ====================================================== */
/* ĐỒNG BỘ: NÚT CHỌN LỚP (DROPDOWN) CHO CẢ 2 GIAO DIỆN */
/* ====================================================== */

/* 1. CẤU HÌNH CHUNG (Xóa giao diện mặc định) */
#classSelect {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    
    height: 45px; /* Chiều cao bằng với các nút bên cạnh */
    padding: 0 40px 0 20px; /* Chừa chỗ cho mũi tên bên phải */
    
    font-family: 'Quicksand', sans-serif;
    font-weight: 700;
    font-size: 15px;
    border-radius: 10px; /* Bo góc khớp với nút Button */
    cursor: pointer;
    outline: none;
    transition: all 0.3s ease;
    
    /* Căn chỉnh mũi tên */
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
}

/* 2. GIAO DIỆN VŨ TRỤ (MẶC ĐỊNH) */
#classSelect {
    background-color: rgba(10, 25, 60, 0.6); /* Nền tối trong suốt */
    border: 2px solid #00bcd4; /* Viền xanh Cyan */
    color: #00bcd4; /* Chữ xanh Cyan */
    
    /* Mũi tên màu Xanh Cyan (SVG) */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300bcd4%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    
    box-shadow: 0 0 10px rgba(0, 188, 212, 0.2);
}

#classSelect:hover {
    box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);
    background-color: rgba(0, 188, 212, 0.1);
}

/* Danh sách sổ xuống (Nền tối) */
#classSelect option {
    background-color: #0a0a2a;
    color: #fff;
    padding: 10px;
}

/* 3. GIAO DIỆN YERSIN LIGHT (PHẲNG & SẠCH) */
body.theme-yersin-light #classSelect {
    background-color: #ffffff !important;
    border: 2px solid #e0e0e0 !important; /* Viền xám nhẹ */
    color: #546e7a !important; /* Chữ xám xanh chuyên nghiệp */
    box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
    text-shadow: none !important;
    
    /* Mũi tên màu Xám (SVG) */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2378909c%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") !important;
}

/* Khi di chuột hoặc bấm vào trong chế độ Sáng (Hiện viền Cam) */
body.theme-yersin-light #classSelect:hover,
body.theme-yersin-light #classSelect:focus {
    border-color: #ff7043 !important; /* Màu cam giống nút Ôn Tập */
    color: #d84315 !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1) !important;
    
    /* Đổi mũi tên sang màu Cam */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ff7043%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") !important;
}

/* Danh sách sổ xuống (Nền trắng) */
body.theme-yersin-light #classSelect option {
    background-color: #ffffff;
    color: #333;
}
/* ====================================================== */
/* ĐỒNG BỘ GIAO DIỆN YERSIN (LIGHT THEME) */
/* Áp dụng cho Dropdown Lớp & Menu Chuột Phải */
/* ====================================================== */

/* 1. MENU CHỌN LỚP (Dropdown) */
body.theme-yersin-light .dropdown-options {
    background: #ffffff !important; /* Nền trắng sạch */
    border: 1px solid #e0e0e0 !important; /* Viền xám mờ */
    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important; /* Bóng đổ mềm mại */
    border-radius: 12px !important;
    padding: 5px !important;
}

/* Các dòng trong menu lớp */
body.theme-yersin-light .class-option {
    color: #455a64 !important; /* Chữ màu xám xanh */
    border-bottom: 1px solid #f5f5f5 !important;
    border-radius: 8px !important;
    font-weight: 600 !important;
}

/* Khi di chuột vào dòng lớp */
body.theme-yersin-light .class-option:hover {
    background: #fff3e0 !important; /* Nền cam rất nhạt */
    color: #d84315 !important; /* Chữ cam đậm */
    padding-left: 15px !important; /* Hiệu ứng trượt nhẹ */
}

/* Dòng tiêu đề khối (K10, K11...) */
body.theme-yersin-light .opt-group-label {
    background: #fafafa !important;
    color: #ef6c00 !important; /* Cam đậm */
    border-bottom: 1px solid #eee !important;
}

/* Ô nhập thêm lớp mới */
body.theme-yersin-light .add-class-area {
    background: #fafafa !important;
    border-top: 1px solid #e0e0e0 !important;
}
body.theme-yersin-light .add-class-input {
    background: #ffffff !important;
    border: 1px solid #bdbdbd !important;
    color: #333 !important;
}

/* 2. MENU CHUỘT PHẢI (Context Menu) */
body.theme-yersin-light #contextMenu {
    background: #ffffff !important;
    border: 1px solid #cfd8dc !important;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15) !important;
    border-radius: 12px !important;
}

/* Các dòng trong menu chuột phải */
body.theme-yersin-light .ctx-item {
    color: #37474f !important;
    border-bottom: 1px solid #f1f1f1 !important;
    font-weight: 600 !important;
}

/* Khi di chuột vào menu chuột phải */
body.theme-yersin-light .ctx-item:hover {
    background: #e0f7fa !important; /* Xanh ngọc nhạt */
    color: #006064 !important; /* Chữ xanh đậm */
}
/* Riêng nút Xóa (Màu đỏ) */
body.theme-yersin-light .ctx-item:nth-last-child(2):hover {
    background: #ffebee !important; /* Đỏ nhạt */
    color: #c62828 !important;
}

/* 3. THANH CUỘN (Scrollbar) TRONG MENU */
body.theme-yersin-light .dropdown-options::-webkit-scrollbar-thumb {
    background: #ffcc80 !important; /* Thanh cuộn màu vàng cam */
    border-radius: 4px;
}
body.theme-yersin-light .dropdown-options::-webkit-scrollbar-track {
    background: #f5f5f5 !important;
}

/* 4. CẬP NHẬT GIAO DIỆN NÚT CHỌN LỚP (HEADER) */
body.theme-yersin-light .dropdown-selected {
    background: #ffffff !important;
    border: 1px solid #bdbdbd !important;
    color: #424242 !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05) !important;
}

body.theme-yersin-light .dropdown-selected:hover {
    border-color: #ff7043 !important;
    color: #d84315 !important;
    background: #fff8e1 !important;
}  
/* ====================================================== */
/* NÂNG CẤP KHUNG QUÉT CHỌN (SELECTION BOX DESKTOP STYLE) */
/* ====================================================== */

/* --- CSS KHUNG QUÉT CHUẨN DESKTOP --- */
#selectionBox {
    position: fixed;
    background: rgba(0, 120, 215, 0.25); /* Màu xanh Windows trong suốt */
    border: 1px solid rgba(0, 120, 215, 0.7); /* Viền xanh đậm */
    z-index: 99999;       /* Luôn nổi trên cùng */
    display: none;        /* Mặc định ẩn */
    pointer-events: none; /* CỰC KỲ QUAN TRỌNG: Để chuột click xuyên qua được khung này */
    border-radius: 2px;
}


/* Ngăn bôi đen văn bản khi đang quét */
body.noselect {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* --- ĐỒNG BỘ VỚI GIAO DIỆN YERSIN (LIGHT) --- */
/* Chuyển sang tông màu Cam/Vàng ấm áp */
/* Tùy chỉnh cho giao diện Sáng (Yersin Light) */
body.theme-yersin-light #selectionBox {
    background: rgba(255, 152, 0, 0.15); /* Màu cam nhạt */
    border: 1px solid #ef6c00;
}

/* Ngăn bôi đen văn bản khi đang quét */
.disable-select {
    user-select: none !important;
    -webkit-user-select: none !important;
}
/* Hiệu ứng khi thẻ được chọn trong giao diện Yersin */
body.theme-yersin-light .student-card.selected-active {
    background: rgba(255, 243, 224, 0.9) !important;
    border-color: #ef6c00 !important;
    box-shadow: 0 4px 15px rgba(239, 108, 0, 0.3) !important;
}
/* --- CÁC NÚT BẤM NHANH (PHIÊN BẢN MINI) --- */

/* 1. Lưới nút bấm: Chỉnh minmax xuống 100px để xếp được nhiều nút hơn trên 1 hàng */
.holo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Cũ là 140px */
    gap: 10px; /* Giảm khoảng cách giữa các nút */
    margin-bottom: 25px;
}

/* 2. Thẻ nút bấm: Giảm chiều cao và padding */
.holo-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px; /* Bo góc nhỏ lại một chút */
    padding: 10px 5px;   /* Giảm vùng đệm bên trong */
    text-align: center;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    height: 85px; /* Cũ là 110px -> Giảm xuống 85px */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Hiệu ứng Hover giữ nguyên */
.holo-card:hover {
    transform: translateY(-3px); /* Nổi lên nhẹ hơn */
    background: rgba(255, 255, 255, 0.08);
}
.holo-card:active { transform: scale(0.95); }

/* Màu sắc từng loại nút (Giữ nguyên) */
.holo-card.good:hover {
    border-color: var(--neon-green);
    box-shadow: 0 5px 15px rgba(74, 222, 128, 0.15);
}
.holo-card.bad:hover {
    border-color: var(--neon-red);
    box-shadow: 0 5px 15px rgba(244, 63, 94, 0.15);
}
.holo-card.acad:hover {
    border-color: var(--neon-gold);
    box-shadow: 0 5px 15px rgba(251, 191, 36, 0.15);
}

/* 3. Icon bên trong: Thu nhỏ kích thước */
.hc-icon { 
    font-size: 24px; /* Cũ là 32px -> Giảm còn 24px */
    margin-bottom: 5px; 
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); 
    transition: 0.3s; 
}
.holo-card:hover .hc-icon { transform: scale(1.1); }

/* 4. Chữ tiêu đề: Thu nhỏ font */
.hc-label {
    font-size: 11px; /* Cũ là 13px */
    font-weight: 600; 
    line-height: 1.2; 
    color: var(--text);
    padding: 0 5px; /* Tránh chữ dính sát viền */
}
.hc-label small {
    display: block; 
    font-size: 10px; /* Cũ là 11px */
    font-weight: 800; 
    margin-top: 3px; 
    opacity: 0.8;
}

/* Tùy chỉnh cho giao diện Sáng (Yersin Light) để đồng bộ */
body.theme-yersin-light .holo-card {
    background: #ffffff !important;
    border: 1px solid #e2e8f0 !important;
    color: #333 !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
}
/* --- BỐ CỤC 2 CỘT CHO NÚT BẤM --- */
.action-columns {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Chia đều 50% - 50% */
    gap: 20px; /* Khoảng cách giữa 2 cột */
    margin-bottom: 10px;
}

/* Khi màn hình nhỏ (điện thoại) thì tự động xếp chồng lên nhau */
@media (max-width: 800px) {
    .action-columns {
        grid-template-columns: 1fr;
    }
}

/* Tinh chỉnh lại tiêu đề mục cho gọn */
.section-label {
    font-size: 11px; /* Nhỏ lại chút cho cân đối */
    margin-bottom: 10px;
}
/* --- CSS CHO TAB SỔ ĐIỂM (MỚI) --- */
.acad-tab-nav {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
}

.acad-tab-btn {
    flex: 1;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s;
    opacity: 0.6;
    border: 1px solid transparent;
    color: var(--text);
    text-transform: uppercase;
    font-size: 13px;
}

.acad-tab-btn:hover {
    background: rgba(255,255,255,0.05);
    opacity: 1;
}

/* Tab Kho Điểm (Vàng) */
.acad-tab-btn.tab-bank.active {
    background: rgba(251, 191, 36, 0.15);
    border-color: var(--neon-gold);
    color: var(--neon-gold);
    opacity: 1;
    box-shadow: 0 0 15px rgba(251, 191, 36, 0.1);
}

/* Tab Sổ Điểm (Xanh) */
.acad-tab-btn.tab-grade.active {
    background: rgba(0, 234, 255, 0.15);
    border-color: var(--neon-cyan);
    color: var(--neon-cyan);
    opacity: 1;
    box-shadow: 0 0 15px rgba(0, 234, 255, 0.1);
}
/* Style cho nội dung hướng dẫn */
.guide-section { margin-bottom: 20px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 15px; }
.guide-section:last-child { border: none; }
.guide-title { color: var(--neon-gold); font-weight: bold; font-size: 16px; margin-bottom: 8px; display:flex; align-items:center; gap:8px; text-transform: uppercase;}
.guide-list { padding-left: 20px; margin: 0; }
.guide-list li { margin-bottom: 5px; color: var(--text); }
.guide-highlight { color: var(--neon-green); font-weight: bold; background: rgba(74, 222, 128, 0.1); padding: 2px 5px; border-radius: 4px; }
.key-shortcut { border: 1px solid rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 4px; font-family: monospace; background: rgba(0,0,0,0.3); font-size: 11px; }

/* Tương thích giao diện Sáng */
body.theme-yersin-light .guide-title { color: #d84315 !important; }
body.theme-yersin-light .guide-list li { color: #333 !important; }
body.theme-yersin-light .guide-highlight { color: #2e7d32; background: #e8f5e9; }
body.theme-yersin-light .key-shortcut { border-color: #ccc; background: #f5f5f5; color: #333; }
/* --- GIAO DIỆN QUẢN LÝ LỚP DẠNG LƯỚI (MỚI) --- */

/* Nút mở bảng lớp trên Header */
.class-trigger-btn {
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--neon-cyan);
    color: var(--neon-cyan);
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.3s;
    min-width: 150px;
    justify-content: space-between;
}
.class-trigger-btn:hover {
    background: rgba(0, 234, 255, 0.1);
    box-shadow: 0 0 15px rgba(0, 234, 255, 0.2);
}
body.theme-yersin-light .class-trigger-btn {
    background: #ffffff;
    border: 1px solid #cfd8dc;
    color: #455a64;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
body.theme-yersin-light .class-trigger-btn:hover {
    border-color: #ff7043;
    color: #d84315;
}

/* Modal Quản Lý Lớp */
.class-manager-body {
    padding: 20px;
    overflow-y: auto;
    max-height: 70vh;
}

.block-section {
    margin-bottom: 25px;
}
.block-title {
    font-size: 20px !important; /* Tăng lên 20px cho to rõ */
    margin-bottom: 15px;
    border-bottom: 2px solid rgba(255,255,255,0.2); /* Kẻ gạch chân dày hơn */
}
body.theme-yersin-light .block-title { color: #e65100; border-bottom-color: #e0e0e0; }

.class-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
}

.class-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    position: relative;
    transition: 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80px;
}
.class-card:hover {
    transform: translateY(-3px);
    border-color: var(--neon-cyan);
    background: rgba(0, 234, 255, 0.1);
}
.class-card.active {
    border-color: var(--neon-green);
    background: rgba(74, 222, 128, 0.1);
    box-shadow: 0 0 15px rgba(74, 222, 128, 0.2);
}

/* Style cho theme sáng */
body.theme-yersin-light .class-card {
    background: #ffffff;
    border: 1px solid #e0e0e0;
    color: #333;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
body.theme-yersin-light .class-card:hover {
    border-color: #ff7043;
    background: #fff3e0;
}
body.theme-yersin-light .class-card.active {
    border-color: #2e7d32;
    background: #e8f5e9;
    color: #1b5e20;
}

.class-name { 
    font-size: 22px !important; /* Tên lớp siêu to */
    font-weight: 900 !important; 
}
.class-count { 
    font-size: 16px !important; /* Tăng từ 11px lên 16px */
    opacity: 1 !important;      /* Không làm mờ nữa */
    font-weight: bold;
    margin-top: 8px;
    color: var(--neon-green);   /* Màu xanh sáng cho dễ nhìn số */
    background: rgba(0,0,0,0.3); /* Nền đen mờ nhẹ để nổi bật số */
    padding: 4px 10px;
    border-radius: 20px;
}
/* Chỉnh lại màu cho giao diện Sáng (Yersin Light) */
body.theme-yersin-light .class-count {
    color: #d84315; /* Màu cam đậm */
    background: #fff3e0;
}
/* Nút sửa/xóa trên thẻ lớp */
.class-actions {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: 0.2s;
}
.class-card:hover .class-actions { opacity: 1; }

.action-mini-btn {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    cursor: pointer;
    background: rgba(0,0,0,0.5);
    color: white;
}
.action-mini-btn:hover { transform: scale(1.2); }
.btn-edit:hover { background: var(--neon-blue); }
.btn-del:hover { background: var(--neon-red); }
/* --- FIX LỖI: ĐƯA CỬA SỔ THÊM LỚP LÊN TRÊN CÙNG --- */
#addClassModal {
    z-index: 10000 !important; /* Cao hơn mọi cửa sổ khác */
}
/* --- FIX LỖI: CHUYỂN CỬA SỔ SANG GIAO DIỆN PHẲNG (YERSIN LIGHT) --- */

/* 1. Xử lý khung cửa sổ (Bỏ viền neon, thêm nền trắng) */
body.theme-yersin-light .confirm-box {
    background: #ffffff !important;
    border: 1px solid #cfd8dc !important; /* Viền xám nhạt */
    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important; /* Bóng đổ mềm */
    color: #37474f !important;
}

/* 2. Xử lý thanh tiêu đề cửa sổ */
body.theme-yersin-light .confirm-header {
    background: #f5f5f5 !important; /* Nền xám nhẹ */
    border-bottom: 1px solid #e0e0e0 !important;
    color: #d84315 !important; /* Chữ màu Cam Đậm */
    text-shadow: none !important; /* Bỏ phát sáng */
}

/* 3. Xử lý tiêu đề bên trong (những chữ đang bị dính màu Neon) */
body.theme-yersin-light .confirm-header span {
    color: #d84315 !important; /* Ép sang màu cam */
    text-shadow: none !important;
}
/* --- FIX LỖI: LỊCH SỬ BỊ KHUẤT (THU GỌN GIAO DIỆN) --- */

/* 1. Thu nhỏ vòng tròn điểm số */
.score-circle-container {
    width: 120px !important;  /* Giảm từ 180px xuống 120px cho gọn */
    height: 120px !important;
    margin-bottom: 10px !important;
}

/* 2. Thu nhỏ cỡ chữ điểm số bên trong */
.score-value {
    font-size: 32px !important; /* Giảm từ 48px xuống 32px */
}

/* 3. Giảm khoảng cách lề (Padding) cột bên trái */
.pw-left {
    padding: 15px !important; /* Giảm từ 30px xuống 15px để tiết kiệm chỗ */
}

/* 4. Ép khung lịch sử luôn hiện thanh cuộn */
.timeline-container {
    flex: 1;             /* Tự động chiếm hết khoảng trống còn lại */
    overflow-y: auto;    /* Bật thanh cuộn dọc */
    min-height: 150px;   /* Đảm bảo luôn có độ cao tối thiểu */
    width: 100%;
    padding-right: 5px;
    margin-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.1); /* Kẻ 1 đường phân cách mờ */
}

/* Tùy chỉnh thanh cuộn cho lịch sử (Chrome/Cốc Cốc) */
.timeline-container::-webkit-scrollbar {
    width: 5px;
}
.timeline-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
}
/* --- REDESIGN GIAO DIỆN CỘT TRÁI (ĐẸP & GỌN) --- */

/* 1. Tối ưu hóa không gian cột trái */
.pw-left {
    /* Giảm padding để tiết kiệm diện tích */
    padding: 15px 10px !important; 
    /* Sắp xếp các phần tử sát nhau hơn */
    gap: 10px !important;
    /* Đẩy mọi thứ lên trên cùng thay vì căn giữa dọc */
    justify-content: flex-start !important;
}

/* 2. Thiết kế lại Vòng tròn điểm (Vừa vặn & Sang trọng) */
.score-circle-container {
    /* Kích thước vàng: Đủ lớn để đẹp, đủ nhỏ để gọn */
    width: 145px !important; 
    height: 145px !important;
    margin: 0 auto 5px auto !important; /* Canh giữa, giảm lề dưới */
    
    /* Thêm hiệu ứng chiều sâu (bóng đổ bên trong) */
    box-shadow: inset 0 0 20px rgba(0,0,0,0.4);
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0, 234, 255, 0.05) 0%, transparent 70%); /* Nền phát sáng nhẹ */
}

/* SVG vòng tròn tiến trình */
.progress-ring__circle {
    /* Làm nét vòng tròn hơn */
    stroke-width: 6 !important; 
    filter: drop-shadow(0 0 5px var(--neon-cyan)); /* Phát sáng vừa phải, không bị lóa */
}

/* Số điểm bên trong */
.score-value {
    /* Font chữ to, đậm, sát nhau nhìn mạnh mẽ hơn */
    font-size: 48px !important;
    font-weight: 800 !important;
    line-height: 0.9 !important; /* Ép dòng lại cho gọn */
    margin-bottom: 2px !important; /* Kéo chữ "Điểm" sát lại */
    text-shadow: 0 0 15px var(--neon-cyan); /* Hiệu ứng neon */
}

/* Chữ "Điểm" nhỏ bên dưới */
.score-label {
    font-size: 12px !important;
    font-weight: 600 !important;
    text-transform: uppercase;
    letter-spacing: 2px; /* Giãn chữ ra cho sang */
    opacity: 0.7 !important;
}

/* 3. Khu vực Lịch sử (Tự động chiếm chỗ còn lại) */
.timeline-container {
    flex: 1; /* Tự động giãn ra để lấp đầy khoảng trống bên dưới */
    width: 100%;
    min-height: 120px; /* Đảm bảo luôn có chiều cao tối thiểu để hiển thị */
    
    overflow-y: auto; /* Bật thanh cuộn nếu nội dung dài */
    padding-right: 5px; /* Chừa chỗ cho thanh cuộn */
    
    /* Kẻ vạch ngăn cách mờ với phần trên */
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 10px;
    margin-top: 5px;
}

/* 4. Khu vực nút Ảnh/Hoàn tác (Đẩy xuống đáy) */
.pw-left > div:last-child {
    margin-top: auto !important; /* Kỹ thuật đẩy phần tử xuống cuối cùng */
    padding-top: 10px;
    width: 90% !important; /* Thu gọn chiều ngang nút một chút cho đẹp */
}

/* --- Tùy chỉnh thanh cuộn cho đẹp --- */
.timeline-container::-webkit-scrollbar { width: 4px; }
.timeline-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
.timeline-container::-webkit-scrollbar-thumb { background: var(--neon-cyan); border-radius: 10px; }
/* --- GIAO DIỆN VÒNG TRÒN ĐIỂM "ENERGY CORE" --- */

/* --- GIAO DIỆN VÒNG TRÒN ĐIỂM CHUẨN (FIX MÉO) --- */

/* 1. Khung chứa vòng tròn */
.score-circle-container {
    /* Kích thước cố định hình vuông */
    width: 150px !important;
    height: 150px !important;
    
    /* CHỐNG MÉO: Quan trọng nhất */
    min-width: 150px !important;
    min-height: 150px !important;
    flex-shrink: 0 !important; /* Cấm không cho Flexbox ép nhỏ lại */
    
    /* Căn chỉnh */
    margin: 0 auto 15px auto !important;
    position: relative !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    
    /* Hình dáng và Nền */
    border-radius: 50% !important;
    background: rgba(0, 0, 0, 0.2) !important; /* Nền tối mờ */
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5); /* Bóng đổ vào trong tạo độ sâu */
    border: 1px solid rgba(255,255,255,0.05); /* Viền mờ siêu mảnh */
}

/* 2. Vòng tròn màu (Tiến trình) */
.score-circle {
    position: absolute !important;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50% !important;
    
    /* Tạo vòng tròn màu */
    background: conic-gradient(
        var(--score-color) var(--score-pct), 
        rgba(255, 255, 255, 0.05) 0deg
    ) !important;
    
    /* Cắt rỗng ruột để tạo thành cái nhẫn */
    mask: radial-gradient(closest-side, transparent 84%, black 85%) !important;
    -webkit-mask: radial-gradient(closest-side, transparent 84%, black 85%) !important;
    
    /* Bóng phát sáng cho vòng màu */
    filter: drop-shadow(0 0 5px var(--score-color));
    transition: all 1s ease-out;
}

/* 3. Số điểm bên trong */
.score-inner {
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.score-value {
    font-family: 'Quicksand', sans-serif !important;
    font-size: 42px !important; /* Cỡ chữ vừa vặn */
    font-weight: 800 !important;
    line-height: 1 !important;
    color: #ffffff !important;
    
    /* Đổ bóng chữ neon */
    text-shadow: 0 0 15px var(--score-color); 
    margin-bottom: 2px !important;
}

.score-label {
    font-size: 10px !important;
    font-weight: 700 !important;
    text-transform: uppercase;
    letter-spacing: 2px !important;
    color: rgba(255,255,255,0.5) !important;
}

/* 4. Fix riêng cho giao diện Sáng (Yersin Light) để giống hình mẫu bạn gửi */
body.theme-yersin-light .score-circle-container {
    background: #ffffff !important; /* Nền trắng */
    border: 4px solid #f0f0f0 !important; /* Viền xám nhạt bao ngoài */
    box-shadow: none !important;
}

body.theme-yersin-light .score-circle {
    /* Ở nền sáng, vòng tròn sẽ rực rỡ hơn */
    filter: none !important; 
    mask: radial-gradient(closest-side, transparent 75%, black 76%) !important; /* Vòng dày hơn chút */
    -webkit-mask: radial-gradient(closest-side, transparent 75%, black 76%) !important;
}

body.theme-yersin-light .score-value {
    color: var(--score-color) !important; /* Chữ lấy màu theo điểm (Vàng/Xanh/Đỏ) */
    text-shadow: none !important; /* Tắt phát sáng để nét chữ sắc sảo */
}

body.theme-yersin-light .score-label {
    color: #90a4ae !important; /* Chữ label màu xám xanh */
}
/* --- CẬP NHẬT: THU GỌN THANH TIÊU ĐỀ POPUP (MODAL) --- */

/* 1. Ép thanh tiêu đề (Header) mỏng lại */
.pw-header {
    padding: 5px 15px !important; /* Giảm khoảng cách thừa (Cũ là 20px) */
    min-height: 50px !important;  /* Chiều cao tối thiểu chỉ còn 50px */
    gap: 10px !important;         /* Khoảng cách giữa các phần tử gần hơn */
    
    /* Làm đường gạch ngang dưới chân mỏng và mờ đi */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important; 
}

/* 2. Thu nhỏ Avatar trong thanh này */
.pw-header .avatar-container {
    width: 40px !important;  /* Cũ là 60px -> Giảm còn 40px */
    height: 40px !important;
    margin: 0 !important;    /* Bỏ căn lề thừa */
    border-width: 1px !important; /* Viền siêu mỏng */
}

/* 3. Thu nhỏ Tên Học Sinh và Lớp */
.pw-header #pName {
    font-size: 15px !important; /* Cũ là 18px */
    margin-bottom: 0 !important;
    line-height: 1.2 !important;
}
.pw-header #pClass {
    font-size: 11px !important; /* Cũ là 12px */
    margin-top: 0 !important;
}

/* 4. Thu nhỏ các nút bấm (Sửa, Xóa, Đóng) ở góc phải */
.pw-header .icon-btn, 
.pw-header .pw-close {
    font-size: 16px !important; /* Nút nhỏ lại cho cân đối */
    opacity: 0.7;
}
/* --- CẬP NHẬT CÁC NÚT ĐIỂM NHỎ GỌN (SIÊU NHỎ) --- */

/* 1. Chỉnh lưới hiển thị để xếp nút dày hơn */
.holo-grid {
    /* Giảm chiều rộng tối thiểu cột xuống 55px để xếp được nhiều nút hơn */
    grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)) !important; 
    gap: 4px !important; /* Khoảng cách giữa các nút sát lại */
}

/* 2. Thu nhỏ kích thước thẻ nút */
.holo-card {
    height: 42px !important; /* Chiều cao giảm còn 42px (rất gọn) */
    padding: 2px !important;
    border-radius: 5px !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
}

/* 3. Thu nhỏ Icon */
.hc-icon {
    font-size: 14px !important; /* Icon bé lại */
    margin-bottom: 0px !important;
    margin-top: 1px !important;
}

/* 4. Thu nhỏ chữ (Label) */
.hc-label {
    font-size: 8px !important; /* Cỡ chữ rất nhỏ (8px) */
    line-height: 1.1 !important;
    padding: 0 1px !important;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Tối đa 2 dòng */
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Hiệu ứng khi di chuột (Hover) để dễ nhận biết */
.holo-card:hover {
    transform: translateY(-1px);
    border-color: var(--neon-cyan) !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
/* Class chung cho ô xếp loại */
.badge-rank {
    padding: 6px 12px;
    border-radius: 50px; /* Bo tròn tạo hình viên thuốc */
    font-weight: 600;
    font-size: 0.85rem;
    color: white;
    text-transform: uppercase; /* Viết hoa toàn bộ */
    letter-spacing: 0.5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Đổ bóng nhẹ */
    display: inline-block;
    min-width: 80px;
    text-align: center;
}

/* Màu sắc theo từng loại */
.rank-tot {
    background-color: #00c853; /* Xanh lá đậm */
    border: 1px solid #00e676;
}

.rank-kha {
    background-color: #2979ff; /* Xanh dương sáng */
    border: 1px solid #448aff;
}

.rank-tb {
    background-color: #ff9100; /* Cam */
    border: 1px solid #ffab40;
}

.rank-yeu {
    background-color: #d50000; /* Đỏ */
    border: 1px solid #ff5252;
}
/* --- TÍNH NĂNG GHIM MENU (PIN SIDEBAR) --- */

/* 1. Khi kích hoạt ghim: Menu luôn hiện */
body.pinned-mode .sidebar {
    left: 0 !important; /* Ép menu luôn hiện */
    box-shadow: 5px 0 15px rgba(0,0,0,0.2) !important; /* Giảm bóng đổ cho nhẹ */
}

/* 2. Đẩy nội dung chính sang phải để không bị menu che */
body.pinned-mode .main-content {
    margin-left: 260px !important; /* Chừa khoảng trống bằng chiều rộng menu */
    width: calc(100vw - 260px) !important; /* Thu hẹp chiều rộng nội dung lại */
}

/* 3. Tắt hiệu ứng làm mờ nội dung khi di chuột vào menu (vì giờ menu luôn hiện) */
body.pinned-mode .sidebar:hover ~ .main-content {
    filter: none !important;
    pointer-events: auto !important;
}

/* 4. Hiệu ứng nút ghim khi đang bật */
body.pinned-mode #pinTrigger {
    color: var(--neon-green) !important; /* Đổi màu xanh */
    opacity: 1 !important;
    transform: rotate(45deg); /* Xoay nghiêng cái ghim */
    text-shadow: 0 0 10px var(--neon-green);
}
/* --- CHẾ ĐỘ THẺ HỌC SINH NHỎ GỌN (COMPACT CARD) --- */

/* 1. Điều chỉnh lưới để xếp nhiều cột hơn */
.list-container {
    /* Giảm kích thước tối thiểu từ ~250px xuống 160px để xếp được 5-6 thẻ/hàng */
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
    gap: 10px !important; /* Giảm khoảng cách giữa các thẻ cho khít hơn */
    padding: 10px !important;
}

/* 2. Thu nhỏ khung thẻ */
.student-card {
    padding: 10px !important; /* Giảm lề trong của thẻ */
    min-height: auto !important; /* Bỏ chiều cao tối thiểu cũ */
}

/* 3. Thu nhỏ Avatar (Ảnh đại diện) */
.student-avatar {
    width: 45px !important; /* Giảm kích thước ảnh */
    height: 45px !important;
    font-size: 1.2rem !important; /* Giảm chữ cái trong avatar */
    margin-bottom: 5px !important;
}

/* 4. Thu nhỏ Tên và Thông tin */
.student-info h3 {
    font-size: 0.95rem !important; /* Tên nhỏ lại */
    margin-bottom: 2px !important;
    white-space: nowrap; /* Tên dài quá thì cắt bớt ... */
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

.student-info p {
    font-size: 0.75rem !important; /* Chữ phụ (lớp, ngày sinh) nhỏ lại */
    margin-bottom: 2px !important;
    line-height: 1.2 !important;
}

/* 5. Thu nhỏ các nút bấm (Sửa/Xóa/...) */
.student-actions {
    margin-top: 5px !important;
    gap: 5px !important;
}

.student-actions button {
    padding: 4px 8px !important; /* Nút bé lại */
    font-size: 0.7rem !important;
}
/* --- GIAO DIỆN THẺ TKB MỚI (AVATAR + TEXT) --- */
.tkb-card {
    /* Cấu trúc Flex dọc để ảnh ở trên, chữ ở dưới (hoặc ngang tùy chỉnh) */
    display: flex !important;
    flex-direction: column !important;
    align-items: center;
    justify-content: center;
    gap: 10px;
    
    /* Màu nền kính mờ sang trọng */
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px; /* Bo góc tròn hơn */
    padding: 20px !important;
    min-height: 160px; /* Tăng chiều cao để chứa ảnh */
    
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(5px);
}

/* Hiệu ứng khi di chuột vào thẻ */
.tkb-card:hover {
    transform: translateY(-5px) scale(1.02); /* Nổi lên và phóng to nhẹ */
    background: rgba(30, 30, 60, 0.6);
    border-color: var(--neon-cyan);
    box-shadow: 0 10px 30px rgba(0, 234, 255, 0.2), inset 0 0 20px rgba(0, 234, 255, 0.05);
}

/* Ảnh đại diện trong thẻ */
.tkb-card-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255,255,255,0.1);
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    transition: 0.3s;
    background: #1a1a2e; /* Nền tối cho ảnh PNG trong suốt */
}

.tkb-card:hover .tkb-card-avatar {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 20px var(--neon-cyan);
    transform: rotate(5deg); /* Xoay nhẹ ảnh tạo động lực */
}

/* Thông tin chữ */
.tkb-card-info {
    text-align: center;
    z-index: 1;
}

.tkb-card-title {
    font-size: 18px;
    font-weight: 800;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 3px;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.tkb-card:hover .tkb-card-title {
    color: var(--neon-gold); /* Đổi màu vàng khi hover */
    text-shadow: 0 0 10px var(--neon-gold);
}

.tkb-card-sub {
    font-size: 11px;
    opacity: 0.6;
    font-style: italic;
    color: var(--neon-blue);
}

/* Điều chỉnh riêng cho giao diện Sáng (Yersin Light) */
body.theme-yersin-light .tkb-card {
    background: #ffffff !important;
    border: 1px solid #e0e0e0 !important;
    color: #333 !important;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
body.theme-yersin-light .tkb-card:hover {
    border-color: #ff7043 !important;
    box-shadow: 0 10px 20px rgba(255, 112, 67, 0.2) !important;
}
body.theme-yersin-light .tkb-card-title { color: #d84315 !important; text-shadow: none !important; }
body.theme-yersin-light .tkb-card-sub { color: #546e7a !important; }
/* --- NÂNG CẤP GIAO DIỆN THẺ GIÁO VIÊN --- */
.teacher-card {
    /* --- CẬP NHẬT: GIỐNG TKB-CARD --- */
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px; /* Bo góc lớn hơn giống thẻ lớp */
    padding: 20px !important;
    min-height: 160px; /* Chiều cao tối thiểu giống thẻ lớp */
    
    display: flex;
    flex-direction: column; /* Đổi sang xếp dọc */
    align-items: center;
    justify-content: center;
    gap: 10px;
    
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(5px);
}

/* Hiệu ứng Hover */
.teacher-card:hover {
    transform: translateY(-5px);
    border-color: var(--neon-blue);
    background: rgba(30, 41, 59, 0.9);
    box-shadow: 0 10px 25px rgba(0, 234, 255, 0.15);
}

/* Avatar Giáo viên (Nghiêm túc) */
.teacher-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #94a3b8; /* Viền xám bạc */
    background: #e2e8f0;
    flex-shrink: 0;
}

.teacher-card:hover .teacher-avatar {
    border-color: var(--neon-blue);
}

/* Thông tin chữ */
.teacher-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    text-align: center; /* Thêm dòng này để căn giữa chữ */
    width: 100%;        /* Thêm dòng này */
}

.teacher-name {
    font-size: 16px;
    font-weight: 800;
    color: #f8fafc;
    text-transform: uppercase;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.teacher-role, .teacher-subject {
    font-size: 11px;
    color: #cbd5e1;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 2px;
}

/* Nút chỉnh sửa nhỏ trên thẻ */
.teacher-edit-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: white;
    opacity: 0;
    transition: 0.2s;
    z-index: 5;
}
.teacher-card:hover .teacher-edit-btn { opacity: 1; }
.teacher-edit-btn:hover { background: var(--neon-gold); color: black; }

/* --- GIAO DIỆN HỌC SINH CHĂM NGOAN TRONG TKB --- */
.studious-mascot {
    position: absolute;
    right: 20px;
    bottom: 10px;
    width: 120px;
    height: auto;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
    animation: floatMascot 3s ease-in-out infinite;
    pointer-events: none;
    z-index: 10;
}

@keyframes floatMascot {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* Chỉnh lại Header TKB để chứa Mascot */
.cute-header-section {
    position: relative; /* Để Mascot định vị theo */
    overflow: visible !important; /* Để Mascot thò ra ngoài */
    min-height: 100px;
}

/* Tùy chỉnh cho giao diện Sáng (Yersin Light) */
body.theme-yersin-light .teacher-card {
    background: #ffffff !important;
    border: 1px solid #e2e8f0 !important;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
body.theme-yersin-light .teacher-name { color: #0f172a !important; }
body.theme-yersin-light .teacher-role, 
body.theme-yersin-light .teacher-subject { color: #64748b !important; }
body.theme-yersin-light .teacher-avatar { border-color: #cbd5e1 !important; }
/* Thêm vào phần style */
.tkb-card-body {
    font-size: 16px !important; /* Tăng cỡ chữ lên cho dễ đọc */
    font-weight: 500;
}
.tkb-card-header {
    font-size: 18px !important; /* Tăng cỡ tên lớp */
}
/* Ẩn dòng tiết thứ 9 và 10 nếu code HTML lỡ sinh ra */
tr:nth-child(n+10) { 
    display: none !important; 
}
/* --- CẬP NHẬT GIAO DIỆN TKB --- */
/* Tăng kích thước ô và chữ */
.tkb-cell {
    padding: 8px !important; /* Tăng khoảng cách lề */
    min-height: 80px; /* Đảm bảo ô đủ cao */
}

/* Định dạng tên môn học: To, Đậm, Màu rõ */
.subject-name {
    font-size: 36px !important; /* Cỡ chữ to hơn */
    font-weight: 700 !important; /* In đậm */
    color: #ffd700; /* Màu vàng sáng hoặc màu bạn thích */
    margin-bottom: 4px;
    display: block;
    text-transform: uppercase;
}

/* Định dạng tên giáo viên: Nhỏ hơn môn một chút nhưng vẫn rõ */
.teacher-name {
    font-size: 14px !important;
    color: #ffffff; /* Màu trắng */
    font-style: italic;
    background-color: rgba(255,255,255,0.1); /* Nền mờ nhẹ để dễ đọc */
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
}
/* --- CẢI THIỆN HIỂN THỊ BẢNG TKB --- */

/* 1. Tăng cỡ chữ cho toàn bộ ô trong bảng TKB */
.table-tkb td, #tkbTable td, .tkb-cell {
    font-size: 15px !important;       /* Tăng kích thước chữ (Mặc định thường là 12-13px) */
    font-weight: 500 !important;      /* Chữ đậm hơn một chút cho dễ đọc */
    line-height: 1.4 !important;      /* Giãn cách dòng để tên môn và tên GV không dính nhau */
    padding: 8px 5px !important;      /* Tăng khoảng cách lề để ô thoáng hơn */
    vertical-align: middle !important; /* Căn giữa nội dung theo chiều dọc */
    white-space: pre-wrap !important; /* Đảm bảo xuống dòng tự động đẹp mắt */
}

/* 2. Tạo hiệu ứng khi rê chuột vào ô (để dễ dò) */
.table-tkb td:hover, #tkbTable td:hover {
    background-color: #f0f8ff !important; /* Màu nền xanh nhạt khi chỉ vào */
    cursor: pointer;
    transform: scale(1.02);           /* Phóng to nhẹ ô đang xem */
    transition: all 0.2s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 10;                      /* Đưa ô đang xem lên trên cùng */
}

/* 3. Chỉnh màu sắc riêng biệt (Tùy chọn - nếu bạn muốn tách màu Môn và GV) */
/* Lưu ý: Code này chỉ chạy tốt nếu trong JS bạn bao thẻ <span>, nếu không nó sẽ ăn theo CSS mục 1 */
</style>
</head>

<body>

<div class="sidebar-trigger"></div>
<div class="sidebar" id="sidebar">
  <div class="brand">
    <span>YERSIN SCHOOL</span>
    <div style="text-align: center; padding: 20px 0;">
        <h3 style="color: white; margin-top: 10px; font-size: 16px;">TRẠM VŨ TRỤ</h3>
    </div>
    <span id="pinTrigger" onclick="toggleSidebarPin()" style="cursor: pointer; font-size: 16px; margin-left: auto; margin-right: 10px; opacity: 0.7; transition: 0.3s;" title="Ghim/Bỏ ghim Menu">
        📌
    </span>
    <span onclick="openSettings()" ...>⚙️</span>
  </div>

  <div class="nav-item active hk-mode" id="nav-hk" onclick="switchMode('hk')"><span class="nav-icon">📋</span> Hạnh Kiểm</div>
  <div class="nav-item" id="nav-acad" onclick="switchMode('acad')"><span class="nav-icon">📒</span> Sổ Điểm</div>
  <div class="nav-item" id="nav-tkb" onclick="switchMode('tkb')"><span class="nav-icon">📅</span> Thời Khóa Biểu</div>
  <div class="nav-item" id="nav-games" onclick="switchMode('games')"><span class="nav-icon">🎮</span> Tiện Ích</div>
  <div class="nav-item" onclick="openContextGuide()"><span class="nav-icon">❓</span> Hướng Dẫn</div>
  <div style="height: 1px; background: var(--glass-border); margin: 15px 0;"></div>
  <div class="nav-item" id="nav-stats" onclick="switchPage('stats', this); renderStats()"><span class="nav-icon">📊</span> Thống Kê</div>
  <div class="nav-item" id="nav-trash" onclick="switchPage('trash', this); renderTrash()"><span class="nav-icon">🗑️</span> Thùng Rác <span id="trashCount" style="margin-left:auto;font-size:10px; background: var(--neon-red); padding: 2px 6px; border-radius: 4px;">0</span></div>
  
  <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--glass-border)">
    <div class="nav-item" id="btnCloudSync" onclick="openCloudModal()" style="color: #00eaff; display: none;"><span class="nav-icon">☁️</span> Cloud Sync</div>    <div class="nav-item" onclick="backupData()"><span class="nav-icon">💾</span> Backup</div>
    <div class="nav-item" onclick="$('restoreFile').click()"><span class="nav-icon">📂</span> Restore</div>
    <div class="nav-item" onclick="clearAllData()" style="color: #fca5a5;"><span class="nav-icon">🔥</span> Reset App</div>
    <input type="file" id="restoreFile" hidden accept=".json" onchange="restoreData(this)">
  </div>
</div>

<div class="main-content">
  
<div class="header">
    <div style="display:flex; align-items:center; gap: 15px;">
         <button class="btn" style="margin-right:5px; display:none" id="menuBtn" onclick="toggleSidebar()">☰</button>
         
         <div id="pageTitle" style="font-weight:700; font-size: 18px; color:var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple); white-space: nowrap;">QUẢN LÝ HẠNH KIỂM</div>

         <div id="headerWeekNav" style="display: none; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
            <button class="week-header-btn" onclick="changeWeek(-1)">❮</button>
            <div style="text-align:center; display:flex; flex-direction:column; justify-content:center; min-width: 90px;">
                <span id="headerWeekTitle" style="font-weight:800; color:var(--neon-cyan); font-size: 13px; line-height: 1;">TUẦN 1</span>
                <input type="text" id="headerWeekDate" class="week-header-input date-locked" placeholder="Ngày - Ngày" disabled onchange="saveWeekDate()">
            </div>
            <button class="week-header-btn" onclick="changeWeek(1)">❯</button>
         </div>
    </div>
    
    <div style="display:flex; gap:10px; flex-wrap: wrap; flex:1; justify-content: flex-end; align-items: center;">
        <div id="studentTools" style="display: flex; gap: 10px; align-items: center;">
            <div id="classTrigger" class="class-trigger-btn" onclick="openClassManager()">
                <span id="currentClassLabel">🌐 Tất cả lớp</span>
                <span>▼</span>
            </div>
            <input type="hidden" id="classSelect" value="">
            <input id="search" class="search-box" placeholder="Tìm tên..." style="width: 150px">
            <button class="btn purple" onclick="openAddModal()">+ Thêm HS</button>
            <button class="btn green" onclick="handleImportClick()">+ Nhập dữ liệu</button>
            <button class="btn green" onclick="openExportModal()">📤 Xuất dữ liệu</button>
        </div>
        <button class="btn" style="font-size: 16px; padding: 8px 15px;" onclick="toggleRightMenu()">☰</button>
        <input type="file" id="studentFile" hidden accept=".xlsx,.xls" onchange="processImport()">
    </div>
</div>
  <div id="home" class="page-view active">
    <div class="grid-container" id="listContainer"></div>
  </div>

  <div id="games" class="page-view">
    <div class="game-container">
        <div class="game-sidebar">
            <h3 style="color:var(--neon-green); text-align:center; text-shadow:0 0 10px var(--neon-green)">🎮 CONTROL CENTER</h3>
            
            <label style="font-size:12px; opacity:0.7; margin-top:10px">📝 DANH SÁCH THAM GIA</label>
            <textarea id="gameInputData" class="game-input-area" oninput="drawGameWheel()" placeholder="Nhập tên học sinh, mỗi người một dòng..."></textarea>
            <div style="display:flex; gap:5px; margin-top:10px">
                <button class="btn" style="flex:1; font-size:11px" onclick="loadClassToGame()">📥 Lớp hiện tại</button>
                <button class="btn" style="flex:1; font-size:11px" onclick="$('gameInputData').value=''">❌ Xóa</button>
            </div>

            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:20px 0; width:100%">

            <div class="game-tab-btn active" onclick="switchGameTab('wheel')">🎡 Vòng Quay May Mắn</div>
            <div class="game-tab-btn" onclick="switchGameTab('race')">🚀 Đua Phi Thuyền</div>
            <div class="game-tab-btn" onclick="switchGameTab('group')">👥 Chia Nhóm Ngẫu Nhiên</div>
            <div class="game-tab-btn" onclick="switchGameTab('timer')">⏳ Đồng Hồ Đếm Ngược</div>
        </div>

        <div class="game-main">
            <div id="tab-wheel" class="game-content active">
                <div class="wheel-wrapper" style="transform: scale(1.2); margin-top: 50px;">
                    <div class="wheel-pointer"></div>
                    <div class="wheel-center">⚡</div>
                    <canvas id="gameWheelCanvas" width="400" height="400"></canvas>
                </div>
                <div style="text-align:center; margin-top:60px">
                    <button class="btn green" style="padding:15px 40px; font-size:20px; font-weight:bold; box-shadow:0 0 20px rgba(74, 222, 128, 0.4)" onclick="spinGameWheel()">QUAY NGAY</button>
                    <div id="gameWheelResult" style="margin-top:20px; font-size:24px; font-weight:bold; color:var(--neon-gold); text-shadow:0 0 15px currentColor; min-height:40px"></div>
                </div>
            </div>

            <div id="tab-race" class="game-content">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h2 style="margin:0; color:var(--neon-cyan)">🏁 ĐƯỜNG ĐUA TỬ THẦN</h2>
                    <button class="btn green" onclick="startSpaceRace()">🚀 KHỞI ĐỘNG ĐỘNG CƠ</button>
                </div>
                <div id="raceTrack" class="race-track">
                    <div style="text-align:center; padding:50px; opacity:0.5">Vui lòng nhập danh sách và ấn Khởi Động</div>
                </div>
            </div>

            <div id="tab-group" class="game-content">
                <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; display:flex; gap:15px; align-items:center; flex-wrap:wrap">
                    <div>
                        <label>Phương thức chia:</label>
                        <select id="groupMode" class="search-box">
                            <option value="count">Số lượng nhóm</option>
                            <option value="size">Số người/nhóm</option>
                        </select>
                    </div>
                    <div>
                        <label>Giá trị:</label>
                        <input id="groupValue" type="number" value="4" class="search-box" style="width:60px">
                    </div>
                    <button class="btn purple" onclick="generateGroups()">⚡ CHIA NGAY</button>
                </div>
                <div id="groupResult" class="group-grid"></div>
            </div>

            <div id="tab-timer" class="game-content">
                <div class="timer-wrapper">
                    <h2 style="color:var(--text); opacity:0.7; letter-spacing:5px">ĐẾM NGƯỢC THỜI GIAN</h2>
                    <div id="displayTimer" class="digital-clock">00:00</div>
                    <div class="timer-controls">
                        <input id="timerMin" type="number" class="timer-input" placeholder="Phút" value="5">
                        <input id="timerSec" type="number" class="timer-input" placeholder="Giây" value="00">
                    </div>
                    <div class="timer-controls" style="margin-top:20px">
                        <button class="btn green" style="padding:10px 40px" onclick="startTimer()">▶ BẮT ĐẦU</button>
                        <button class="btn red" onclick="pauseTimer()">⏸ TẠM DỪNG</button>
                        <button class="btn" onclick="resetTimer()">🔄 ĐẶT LẠI</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

<div id="tkb" class="page-view">
      <div class="tkb-controls" id="tkbControls" style="justify-content: space-between;">
          <div class="sub-tab-nav" style="margin-bottom: 0; border: none;">
              <button class="sub-tab-btn active" id="btnTkbTeacher" onclick="switchTkbView('teacher')">👨‍🏫 Giáo Viên</button>
              <button class="sub-tab-btn" id="btnTkbStudent" onclick="switchTkbView('student')">🎓 Lớp Học</button>
              <button class="sub-tab-btn" id="btnTkbGrad" onclick="switchTkbView('grad')">📚 Ôn Tốt Nghiệp</button> 
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <input id="tkbSearch" class="search-box" placeholder="🔍 Tìm nhanh..." oninput="filterTKBCards()" style="width: 150px;">
              <input type="file" id="tkbFile" hidden accept=".xlsx,.xls" onchange="processTKBExcel()">
              <button class="btn green" onclick="$('tkbFile').click()">📥 Nhập TKB Chính</button>
              <button class="btn purple" onclick="exportCurrentTKB()">📤 Xuất TKB</button>
              <button class="btn" style="background:linear-gradient(135deg, #6366f1, #8b5cf6); color:white; border:none; font-weight:bold; box-shadow:0 0 15px rgba(139, 92, 246, 0.4)" onclick="openSchoolManager()">
                    🏫 XẾP TKB TOÀN TRƯỜNG
              </button>
          </div>
      </div>
      
      <div id="tkbListView" class="grid-container" style="margin-top: 20px;"></div>
      
      <div id="tkbDetailView" style="display: none; animation: zoomIn 0.3s;">
          <button class="btn" onclick="backToTKBList()" style="margin-bottom: 15px; border: 1px dashed rgba(255,255,255,0.3)">⬅️ Quay lại danh sách</button>
          <button class="btn" style="background:rgba(255,255,255,0.1); border-color:white; float: right;" onclick="captureTKB()">📸 Chụp Ảnh TKB</button>
          <div id="tkbContent" class="tkb-container"></div>
      </div>
  </div>
  <div id="stats" class="page-view">
    <div class="stats-container" id="statsContainer"></div>
  </div>

  <div id="trash" class="page-view">
    <div id="trashContainer"></div>
  </div>

</div>

<div class="modal-overlay" id="profileModal" onclick="if(event.target===this) closeProfile()">
  <div class="profile-window" id="pwWindow" style="transition: transform 0.2s ease;">
    <div class="pw-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="profileAvatarContainer" class="avatar-container" style="width:60px; height:60px; margin:0;"></div>
            <div>
                <h2 id="pName" style="margin:0; font-size: 18px; text-shadow: 0 0 10px rgba(255,255,255,0.3)">Tên HS</h2>
                <div id="pClass" style="font-size: 12px; opacity:0.5">Lớp...</div>
            </div>
            <div class="icon-btn" onclick="renameStudent()" title="Sửa tên/lớp" style="margin-left:5px">✏️</div>
            <div id="pViolationBadge" style="margin-left: 15px; display:none;"></div>
        </div>  
        <div style="display:flex; align-items:center; gap:15px">
            <span class="icon-btn" style="color: var(--neon-red);" onclick="moveCurrentToTrash()" title="Xóa học sinh">🗑️</span>
            <span class="pw-close" style="cursor:pointer; opacity:0.5; font-size: 24px; font-weight:300" onclick="closeProfile()">✕</span>
        </div>
    </div>
    
    <div class="pw-body">
        <div class="pw-left">
             <div id="leftDynamicContent" style="width:100%; display:flex; flex-direction:column; align-items:center; flex:1; overflow:hidden"></div>
             <input type="file" id="pAvatarInput" hidden accept="image/*">
             <div style="margin-top:auto; width:100%; display:flex; gap:10px">
                <button class="btn" style="flex:1; font-size:11px" onclick="$('pAvatarInput').click()">📸 Ảnh</button>
                <button class="btn" style="flex:1; font-size:11px" onclick="undoLast()">↩ Hoàn tác</button>
             </div>
        </div>
        <div class="pw-right" id="actionArea"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="confirm-box" id="cBox">
        <div class="confirm-header"><h3 id="cTitle">XÁC NHẬN</h3></div>
        <div id="cWarning" style="color:var(--neon-red); text-align:center; font-size:12px; margin-top:-15px; margin-bottom:10px; font-weight:bold"></div>
        <div class="confirm-body">
            <div class="input-group"><label>Nội dung ghi nhận</label><input id="cDesc" type="text" placeholder="Ví dụ: Làm bài tốt..."></div>
            <div class="input-group"><label>Số điểm</label><input id="cVal" type="number" placeholder="0"></div>
            <div class="input-group"><label>Thời gian ghi nhận</label><input id="cTime" type="datetime-local"></div>
        </div>
        <div class="confirm-footer">
            <button class="btn" onclick="closeConfirmModal()">Hủy bỏ</button>
            <button class="btn green" onclick="commitScore()">Lưu lại</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="printPreviewModal">
    <div class="confirm-box" style="border-color: var(--neon-gold); box-shadow: 0 0 50px rgba(251, 191, 36, 0.2);">
        <div class="confirm-header" style="color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold);">🖨️ XEM TRƯỚC KHI IN</div>
        <div class="confirm-body" id="printArea">
            </div>
        <div class="confirm-footer">
            <button class="btn" onclick="$('printPreviewModal').style.display='none'">Đóng</button>
            <button class="btn green" style="background: var(--neon-gold); color: black; border:none; font-weight:bold" onclick="printReports()">🖨️ IN NGAY</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addModal">
    <div class="confirm-box" style="border-color: var(--neon-purple); box-shadow: 0 0 30px rgba(189, 0, 255, 0.3);">
        <div class="confirm-header" style="text-shadow: 0 0 10px var(--neon-purple);">THÊM HỌC SINH MỚI</div>
        <div class="confirm-body">
            <div class="input-group"><label>Họ và Tên</label><input id="newStName" type="text" placeholder="Nguyễn Văn A"></div>
            <div class="input-group"><label>Lớp</label><input id="newStClass" type="text" placeholder="Lớp 10A1"></div>
        </div>
        <div class="confirm-footer">
            <button class="btn" onclick="$('addModal').style.display='none'">Đóng</button>
            <button class="btn purple" onclick="addNewStudentManual()">Thêm ngay</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="wheelModal">
    <div class="confirm-box" style="width: 500px; text-align: center; border-color: var(--neon-cyan); box-shadow: 0 0 50px rgba(0, 255, 204, 0.2);">
        <div class="confirm-header" style="position: relative;">
            <span style="color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan);">🎡 VÒNG QUAY VŨ TRỤ</span>
            <div style="position: absolute; right: 20px; top:20px; display:flex; gap:10px; align-items:center">
                <span onclick="openWheelSettings()" style="cursor: pointer; font-size:16px" title="Cấu hình">⚙️</span>
                <span onclick="$('wheelModal').style.display='none'" style="cursor: pointer; color: white;">✕</span>
            </div>
        </div>
        
        <div id="wheelView" class="confirm-body" style="align-items: center; overflow: hidden; padding-bottom: 30px; padding-top: 30px; display:flex; flex-direction:column;">
            <div class="wheel-wrapper">
                <div class="wheel-pointer"></div>
                <div class="wheel-center">⚡</div>
                <canvas id="wheelCanvas" width="300" height="300"></canvas>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px">
                <div class="spin-btn" onclick="spin()" style="padding:10px 40px; border-radius:30px; background:var(--neon-green); color:black; font-weight:900; cursor:pointer; box-shadow:0 0 20px rgba(74, 222, 128, 0.5); text-transform:uppercase; transition:0.2s" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">QUAY NGAY</div>
            </div>

            <div id="wheelResult" style="height: 40px; margin-top: 15px; font-weight: bold; color: var(--neon-gold); font-size: 20px; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); text-align:center"></div>
            
            <button id="btnRemoveWinner" class="btn red" style="display:none; margin-top:10px; font-size:12px" onclick="removeCurrentWinner()">🚫 Xóa người này khỏi vòng quay</button>
        </div>

        <div id="wheelSettings" class="confirm-body" style="display:none; text-align:left; max-height:400px; overflow-y:auto">
            <h4 style="margin:0 0 10px 0; color:var(--neon-blue)">Danh sách ô (Màu - Tên)</h4>
            <textarea id="wheelBulkInput" style="width:100%; height:150px; background:rgba(0,0,0,0.5); color:white; border:1px solid var(--glass-border); border-radius:8px; padding:10px; box-sizing:border-box; resize:vertical; font-family:'Quicksand'; margin-bottom:10px" placeholder="Nhập tên mỗi dòng một người..."></textarea>
            <div style="display:flex; justify-content:space-between; align-items:center">
                <button id="btnLoadClass" class="btn" style="border:1px dashed rgba(255,255,255,0.3); font-size:11px" onclick="loadClassToWheel()">📥 Nạp danh sách lớp</button>
            </div>
        </div>
        <div class="confirm-footer" style="justify-content: center;">
            <div id="wheelBtnsMain"><button class="btn" onclick="$('wheelModal').style.display='none'">Đóng</button></div>
            <div id="wheelBtnsEdit" style="display:none"><button class="btn red" onclick="resetWheelSettings()">Mặc định</button><button class="btn green" onclick="saveWheelSettings()">Lưu lại</button></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="celebrateModal" onclick="closeCelebration()">
    <div class="celebrate-box" onclick="event.stopPropagation()">
        <div class="pyro"><div class="before"></div><div class="after"></div></div>
        <div class="cel-header">🎉 CHÚC MỪNG 🎉</div>
        <div id="celWinner" class="cel-winner">TÊN NGƯỜI THẮNG</div>
        <div class="cel-note">Vũ trụ đã gọi tên bạn!</div>
        <button class="btn purple" style="margin-top:20px; font-size:16px; padding:10px 30px" onclick="closeCelebration()">Tuyệt vời!</button>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="confirm-box">
        <div class="confirm-header">
            <span style="display:flex; align-items:center; gap:10px; color:white; text-shadow:0 0 10px rgba(255,255,255,0.3)">
                <span style="font-size:24px">⚙️</span> CẤU HÌNH HỆ THỐNG
            </span>
            <span style="cursor:pointer; opacity:0.5; font-size:20px" onclick="$('settingsModal').style.display='none'">✕</span>
        </div>
        
        <div class="confirm-body">
            
            <div class="setting-group">
                <div class="setting-title">👤 HỒ SƠ GIÁO VIÊN</div>
                <input id="cfgTeacher" class="modern-input" type="text" placeholder="Nhập tên hiển thị của bạn (VD: Thầy Huy)...">
                <div style="font-size:11px; opacity:0.5; margin-top:5px; margin-left:5px">Tên này sẽ hiển thị trên tiêu đề trang và phiếu in.</div>
            </div>

            <div class="setting-group">
                <div class="setting-title">🎨 GIAO DIỆN & CHỦ ĐỀ</div>
                <div class="theme-grid-modern">
                    <div class="theme-option theme-card" onclick="selectTheme('yersin2025')" id="theme-yersin2025">
                        <div class="theme-bg-preview" style="background: linear-gradient(135deg, #ffffff, #ffe0b2);"></div>
                        <div class="theme-name" style="color:black; background:rgba(255,255,255,0.8)">Yersin 2025 (Light)</div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option theme-card" onclick="selectTheme('nature')" id="theme-nature">
                        <div class="theme-bg-preview" style="background: linear-gradient(to bottom, #134e5e, #71b280);"></div>
                        <div class="theme-name">Thiên Nhiên</div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option theme-card" onclick="selectTheme('sea')" id="theme-sea">
                        <div class="theme-bg-preview" style="background: linear-gradient(to bottom, #006994, #001e4d);"></div>
                        <div class="theme-name">Biển Khơi</div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option theme-card" onclick="selectTheme('firewater')" id="theme-firewater">
                        <div class="theme-bg-preview" style="background: linear-gradient(45deg, #ff0000 0%, #000080 100%);"></div>
                        <div class="theme-name">Lửa & Nước</div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option theme-card" onclick="selectTheme('sun')" id="theme-sun">
                        <div class="theme-bg-preview" style="background: linear-gradient(to top, #fceabb, #f8b500);"></div>
                        <div class="theme-name">Mặt Trời (Sáng)</div>
                        <div class="theme-check">✓</div>
                    </div>
                    <div class="theme-option theme-card" onclick="selectTheme('white')" id="theme-white">
                        <div class="theme-bg-preview" style="background: linear-gradient(to bottom, #ffffff, #e2e8f0); border:1px solid #ddd"></div>
                        <div class="theme-name" style="color:black; background:white">Văn Phòng (Light)</div>
                        <div class="theme-check">✓</div>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-title">🔊 TIỆN ÍCH HỆ THỐNG</div>
                
                <div class="switch-container" onclick="$('cfgSound').click()">
                    <div>
                        <div style="font-weight:bold; color:white">Hiệu ứng âm thanh</div>
                        <div style="font-size:11px; opacity:0.6">Phát tiếng khi quay số, cộng điểm</div>
                    </div>
                    <label class="switch" onclick="event.stopPropagation()">
                        <input type="checkbox" id="cfgSound">
                        <span class="slider"></span>
                    </label>
                </div>

            </div>

        </div>

        <div class="confirm-footer" style="background: rgba(0,0,0,0.2); border-top:1px solid rgba(255,255,255,0.05); padding:20px">
            <button class="btn" onclick="$('settingsModal').style.display='none'" style="opacity:0.7">Đóng</button>
            <button class="btn purple" style="background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple)); border:none; color:white; font-weight:bold; padding:10px 30px; box-shadow:0 0 20px rgba(189, 0, 255, 0.4)" onclick="saveAppConfigUI()">💾 LƯU CẤU HÌNH</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="exportModal">
    <div class="confirm-box" style="border-color: var(--neon-green); box-shadow: 0 0 30px rgba(74, 222, 128, 0.3);">
        <div class="confirm-header" style="color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);">
            📤 XUẤT BÁO CÁO THÁNG
        </div>
        <div class="confirm-body">
            <div style="text-align:center; margin-bottom:15px; opacity:0.8; font-size:14px">
                Chọn tháng bạn muốn xuất dữ liệu:
            </div>
            
            <div class="input-group">
                <div style="display: flex; gap: 15px; justify-content: center; align-items: center;">
                    
                    <select id="exportMonth" style="width: 120px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--neon-green); color: white; font-weight: bold; font-family: 'Quicksand', sans-serif;">
                        <option value="1">Tháng 1</option>
                        <option value="2">Tháng 2</option>
                        <option value="3">Tháng 3</option>
                        <option value="4">Tháng 4</option>
                        <option value="5">Tháng 5</option>
                        <option value="6">Tháng 6</option>
                        <option value="7">Tháng 7</option>
                        <option value="8">Tháng 8</option>
                        <option value="9">Tháng 9</option>
                        <option value="10">Tháng 10</option>
                        <option value="11">Tháng 11</option>
                        <option value="12">Tháng 12</option>
                    </select>

                    <select id="exportYear" style="width: 100px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--neon-gold); color: var(--neon-gold); font-weight: bold; font-family: 'Quicksand', sans-serif;">
                        </select>
                </div>
            </div>
        </div>
        <div class="confirm-footer" style="justify-content: center; gap: 10px;">
            <button class="btn" onclick="$('exportModal').style.display='none'">Đóng</button>
            <button class="btn green" onclick="processExportWithDate()">Xuất Ngay</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="commentManagerModal">
    <div class="profile-window" style="width: 1100px; height: 90vh; border-color: var(--neon-gold); box-shadow: 0 0 40px rgba(251, 191, 36, 0.2);">
        
        <div class="pw-header" style="background: rgba(251, 191, 36, 0.05); border-bottom: 1px solid var(--neon-gold);">
            <div style="display:flex; align-items:center; gap:15px;">
                <span style="font-size:20px">📝</span>
                <h2 style="margin:0; color:var(--neon-gold); text-shadow:none">NHẬN XÉT ĐỊNH KỲ</h2>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <label style="color:var(--text); opacity:0.7">Thời gian:</label>
                <select id="cmtMonth" class="search-box" onchange="renderCommentManager()" style="width:80px; text-align:center; border-color:var(--neon-gold)">
                    <option value="1">T1</option><option value="2">T2</option><option value="3">T3</option>
                    <option value="4">T4</option><option value="5">T5</option><option value="6">T6</option>
                    <option value="7">T7</option><option value="8">T8</option><option value="9">T9</option>
                    <option value="10">T10</option><option value="11">T11</option><option value="12">T12</option>
                </select>
                <select id="cmtYear" class="search-box" onchange="renderCommentManager()" style="width:100px; text-align:center; border-color:var(--neon-gold)">
                    </select>
                <span class="pw-close" onclick="$('commentManagerModal').style.display='none'">✕</span>
            </div>
        </div>

        <div class="pw-body" style="grid-template-columns: 300px 1fr;">
            
            <div class="pw-left" style="padding:0; border-right:1px solid rgba(255,255,255,0.1); background:rgba(0,0,0,0.2)">
                
                <div style="display:flex; border-bottom:1px solid rgba(255,255,255,0.1)">
                    <div id="tabPending" class="cmt-tab active" onclick="switchCommentTab('pending')" style="flex:1; text-align:center; padding:15px; cursor:pointer; font-weight:bold; color:var(--neon-red); border-bottom:2px solid var(--neon-red); transition:0.3s">
                        Chưa Nhận Xét (<span id="countPending">0</span>)
                    </div>
                    <div id="tabDone" class="cmt-tab" onclick="switchCommentTab('done')" style="flex:1; text-align:center; padding:15px; cursor:pointer; font-weight:bold; color:var(--text); opacity:0.5; border-bottom:2px solid transparent; transition:0.3s">
                        Đã Xong (<span id="countDone">0</span>)
                    </div>
                </div>

                <div id="cmtStudentList" style="flex:1; overflow-y:auto; padding:10px;">
                    </div>
            </div>

            <div class="pw-right" style="padding:30px; display:flex; flex-direction:column; background:rgba(255,255,255,0.02)">
                <div id="cmtEditorArea" style="display:none; flex-direction:column; height:100%">
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px">
                        <img id="cmtAvatar" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--neon-gold)">
                        <div>
                            <h2 id="cmtName" style="margin:0; color:var(--neon-gold)">Nguyễn Văn A</h2>
                            <div id="cmtScoreInfo" style="font-size:14px; opacity:0.7">Điểm tổng kết tháng: ...</div>
                        </div>
                    </div>

                    <label style="margin-bottom:10px; font-weight:bold">Nội dung nhận xét:</label>
                    <textarea id="cmtContent" class="teacher-note-area" style="flex:1; font-size:16px; line-height:1.6; border-color:var(--neon-gold)" placeholder="Nhập đánh giá của bạn về học sinh này trong tháng..."></textarea>
                    
                    <div style="display:flex; justify-content:flex-end; margin-top:20px; gap:10px">
                        <button class="btn" onclick="skipComment()">Bỏ qua</button>
                        <button class="btn green" onclick="saveMonthlyComment()" style="padding:10px 40px; font-weight:bold; font-size:16px">💾 LƯU & TIẾP TỤC</button>
                    </div>
                </div>

                <div id="cmtEmptyState" style="height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; opacity:0.3">
                    <span style="font-size:50px">👈</span>
                    <h3>Chọn học sinh bên trái để bắt đầu</h3>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="right-sidebar-overlay" id="rsOverlay" onclick="toggleRightMenu()"></div>
<div class="right-sidebar-panel" id="rsPanel">
    <div class="rs-header">
        <h3 style="margin:0; color:var(--neon-purple)">CẤU HÌNH XEM</h3>
        <span style="cursor:pointer; font-size:20px; opacity:0.7" onclick="toggleRightMenu()">✕</span>
    </div>

    <div class="rs-section">
        <div class="rs-label">🗓️ Thời gian làm việc</div>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px">
            <div style="margin-bottom:5px; font-size:12px; opacity:0.7">Tháng:</div>
            <select id="viewMonth" class="search-box" style="width:100%; margin-bottom:10px" onchange="renderList()">
                </select>
            
            <div style="margin-bottom:5px; font-size:12px; opacity:0.7">Năm:</div>
            <select id="viewYear" class="search-box" style="width:100%" onchange="renderList()">
                </select>
        </div>
    </div>

    <div class="rs-section">
        <div class="rs-label">👁️ Chế độ hiển thị</div>
        <button id="btnToggleView" class="btn" style="width:100%; justify-content:center; padding:12px" onclick="toggleShowReviewed()">
            👁️ Đã Nhận Xét
        </button>
        <div style="font-size:11px; opacity:0.5; margin-top:8px; font-style:italic; text-align:center">
            Bật để hiện các học sinh đã đánh giá trong tháng chọn.
        </div>
    </div>
    <div class="rs-section">
        <div class="rs-label">📅 Cấu hình TKB</div>
        
        <button id="dateLockBtn" class="btn red" style="width:100%; justify-content:center; padding:12px; display:flex; align-items:center; gap:10px; transition:0.3s" onclick="toggleDateLock()">
            <span class="lock-icon" style="font-size:16px">🔒</span> 
            <span id="lockStatusTxt" style="font-weight:bold">ĐÃ KHÓA NGÀY</span>
        </button>
        
        <div style="font-size:11px; opacity:0.5; margin-top:8px; font-style:italic; text-align:center">
            Mở khóa để chỉnh sửa ngày tháng trên thanh Tuần.
        </div>
    </div>
    <div style="margin-top:auto; text-align:center; opacity:0.3; font-size:10px">
        Yersin Galaxy App v3.5
    </div>
</div>
<div id="contextMenu">
    <div class="ctx-item" onclick="bulkPrintHK()"><span class="ctx-icon">🖨️</span> In Phiếu HK</div>
    <div class="ctx-item" onclick="bulkExportPDF()"><span class="ctx-icon">📄</span> Xuất file PDF</div>
    <div class="ctx-item" onclick="bulkComment()"><span class="ctx-icon">📝</span> Nhận xét nhanh</div>
    <div class="ctx-item" onclick="bulkExport()"><span class="ctx-icon">📤</span> Xuất Excel</div>
    <div style="height:1px; background:rgba(255,255,255,0.1); margin: 2px 0;"></div>
    <div class="ctx-item" onclick="bulkDelete()" style="color: var(--neon-red)"><span class="ctx-icon">🗑️</span> Xóa học sinh</div>
    <div class="ctx-item" onclick="clearSelection()"><span class="ctx-icon">✕</span> Hủy chọn</div>
</div>

<div id="selectionBox"></div>

<div class="modal-overlay" id="addClassModal">
    <div class="confirm-box" style="border-color: var(--neon-green); box-shadow: 0 0 30px rgba(74, 222, 128, 0.3);">
        <div class="confirm-header" style="color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);">
            🏫 THÊM LỚP MỚI
        </div>
        <div class="confirm-body">
            <div class="input-group">
                <label>Chọn Khối</label>
                <select id="modalNewBlock" class="modern-input" style="width:100%; background:rgba(0,0,0,0.3); color:white">
                    <option value="Khối 10">Khối 10</option>
                    <option value="Khối 11">Khối 11</option>
                    <option value="Khối 12">Khối 12</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>
            <div class="input-group">
                <label>Tên Lớp</label>
                <input id="modalNewClassName" type="text" placeholder="Ví dụ: 10A1, 12C5..." class="modern-input">
            </div>
        </div>
        <div class="confirm-footer">
            <button class="btn" onclick="$('addClassModal').style.display='none'">Hủy bỏ</button>
            <button class="btn green" onclick="confirmAddClass()">Lưu Lớp Mới</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="guideModal" onclick="if(event.target===this) $('guideModal').style.display='none'">
    <div class="confirm-box" style="width: 700px; max-width: 95vw; border-color: var(--neon-blue); box-shadow: 0 0 40px rgba(0, 234, 255, 0.2);">
        <div class="confirm-header" style="background: linear-gradient(90deg, rgba(0,234,255,0.1), transparent); display:flex; justify-content:space-between; align-items:center">
            <span style="color: var(--neon-cyan); font-size: 18px; text-shadow: 0 0 10px var(--neon-cyan);">
                🧭 HƯỚNG DẪN SỬ DỤNG
            </span>
            <span style="cursor:pointer; opacity:0.7" onclick="$('guideModal').style.display='none'">✕</span>
        </div>
        
        <div class="confirm-body" style="max-height: 70vh; overflow-y: auto; padding: 0;">
            <div id="guideContent" style="padding: 20px; line-height: 1.6; font-size: 14px;"></div>
        </div>

        <div class="confirm-footer">
            <button class="btn" onclick="$('guideModal').style.display='none'">Đã hiểu</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="classManagerModal" onclick="if(event.target===this) $('classManagerModal').style.display='none'">
    <div class="confirm-box" style="width: 900px; max-width: 95vw; height: 80vh; display: flex; flex-direction: column;">
        
        <div class="confirm-header" style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size: 18px; font-weight: 800; letter-spacing: 1px;">
                🏫 DANH SÁCH LỚP HỌC
            </span>
            <div style="display:flex; gap:10px">
                <button class="btn green" style="padding: 5px 15px; font-size:12px" onclick="openAddClassModal()">+ Thêm Lớp</button>
                <span style="cursor:pointer; opacity:0.7; font-size:20px" onclick="$('classManagerModal').style.display='none'">✕</span>
            </div>
        </div>
        
        <div class="class-manager-body" id="classGridContainer">
            </div>

        <div class="confirm-footer">
             <div style="font-size:11px; opacity:0.6; font-style:italic; margin-right:auto">
                * Bấm vào thẻ để chọn lớp. Di chuột vào thẻ để hiện nút Sửa/Xóa.
             </div>
             <button class="btn" onclick="selectClass('')">🌐 Xem Tất Cả</button>
             <button class="btn" onclick="$('classManagerModal').style.display='none'">Đóng</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="schoolManagerModal" style="z-index: 5000;">
    <div class="confirm-box" style="width: 98vw; height: 98vh; max-width: 100%; background: #0f172a; border: 1px solid #334155; display: flex; flex-direction: column; border-radius: 0; box-shadow: none;">
        
        <div class="confirm-header" style="background: #1e293b; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 24px;">🚀</span>
                <div>
                    <h2 style="margin: 0; font-size: 16px; color: #38bdf8; text-transform: uppercase; font-weight: 800; letter-spacing: 1px;">TRUNG TÂM ĐIỀU KHIỂN TKB - GALAXY AI</h2>
                    <div style="font-size: 11px; opacity: 0.6; color: #cbd5e1;">Hệ thống xếp thời khóa biểu thông minh v3.0</div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                
                <div style="background: #0f172a; padding: 5px 10px; border-radius: 6px; border: 1px solid #475569; display: flex; align-items: center; gap: 5px;">
                    <span style="color: #94a3b8; font-size: 12px;">Áp dụng Tuần:</span>
                    <input type="number" id="schWeek" value="1" min="1" max="52" style="background: transparent; border: none; color: #38bdf8; font-weight: bold; width: 40px; text-align: center;">
                </div>

                <div style="background: #0f172a; padding: 5px 10px; border-radius: 6px; border: 1px solid #475569; display: flex; align-items: center; gap: 5px;">
                    <span style="color: #94a3b8; font-size: 12px;">Từ ngày:</span>
                    <input type="date" id="schDateStart" style="background: transparent; border: none; color: white; font-family: 'Quicksand'; font-size: 12px;">
                </div>

                <div style="width: 1px; height: 30px; background: #475569; margin: 0 10px;"></div>

                <button class="btn purple" onclick="applySchedulerToMain()" title="Lưu TKB này ra màn hình chính">
                    💾 ÁP DỤNG RA WEB
                </button>
                <button class="btn" onclick="$('schoolManagerModal').style.display='none'" style="background: rgba(255,255,255,0.1); border: none;">
                    ✕ ĐÓNG
                </button>
            </div>
        </div>

        <div class="confirm-body" style="flex: 1; padding: 0; display: grid; grid-template-columns: 320px 1fr; overflow: hidden;">
            
            <div style="background: #111827; border-right: 1px solid #334155; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;">
                
                <div class="panel-section" style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div class="section-label" style="color: #fbbf24; display: flex; justify-content: space-between;">
                        <span>📂 1. DỮ LIỆU NGUỒN</span>
                    </div>
                    
                    <button class="btn" style="width: 100%; margin-bottom: 8px; font-size: 12px; text-align: left; border: 1px dashed #64748b;" onclick="$('impSchTKB').click()">
                        📥 Nạp TKB Cũ (Để sửa)
                    </button>
                    <input type="file" id="impSchTKB" hidden accept=".xlsx,.csv" onchange="schImportOldTKB(this)">

                    <button class="btn" style="width: 100%; font-size: 12px; text-align: left; border: 1px dashed #64748b;" onclick="$('impSchPCCM').click()">
                        📋 Nhập Phân Công (Excel)
                    </button>
                    <input type="file" id="impSchPCCM" hidden accept=".xlsx,.csv" onchange="schImportPCCM(this)">
                    
                    <div id="schDataStatus" style="font-size: 11px; margin-top: 8px; color: #4ade80; font-style: italic; display: none;">
                        ✅ Đã có dữ liệu
                    </div>
                </div>

                <div class="panel-section" style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div class="section-label" style="color: #f472b6;">🤖 2. CẤU HÌNH AI GENERATE</div>
                    
                    <div class="switch-container" style="padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.1);">
                        <div>
                            <div style="font-size: 12px; font-weight: bold; color: #e2e8f0;">Né Tiết 5 & 8</div>
                            <div style="font-size: 10px; color: #94a3b8;">TD, QP không xếp tiết cuối</div>
                        </div>
                        <label class="switch"><input type="checkbox" id="aiConst_LastPeriod" checked><span class="slider"></span></label>
                    </div>

                    <div class="switch-container" style="padding: 8px 0; border-bottom: 1px dashed rgba(255,255,255,0.1);">
                        <div>
                            <div style="font-size: 12px; font-weight: bold; color: #e2e8f0;">Giãn cách môn</div>
                            <div style="font-size: 10px; color: #94a3b8;">Max 2 tiết/ngày/môn</div>
                        </div>
                        <label class="switch"><input type="checkbox" id="aiConst_Max2" checked><span class="slider"></span></label>
                    </div>

                    <div class="switch-container" style="padding: 8px 0;">
                        <div>
                            <div style="font-size: 12px; font-weight: bold; color: #e2e8f0;">Ưu tiên xếp cặp</div>
                            <div style="font-size: 10px; color: #94a3b8;">Văn, Toán xếp liền 2 tiết</div>
                        </div>
                        <label class="switch"><input type="checkbox" id="aiConst_Pairs" checked><span class="slider"></span></label>
                    </div>

                    <button class="btn green" style="width: 100%; margin-top: 15px; font-weight: bold; box-shadow: 0 0 15px rgba(74, 222, 128, 0.2);" onclick="schRunAI()">
                        ✨ SOẠN RANDOM (AI)
                    </button>
                    
                    <button class="btn red" style="width: 100%; margin-top: 10px; font-size: 11px;" onclick="schClearGrid()">
                        🗑️ Xóa TKB Đang Soạn
                    </button>
                </div>

                <div style="flex: 1; background: #000; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 10px; color: #4ade80; overflow-y: auto; border: 1px solid #334155;">
                    <div style="color: #94a3b8; border-bottom: 1px solid #333; margin-bottom: 5px;">CONSOLE LOG:</div>
                    <div id="schLogContent">System Ready...</div>
                </div>

            </div>

            <div style="display: flex; flex-direction: column; background: #0f172a; overflow: hidden;">
                
                <div style="padding: 10px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; gap: 10px;">
                    <select id="schViewMode" class="search-box" style="background: #0f172a; color: white;" onchange="schRenderGrid()">
                        <option value="class">Xem theo Lớp</option>
                        <option value="teacher">Xem theo Giáo Viên</option>
                    </select>
                    <input type="text" id="schSearch" class="search-box" placeholder="🔍 Tìm Lớp/GV..." style="background: #0f172a; color: white;" oninput="schRenderGrid()">
                    <div style="margin-left: auto; font-size: 12px; color: #94a3b8; display: flex; align-items: center; gap: 10px;">
                        <span>⚪ Chưa xếp</span>
                        <span style="color: #4ade80">● Đã xếp</span>
                        <span style="color: #f43f5e">● Xung đột</span>
                    </div>
                </div>

                <div id="schGridContainer" style="flex: 1; overflow: auto; padding: 20px;">
                    <div style="text-align: center; margin-top: 100px; opacity: 0.5;">
                        <div style="font-size: 50px;">📅</div>
                        <h3>Chưa có dữ liệu. Hãy nhập file hoặc tạo mới.</h3>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="schEditModal" style="z-index: 5001;">
    <div class="confirm-box" style="width: 350px; background: #1e293b; border: 1px solid #38bdf8;">
        <div class="confirm-header" style="color: #38bdf8;">✏️ CHỈNH SỬA TIẾT HỌC</div>
        <div class="confirm-body">
            <div id="schEditInfo" style="font-size: 12px; margin-bottom: 10px; opacity: 0.7;">Lớp 10A1 - Thứ 2 - Tiết 1</div>
            
            <div class="input-group">
                <label>Môn Học</label>
                <input id="schEditSubj" type="text" class="modern-input" placeholder="Toán, Văn..." oninput="schSuggestTeacher()">
            </div>
            
            <div class="input-group">
                <label>Giáo Viên</label>
                <input id="schEditTeacher" type="text" class="modern-input" placeholder="Tên GV...">
                <div id="schTeacherSuggestion" style="font-size: 10px; color: #fbbf24; margin-top: 2px;"></div>
            </div>

            <div class="switch-container" style="background: rgba(255,255,255,0.05);">
                <div>
                    <div style="font-size: 12px; color: white;">Khóa tiết này (Lock)</div>
                    <div style="font-size: 10px; opacity: 0.6;">AI sẽ không tự động đổi</div>
                </div>
                <label class="switch"><input type="checkbox" id="schEditLock"><span class="slider"></span></label>
            </div>
        </div>
        <div class="confirm-footer">
            <button class="btn red" onclick="schDeleteCell()">Xóa Tiết</button>
            <button class="btn" onclick="$('schEditModal').style.display='none'">Hủy</button>
            <button class="btn green" onclick="schSaveCell()">Lưu</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="editBtnModal">
    <div class="confirm-box">
        <div class="confirm-header">CHỈNH SỬA NÚT</div>
        <div class="confirm-body">
            <div class="input-group">
                <label>Tên nút hiển thị:</label>
                <input id="editBtnName" type="text" class="modern-input" placeholder="Ví dụ: Giơ tay phát biểu">
            </div>
            <div class="input-group">
                <label>Điểm số (+/-):</label>
                <input id="editBtnVal" type="number" step="0.1" class="modern-input" placeholder="Ví dụ: 1.0">
            </div>
        </div>
        <div class="confirm-footer" style="justify-content: space-between;">
            <button class="btn red" onclick="deleteButtonEdit()">🗑️ Xóa nút này</button>
            <div style="display:flex; gap:10px">
                <button class="btn" onclick="$('editBtnModal').style.display='none'">Hủy</button>
                <button class="btn green" onclick="saveButtonEdit()">💾 Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="cloudModal" style="display: none;">
    <div class="confirm-box" style="border-color: #00eaff; box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);">
        <div class="confirm-header" style="color: #00eaff;">☁️ HỆ THỐNG ĐỒNG BỘ TỰ ĐỘNG</div>
        <div class="confirm-body">
            <div class="input-group">
                <label>LIÊN KẾT DỮ LIỆU (CỐ ĐỊNH)</label>
                <input id="cloudApiUrl" type="text" class="modern-input" 
                       value="https://script.google.com/macros/s/AKfycbyIgvtL-0LdiCMOrakYZFKuG7ov5-NZjIYwWYQwqjK6_vrq6MdMd7SZCWU31NlM5nTP/exec" 
                       readonly disabled
                       style="background: rgba(0,0,0,0.2); color: #00eaff; cursor: not-allowed; border-color: #00eaff;">
            </div>
            <p style="text-align:center; font-size:11px; color:#4ade80; margin-top:15px; font-style: italic;">
                ● Trạng thái: Đang kết nối và cập nhật liên tục...
            </p>
        </div>
        <div class="confirm-footer">
            <button class="btn" onclick="document.getElementById('cloudModal').style.display='none'">ĐÓNG BẢNG</button>
        </div>
    </div>
</div>
            </div>
            <div id="cloudStatus" style="text-align:center; margin-top:10px; font-size:12px; font-style:italic; height:20px"></div>
        </div>
        <div class="confirm-footer">
            <button class="btn" onclick="$('cloudModal').style.display='none'">Đóng</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="teacherEditModal">
    <div class="confirm-box" style="border-color: var(--neon-blue); width: 400px;">
        <div class="confirm-header" style="color: var(--neon-blue);">
            👨‍🏫 HỒ SƠ GIÁO VIÊN
        </div>
        <div class="confirm-body" style="align-items: center;">
            <div style="position: relative; margin-bottom: 15px;">
                <img id="editTeacherAvt" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--neon-blue);">
                <button class="btn" style="position: absolute; bottom: 0; right: -10px; padding: 5px 10px; font-size: 10px; border-radius: 20px;" onclick="$('teacherAvtInput').click()">📷 Đổi ảnh</button>
                <input type="file" id="teacherAvtInput" hidden accept="image/*" onchange="previewTeacherAvatar(this)">
            </div>
            
            <div class="input-group" style="width: 100%;">
                <label>Họ và Tên</label>
                <input id="editTeacherName" type="text" class="modern-input" disabled style="opacity: 0.7; cursor: not-allowed;">
            </div>
            <div class="input-group" style="width: 100%;">
                <label>Môn Dạy</label>
                <input id="editTeacherSubject" type="text" class="modern-input" placeholder="Ví dụ: Toán Học, Ngữ Văn...">
            </div>
            <div class="input-group" style="width: 100%;">
                <label>Chức Vụ / Ghi chú</label>
                <input id="editTeacherRole" type="text" class="modern-input" placeholder="Ví dụ: Tổ Trưởng, GVCN 12A1...">
            </div>
        </div>
        <div class="confirm-footer">
            <button class="btn" onclick="$('teacherEditModal').style.display='none'">Đóng</button>
            <button class="btn green" onclick="saveTeacherProfile()">💾 Lưu Hồ Sơ</button>
        </div>
    </div>
</div>
</body>
<script>
// ======================================================
// 1. KHỞI TẠO, BIẾN CỐT LÕI & CẤU HÌNH
// ======================================================
const LS = { 
    students: "hk_v33_list", avatars: "hk_v33_avt", trash: "hk_v33_trash",
    hk_data: "hk_v33_data_hk", acad_data: "hk_v33_data_acad", grades: "hk_v33_grades",
    wheel: "hk_v33_wheel", tkb: "hk_v33_tkb",
    quick_buttons: "hk_v33_quick_btns" 
};

let teacherProfiles = JSON.parse(localStorage.getItem("hk_v33_teacher_profiles") || "{}");
// --- THÊM DÒNG NÀY VÀO PHẦN KHAI BÁO BIẾN (Gần đầu file) ---
const LS_HISTORY = "hk_v33_tkb_history"; // Tên khóa lưu trữ mới
let tkbHistory = JSON.parse(localStorage.getItem(LS_HISTORY) || "{}");
const $ = id => document.getElementById(id);

const AVATAR_COLORS = ["#F44336", "#E91E63", "#9C27B0", "#673AB7", "#3F51B5", "#2196F3", "#03A9F4", "#00BCD4", "#009688", "#4CAF50", "#8BC34A", "#CDDC39", "#FFC107", "#FF9800", "#FF5722", "#795548", "#607D8B", "#FF4081", "#7C4DFF", "#536DFE"];
// --- THAY THẾ ĐOẠN KHAI BÁO SUBJECTS CŨ BẰNG ĐOẠN NÀY ---

// 1. Danh sách mặc định
const DEFAULT_SUBJECTS = { 
    math: "Toán", lit: "Ngữ Văn", eng: "Tiếng Anh", 
    info: "Tin Học", hist: "Lịch Sử", chem: "Hóa Học", 
    read: "Đọc Sách", def: "QPAN", pe: "Thể Dục", 
    phy: "Vật Lí", bio: "Sinh Học", geo: "Địa Lý", 
    tech: "Công Nghệ", cnd: "Công Dân"
};

// 2. Tải danh sách đã đồng bộ (nếu có), nếu không thì dùng mặc định
let SUBJECTS = JSON.parse(localStorage.getItem("hk_v33_custom_subjects")) || DEFAULT_SUBJECTS;

// Hàm hỗ trợ tạo Key không dấu (VD: "Giáo Dục Kinh Tế" -> "giao_duc_kinh_te")
function toSlug(str) {
    return str.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[đĐ]/g, 'd').replace(/\s+/g, '_');
}
const PRESET_CLASSES = { "Khối 10": ["Lớp 10A1", "Lớp 10A2", "Lớp 10A3", "Lớp 10A4", "Lớp 10A5", "Lớp 10A6", "Lớp 10H"], "Khối 11": ["Lớp 11B1", "Lớp 11B2", "Lớp 11B3", "Lớp 11B4", "Lớp 11B5", "Lớp 11B6", "Lớp 11H"], "Khối 12": ["Lớp 12C1", "Lớp 12C2", "Lớp 12C3", "Lớp 12C4", "Lớp 12C5", "Lớp 12C6", "Lớp 12H"] };

// --- CẬP NHẬT 1: THÊM DATA NÚT CHO SỔ ĐIỂM ---
// --- PHẦN 1: CẤU HÌNH NÚT MẶC ĐỊNH ---
// --- CẬP NHẬT: DANH SÁCH NÚT MẶC ĐỊNH MỞ RỘNG ---
const DEFAULT_BUTTONS = {
    // 1. Phần Hạnh Kiểm (Giữ nguyên hoặc tùy chỉnh thêm)
    good: [
        { text: "Tuần học tốt (Chuyên cần)", val: 0.25, icon: "🌟" },
        { text: "Tiến bộ vượt bậc", val: 0.5, icon: "📈" },
        { text: "Giúp đỡ bạn bè", val: 1.0, icon: "🤝" },
        { text: "Vệ sinh sạch sẽ", val: 0.25, icon: "🧹" },
        { text: "Xung phong phát biểu", val: 0.25, icon: "🙋‍♀️" }
    ],
    bad: [
        { text: "Đi trễ (< 5 phút)", val: -0.5, icon: "⏰" },
        { text: "Đi trễ (> 15 phút)", val: -1.0, icon: "🏃" },
        { text: "Sai đồng phục/thẻ", val: -0.25, icon: "👔" },
        { text: "Nói chuyện riêng", val: -0.5, icon: "🤫" },
        { text: "Vắng không phép", val: -2.0, icon: "🚫" },
        { text: "Sử dụng ĐT sai quy định", val: -1.0, icon: "📱" }
    ],

    // 2. Phần Sổ Điểm / Học Tập (ĐÃ CẬP NHẬT MỚI)
    acadGood: [
        { text: "Phát biểu xây dựng bài", val: 1.0, icon: "🎤" },
        { text: "Lên bảng giải đúng", val: 2.0, icon: "💯" },
        { text: "Làm bài tập đầy đủ/đẹp", val: 1.0, icon: "📚" },
        { text: "Tinh thần xung phong", val: 0.5, icon: "🙋‍♂️" },
        { text: "Tư duy sáng tạo", val: 1.0, icon: "💡" },
        { text: "Hoạt động nhóm tốt", val: 1.0, icon: "🧩" }
    ],
    acadBad: [
        { text: "Không làm bài tập về nhà", val: -2.0, icon: "📝" },
        { text: "Quên SGK/Vở ghi/Dụng cụ", val: -1.0, icon: "📖" },
        { text: "Mất trật tự (Ảnh hưởng lớp)", val: -1.0, icon: "🤫" },
        { text: "Ngủ gật/Không chú ý", val: -1.0, icon: "😴" },
        { text: "Sử dụng điện thoại trong giờ", val: -2.0, icon: "📱" },
        { text: "Quay cóp/Gian lận thi cử", val: -5.0, icon: "🚫" } // Phạt nặng
    ]
};
// THÊM ĐOẠN NÀY VÀO CODE CỦA BẠN
const DEFAULT_PRIZES = [
    { text: "Giải Nhất", color: "#bd00ff" }, // Tím
    { text: "Giải Nhì", color: "#00eaff" },  // Xanh Neon
    { text: "Giải Ba", color: "#00ffcc" },   // Xanh Ngọc
    { text: "May Mắn Lần Sau", color: "#f43f5e" }, // Đỏ
    { text: "1 Tràng Pháo Tay", color: "#fbbf24" }, // Vàng
    { text: "Phần Quà Bí Mật", color: "#4ade80" }   // Xanh Lá
];
// --- Load Data from LocalStorage ---
let students = JSON.parse(localStorage.getItem(LS.students) || "[]");
let trash = JSON.parse(localStorage.getItem(LS.trash) || "[]");
let avatars = JSON.parse(localStorage.getItem(LS.avatars) || "{}");
let db = { hk: JSON.parse(localStorage.getItem(LS.hk_data) || "{}"), acad: JSON.parse(localStorage.getItem(LS.acad_data) || "{}") };
let grades = JSON.parse(localStorage.getItem(LS.grades) || "{}");
let tkbData = JSON.parse(localStorage.getItem(LS.tkb) || '{"teacher":{}, "student":{}, "grad":{}}');

// --- Load Data from LocalStorage ---
// ... (Các dòng load students, trash... giữ nguyên) ...

let quickButtons = JSON.parse(localStorage.getItem(LS.quick_buttons));

// LOGIC MỚI: Tự động kiểm tra và thêm nút nếu dữ liệu cũ bị thiếu
if (!quickButtons) {
    quickButtons = JSON.parse(JSON.stringify(DEFAULT_BUTTONS)); 
} else {
    // Nếu đã có dữ liệu cũ nhưng thiếu nút Sổ Điểm (Acad), thì tự động nạp thêm vào
    if (!quickButtons.acadGood || quickButtons.acadGood.length === 0) {
        quickButtons.acadGood = JSON.parse(JSON.stringify(DEFAULT_BUTTONS.acadGood));
    }
    if (!quickButtons.acadBad || quickButtons.acadBad.length === 0) {
        quickButtons.acadBad = JSON.parse(JSON.stringify(DEFAULT_BUTTONS.acadBad));
    }
}

// --- State Variables ---
let selectedStudents = new Set();
const CONFIG_KEY = "yersin_config_v3"; 
// 👇 Đổi thành "yersin2025" để làm mặc định
let appConfig = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{"theme":"yersin2025","sound":true,"teacher":""}');
let tempSelectedTheme = 'galaxy';
let currentMode = 'hk';
let currentID = null;
let currentAcadTab = 'bank';
let currentSubject = 'math'; 
let tkbViewMode = 'teacher';
let currentTkbTarget = null; 
let avatarCache = {}; 
let chartInstances = {}; // Cho Chart.js

let isBulkMode = false; 
let bulkActionType = 'history'; 
let isEditQuickMode = false; 
// --- THÊM BIẾN MỚI NÀY ---
let isShowReviewedMode = false; // Mặc định là TẮT (False)

// --- THÊM HÀM BẬT/TẮT ---
function toggleShowReviewed() {
    isShowReviewedMode = !isShowReviewedMode; // Đảo ngược trạng thái
    
    // Đổi màu nút để biết đang bật hay tắt
    const btn = document.getElementById('btnToggleView');
    if(isShowReviewedMode) {
        btn.classList.add('green'); // Bật đèn xanh
        btn.innerHTML = "👁️ Đang Hiện";
    } else {
        btn.classList.remove('green'); // Tắt đèn
        btn.innerHTML = "👁️ Đã Nhận Xét";
    }
    
    renderList(); // Vẽ lại danh sách để áp dụng thay đổi
}
// Biến cho Stats Nâng cao
let currentStatSubject = 'math'; 
let currentStatGradeType = 'tx1'; 

// Biến cho Trash Nâng cao
let trashSelection = new Set();

// ======================================================
// 2. HÀM INIT & TIỆN ÍCH (UTILS)
// ======================================================
function init() { 
    applyTheme(appConfig.theme);
    if(appConfig.teacher) {
        const titlePart = currentMode === 'hk' ? "QUẢN LÝ HẠNH KIỂM" : "SỔ ĐIỂM";
        $('pageTitle').innerHTML = `${appConfig.teacher} - ${titlePart}`;
    }
    renderClassDropdown(); renderList(); updateTrashCount();
    if(window.innerWidth < 768) $('menuBtn').style.display = 'block';
    
    // Avatar upload handler
    $('pAvatarInput').onchange = e => { 
        const f = e.target.files[0]; 
        if(f && currentID) { 
            if(f.size > 5 * 1024 * 1024) { showToast("Ảnh quá lớn (>5MB)!", "error"); return; }
            compressImage(f, 150, 0.7, (resultData) => { avatars[currentID] = resultData; saveData(); $('pAvatarSmall').src = resultData; renderList(); renderHKProfile(); });
        } 
    };
    loadPrizes(); 
    setInterval(checkCurrentPeriod, 60000); 
    
    // Fix modal buttons
    const btns = document.querySelectorAll('.confirm-footer .btn');
    if(btns.length > 0) btns[0].onclick = closeConfirmModal;
// --- CODE MỚI: KHỞI TẠO THÁNG/NĂM ---
    const today = new Date();
    const curM = today.getMonth() + 1;
    const curY = today.getFullYear();

    // Tạo option cho tháng 1-12
    const mSelect = $('viewMonth');
    for(let i=1; i<=12; i++) {
        const opt = document.createElement('option');
        opt.value = i; opt.innerText = "T" + i;
        if(i === curM) opt.selected = true;
        mSelect.appendChild(opt);
    }

    // Tạo option cho năm (Năm ngoái, Năm nay, Năm sau)
    const ySelect = $('viewYear');
    [curY-1, curY, curY+1].forEach(y => {
        const opt = document.createElement('option');
        opt.value = y; opt.innerText = y;
        if(y === curY) opt.selected = true;
        ySelect.appendChild(opt);
    });
    // --- HẾT CODE MỚI ---
// 1. Khôi phục tab cũ (Hạnh kiểm/Sổ điểm/TKB...)
    const savedMode = localStorage.getItem('yersin_saved_mode');
    if (savedMode && savedMode !== 'hk') { // Nếu khác mặc định mới chuyển
        switchMode(savedMode);
    }

    // 2. Khôi phục cửa sổ hồ sơ học sinh (nếu đang mở)
    const savedProfile = localStorage.getItem('yersin_saved_profile');
    if (savedProfile) {
        setTimeout(() => {
            // Kiểm tra xem ID này có trong danh sách hiện tại không rồi mới mở
            if (students.includes(savedProfile)) {
                openProfile(savedProfile);
            } else {
                localStorage.removeItem('yersin_saved_profile');
            }
        }, 300); // Đợi 300ms để danh sách load xong
    }
    // ----------------------------------------
// --- THÊM DÒNG NÀY VÀO CUỐI HÀM INIT ---
    if(localStorage.getItem('yersin_sidebar_pinned') === 'true') {
        document.body.classList.add('pinned-mode');
    }
}

// Helpers
function smartCleanName(str) {
    if (!str || typeof str !== 'string') return "";
    
    // 1. Làm sạch cơ bản: Xóa khoảng trắng thừa, xóa dấu / hoặc , bị dính ở cuối
    // Ví dụ: "Huy/" -> "Huy"
    let s = str.trim().replace(/[\/\\,\.;]+$/, ""); 

    // 2. Chuẩn hóa Tiền tố: Tự động sửa "Thầy ", "T ", "t " thành "T."
    // Ví dụ: "T Phong" -> "T.Phong", "Thầy Huy" -> "T.Huy"
    s = s.replace(/^(Thầy\s+|T\s+|t\s+|Th\.\s+)/i, "T.");
    s = s.replace(/^(Cô\s+|C\.\s+|c\s+)/i, "Cô ");

    // 3. XỬ LÝ GỘP TÊN CỤ THỂ (MAPPING)
    // Chuyển thành chữ in hoa để so sánh cho chính xác
    const upper = s.toUpperCase();

    // --- NHÓM T.PHONG ---
    // Gộp tất cả biến thể chứa "PHONG" (trừ khi là Thanh Phong, v.v. nếu cần tách thì thêm điều kiện)
    if (upper === "PHONG" || upper === "T PHONG" || upper === "T.PHONG") {
        return "T.Phong";
    }

    // --- NHÓM T.HUY ---
    // Gộp "Huy", "T.Huy", "Thầy Huy"
    if (upper === "HUY" || upper === "T HUY" || upper === "T.HUY" || upper === "THẦY HUY") {
        return "T.Huy";
    }

    // --- NHÓM CÁC GV KHÁC (Tự động viết hoa chữ cái đầu) ---
    // Ví dụ: "nguyễn văn a" -> "Nguyễn Văn A"
    return s.toLowerCase().replace(/(^|\s)\S/g, l => l.toUpperCase());
}function smartCleanClass(str) { if (!str) return ""; let clean = str.toString().trim().toUpperCase().replace(/\s+/g, ''); clean = clean.replace(/LỚP/g, ''); return "Lớp " + clean; }
function compressImage(file, maxWidth, quality, callback) { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = event => { const img = new Image(); img.src = event.target.result; img.onload = () => { let width = img.width; let height = img.height; if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); const dataUrl = canvas.toDataURL('image/jpeg', quality); callback(dataUrl); }; }; }
function saveData() {
    // 1. Lưu vào máy như cũ
    localStorage.setItem('hk_v33_db', JSON.stringify(db));
    
    // 2. Cập nhật giao diện
    if (typeof updateStats === 'function') updateStats();
    if (typeof renderList === 'function') renderList();
    
    // 3. BẬT CÔNG TẮC (Đây là dòng quan trọng nhất)
    window.hasLocalChange = true; 
    console.log("🚀 Đã bật công tắc đồng bộ!");
}
function generateAvatar(name) {
    if (!name) return "";
    if (avatarCache[name]) return avatarCache[name];
    let initials = ""; const parts = name.trim().split(" ");
    if (parts.length > 1) { initials = (parts[0][0] + parts[parts.length - 1][0]).toUpperCase(); } else { initials = name.substring(0, 2).toUpperCase(); }
    let hash = 0; for (let i = 0; i < name.length; i++) { hash = name.charCodeAt(i) + ((hash << 5) - hash); }
    const color = AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
    const canvas = document.createElement('canvas'); canvas.width = 100; canvas.height = 100; const ctx = canvas.getContext('2d');
    ctx.fillStyle = color; ctx.fillRect(0, 0, 100, 100); ctx.fillStyle = "#FFFFFF"; ctx.font = "bold 45px Quicksand, sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(initials, 50, 50);
    const dataURL = canvas.toDataURL(); avatarCache[name] = dataURL; return dataURL;
}

// ======================================================
// 3. THEME & GIAO DIỆN
// ======================================================
function applyTheme(theme) {
    const root = document.documentElement;
    let bg, mainColor, subColor, sidebarBg, textColor;
    
    // Mặc định (cho các theme tối khác)
    sidebarBg = 'rgba(10, 10, 42, 0.95)'; 
    textColor = '#e2e8f0';

    // --- LOGIC KÍCH HOẠT CHẾ ĐỘ SÁNG ---
    // Nếu là theme Yersin 2025 hoặc White -> Thêm class đặc biệt để CSS xử lý
    if (theme === 'yersin2025' || theme === 'white') {
        document.body.classList.add('theme-yersin-light');
    } else {
        document.body.classList.remove('theme-yersin-light');
    }

    switch(theme) {
        // --- YERSIN 2025 (CAM TRẮNG PASTEL - KHÔNG NEON) ---
        case 'yersin2025': 
        case 'galaxy': // Fallback
        default: 
            // Nền: Gradient Cam Phấn nhẹ nhàng
            bg = 'linear-gradient(135deg, #fff5e6 0%, #ffcc80 100%)'; 
            
            // Màu chính: Cam Đất (đậm đà, dễ đọc trên nền sáng)
            mainColor = '#d35400'; 
            
            // Màu phụ: Vàng Nghệ
            subColor = '#f39c12';  
            
            // Sidebar & Text
            sidebarBg = 'rgba(255, 255, 255, 0.95)'; 
            textColor = '#2c3e50'; // Chữ màu xanh đen đậm
            break;

        case 'nature': 
            bg = 'linear-gradient(to bottom, #134e5e, #71b280)'; 
            mainColor = '#4ade80'; subColor = '#22d3ee'; 
            break;
        case 'sea': 
            bg = 'linear-gradient(to bottom, #006994, #001e4d)'; 
            mainColor = '#00eaff'; subColor = '#0033cc'; 
            break;
        case 'white': 
            bg = 'linear-gradient(to bottom, #f8fafc, #e2e8f0)'; 
            mainColor = '#0f172a'; subColor = '#64748b'; 
            sidebarBg = 'rgba(255, 255, 255, 0.95)'; 
            textColor = '#1e293b'; 
            break;
    }

    // Áp dụng biến CSS
    document.body.style.backgroundImage = bg;
    root.style.setProperty('--bg-space', bg); 
    root.style.setProperty('--neon-purple', mainColor); 
    root.style.setProperty('--neon-blue', subColor);
    root.style.setProperty('--sidebar-bg', sidebarBg); 
    root.style.setProperty('--text', textColor);

    // Cập nhật màu tiêu đề
    const pt = document.getElementById('pageTitle');
    if(pt) {
        pt.style.color = mainColor;
        pt.style.textShadow = 'none'; // Đảm bảo tắt bóng chữ
    }

    // Cập nhật màu menu Active
    if(typeof currentMode !== 'undefined' && currentMode === 'hk') {
        document.querySelectorAll('.nav-item.hk-mode').forEach(el => { 
            if(el.classList.contains('active')) { 
                el.style.color = mainColor; 
                el.style.borderColor = mainColor; 
                el.style.textShadow = 'none';
            }
        });
    }
}
function openSettings() { $('settingsModal').style.display = 'flex'; $('cfgTeacher').value = appConfig.teacher || ""; $('cfgSound').checked = appConfig.sound; selectTheme(appConfig.theme || 'galaxy'); }
function selectTheme(themeName) { tempSelectedTheme = themeName; document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('selected')); document.getElementById(`theme-${themeName}`).classList.add('selected'); }
function saveAppConfigUI() { 
    appConfig.teacher = $('cfgTeacher').value.trim(); appConfig.sound = $('cfgSound').checked; appConfig.theme = tempSelectedTheme; 
    localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig)); applyTheme(appConfig.theme); 
    const baseTitle = currentMode === 'hk' ? "QUẢN LÝ HẠNH KIỂM" : "SỔ ĐIỂM"; const finalTitle = appConfig.teacher ? `${appConfig.teacher} - ${baseTitle}` : baseTitle; $('pageTitle').innerText = finalTitle; 
    renderList(); 
    showToast("Đã lưu cấu hình thành công!", "success"); // TOAST
    $('settingsModal').style.display = 'none'; 
}


function switchPage(pageId, btn) { 
    document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active')); 
    $(pageId).classList.add('active'); 
    
    // Nếu vào trang Trash, gọi renderTrash mới
    if(pageId === 'trash') renderTrash();
    // Nếu vào trang Stats, gọi renderStats mới
    if(pageId === 'stats') renderStats();
}

// ==========================================
// QUẢN LÝ DANH SÁCH LỚP (ĐÃ FIX LỖI KHÔNG CHỌN ĐƯỢC)
// ==========================================

// 1. Dữ liệu lớp mặc định
const DEFAULT_CLASSES_STRUCTURE = {
    "Khối 10": ["Lớp 10A1", "Lớp 10A2", "Lớp 10A3", "Lớp 10A4", "Lớp 10A5", "Lớp 10A6", "Lớp 10H"],
    "Khối 11": ["Lớp 11B1", "Lớp 11B2", "Lớp 11B3", "Lớp 11B4", "Lớp 11B5", "Lớp 11B6", "Lớp 11H"],
    "Khối 12": ["Lớp 12C1", "Lớp 12C2", "Lớp 12C3", "Lớp 12C4", "Lớp 12C5", "Lớp 12C6", "Lớp 12H"]
};

// Biến lưu danh sách lớp
let classData = JSON.parse(localStorage.getItem("hk_v33_classes")) || JSON.parse(JSON.stringify(DEFAULT_CLASSES_STRUCTURE));

// Hàm bật/tắt menu (Sổ xuống)
function toggleCustomDropdown() {
    const list = document.getElementById('dropdownList');
    // Nếu đang hiện thì ẩn, đang ẩn thì hiện
    if (list.style.display === 'block') {
        list.style.display = 'none';
    } else {
        renderCustomClassList(); // Vẽ lại danh sách mới nhất
        list.style.display = 'block';
    }
}

// Hàm đóng menu khi click ra ngoài (quan trọng để không bị kẹt menu)
document.addEventListener('click', function(e) {
    const container = document.getElementById('customClassDropdown');
    const list = document.getElementById('dropdownList');
    // Nếu click ra ngoài vùng menu thì đóng lại
    if (container && !container.contains(e.target)) {
        list.style.display = 'none';
    }
});

// Hàm vẽ danh sách lớp (MỚI: NÚT BẤM MỞ MODAL)
function renderCustomClassList() {
    const listDiv = document.getElementById('dropdownList');
    listDiv.innerHTML = "";

    // 1. Mục "Tất cả lớp"
    const allOption = document.createElement('div');
    allOption.className = "class-option";
    allOption.innerHTML = `<span style="font-weight:bold">🌐 Tất cả lớp</span>`;
    allOption.onclick = function() { selectClass(""); }; 
    listDiv.appendChild(allOption);

    // 2. Vẽ danh sách các lớp
    let hasClasses = false;
    for (const [blockName, classes] of Object.entries(classData)) {
        if(classes.length === 0) continue;
        hasClasses = true;
        
        const groupLabel = document.createElement('div');
        groupLabel.className = "opt-group-label";
        groupLabel.innerText = blockName;
        listDiv.appendChild(groupLabel);

        classes.forEach(cls => {
            const item = document.createElement('div');
            item.className = "class-option";
            if (document.getElementById('classSelect').value === cls) item.classList.add('active');
            
            item.innerHTML = `<span>${cls}</span><span class="del-class-btn" title="Xóa">🗑️</span>`;
            
            item.onclick = function() { selectClass(cls); };
            
            const delBtn = item.querySelector('.del-class-btn');
            delBtn.onclick = function(e) { e.stopPropagation(); deleteClass(blockName, cls); };

            listDiv.appendChild(item);
        });
    }

    if (!hasClasses) {
        listDiv.innerHTML += `<div style="padding:20px; text-align:center; opacity:0.5; font-size:12px">(Chưa có lớp nào)</div>`;
    }

    // 3. NÚT BẤM DƯỚI ĐÁY (STICKY)
    const addArea = document.createElement('div');
    addArea.className = "add-class-area";
    // Ngăn click vào đây làm đóng menu
    addArea.onclick = function(e) { e.stopPropagation(); };
    
    // Nút bấm mở Modal
    addArea.innerHTML = `
        <button class="btn green" style="width:100%; font-weight:bold; display:flex; justify-content:center; align-items:center; gap:5px" onclick="openAddClassModal()">
            <span style="font-size:16px; font-weight:900">+</span> THÊM LỚP MỚI
        </button>
    `;
    listDiv.appendChild(addArea);
}
// Hàm xử lý khi chọn lớp
function selectClass(className) {
    // 1. Cập nhật giá trị vào input ẩn
    const selectElem = document.getElementById('classSelect');
    if(selectElem) selectElem.value = className;
    
    // 2. Cập nhật nhãn hiển thị
    const labelElem = document.getElementById('currentClassLabel');
    if(labelElem) labelElem.innerText = className || "-- Tất cả lớp --";
    
    // 3. Đóng menu
    const list = document.getElementById('dropdownList');
    if(list) list.style.display = 'none';
    
    // 4. Gọi hàm lọc danh sách chính (Quan trọng)
    if(typeof renderList === 'function') renderList(); 
    
    // 5. Gọi hàm thống kê nếu đang ở trang thống kê
    if(document.getElementById('stats') && document.getElementById('stats').classList.contains('active')) {
        if(typeof renderStats === 'function') renderStats();
    }
}

// Hàm thêm lớp mới
function addClassFromDropdown() {
    const block = document.getElementById('newBlockSelect').value;
    let name = document.getElementById('newClassName').value.trim();
    
    if (!name) return showToast("Vui lòng nhập tên lớp!", "error");
    if (!name.toLowerCase().startsWith("lớp")) name = "Lớp " + name;
    
    if (!classData[block]) classData[block] = [];
    if (classData[block].includes(name)) return showToast("Lớp này đã có rồi!", "error");
    
    classData[block].push(name);
    classData[block].sort();
    
    saveClasses();
    renderCustomClassList(); // Vẽ lại menu
    showToast(`Đã thêm ${name}`, "success");
}

// --- SỬA LOGIC XÓA LỚP ---
function deleteClass(block, className) {
    if (!confirm(`Bạn chắc chắn muốn xóa ${className}?`)) return;
    
    // 1. Xóa lớp khỏi dữ liệu
    classData[block] = classData[block].filter(c => c !== className);
    
    // 2. Nếu lớp bị xóa đang được chọn ở ngoài -> Reset về "Tất cả"
    if(document.getElementById('classSelect').value === className) {
        selectClass("");
    }
    
    saveClasses(); // Lưu vào bộ nhớ máy
    
    // 3. QUAN TRỌNG: Vẽ lại bảng lưới để thẻ lớp biến mất ngay
    renderClassGrid(); 
    
    // Cập nhật cả menu dropdown (để đồng bộ)
    renderCustomClassList(); 
    
    showToast(`Đã xóa thành công: ${className}`, "info");
}

// Hàm lưu xuống LocalStorage
function saveClasses() {
    localStorage.setItem("hk_v33_classes", JSON.stringify(classData));
}

// Override hàm cũ để khởi tạo đúng text ban đầu
function renderClassDropdown() {
    const current = document.getElementById('classSelect').value;
    const label = document.getElementById('currentClassLabel');
    if(label) label.innerText = current || "-- Tất cả lớp --";
}

function toggleSelection(id) { if (selectedStudents.has(id)) selectedStudents.delete(id); else selectedStudents.add(id); updateBulkActionBar(); renderList(); }
function clearSelection() { selectedStudents.clear(); updateBulkActionBar(); renderList(); }
function toggleSelectAll() { const cls = $('classSelect').value; const txt = $('search').value.toLowerCase(); const visibleStudents = students.filter(s => { const parts = s.split(" - "); const c = parts[1] || "Chưa xếp lớp"; if (cls && c !== cls) return false; if (txt && !parts[0].toLowerCase().includes(txt)) return false; return true; }); if (visibleStudents.every(s => selectedStudents.has(s))) visibleStudents.forEach(s => selectedStudents.delete(s)); else visibleStudents.forEach(s => selectedStudents.add(s)); updateBulkActionBar(); renderList(); }
function bulkDelete() { 
    if (confirm(`Xóa ${selectedStudents.size} học sinh?`)) { 
        selectedStudents.forEach(id => { const idx = students.indexOf(id); if (idx > -1) { students.splice(idx, 1); trash.push(id); }}); 
        saveData(); 
        showToast(`Đã chuyển ${selectedStudents.size} HS vào thùng rác`, "info");
        clearSelection(); renderList(); renderClassDropdown(); 
    } 
}
function handleImportClick() { $('studentFile').click(); }

// --- HÀM NHẬP DANH SÁCH HỌC SINH (IMPORT) ĐÃ SỬA LỖI ---
function processImport() {
    const defaultClass = $('classSelect').value; // Lấy lớp đang chọn ở menu
    const f = $('studentFile').files[0];
    if (!f) return;

    const r = new FileReader();
    r.onload = e => {
        try {
            // 1. Đọc dữ liệu file Excel/CSV
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});

            // 2. Tìm dòng tiêu đề & Xác định vị trí cột
            let nameColIdx = -1;
            let classColIdx = -1;
            let headerIdx = -1;

            // Quét 10 dòng đầu để tìm tiêu đề
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const row = rows[i];
                if (!row) continue;
                
                for (let j = 0; j < row.length; j++) {
                    const cell = row[j] ? row[j].toString().trim().toUpperCase() : "";
                    
                    // Tìm cột Tên (Chấp nhận: Họ và tên, Họ tên, Tên, Name...)
                    if (cell.includes("HỌ VÀ TÊN") || cell === "HỌ TÊN" || cell === "TÊN" || cell === "NAME") {
                        nameColIdx = j;
                    }
                    // Tìm cột Lớp (Chấp nhận: Lớp, Class, Lớp học...)
                    if (cell === "LỚP" || cell.includes("LỚP HỌC") || cell === "CLASS") {
                        classColIdx = j;
                    }
                }
                // Nếu tìm thấy cột tên thì chốt đây là dòng tiêu đề
                if (nameColIdx !== -1) {
                    headerIdx = i;
                    break;
                }
            }

            if (headerIdx === -1 || nameColIdx === -1) {
                showToast("❌ Lỗi: Không tìm thấy cột 'Họ và tên' trong file!", "error");
                return;
            }

            // 3. Đọc dữ liệu từng dòng
            let count = 0;
            let newClassesFound = new Set(); // Danh sách các lớp mới tìm thấy

            for (let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                if(!row) continue;

                const rawName = row[nameColIdx];
                if (!rawName) continue;

                // --- Xử lý Lớp ---
                let targetClass = "";
                
                // Ưu tiên 1: Lấy từ cột "Lớp" trong file (nếu có)
                if (classColIdx !== -1 && row[classColIdx]) {
                    const cleanCls = smartCleanClass(row[classColIdx]);
                    if (cleanCls) {
                        targetClass = cleanCls;
                        newClassesFound.add(targetClass);
                    }
                }
                
                // Ưu tiên 2: Nếu file không có cột lớp (như file Lớp 11), dùng lớp đang chọn ở menu
                if (!targetClass && defaultClass) {
                    targetClass = defaultClass;
                }
                
                // Ưu tiên 3: Nếu không có gì cả
                if (!targetClass) targetClass = "Chưa xếp lớp";

                // --- Xử lý Tên ---
                const finalName = smartCleanName(rawName);
                
                if (finalName && finalName.length > 1) {
                    const key = `${finalName} - ${targetClass}`;
                    // Chỉ thêm nếu chưa có (tránh trùng lặp)
                    if (!students.includes(key) && !trash.includes(key)) {
                        students.push(key);
                        count++;
                    }
                }
            }

            // 4. Tự động cập nhật danh sách lớp vào hệ thống
            if (newClassesFound.size > 0) {
                newClassesFound.forEach(cls => {
                    let block = "Khác";
                    if (cls.includes("10")) block = "Khối 10";
                    else if (cls.includes("11")) block = "Khối 11";
                    else if (cls.includes("12")) block = "Khối 12";

                    if (!classData[block]) classData[block] = [];
                    if (!classData[block].includes(cls)) {
                        classData[block].push(cls);
                    }
                    classData[block].sort();
                });
                saveClasses(); // Lưu danh sách lớp mới
            }

            // 5. Hoàn tất
            $('studentFile').value = ""; // Reset input file
            saveData(); // Lưu danh sách học sinh
            
            // Nếu file Lớp 11 không có cột lớp, nhưng người dùng đã import thành công
            // Hệ thống sẽ tự chọn lớp đó để hiển thị
            if (!defaultClass && newClassesFound.size === 1) {
                const autoClass = [...newClassesFound][0];
                selectClass(autoClass);
            } else {
                renderList();
            }
            
            // Cập nhật lại menu chọn lớp
            renderCustomClassList();
            
            showToast(`✅ Đã nhập thành công ${count} học sinh!`, "success");

        } catch (err) {
            console.error(err);
            showToast("❌ Lỗi đọc file: " + err.message, "error");
        }
    };
    r.readAsArrayBuffer(f);
}
// ======================================================
// 5. THỜI KHÓA BIỂU (TKB)
// ======================================================
function switchTkbView(view) { 
    tkbViewMode = view; 
    document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active')); 
    if(view === 'teacher') $('btnTkbTeacher').classList.add('active'); 
    else if(view === 'student') $('btnTkbStudent').classList.add('active');
    else if(view === 'grad') $('btnTkbGrad').classList.add('active'); 
    backToTKBList();
}

// ============================================================
// KHÔI PHỤC TÍNH NĂNG HIỂN THỊ VÀ LỌC TKB (SEARCH)
// ============================================================

function renderTKBCards() {
    const container = document.getElementById('tkbListView');
    if(!container) return;
    container.innerHTML = ""; 
    
    document.getElementById('tkbDetailView').style.display = 'none';
    container.style.display = 'grid';
    
    let sourceData = {};
    if (tkbViewMode === 'teacher') sourceData = tkbData.teacher;
    else if (tkbViewMode === 'student') sourceData = tkbData.student;
    else if (tkbViewMode === 'grad') sourceData = tkbData.grad;

    if (!sourceData || Object.keys(sourceData).length === 0) {
        container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; opacity:0.5">Chưa có dữ liệu.</div>`;
        return;
    }

    const keys = Object.keys(sourceData).sort();

    keys.forEach(key => {
        // --- CHẾ ĐỘ GIÁO VIÊN ---
        if (tkbViewMode === 'teacher') {
            const profile = teacherProfiles[key] || {};
            
            // TẠO AVATAR GIÁO VIÊN (Dùng style 'Notionists' để tạo chân dung nghệ thuật)
            // Nếu chưa upload ảnh thật thì dùng ảnh này
            const defaultAvt = `https://api.dicebear.com/9.x/notionists/svg?seed=${encodeURIComponent(key)}&backgroundColor=e5e7eb&brows=variant10&lips=variant15`;
            
            const avatarUrl = profile.avatar || defaultAvt;
            const subject = profile.subject || "Giáo Viên Bộ Môn";
            const role = profile.role || "---";

            const card = document.createElement('div');
            card.className = "teacher-card";
            card.innerHTML = `
                <img src="${avatarUrl}" class="teacher-avatar" alt="GV">
                <div class="teacher-info">
                    <div class="teacher-name">${key}</div>
                    <div class="teacher-subject">📚 ${subject}</div>
                    <div class="teacher-role">💼 ${role}</div>
                </div>
                <div class="teacher-edit-btn" onclick="openTeacherEdit('${key}')">✏️</div>
            `;
            card.onclick = (e) => {
                if(!e.target.classList.contains('teacher-edit-btn')) {
                    openTKBDetail(key);
                }
            };
            container.appendChild(card);
        } 
        // --- CHẾ ĐỘ LỚP HỌC & ÔN THI ---
        else {
            const card = document.createElement('div');
            card.className = "tkb-card";
            
            // TẠO AVATAR LỚP HỌC (Dùng style 'Shapes' để tạo Logo/Huy hiệu trừu tượng)
            // Mỗi lớp sẽ có một hình khối và màu sắc riêng biệt dựa trên tên lớp
            const avatarUrl = `https://api.dicebear.com/9.x/shapes/svg?seed=${encodeURIComponent(key)}`;
            
            const subText = tkbViewMode === 'student' ? "Lớp Học" : "Ôn Thi";
            
            card.innerHTML = `
                <img src="${avatarUrl}" class="tkb-card-avatar" alt="Lớp" style="background: white; padding: 5px;"> 
                <div class="tkb-card-info">
                    <div class="tkb-card-title">${key}</div>
                    <div class="tkb-card-sub">${subText}</div>
                </div>
            `;
            card.onclick = () => openTKBDetail(key);
            container.appendChild(card);
        }
    });
}
// 2. Hàm LỌC (SEARCH) - Đây là phần bạn đang bị mất
function filterTKBCards() {
    // Lấy từ khóa tìm kiếm, chuyển về chữ thường
    const searchVal = document.getElementById('tkbSearch').value.toLowerCase().trim();
    
    // Lấy tất cả các thẻ card đang có
    const cards = document.getElementsByClassName('tkb-card');
    
    // Duyệt qua từng thẻ để ẩn/hiện
    for (let card of cards) {
        const text = card.innerText.toLowerCase();
        
        // Nếu từ khóa xuất hiện trong tên thẻ -> Hiện, ngược lại -> Ẩn
        if (text.includes(searchVal)) {
            card.style.display = "flex"; // Trả lại display flex để giữ căn giữa
        } else {
            card.style.display = "none";
        }
    }
}
function filterTKBCards() { renderTKBCards(); }
function openTKBDetail(target) { currentTkbTarget = target; $('tkbListView').style.display = 'none'; $('tkbControls').style.display = 'none'; $('tkbDetailView').style.display = 'block'; renderTKBTable(target); }
function backToTKBList() { currentTkbTarget = null; $('tkbListView').style.display = 'grid'; $('tkbDetailView').style.display = 'none'; $('tkbControls').style.display = 'flex'; renderTKBCards(); }

function renderTKBTable(target) {
    // 1. Xác định target (Nếu không truyền vào thì lấy target hiện tại)
    if (!target) target = currentTkbTarget;
    if (!target) return;
    
    const container = $('tkbContent');
    
    // 2. Lấy dữ liệu dựa trên chế độ xem (Teacher/Student/Grad)
    let data = {};
    if (tkbViewMode === 'teacher') data = tkbData.teacher[target];
    else if (tkbViewMode === 'student') data = tkbData.student[target];
    else if (tkbViewMode === 'grad') data = tkbData.grad[target];
    
    // Nếu không có dữ liệu thì gán rỗng để tránh lỗi
    if (!data) data = {};

    // 3. Thiết lập Tiêu đề và Mascot (Học sinh chăm ngoan)
    let mainTitle = "THỜI KHÓA BIỂU";
    let subTitle = "";
    let mascotHTML = ""; // Mặc định không có mascot

    if (tkbViewMode === 'teacher') {
        subTitle = `GIÁO VIÊN: ${target}`;
        // Giáo viên nghiêm túc -> Không hiện mascot (hoặc bạn có thể thêm icon khác nếu muốn)
    } 
    else if (tkbViewMode === 'student') {
        subTitle = `LỚP: ${target}`;
        // Thêm Mascot cho học sinh
    } 
    else { // Chế độ Ôn thi (grad)
        mainTitle = "LỊCH ÔN TẬP";
        subTitle = target;
    }

    // 4. Tính toán số ngày cần hiển thị (Có thứ 7, CN hay không?)
    let maxDay = 6; // Mặc định đến Thứ 7
    // Kiểm tra nếu có dữ liệu Chủ Nhật (8) hoặc Thứ 7 (7) mà muốn mở rộng
    if (data["7"] && Object.keys(data["7"]).length > 0) maxDay = 7;
    if (data["8"] && Object.keys(data["8"]).length > 0) maxDay = 8;

    // 5. Tạo khung HTML
    let html = `
    <div id="tkbCaptureArea" class="cute-tkb-wrapper">
        <div class="cute-header-section" style="position: relative; overflow: visible;">
            <div class="cute-icon-decor">📅</div>
            <div class="cute-title">${mainTitle}</div>
            <div class="cute-subtitle">${subTitle}</div>
            ${mascotHTML} </div>
        
        <table class="cute-table">
            <thead>
                <tr>
                    <th style="width:50px">Tiết</th>`;
    
    // Vòng lặp tạo tiêu đề Thứ (Thứ 2 -> CN)
    for(let d=2; d<=maxDay; d++) {
        html += `<th>${d===8 ? "CN" : "Thứ " + d}</th>`;
    }
    
    html += `   </tr>
            </thead>
            <tbody>`;

    // 6. Định nghĩa các buổi học (Sáng/Chiều)
    // Sáng: Tiết 1-5 (index 0-4), Chiều: Tiết 6-9 (index 5-8)
    const sessions = [
        { name: "☀️ BUỔI SÁNG", start: 0, end: 4 },
        { name: "🌥️ BUỔI CHIỀU", start: 5, end: 8 }
    ];

    sessions.forEach(sess => {
        // Hàng tiêu đề buổi
        html += `<tr class="cute-session-row">
                    <td colspan="${maxDay}">${sess.name}</td>
                 </tr>`;
        
        // Vòng lặp các tiết học trong buổi
        for(let i = sess.start; i <= sess.end; i++) {
            html += `<tr>
                        <td>${i + 1}</td>`; // Cột số tiết
            
            // Vòng lặp các ngày trong tuần
            for(let d = 2; d <= maxDay; d++) {
                const val = data[d]?.[i] || ""; // Lấy dữ liệu môn học
                
                // Kiểm tra highlight (Ô đã được bôi vàng trước đó chưa)
                let hlClass = "";
                if (tkbData.highlights && tkbData.highlights[`${target}_${d}_${i}`]) {
                    hlClass = "cute-important";
                }

                // Tạo ô dữ liệu (gắn sự kiện click để highlight)
                html += `<td onclick="toggleTKBHighlight('${target}', ${d}, ${i}, this)" class="${hlClass}">
                            <div class="cute-cell">${formatCellDisplay(val)}</div>
                         </td>`;
            }
            html += `</tr>`;
        }
    });

    html += `   </tbody>
        </table>
        
        <div style="margin-top:10px; text-align:right; font-size:10px; opacity:0.6; font-style:italic;">
            Trạm Vũ Trụ Yersin - Galaxy Edition
        </div>
    </div>`;

    // 7. Render ra màn hình
    container.innerHTML = html;
}
// --- HÀM IMPORT TKB TỪ EXCEL (FULL OPTION: TỰ ĐỘNG TUẦN, LỌC GVBM, FIX F5) ---
function processTKBExcel() {
    const file = $('tkbFile').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];

            // --- 1. XỬ LÝ MERGE CELL (GỘP Ô) ---
            if (sheet['!merges']) {
                sheet['!merges'].forEach(range => {
                    const topCellRef = XLSX.utils.encode_cell({c: range.s.c, r: range.s.r});
                    const cellVal = sheet[topCellRef] ? sheet[topCellRef].v : null;
                    if (cellVal) {
                        for (let R = range.s.r; R <= range.e.r; ++R) {
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const ref = XLSX.utils.encode_cell({c: C, r: R});
                                if (!sheet[ref]) sheet[ref] = { v: cellVal, t: 's' };
                            }
                        }
                    }
                });
            }

            // Chuyển Sheet thành JSON
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

            // ============================================================
            // [TÍNH NĂNG 1] TỰ ĐỘNG QUÉT TUẦN VÀ NGÀY ÁP DỤNG TỪ TIÊU ĐỀ
            // ============================================================
            let detectedWeek = null;
            let detectedDate = null;

            // Quét 10 dòng đầu tiên để tìm thông tin
            for (let i = 0; i < Math.min(json.length, 10); i++) {
                const rowStr = json[i].join(" ").toUpperCase();
                
                // Tìm chữ "TUẦN" (Ví dụ: TUẦN 15)
                const weekMatch = rowStr.match(/TUẦN\s*0?(\d+)/);
                if (weekMatch) detectedWeek = parseInt(weekMatch[1]);

                // Tìm chữ "TỪ NGÀY" (Ví dụ: TỪ NGÀY 15/12/2025)
                const dateMatch = rowStr.match(/TỪ NGÀY\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/);
                if (dateMatch) detectedDate = dateMatch[1];
            }

            // Cập nhật Tuần nếu tìm thấy
            if (detectedWeek) {
                if (typeof currentWeek !== 'undefined') currentWeek = detectedWeek;
                
                const titleEl = document.getElementById('headerWeekTitle');
                if (titleEl) titleEl.innerText = "TUẦN " + detectedWeek;
                
                const globalWeekInput = document.getElementById('globalWeek');
                if (globalWeekInput) globalWeekInput.value = detectedWeek;
                
                showToast(`📅 Đã phát hiện dữ liệu Tuần ${detectedWeek}`, "info");
            }

            // Cập nhật Ngày nếu tìm thấy
            if (detectedDate) {
                try {
                    const parts = detectedDate.split(/[\/\-]/);
                    const d = parseInt(parts[0]);
                    const m = parseInt(parts[1]) - 1;
                    const y = parseInt(parts[2]);
                    
                    const startDate = new Date(y, m, d);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // +6 ngày ra Chủ Nhật
                    
                    const startStr = `${startDate.getDate()}/${startDate.getMonth()+1}`;
                    const endStr = `${endDate.getDate()}/${endDate.getMonth()+1}`;
                    const dateRangeStr = `${startStr} - ${endStr}`;
                    
                    const dateInput = document.getElementById('headerWeekDate');
                    if (dateInput) {
                        dateInput.value = dateRangeStr;
                        if (typeof saveWeekDate === 'function') saveWeekDate(); 
                    }
                } catch (e) {
                    console.error("Lỗi tính ngày:", e);
                }
            }

            // --- 2. TÌM DÒNG TIÊU ĐỀ LỚP ---
            let headerRowIndex = -1;
            let classMap = {};
            for (let i = 0; i < Math.min(json.length, 30); i++) {
                const row = json[i];
                if (!row) continue;
                row.forEach((cell, idx) => {
                    if (!cell) return;
                    const str = cell.toString().trim().toUpperCase();
                    if (/^(10|11|12)[A-Z][0-9]?/.test(str)) {
                        classMap[idx] = str;
                        headerRowIndex = i;
                    }
                });
                if (headerRowIndex !== -1 && Object.keys(classMap).length > 0) break;
            }

            if (headerRowIndex === -1) {
                return showToast("❌ Lỗi: Không tìm thấy dòng tên lớp (10A1, 11B1...)", "error");
            }

            // --- 3. KHỞI TẠO DB ---
            let teacherDB = {};
            let studentDB = {};
            let gradDB = {}; 
            let currentDay = "";

            // --- 4. DUYỆT DỮ LIỆU TỪNG DÒNG ---
            for (let i = headerRowIndex + 1; i < json.length; i++) {
                const row = json[i];
                if (!row) continue;

                // Xử lý Cột Thứ
                let rawDay = row[0] ? row[0].toString().trim().toUpperCase() : "";
                if (rawDay) {
                    if (rawDay.includes("THỨ")) currentDay = rawDay.replace("THỨ", "").trim();
                    else if (["2","3","4","5","6","7"].includes(rawDay)) currentDay = rawDay;
                    else if (rawDay.includes("CN") || rawDay.includes("CHỦ NHẬT")) currentDay = "8";
                }
                if (!currentDay) continue;

                // Xử lý Cột Tiết
                let rawPeriod = row[2];
                if (!rawPeriod && row[1] && !isNaN(row[1]) && row[1] < 15) rawPeriod = row[1]; 
                if (!rawPeriod || isNaN(parseInt(rawPeriod))) continue;
                let currentPeriod = parseInt(rawPeriod) - 1;

                // Duyệt qua từng Cột Lớp
                for (let colIdx in classMap) {
                    const className = classMap[colIdx];
                    let cellContent = row[colIdx];
                    if (!cellContent && row[colIdx - 1] && (row[colIdx-1].toString().toUpperCase().includes("CHÀO CỜ") || row[colIdx-1].toString().toUpperCase().includes("TỰ HỌC"))) {
                        cellContent = row[colIdx - 1];
                    }
                    if (!cellContent) continue;
                    
                    const contentStr = cellContent.toString().trim();

                    // --- TRƯỜNG HỢP A: ÔN THI TỐT NGHIỆP ---
                    if (contentStr.toUpperCase().includes("ÔN THI TN") || contentStr.toUpperCase().includes("ÔN TỐT NGHIỆP")) {
                        if (!studentDB[className]) studentDB[className] = {};
                        if (!studentDB[className][currentDay]) studentDB[className][currentDay] = [];
                        studentDB[className][currentDay][currentPeriod] = "ÔN TẬP";

                        const gradInfo = (typeof parseGraduationContent === 'function') ? parseGraduationContent(contentStr) : [];
                        gradInfo.forEach(item => {
                            const targetClass = item.room || className;
                            if (!gradDB[targetClass]) gradDB[targetClass] = {};
                            if (!gradDB[targetClass][currentDay]) gradDB[targetClass][currentDay] = [];
                            const tName = (typeof smartCleanName === 'function') ? smartCleanName(item.teacher) : item.teacher;
                            const entry = `${item.subject}\n(${tName})`;
                            gradDB[targetClass][currentDay][currentPeriod] = entry;
                        });
                        continue;
                    }

                    // --- TRƯỜNG HỢP B: MÔN HỌC BÌNH THƯỜNG ---
                    const parsedInfo = (typeof parseCellContent === 'function') ? parseCellContent(contentStr) : [];
                    parsedInfo.forEach(info => {
                        let subject = info.subject;
                        let teacher = (typeof smartCleanName === 'function') ? smartCleanName(info.teacher) : info.teacher;

                        // Tự động điền môn từ hồ sơ GV (nếu có)
                        if (typeof teacherProfiles !== 'undefined') {
                            if ((!teacher || teacher.length < 2) && teacherProfiles[subject]) {
                                teacher = subject;
                                if (teacherProfiles[teacher].subject) subject = teacherProfiles[teacher].subject;
                            } else if (teacher && teacherProfiles[teacher] && teacherProfiles[teacher].subject) {
                                if (!subject || subject.trim().length < 2) subject = teacherProfiles[teacher].subject;
                            }
                        }

                        // Lưu vào DB Học Sinh
                        if (!studentDB[className]) studentDB[className] = {};
                        if (!studentDB[className][currentDay]) studentDB[className][currentDay] = [];
                        studentDB[className][currentDay][currentPeriod] = teacher ? `${subject}\n(${teacher})` : subject;

                        // [TÍNH NĂNG 2] LỌC BỎ CÁC TÊN "RÁC" (GVBM, GVCN...)
                        const BLACKLIST = ["GVBM", "GVCN", "GVTG", "SHCN", "SHTT", "CHÀO CỜ", "TỰ QUẢN", "SINH HOẠT"];
                        let isRealTeacher = true;

                        if (!teacher || teacher.trim().length < 2) {
                            isRealTeacher = false;
                        } else {
                            let tUpper = teacher.toUpperCase().trim();
                            if (BLACKLIST.includes(tUpper)) isRealTeacher = false;
                        }

                        // Chỉ lưu vào DB Giáo Viên nếu là GV thật
                        if (isRealTeacher) {
                            if (!teacherDB[teacher]) teacherDB[teacher] = {};
                            if (!teacherDB[teacher][currentDay]) teacherDB[teacher][currentDay] = [];
                            
                            let oldTData = teacherDB[teacher][currentDay][currentPeriod];
                            let tEntry = `${className} - ${subject}`;
                            if (!oldTData || !oldTData.includes(className)) {
                                teacherDB[teacher][currentDay][currentPeriod] = oldTData ? `${oldTData}, ${className}` : tEntry;
                            }
                        }
                    });
                }
            }

            // --- 5. LƯU VÀ CẬP NHẬT GIAO DIỆN ---
            tkbData.teacher = teacherDB;
            tkbData.student = studentDB;
            if(Object.keys(gradDB).length > 0) tkbData.grad = gradDB;

            // [TÍNH NĂNG 3] ĐỒNG BỘ NGAY VÀO LỊCH SỬ ĐỂ FIX LỖI F5
            if (typeof tkbHistory !== 'undefined' && typeof currentWeek !== 'undefined') {
                tkbHistory[currentWeek] = JSON.parse(JSON.stringify(tkbData));
                localStorage.setItem(LS_HISTORY, JSON.stringify(tkbHistory));
            }

            saveData(); // Lưu dữ liệu hiện tại
            showToast(`✅ Đã cập nhật TKB Tuần ${detectedWeek || 'mới'}!`, "success");
            
            // Vẽ lại giao diện
            if(typeof renderTKBCards === 'function') {
                renderTKBCards();
                switchTkbView('teacher');
            }
            $('tkbFile').value = ""; // Reset input file

        } catch (err) {
            console.error(err);
            showToast("❌ Lỗi đọc file: " + err.message, "error");
        }
    };
    reader.readAsArrayBuffer(file);
}
function processTKBGraduationExcel() {
    const file = $('tkbGradFile').files[0]; if (!file) return;
    const reader = new FileReader(); reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
            let gradDB = {}; let currentDay = ""; let classMap = {};
            for (let i = 0; i < json.length; i++) {
                const row = json[i]; if (!row || row.length === 0) continue;
                const firstCell = (row[0] || "").toString().trim().toLowerCase();
                if (firstCell.includes("thứ") || firstCell === "cn" || firstCell.includes("chủ nhật")) {
                    let num = firstCell.replace(/[^0-9]/g, ''); if (firstCell.includes("chủ nhật") || firstCell === "cn") num = "8";
                    if (num) currentDay = num;
                }
                let isHeaderRow = false; let tempMap = {};
                row.forEach((cell, idx) => {
                    if (!cell) return; const cStr = cell.toString().trim().toUpperCase();
                    if (cStr.startsWith("LỚP") || /12[A-Z]/.test(cStr)) {
                        const cleanName = cStr.replace("LỚP", "").trim(); tempMap[idx] = cleanName; isHeaderRow = true;
                    }
                });
                if (isHeaderRow) { classMap = tempMap; continue; }
                if (!currentDay || Object.keys(classMap).length === 0) continue;
                let periodVal = null;
                if (row[1] && !isNaN(row[1])) periodVal = row[1]; else if (row[0] && !isNaN(row[0]) && row[0] < 15) periodVal = row[0];
                if (!periodVal) continue;
                let periodIdx = parseInt(periodVal) - 1;
                for (let colIdx in classMap) {
                    const className = classMap[colIdx]; const cellContent = row[colIdx];
                    if (cellContent) {
                        const parsedInfo = parseCellContent(cellContent);
                        parsedInfo.forEach(info => {
                            const subject = info.subject; const teacher = info.teacher ? smartCleanName(info.teacher) : "";
                            if (!gradDB[className]) gradDB[className] = {}; if (!gradDB[className][currentDay]) gradDB[className][currentDay] = [];
                            let entry = teacher ? `${subject}\n(${teacher})` : subject; gradDB[className][currentDay][periodIdx] = entry;
                        });
                    }
                }
            }
            tkbData.grad = gradDB; saveData(); $('tkbGradFile').value = ""; 
            showToast(`✅ Đã cập nhật TKB Ôn TN cho ${Object.keys(gradDB).length} lớp!`, "success"); switchTkbView('grad');
        } catch (e) { console.error(e); showToast("Lỗi file: " + e.message, "error"); }
    }; reader.readAsArrayBuffer(file);
}

function parseCellContent(cellContent) {
    if (!cellContent) return []; 
    let str = cellContent.toString().trim();
    
    // Nếu là các ô đặc biệt không phải môn học
    if (["CHÀO CỜ", "SHCN", "TỰ HỌC", "SINH HOẠT", "ÔN TỐT NGHIỆP", "NGOẠI KHÓA"].some(s => str.toUpperCase().includes(s))) {
        return [{ subject: str, teacher: "" }];
    }

    // Tách các môn học (xử lý dấu xuống dòng hoặc dấu chấm phẩy)
    const items = str.split(/[\n;]+/); 
    const results = [];
    
    items.forEach(sub => { 
        sub = sub.trim(); 
        if(sub.length < 2) return; 
        
        let subjectName = sub;
        let teacherName = ""; 
        
        // Logic tách tên GV sau dấu gạch ngang cuối cùng
        const lastDash = sub.lastIndexOf('-'); 
        if (lastDash !== -1) { 
            subjectName = sub.substring(0, lastDash).trim(); 
            // Thêm replace ở đây để xóa rác ngay khi tách
            teacherName = sub.substring(lastDash + 1).replace(/[\/]+$/g, "").trim(); 
        } 
        
        results.push({ subject: subjectName, teacher: teacherName }); 
    });
    return results;
}
// Hàm tách chuỗi Ôn Thi Tốt Nghiệp phức tạp
// Input: "ÔN THI TN - Lý (T Tuấn - C1); Anh (Cô Tố Uyên - PH), Hóa (Thầy Đăng - TN Lý)"
function parseGraduationContent(str) {
    if (!str) return [];
    
    // Xóa tiền tố "ÔN THI TN -" hoặc "ÔN THI TN"
    let cleanStr = str.replace(/^ÔN THI TN\s*[-–]?\s*/i, "").trim();
    
    // Tách các môn bằng dấu chấm phẩy (;) hoặc dấu phẩy (,)
    // Regex này tách dựa trên dấu phân cách, nhưng cẩn thận với dấu phẩy bên trong ngoặc đơn (nếu có)
    const parts = cleanStr.split(/[;,]\s*(?![^()]*\))/); 
    
    const results = [];
    
    parts.forEach(part => {
        part = part.trim();
        if (part.length < 2) return;
        
        // Mẫu mong đợi: "Môn (Giáo Viên - Lớp/Phòng)"
        // Ví dụ: "Lý (T Tuấn - C1)"
        // Regex bắt: Tên Môn + Nội dung trong ngoặc
        const match = part.match(/^([^(]+)\(([^)]+)\)$/);
        
        if (match) {
            const subject = match[1].trim(); // "Lý"
            const inner = match[2].trim();   // "T Tuấn - C1"
            
            // Tách Giáo viên và Lớp trong ngoặc
            const innerParts = inner.split(/[-–]/);
            let teacher = innerParts[0] ? innerParts[0].trim() : "";
            let room = innerParts[1] ? innerParts[1].trim() : "";
            
            results.push({ subject, teacher, room });
        } else {
            // Trường hợp không đúng định dạng chuẩn, cố gắng lấy môn
            results.push({ subject: part, teacher: "", room: "" });
        }
    });
    
    return results;
}
function saveTkbCell(target, day, period, val) { if (!tkbData[tkbViewMode][target]) tkbData[tkbViewMode][target] = {}; if (!tkbData[tkbViewMode][target][day]) tkbData[tkbViewMode][target][day] = []; tkbData[tkbViewMode][target][day][period] = val.trim(); saveData(); }
function getMainSubject(teacherName) { if (!tkbData.teacher || !tkbData.teacher[teacherName]) return "Giáo Viên"; const subjectCounts = {}; Object.values(tkbData.teacher[teacherName]).forEach(day => { Object.values(day).forEach(val => { if (!val) return; val.split(',').forEach(entry => { const parts = entry.split(' - '); if (parts.length >= 2) { const subj = parts[1].trim(); if(["SHCN", "Chào cờ", "Tự học", "SHTT"].some(x => subj.includes(x))) return; subjectCounts[subj] = (subjectCounts[subj] || 0) + 1; } }); }); }); let bestSubj = ""; let maxCount = 0; for (const [s, c] of Object.entries(subjectCounts)) { if (c > maxCount) { maxCount = c; bestSubj = s; } } return bestSubj || "Lịch Dạy"; }
function getSubjectColorClass(text) { if(!text) return ""; const t = text.toLowerCase(); if(t.includes("toán")) return "subj-math"; if(t.includes("văn")) return "subj-lit"; if(t.includes("anh")) return "subj-eng"; if(t.includes("lý")||t.includes("hóa")||t.includes("sinh")) return "subj-sci"; if(t.includes("sử")||t.includes("địa")||t.includes("gdcd")) return "subj-soc"; if(t.includes("thể dục")||t.includes("qp")) return "subj-pe"; return ""; }
function checkCurrentPeriod() { document.querySelectorAll('.now-active').forEach(el => el.classList.remove('now-active')); const now = new Date(); const day = now.getDay() + 1; if(day < 2 || day > 8) return; const mins = now.getHours() * 60 + now.getMinutes(); const periods = [{p:0,s:420,e:465},{p:1,s:470,e:515},{p:2,s:520,e:565},{p:3,s:575,e:620},{p:4,s:625,e:670},{p:5,s:765,e:810},{p:6,s:815,e:860},{p:7,s:865,e:910},{p:8,s:920,e:965},{p:9,s:970,e:1015}]; periods.forEach(sl => { if(mins >= sl.s && mins <= sl.e) { const c = document.getElementById(`tkb-cell-${day}-${sl.p}`); if(c) c.classList.add('now-active'); } }); }
function captureTKB() { 
    const el = document.getElementById("tkbCaptureArea"); 
    if(!el) return; 

    // Hiển thị thông báo đang xử lý
    showToast("Đang xử lý ảnh...", "info");

    html2canvas(el, { 
        backgroundColor: "#e0fbfd", // QUAN TRỌNG: Ép màu nền xanh nhạt chuẩn
        scale: 2,                   // Tăng độ nét lên gấp đôi
        useCORS: true,              // Hỗ trợ tải icon/ảnh từ nguồn ngoài
        logging: false
    }).then(canvas => { 
        const link = document.createElement("a"); 
        link.download = `TKB_Yersin_${new Date().getTime()}.png`; 
        link.href = canvas.toDataURL("image/png"); 
        link.click(); 
        showToast("Đã lưu ảnh TKB!", "success");
    }).catch(err => {
        console.error(err);
        showToast("Lỗi khi chụp ảnh!", "error");
    }); 
}function processTKBImage() { const f = $('tkbImage').files[0]; if(!f) return; $('tkbOcrResult').style.display = 'block'; $('ocrText').value = "Đang quét..."; Tesseract.recognize(f, 'vie').then(({ data: { text } }) => { $('ocrText').value = text; showToast("Quét ảnh xong!", "success"); }).catch(e => { $('ocrText').value = "Lỗi: " + e; }); }

// ======================================================
// 6. PROFILE & HÀNH KIỂM/ĐIỂM SỐ
// ======================================================
function getHKData(id) { 
    if (!db.hk[id]) db.hk[id] = { base: 80, history: [], note: "" }; 
    const d = db.hk[id]; const base = parseFloat(d.base); 
    let p = 0, m = 0, violationCount = 0; 
    d.history.forEach(h => { if(h.val > 0) p += h.val; else { m += Math.abs(h.val); violationCount++; }}); 
    let final = Math.max(0, Math.min(100, base + p - m)); 
    return { base, plus: p, minus: m, final, history: d.history, violationCount, note: d.note || "" }; 
}
function calculateWallet(id) { if (!db.acad[id]) db.acad[id] = { history: [], note: "" }; let b = 0; db.acad[id].history.forEach(h => b += h.val); return b; }
// Tìm và thay thế hàm getGrades cũ bằng hàm này:
function getGrades(id) {
    if (!grades[id]) grades[id] = {};
    if (!grades[id][currentSubject]) grades[id][currentSubject] = { 
        // HK1 (5 cột)
        tx1:'', tx2:'', tx3:'', tx4:'', tx5:'', 
        // HK2 (5 cột)
        tx6:'', tx7:'', tx8:'', tx9:'', tx10:'', 
        // Điểm thi
        gk1:'', gk2:'', ck1:'', ck2:'' 
    };
    return grades[id][currentSubject];
}
function openProfile(s) { 
    localStorage.setItem('yersin_saved_profile', s);
    currentID = s; 
    const [n, c] = s.split(" - "); 
    $('pName').innerText = n; 
    $('pClass').innerText = c || 'N/A'; 
    
    // --- [LOGIC MỚI] ĐỒNG BỘ AVATAR VỚI BÊN NGOÀI ---
    const hkData = getHKData(s);
    const score = hkData.final;

    // 1. Logic chọn Emoji & Màu nền (Copy từ renderList)
    let emojiIcon = "😐"; 
    let bgStyle = "#2a2a4a"; 

    if (score >= 80) { emojiIcon = "😎"; bgStyle = "linear-gradient(135deg, #00b09b, #96c93d)"; } 
    else if (score >= 65) { emojiIcon = "🙂"; bgStyle = "linear-gradient(135deg, #4facfe, #00f2fe)"; } 
    else if (score >= 50) { emojiIcon = "🤔"; bgStyle = "linear-gradient(135deg, #f6d365, #fda085)"; } 
    else { emojiIcon = "😴"; bgStyle = "linear-gradient(135deg, #f43f5e, #33001b)"; }

    // 2. Tạo HTML Avatar
    let avatarHTML = "";
if (avatars[s]) {
    avatarHTML = `<img src="${avatars[s]}" class="avatar-img" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
} else {
    // Cập nhật hiển thị trong cửa sổ chi tiết
    const autoSrc = getAutoAvatar(n); // n là tên học sinh lấy từ dòng trên
    avatarHTML = `<img src="${autoSrc}" class="avatar-img" style="width:100%; height:100%; border-radius:50%; object-fit:cover; background:${bgStyle}; padding:3px; box-sizing:border-box">`;
}
    // 3. Gán vào khung trong Modal (Kèm hiệu ứng Galaxy)
    const container = $('profileAvatarContainer');
    if(container) {
        container.innerHTML = `
            ${avatarHTML}
            <div class="galaxy-system"><div class="g-layer-1"></div><div class="g-dust"></div></div>
        `;
    }
    // ------------------------------------------------

    currentSubject = 'math'; 
    const win = $('pwWindow'); 
    if (currentMode === 'hk') { 
        win.style.borderColor = "var(--neon-purple)"; 
        win.style.boxShadow = "0 0 100px rgba(189, 0, 255, 0.3)"; 
        renderHKProfile(); 
    } else { 
        win.style.borderColor = "var(--neon-gold)"; 
        win.style.boxShadow = "0 0 100px rgba(251, 191, 36, 0.3)"; 
        renderAcadProfile(); 
    } 
    $('profileModal').style.display = 'flex'; 
    // 👇 THÊM ĐOẠN NÀY VÀO CUỐI CÙNG CỦA HÀM openProfile
    const savedScale = localStorage.getItem('yersin_modal_scale');
    if(savedScale) {
        const slider = document.getElementById('modalZoomSlider');
        if(slider) slider.value = savedScale;
        resizeProfileModal(savedScale);
    } else {
        // Mặc định là 1
        resizeProfileModal(1);
    }
}
// --- CẬP NHẬT 2: SỬA HÀM RENDER ĐỂ HỖ TRỢ GIAO DIỆN ACAD ---
// --- PHẦN 2: XỬ LÝ HIỂN THỊ NÚT ---
function renderQuickButtonsHTML(type) {
    if(!quickButtons[type]) quickButtons[type] = []; // Tạo mảng rỗng nếu chưa có
    
    return quickButtons[type].map((btn, index) => {
        // Nếu đang sửa thì nút gọi hàm sửa, nếu không thì gọi hàm cộng điểm
        const action = isEditQuickMode ? `editQuickBtn('${type}', ${index})` : `preScore(${btn.val}, '${btn.text}')`;
        const shakeClass = isEditQuickMode ? "shake-anim" : "";
        
        // Chọn màu sắc (Class CSS) dựa trên loại nút
        let themeClass = 'bad';
        if (type === 'good') themeClass = 'good'; // Hạnh kiểm tốt (Xanh lá)
        else if (type === 'acadGood') themeClass = 'acad'; // Điểm cộng học tập (Vàng)
        else if (type === 'acadBad') themeClass = 'bad';   // Điểm trừ (Đỏ)
        
        // Nếu điểm phạt nặng (<= -2) thì dùng màu đỏ đậm
        if (btn.val <= -2) themeClass = 'heavy-bad';

        return `<div class="holo-card ${themeClass} ${shakeClass}" onclick="${action}">
            <span class="hc-icon">${btn.icon || '📝'}</span>
            <span class="hc-label">${btn.text}<br><small>${btn.val > 0 ? '+' : ''}${btn.val}</small></span>
            ${isEditQuickMode ? '<span style="position:absolute;top:2px;right:2px;font-size:10px;background:rgba(0,0,0,0.5);border-radius:50%;width:15px;height:15px;display:flex;align-items:center;justify-content:center">✏️</span>' : ''}
        </div>`;
    }).join('');
}

function renderHKProfile() {
    const d = getHKData(currentID);
    
    // Xử lý Badge vi phạm
    const badge = document.getElementById('pViolationBadge');
    if (badge) {
        if (d.violationCount > 0) {
            badge.style.display = 'block';
            badge.innerHTML = `<span style="background:rgba(244, 63, 94, 0.15); color:#f43f5e; border:1px solid #f43f5e; padding:2px 8px; border-radius:20px; font-weight:bold; font-size:10px; display:flex; align-items:center; gap:5px;">⚠️ Vi phạm: ${d.violationCount}</span>`;
        } else {
            badge.style.display = 'none';
            badge.innerHTML = '';
        }
    }

    // Tính toán xếp loại và màu sắc
    let rank = "Chưa Đạt";
    if (d.final >= 80) rank = "Tốt"; else if (d.final >= 65) rank = "Khá"; else if (d.final >= 50) rank = "Đạt";
    
    let color = "#f43f5e";
    if (d.final >= 80) color = "#4ade80"; else if (d.final >= 65) color = "#22d3ee"; else if (d.final >= 50) color = "#fbbf24";

    // Tạo danh sách lịch sử (Timeline)
    let timeline = d.history.slice().reverse().map(h => `
        <div class="timeline-item ${h.val>0?'pos':'neg'}" style="padding: 6px 0; border-bottom:1px dashed rgba(255,255,255,0.05);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="t-desc" style="font-size:12px; font-weight:500;">${h.desc}</div>
                <div class="t-val" style="font-size:12px; font-weight:bold; color:${h.val>0?'var(--neon-green)':'var(--neon-red)'}">
                    ${h.val>0?'+':''}${h.val}
                </div>
            </div>
            <div class="t-time" style="font-size:9px; opacity:0.6; margin-top:2px;">${new Date(h.time).toLocaleString()}</div>
        </div>
    `).join('') || "<div style='opacity:0.5;text-align:center;margin-top:20px;font-size:11px'>Chưa có dữ liệu ghi nhận</div>";

    // Cập nhật CSS Variable cho vòng tròn
    $('leftDynamicContent').style.setProperty('--score-color', color);
    $('leftDynamicContent').style.setProperty('--score-pct', `${d.final}%`);

    // --- CẬP NHẬT HTML: ĐIỂM Ở TRÊN, LỊCH SỬ Ở DƯỚI ---
    $('leftDynamicContent').innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; width:100%;">
            <div class="score-circle-container">
                <div class="score-circle"></div>
                <div class="score-inner">
                    <div class="score-value" style="color:${currentMode==='hk' ? 'white' : 'var(--text)'}">${d.final.toFixed(1)}</div>
                    <div class="score-label">ĐIỂM TỔNG</div>
                </div>
            </div>
            <div class="rank-badge" style="background:${color}15; color:${color}; border:1px solid ${color}; box-shadow: 0 0 10px ${color}40;">
                Xếp loại: ${rank}
            </div>
        </div>
        
        <div class="timeline-container">
            <div style="font-size:11px; font-weight:bold; color:var(--neon-blue); margin-bottom:8px; display:flex; align-items:center; gap:5px;">
                <span>📜</span> LỊCH SỬ GHI NHẬN
            </div>
            ${timeline}
        </div>
    `;

    // Phần bên phải (Nút bấm) - Giữ nguyên logic các nút nhỏ
    $('actionArea').innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
            <h3 style="margin:0; color:var(--neon-blue); font-size:13px; text-transform:uppercase; letter-spacing:1px;">⚡ Tác vụ nhanh</h3>
            <button class="btn ${isEditQuickMode ? "green" : "purple"}" style="font-size:10px; padding: 4px 12px; border-radius:15px" onclick="toggleQuickEdit()">
                ${isEditQuickMode ? "Lưu Nút" : "Sửa Nút"}
            </button>
        </div>
        
        <div class="action-columns" style="gap:10px;">
            <div class="panel-section">
                <div class="section-label" style="color:var(--neon-green); font-size:10px; margin-bottom:4px;">CỘNG ĐIỂM (+)</div>
                <div class="holo-grid" id="gridGood">
                    ${renderQuickButtonsHTML('good')}
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-label" style="color:var(--neon-red); font-size:10px; margin-bottom:4px;">TRỪ ĐIỂM (-)</div>
                <div class="holo-grid" id="gridBad">
                    ${renderQuickButtonsHTML('bad')}
                </div>
            </div>
        </div>

        <button class="btn" style="width:100%; border:1px dashed rgba(255,255,255,0.2); background:rgba(255,255,255,0.02); margin:8px 0; padding:6px; font-size:11px; border-radius:6px;" onclick="openCustomScore()">
            + Tùy chọn khác
        </button>
        
        <div style="margin-top: auto; background:rgba(0,0,0,0.2); padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.05)">
            <textarea class="teacher-note-area" rows="2" style="background:transparent; border:none; width:100%; resize:none; color:var(--text); font-size:11px; outline:none;" placeholder="Ghi chú giáo viên..." onblur="saveTeacherNote(this.value)">${d.note}</textarea>
        </div>
    `;
}
// --- CẬP NHẬT 3: GIAO DIỆN SỔ ĐIỂM CÓ NÚT SỬA ---
// --- PHẦN 3: GIAO DIỆN SỔ ĐIỂM (CÓ NÚT SỬA) ---
// --- CẬP NHẬT: GIAO DIỆN SỔ ĐIỂM (ĐÃ XÓA NHẬN XÉT) ---
// Tìm và thay thế hàm renderAcadProfile cũ bằng hàm này:
function renderAcadProfile() {
    const w = calculateWallet(currentID);
    const g = getGrades(currentID);

    // --- 1. CỘT TRÁI (THÔNG TIN KHO ĐIỂM) ---
    // Giữ nguyên phần hiển thị lịch sử
    let timeline = db.acad[currentID].history.map((h, index) => ({...h, idx: index})).reverse().map(h => 
        `<div class="timeline-item" style="border-color:${h.val<0?'var(--neon-red)':'var(--neon-gold)'}">
            <div class="t-desc" style="padding-right:20px">${h.desc}</div>
            <div class="t-val" style="color:${h.val>0?'#fbbf24':'#f43f5e'}">${h.val>0?'+':''}${h.val}</div>
            <div class="t-time">${new Date(h.time).toLocaleString()}</div>
            <span onclick="deleteAcadHistory(${h.idx})" style="position:absolute; top:5px; right:5px; cursor:pointer; color:rgba(255,255,255,0.3); font-size:12px; font-weight:bold" onmouseover="this.style.color='var(--neon-red)'" onmouseout="this.style.color='rgba(255,255,255,0.3)'">✕</span>
        </div>`
    ).join('') || "<div style='opacity:0.5;text-align:center'>Trống</div>";

    $('leftDynamicContent').style.setProperty('--score-color', '#fbbf24');
    $('leftDynamicContent').style.setProperty('--score-pct', `${Math.min(100, Math.abs(w)*5)}%`);
    
    $('leftDynamicContent').innerHTML = `
        <div class="score-circle-container">
            <div class="score-circle"></div>
            <div class="score-inner">
                <div class="score-value" style="color:#fbbf24">${w > 0 ? '+' : ''}${w.toFixed(1)}</div>
                <div class="score-label">KHO ĐIỂM</div>
            </div>
        </div>
        <div class="timeline-container">${timeline}</div>
    `;

    // Dropdown môn học
    let opts = '';
    for(const [k,v] of Object.entries(SUBJECTS)) opts += `<option value="${k}" ${k===currentSubject?'selected':''}>${v}</option>`;

    // --- 2. CỘT PHẢI (NỘI DUNG CHÍNH) ---
    
    // --- [TAB KHO ĐIỂM] ---
    const bankContent = `
    <div style="animation: fadeIn 0.3s;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <div class="section-label" style="color:var(--neon-gold); font-size:13px">⭐ Tích Lũy (+Điểm)</div>
            <button class="btn ${isEditQuickMode ? "green" : "purple"}" style="font-size:10px; padding: 4px 8px; border-color:var(--neon-gold); color:var(--neon-gold)" onclick="toggleQuickEditAcad()">
                ${isEditQuickMode ? "✅ Xong" : "✏️ Sửa"}
            </button>
        </div>
        <div class="holo-grid" id="gridAcadGood" style="margin-bottom:20px">${renderQuickButtonsHTML('acadGood')}</div>
        
        <div class="section-label" style="color:var(--neon-red); font-size:13px">⚠️ Trừ Điểm (-Điểm)</div>
        <div class="holo-grid" id="gridAcadBad">${renderQuickButtonsHTML('acadBad')}</div>

        <button class="btn" style="width:100%; border:1px dashed rgba(255,255,255,0.2); background:rgba(255,255,255,0.02); margin:10px 0; padding:8px; font-size:12px; color:var(--neon-blue);" onclick="openCustomScore()">
            + Thêm mục mới / Tùy chọn khác
        </button>

        <div class="panel-section" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid var(--neon-gold); margin-top:20px;">
            <div class="section-label" style="color:var(--neon-gold); display:flex; align-items:center; gap:5px">
                <span>🔄</span> Quy Đổi Kho Điểm -> Sổ Điểm
            </div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:10px">
                <select id="transferTarget" class="search-box" style="width:110px; background:rgba(0,0,0,0.3); border-color:var(--neon-gold); color:var(--text)">
                    <option value="tx1">TX 1</option><option value="tx2">TX 2</option><option value="tx3">TX 3</option><option value="tx4">TX 4</option><option value="tx5">TX 5</option>
                </select>
                <input id="transferAmount" type="number" class="search-box" placeholder="Điểm..." style="flex:1; background:rgba(0,0,0,0.3); border-color:var(--neon-gold); color:var(--text)">
                <button class="btn green" style="background:var(--neon-gold); color:black; border:none; font-weight:bold" onclick="executeTransfer()">CHUYỂN</button>
            </div>
        </div>
    </div>`;

    // --- [TAB SỔ ĐIỂM] (Giữ nguyên logic 5 cột TX như bạn đã yêu cầu trước đó) ---
    const gradeContent = `
    <div style="animation: fadeIn 0.3s;">
        <div class="section-label" style="color:var(--neon-blue); margin-bottom:5px">Môn học:</div>
        <select style="width:100%; margin-bottom:20px; background:rgba(0,0,0,0.3); border:1px solid var(--neon-blue); color:var(--neon-blue); font-weight:bold; padding:10px" class="search-box" onchange="switchSubject(this.value)">${opts}</select>
        
        <div class="section-label" style="color:var(--neon-cyan); margin-top:10px; border-bottom:2px solid var(--neon-cyan); padding-bottom:5px; font-weight:900">HỌC KỲ 1</div>
        <div style="display:flex; gap:10px; margin-top:10px; overflow-x:auto; padding-bottom:5px">
            ${renderGradeCard('tx1', 'TX 1', 'var(--neon-cyan)', g.tx1)}
            ${renderGradeCard('tx2', 'TX 2', 'var(--neon-cyan)', g.tx2)}
            ${renderGradeCard('tx3', 'TX 3', 'var(--neon-cyan)', g.tx3)}
            ${renderGradeCard('tx4', 'TX 4', 'var(--neon-cyan)', g.tx4)}
            ${renderGradeCard('tx5', 'TX 5', 'var(--neon-cyan)', g.tx5)}
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
            ${renderGradeCard('gk1', 'Giữa Kỳ 1', 'var(--neon-purple)', g.gk1)}
            ${renderGradeCard('ck1', 'Cuối Kỳ 1', 'var(--neon-red)', g.ck1)}
        </div>

        <div class="section-label" style="color:var(--neon-gold); margin-top:30px; border-bottom:2px solid var(--neon-gold); padding-bottom:5px; font-weight:900">HỌC KỲ 2</div>
        <div style="display:flex; gap:10px; margin-top:10px; overflow-x:auto; padding-bottom:5px">
            ${renderGradeCard('tx6', 'TX 1', 'var(--neon-gold)', g.tx6)}
            ${renderGradeCard('tx7', 'TX 2', 'var(--neon-gold)', g.tx7)}
            ${renderGradeCard('tx8', 'TX 3', 'var(--neon-gold)', g.tx8)}
            ${renderGradeCard('tx9', 'TX 4', 'var(--neon-gold)', g.tx9)}
            ${renderGradeCard('tx10', 'TX 5', 'var(--neon-gold)', g.tx10)}
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
            ${renderGradeCard('gk2', 'Giữa Kỳ 2', 'var(--neon-purple)', g.gk2)}
            ${renderGradeCard('ck2', 'Cuối Kỳ 2', 'var(--neon-red)', g.ck2)}
        </div>
        
        <div style="margin-top:30px; font-size:11px; opacity:0.6; text-align:center; font-style:italic">
            * Nhập điểm trực tiếp vào ô, hệ thống tự động lưu.
        </div>
    </div>
    `;

    $('actionArea').innerHTML = `
    <div style="display:flex; flex-direction:column; height:100%;">
        <div class="acad-tab-nav">
            <div class="acad-tab-btn tab-bank ${currentAcadTab === 'bank' ? 'active' : ''}" onclick="switchAcadTab('bank')"> 📦 Kho Điểm </div>
            <div class="acad-tab-btn tab-grade ${currentAcadTab === 'grade' ? 'active' : ''}" onclick="switchAcadTab('grade')"> 📘 Sổ Điểm </div>
        </div>
        <div style="flex:1; overflow-y:auto; padding-right:5px;">
            ${currentAcadTab === 'bank' ? bankContent : gradeContent}
        </div>
    </div>`;
}

// Tìm và thay thế hàm renderGradeCard cũ:
function renderGradeCard(key, label, color, val) {
    return `
    <div class="grade-card" style="border-color:${color}">
        <div class="grade-label" style="color:${color}">${label}</div>
        <input type="number" class="grade-input" 
            style="color:${color}" 
            value="${val!==undefined?val:''}" 
            min="0" max="10" 
            placeholder="-"
            oninput="if(this.value > 10) this.value = 10; if(this.value < 0) this.value = 0;"
            onchange="saveGrade('${key}', this.value)">
    </div>`;
}
// Tìm và thay thế hàm saveGrade cũ:
function saveGrade(key, val) {
    if (!currentID || !currentSubject) return;

    // Chuyển giá trị về số để kiểm tra
    let numVal = parseFloat(val);

    // Xử lý giới hạn 0 - 10
    if (numVal > 10) numVal = 10;
    if (numVal < 0) numVal = 0;

    // Nếu ô trống thì giữ nguyên rỗng, ngược lại lưu số đã chuẩn hóa
    const finalVal = (val === "" || isNaN(numVal)) ? "" : numVal;

    // Lưu vào biến dữ liệu chính
    if (!grades[currentID]) grades[currentID] = {};
    if (!grades[currentID][currentSubject]) grades[currentID][currentSubject] = {};
    grades[currentID][currentSubject][key] = finalVal;

    // Cập nhật lại giao diện ngay lập tức nếu giá trị bị sửa đổi (VD: nhập 15 -> tự sửa thành 10)
    if (val != finalVal && val !== "") {
        renderAcadProfile(); 
    }
    
    saveData(); // Lưu xuống LocalStorage
}
// Hàm hỗ trợ chuyển Tab (Thêm mới)
function switchAcadTab(tabName) {
    currentAcadTab = tabName;
    renderAcadProfile();
}

// Cập nhật lại hàm renderGradeCell để đẹp hơn (có placeholder)
function renderGradeCell(v, f, placeholder) { 
    return `<div class="input-wrapper" style="margin-bottom:5px">
                <input class="holo-input" type="number" placeholder="${placeholder}" value="${v}" onchange="saveGrade(currentSubject,'${f}',this.value)" style="width:100%; text-align:center; padding:8px; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); border-radius:6px; color:white;">
            </div>`; 
}
// Thêm hàm helper nhỏ này vào ngay dưới hàm renderAcadProfile
function toggleQuickEditAcad() { isEditQuickMode = !isEditQuickMode; renderAcadProfile(); }

function toggleQuickEdit() { isEditQuickMode = !isEditQuickMode; renderHKProfile(); }
// --- LOGIC CHỈNH SỬA NÚT MỚI (GIAO DIỆN ĐẸP) ---
// --- BỔ SUNG LOGIC CHỈNH SỬA NÚT ---
let curEditType = null;
let curEditIdx = -1;

function editQuickBtn(type, index) {
    // Chỉ hoạt động khi đang ở chế độ sửa
    if (!isEditQuickMode) return;
    
    curEditType = type;
    curEditIdx = index;
    
    // Lấy dữ liệu nút hiện tại
    const btnData = quickButtons[type][index];
    
    // Đổ dữ liệu vào Modal
    document.getElementById('editBtnName').value = btnData.text;
    document.getElementById('editBtnVal').value = btnData.val;
    
    // Hiện Modal
    document.getElementById('editBtnModal').style.display = 'flex';
    document.getElementById('editBtnName').focus();
}
function saveButtonEdit() {
    const newName = document.getElementById('editBtnName').value.trim();
    const newVal = parseFloat(document.getElementById('editBtnVal').value);
    
    if (!newName || isNaN(newVal)) {
        // Thay showToast bằng alert nếu showToast chưa sẵn sàng, 
        // nhưng ở đây dùng showToast cho đồng bộ
        if(typeof showToast === 'function') showToast("Vui lòng nhập đầy đủ thông tin!", "error");
        else alert("Vui lòng nhập tên và điểm!");
        return;
    }
    
    // Cập nhật dữ liệu vào mảng
    quickButtons[curEditType][curEditIdx].text = newName;
    quickButtons[curEditType][curEditIdx].val = newVal;
    
    saveData(); // Lưu lại
    
    // Vẽ lại giao diện tương ứng (Hạnh kiểm hoặc Sổ điểm)
    if (currentMode === 'hk') renderHKProfile();
    else renderAcadProfile();
    
    // Đóng modal và thông báo
    document.getElementById('editBtnModal').style.display = 'none';
    if(typeof showToast === 'function') showToast("Đã lưu thay đổi!", "success");
}
function deleteButtonEdit() {
    if (confirm("Bạn chắc chắn muốn xóa nút này vĩnh viễn?")) {
        // Xóa nút khỏi danh sách
        quickButtons[curEditType].splice(curEditIdx, 1);
        
        saveData(); // Lưu lại
        
        // Vẽ lại giao diện
        if (currentMode === 'hk') renderHKProfile();
        else renderAcadProfile();
        
        document.getElementById('editBtnModal').style.display = 'none';
        if(typeof showToast === 'function') showToast("Đã xóa nút!", "info");
    }
}
function deleteAcadHistory(index) { if(confirm("Xóa dòng này?")) { db.acad[currentID].history.splice(index, 1); saveData(); renderAcadProfile(); renderList(); } }
function executeTransfer() { const targetCol = $('transferTarget').value; const amount = parseFloat($('transferAmount').value); if (isNaN(amount) || amount === 0) return showToast("Vui lòng nhập số điểm!", "error"); const currentWallet = calculateWallet(currentID); if (amount > 0 && currentWallet < amount) { if(!confirm(`Kho điểm (${currentWallet}) thấp hơn mức chuyển (${amount}). Kho sẽ bị âm. Tiếp tục?`)) return; } db.acad[currentID].history.push({ val: -amount, desc: `Quy đổi vào ${targetCol.toUpperCase()}`, time: new Date() }); if (!grades[currentID]) grades[currentID] = {}; if (!grades[currentID][currentSubject]) grades[currentID][currentSubject] = { tx1:'', tx2:'', tx3:'', tx4:'', gk1:'', gk2:'', ck1:'', ck2:'' }; let currentGrade = parseFloat(grades[currentID][currentSubject][targetCol]) || 0; let newGrade = currentGrade + amount; if (newGrade > 10) { showToast("Điểm > 10. Hệ thống sẽ giữ mức 10.", "info"); newGrade = 10; } grades[currentID][currentSubject][targetCol] = newGrade; saveData(); renderAcadProfile(); renderList(); showToast("Quy đổi thành công!", "success"); $('transferAmount').value = ""; }
function renderGradeCell(v, f) { return `<td><div class="input-wrapper"><input class="holo-input" type="number" value="${v}" onchange="saveGrade(currentSubject,'${f}',this.value)"></div></td>`; }
function switchSubject(v) { currentSubject = v; renderAcadProfile(); }
function saveGrade(s,f,v) { if(!grades[currentID]) grades[currentID]={}; if(!grades[currentID][s]) grades[currentID][s]={}; grades[currentID][s][f]=v; saveData(); }
function updateBaseScore(v) { if(!isNaN(parseFloat(v))) { db.hk[currentID].base = parseFloat(v); saveData(); renderHKProfile(); renderList(); }}

function preScore(v, d) {
    const currentDB = currentMode === 'hk' ? db.hk : db.acad; const hist = currentDB[currentID] ? currentDB[currentID].history : [];
    let count = 0, finalVal = v, warning = "";
    if (currentMode === 'hk' && v < 0) { hist.forEach(item => { if (item.desc === d) count++; }); if(count>0) { finalVal = v * (count+1); warning = `⚠️ TÁI PHẠM LẦN ${count+1}: Phạt nhân ${count+1} (${v} x ${count+1} = ${finalVal})`; $('cWarning').style.animation = "pulseRed 0.5s infinite alternate"; } else $('cWarning').style.animation = "none"; }
    $('cDesc').value = d; $('cVal').value = finalVal; $('cTime').value = new Date().toISOString().slice(0,16); $('cWarning').innerText = warning; 
    $('cVal').parentElement.style.display = 'block'; $('cTime').parentElement.style.display = 'block'; $('cTitle').innerText = "XÁC NHẬN"; $('confirmModal').style.display = 'flex'; $('cVal').focus(); bulkActionType = 'history'; isBulkMode = false;
}
function bulkComment() { if (selectedStudents.size === 0) return showToast("Chưa chọn HS!", "error"); isBulkMode = true; bulkActionType = 'note'; $('cTitle').innerText = `NHẬN XÉT (${selectedStudents.size} HS)`; $('cWarning').innerText = "⚠️ Thêm vào 'Nhận xét của GV'."; $('cDesc').value = ""; $('cVal').parentElement.style.display = 'none'; $('cTime').parentElement.style.display = 'none'; $('confirmModal').style.display = 'flex'; $('cDesc').focus(); }
function openCustomScore() { isBulkMode = false; bulkActionType = 'history'; $('cTitle').innerText = "XÁC NHẬN"; $('cDesc').value=""; $('cVal').value=""; $('cTime').value=new Date().toISOString().slice(0,16); $('cWarning').innerText = ""; $('cVal').parentElement.style.display = 'block'; $('cTime').parentElement.style.display = 'block'; $('confirmModal').style.display='flex'; }
function commitScore() { 
    const d = $('cDesc').value; 
    const v = parseFloat($('cVal').value); 
    const timeVal = new Date($('cTime').value);

    // LẤY THÁNG ĐANG CHỌN ĐỂ LƯU
    const vMonth = $('viewMonth').value;
    const vYear = $('viewYear').value;
    const timeKey = `${vMonth}-${vYear}`;

    if (bulkActionType === 'history' && (isNaN(v) || !d)) return showToast("Thiếu thông tin!", "error");

    const dbTarget = currentMode === 'hk' ? db.hk : db.acad;

    // Logic lưu nút tắt (giữ nguyên)
    if (bulkActionType === 'history' && !isBulkMode) {
        if (currentMode === 'hk') {
            const exists = [...quickButtons.good, ...quickButtons.bad].some(b => b.text === d);
            if (!exists) {
                if (v >= 0) quickButtons.good.push({ text: d, val: v, icon: "📝" }); 
                else quickButtons.bad.push({ text: d, val: v, icon: "📝" }); 
                saveData();
            }
        } else {
             if (!quickButtons.acadGood) quickButtons.acadGood = [];
             if (!quickButtons.acadBad) quickButtons.acadBad = [];
             const exists = [...quickButtons.acadGood, ...quickButtons.acadBad].some(b => b.text === d);
             if (!exists) {
                if (v >= 0) quickButtons.acadGood.push({ text: d, val: v, icon: "📝" });
                else quickButtons.acadBad.push({ text: d, val: v, icon: "📝" });
                saveData();
            }
        }
    }

    (isBulkMode ? selectedStudents : (currentID ? [currentID] : [])).forEach(id => {
        if (!dbTarget[id]) dbTarget[id] = { base: 80, history: [], note: "" };
        
        if (bulkActionType === 'note') {
            // --- SỬA ĐỔI QUAN TRỌNG: LƯU VÀO MONTHLY NOTES ---
            if (!dbTarget[id].monthlyNotes) dbTarget[id].monthlyNotes = {};
            
            // Lưu đè hoặc cộng dồn (ở đây mình làm cộng dồn nếu muốn nhận xét nhiều lần)
            const oldNote = dbTarget[id].monthlyNotes[timeKey] || "";
            dbTarget[id].monthlyNotes[timeKey] = oldNote ? (oldNote + ". " + d) : d;
            
            // Vẫn lưu vào note chung để in phiếu không bị lỗi
            dbTarget[id].note = (dbTarget[id].note ? dbTarget[id].note + "\n- " : "- ") + `(T${vMonth}): ` + d;
            // -------------------------------------------------
        } else {
            dbTarget[id].history.push({ val: v, desc: d, time: timeVal });
        }
    });

    saveData(); 
    renderList(); // Render lại sẽ tự hiện dấu tích đỏ

    if (currentID && !isBulkMode) { 
        if(currentMode === 'hk') renderHKProfile(); 
        else renderAcadProfile(); 
    }

    closeConfirmModal(); 
    
    if (isBulkMode) { 
        showToast("Đã lưu nhận xét & Đánh dấu hoàn thành!", "success"); 
        clearSelection(); 
    } else { 
        showToast("Thành công!", "success"); 
    }
}
function closeConfirmModal() { $('confirmModal').style.display = 'none'; bulkActionType = 'history'; isBulkMode = false; }
function undoLast() { let h = currentMode==='hk'?db.hk[currentID].history:db.acad[currentID].history; if(h.length) { h.pop(); saveData(); renderList(); if(currentMode==='hk') renderHKProfile(); else renderAcadProfile(); showToast("Đã hoàn tác!", "info"); } }
function renameStudent() { const n = prompt("Tên mới:", currentID); if(n && !students.includes(n)) { students[students.indexOf(currentID)] = n; if(db.hk[currentID]) { db.hk[n]=db.hk[currentID]; delete db.hk[currentID]; } if(db.acad[currentID]) { db.acad[n]=db.acad[currentID]; delete db.acad[currentID]; } currentID=n; saveData(); renderList(); openProfile(n); }}
function moveCurrentToTrash() { if(confirm("Xóa HS này?")) { students.splice(students.indexOf(currentID),1); trash.push(currentID); saveData(); closeProfile(); renderList(); showToast("Đã chuyển vào thùng rác!", "info"); }}

function addNewStudentManual() {
    const nameInput = document.getElementById('newStName'); const classInput = document.getElementById('newStClass');
    const rawName = nameInput.value; const rawClass = classInput.value;
    if (!rawName || !rawName.trim()) { showToast("Vui lòng nhập tên học sinh!", "error"); nameInput.focus(); return; }
    if (!rawClass || !rawClass.trim()) { showToast("Vui lòng nhập tên lớp!", "error"); classInput.focus(); return; }
    const finalName = smartCleanName(rawName); 
    let finalClass = rawClass.trim().toUpperCase(); if (!finalClass.startsWith("LỚP")) finalClass = "Lớp " + finalClass.replace("LỚP", "").trim();
    const key = `${finalName} - ${finalClass}`;
    if (students.includes(key)) { return showToast(`Học sinh "${finalName}" đã tồn tại!`, "error"); }
    if (trash.includes(key) || trash.some(t => typeof t === 'object' ? t.id === key : t === key)) {
        if(confirm(`⚠️ Học sinh này đang nằm trong Thùng Rác. Bạn có muốn khôi phục không?`)) {
            let trashIdx = trash.findIndex(t => (typeof t === 'string' ? t : t.id) === key);
            if (trashIdx > -1) trash.splice(trashIdx, 1);
            students.push(key); saveData(); updateTrashCount(); renderList(); $('addModal').style.display = 'none'; openProfile(key); return;
        } else return;
    }
    students.push(key); saveData(); renderList(); nameInput.value = ""; $('addModal').style.display = 'none'; openProfile(key); 
    showToast(`Đã thêm thành công: ${finalName}`, "success");
}

function openAddModal() { $('addModal').style.display = 'flex'; $('newStName').focus(); }
function closeProfile() { localStorage.removeItem('yersin_saved_profile'); $('profileModal').style.display='none'; currentID=null; }
function toggleSidebar() { $('sidebar').classList.toggle('open'); }
function openSubTab(t,b) { document.querySelectorAll('.sub-tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.sub-tab-btn').forEach(e=>e.classList.remove('active')); $(t).classList.add('active'); b.classList.add('active'); }
function updateTrashCount() { $('trashCount').innerText = trash.length; }
function backupData() { const b=new Blob([JSON.stringify({students,trash,avatars,db,grades,appConfig,tkbData,quickButtons})],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='Yersin_Backup.json'; a.click(); }
function restoreData(e) { const r=new FileReader(); r.onload=ev=>{ const d=JSON.parse(ev.target.result); students=d.students; trash=d.trash; avatars=d.avatars; db=d.db; grades=d.grades||{}; tkbData=d.tkbData||{}; appConfig=d.appConfig; quickButtons=d.quickButtons || quickButtons; saveData(); location.reload(); }; r.readAsText(e.files[0]); }
function clearAllData() { if(confirm("XÓA TOÀN BỘ DỮ LIỆU?")) { localStorage.clear(); location.reload(); } }

// --- LOGIC XUẤT EXCEL THEO THÁNG ---

// --- LOGIC XUẤT FILE VỚI MENU TIẾNG VIỆT ---

// 1. Hàm mở Modal và nạp năm tự động
function openExportModal() {
    const modalBody = document.querySelector('#exportModal .confirm-body');
    
    // Xóa nội dung cũ để render lại theo chế độ
    modalBody.innerHTML = "";

    // --- TRƯỜNG HỢP 1: ĐANG Ở SỔ ĐIỂM (ACAD) ---
    if (currentMode === 'acad') {
        const headerTitle = document.querySelector('#exportModal .confirm-header');
        headerTitle.innerHTML = "📤 XUẤT SỔ ĐIỂM CHI TIẾT";
        headerTitle.style.color = "var(--neon-gold)";
        headerTitle.style.textShadow = "0 0 10px var(--neon-gold)";
        document.querySelector('#exportModal .confirm-box').style.borderColor = "var(--neon-gold)";

        // Tạo danh sách môn học cho dropdown
        let subjectOptions = `<option value="all">⚡ TẤT CẢ CÁC MÔN (All-in-One)</option>`;
        for (const [key, name] of Object.entries(SUBJECTS)) {
            subjectOptions += `<option value="${key}">${name}</option>`;
        }

        modalBody.innerHTML = `
            <div style="text-align:center; margin-bottom:15px; opacity:0.8; font-size:14px">
                Chọn môn học bạn muốn xuất dữ liệu:
            </div>
            <div class="input-group">
                <div style="display: flex; gap: 15px; justify-content: center; align-items: center; flex-direction: column;">
                    <label style="color:var(--neon-gold); font-weight:bold;">MÔN HỌC:</label>
                    <select id="exportSubject" style="width: 100%; max-width:300px; padding: 12px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--neon-gold); color: white; font-weight: bold; font-family: 'Quicksand', sans-serif;">
                        ${subjectOptions}
                    </select>
                    <div style="font-size:11px; opacity:0.6; font-style:italic">
                        * "Tất cả các môn" sẽ tạo 1 file Excel chứa nhiều Sheet.
                    </div>
                </div>
            </div>
        `;
    } 
    // --- TRƯỜNG HỢP 2: ĐANG Ở HẠNH KIỂM (HK) - GIỮ NGUYÊN ---
    else {
        const headerTitle = document.querySelector('#exportModal .confirm-header');
        headerTitle.innerHTML = "📤 XUẤT BÁO CÁO HẠNH KIỂM";
        headerTitle.style.color = "var(--neon-green)";
        headerTitle.style.textShadow = "0 0 10px var(--neon-green)";
        document.querySelector('#exportModal .confirm-box').style.borderColor = "var(--neon-green)";

        const now = new Date();
        const curY = now.getFullYear();
        let yearOpts = "";
        [curY - 1, curY, curY + 1].forEach(y => {
            yearOpts += `<option value="${y}" ${y === curY ? 'selected' : ''}>${y}</option>`;
        });

        let monthOpts = "";
        for(let i=1; i<=12; i++) {
            monthOpts += `<option value="${i}" ${i === (now.getMonth()+1) ? 'selected' : ''}>Tháng ${i}</option>`;
        }

        modalBody.innerHTML = `
            <div style="text-align:center; margin-bottom:15px; opacity:0.8; font-size:14px">
                Chọn thời gian xuất báo cáo:
            </div>
            <div class="input-group">
                <div style="display: flex; gap: 15px; justify-content: center; align-items: center;">
                    <select id="exportMonth" style="width: 120px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--neon-green); color: white; font-weight: bold;">
                        ${monthOpts}
                    </select>
                    <select id="exportYear" style="width: 100px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--neon-gold); color: var(--neon-gold); font-weight: bold;">
                        ${yearOpts}
                    </select>
                </div>
            </div>
        `;
    }

    // Hiện Modal
    $('exportModal').style.display = 'flex';
}
// 2. Hàm xử lý Xuất file
function processExportWithDate() {
    if (currentMode === 'acad') {
        exportAcadToExcel();
        return;
    }

    const selectedMonth = parseInt(document.getElementById('exportMonth').value);
    const selectedYear = parseInt(document.getElementById('exportYear').value);
    let listToExport = [];
    const currentClass = $('classSelect').value;
    const searchTerm = $('search').value.toLowerCase();

    // 1. Lọc danh sách học sinh
    if (selectedStudents.size > 0) {
        listToExport = Array.from(selectedStudents);
    } else {
        listToExport = students.filter(s => {
            const parts = s.split(" - ");
            const c = parts[1] || "";
            if (currentClass && c !== currentClass) return false;
            if (searchTerm && !parts[0].toLowerCase().includes(searchTerm)) return false;
            return true;
        });
    }

    if (listToExport.length === 0) return showToast("Không có dữ liệu để xuất!", "error");

    // 2. Định nghĩa Tiêu đề chuẩn
    const headers = [
        "", "HỌ VÀ TÊN HỌC SINH", "Hành vi tích cực ", "Tổng điểm\n cộng",
        "Hành vi cần cải thiện ", "Tổng điểm\ntrừ ", "TỔNG ĐIỂM \n4 TUẦN",
        "TỔNG ĐIỂM SAU KHI \nCỘNG VÀ TRỪ\n", "XẾP LOẠI", "NHẬN XÉT"
    ];

    // 3. Tính toán dữ liệu (Tạo mảng dữ liệu thô)
    const dataRows = listToExport.map((s, i) => {
        const [name, className] = s.split(" - ");
        const fullData = getHKData(s);
        
        const monthlyHistory = fullData.history.filter(h => {
            const hDate = new Date(h.time);
            return (hDate.getMonth() + 1) === selectedMonth && hDate.getFullYear() === selectedYear;
        });

        let mPlus = 0, mMinus = 0, posText = "", negText = "";
        monthlyHistory.forEach(h => {
            const dObj = new Date(h.time);
            const dStr = `${dObj.getDate()}/${dObj.getMonth() + 1}`;
            if (h.val > 0) { 
                mPlus += h.val; 
                posText += `- ${h.desc} (${dStr}): +${h.val}\n`; 
            } else { 
                mMinus += Math.abs(h.val); 
                negText += `- ${h.desc} (${dStr}): ${h.val}\n`; 
            }
        });

        // Tính sẵn kết quả để hiển thị ngay (Fallback value)
        const finalScore = fullData.base + mPlus - mMinus;
        let rank = "Chưa Đạt";
        if (finalScore >= 80) rank = "Tốt";
        else if (finalScore >= 65) rank = "Khá";
        else if (finalScore >= 50) rank = "Đạt";

        return [
            i + 1,                          // A: STT
            name,                           // B: Tên
            posText.trim(),                 // C: Hành vi tốt
            mPlus > 0 ? mPlus : null,       // D: Điểm cộng (null để trống)
            negText.trim(),                 // E: Hành vi xấu
            mMinus !== 0 ? mMinus : null,   // F: Điểm trừ (null để trống)
            fullData.base,                  // G: Điểm gốc (80)
            finalScore,                     // H: Tổng điểm (Giá trị hiển thị)
            rank,                           // I: Xếp loại (Giá trị hiển thị)
            fullData.note || ""             // J: Nhận xét
        ];
    });

    // Tạo sheet từ dữ liệu
    const ws = XLSX.utils.aoa_to_sheet([headers, ...dataRows]);

    // 4. QUAN TRỌNG: GHI ĐÈ CÔNG THỨC VÀO CÁC Ô ĐÃ CÓ GIÁ TRỊ
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    // Duyệt qua từng dòng dữ liệu (bỏ dòng tiêu đề)
    for (let R = range.s.r + 1; R <= range.e.r; ++R) {
        // --- Xử lý Cột H (Tổng điểm) ---
        const cellRefH = XLSX.utils.encode_cell({r: R, c: 7});
        const refG = XLSX.utils.encode_cell({r: R, c: 6}); // Cột G (Base)
        const refD = XLSX.utils.encode_cell({r: R, c: 3}); // Cột D (Cộng)
        const refF = XLSX.utils.encode_cell({r: R, c: 5}); // Cột F (Trừ)

        // Lấy giá trị hiện tại (đã tính ở bước 3)
        const currentScore = ws[cellRefH] ? ws[cellRefH].v : 80;

        // Ghi đè: Vừa có giá trị (v) vừa có công thức (f)
        ws[cellRefH] = {
            t: 'n',             // Loại: Số
            v: currentScore,    // Giá trị: Hiển thị ngay số này
            f: `${refG}+${refD}-${refF}` // Công thức: =G+D-F (ẩn bên dưới)
        };

        // --- Xử lý Cột I (Xếp loại) ---
        const cellRefI = XLSX.utils.encode_cell({r: R, c: 8});
        const currentRank = ws[cellRefI] ? ws[cellRefI].v : "Đạt";

        ws[cellRefI] = {
            t: 's',             // Loại: Chuỗi
            v: currentRank,     // Giá trị: Hiển thị ngay chữ "Tốt"/"Khá"...
            f: `IF(${cellRefH}>=80,"Tốt",IF(${cellRefH}>=65,"Khá",IF(${cellRefH}>=50,"Đạt","Chưa Đạt")))`
        };
    }

    // 5. Định dạng (Style) - Kẻ bảng và Font chữ
    const baseStyle = { 
        font: { name: "Times New Roman", sz: 11 }, 
        border: { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} }, 
        alignment: { vertical: "center", wrapText: true } 
    };
    const headerStyle = {
        ...baseStyle, 
        font: { name: "Times New Roman", sz: 11, bold: true }, 
        alignment: { horizontal: "center", vertical: "center", wrapText: true }, 
        fill: { fgColor: { rgb: "FFFFFF" } } 
    };

    for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
            // Nếu ô trống (null), tạo ô ảo để kẻ viền
            if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' }; 
            ws[cellRef].s = (R === 0) ? headerStyle : baseStyle;
        }
    }
    
    // Độ rộng cột (Chuẩn theo file mẫu)
    ws['!cols'] = [
        {wch: 5},  // STT
        {wch: 25}, // Tên
        {wch: 45}, // HV Tốt
        {wch: 10}, // Điểm cộng
        {wch: 45}, // HV Xấu
        {wch: 10}, // Điểm trừ
        {wch: 10}, // Base
        {wch: 10}, // Tổng
        {wch: 10}, // Xếp loại
        {wch: 30}  // Nhận xét
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "BaoCaoHK");
    XLSX.writeFile(wb, `HK_Thang${selectedMonth}_${selectedYear}.xlsx`);
    $('exportModal').style.display = 'none';
    showToast(`✅ Đã xuất xong Tháng ${selectedMonth}/${selectedYear}`, "success");
}
// --- Dán đoạn này ngay sau hàm processExportWithDate ---

function saveTeacherNote(val) { 
    // Kiểm tra xem có đang chọn học sinh nào không
    if(!currentID) return; 
    
    const valTrimmed = val.trim();
    
    // Tự động xác định đang ở chế độ Hạnh Kiểm (hk) hay Sổ Điểm (acad)
    // để lưu vào đúng cơ sở dữ liệu
    const targetDB = (currentMode === 'acad') ? db.acad : db.hk;
    const storageKey = (currentMode === 'acad') ? LS.acad_data : LS.hk_data;
    
    if(targetDB && targetDB[currentID]) {
        // 1. Cập nhật dữ liệu vào biến tạm
        targetDB[currentID].note = valTrimmed;
        
        // 2. Lưu ngay xuống bộ nhớ trình duyệt (LocalStorage)
        // Dùng biến LS đã khai báo ở đầu file
        localStorage.setItem(storageKey, JSON.stringify(targetDB));
        
        // 3. (Tùy chọn) Cập nhật lại danh sách để hiện dấu tích xanh/đỏ nếu cần
        if(typeof renderStudentList === 'function') {
            renderStudentList();
        }
    }
}

// Hàm xóa lịch sử điểm (Nếu bạn cần sửa điểm bằng cách xóa đi nhập lại)
function deleteHistoryItem(index) {
    if (!currentID) return;
    
    const targetDB = (currentMode === 'acad') ? db.acad : db.hk;
    const storageKey = (currentMode === 'acad') ? LS.acad_data : LS.hk_data;

    if (targetDB[currentID] && targetDB[currentID].history[index]) {
        if (confirm("Bạn có chắc muốn xóa dòng lịch sử này không?")) {
            // Xóa phần tử tại vị trí index
            targetDB[currentID].history.splice(index, 1);
            
            // Tính toán lại điểm gốc (Base) nếu cần - Logic đơn giản là lưu lại mảng mới
            localStorage.setItem(storageKey, JSON.stringify(targetDB));
            
            // Cập nhật lại giao diện Modal và Danh sách
            showStudentDetails(currentID);
            renderStudentList();
            showToast("Đã xóa nhật ký thành công!", "success");
        }
    }
}
// ======================================================
// 7. THỐNG KÊ (STATS) - PHIÊN BẢN ĐÃ CẬP NHẬT LỌC LỚP
// ======================================================
function renderStats() {
    const container = $('statsContainer');
    container.innerHTML = "";
    if (currentMode === 'hk') { renderHKStats(container); } else { renderAcadStats(container); }
}

function renderHKStats(container) {
    // --- LỌC THEO LỚP ---
    const selectedClass = $('classSelect').value;
    const filteredStudents = students.filter(s => {
        if (!selectedClass) return true; 
        return s.includes(" - " + selectedClass) || s.endsWith(selectedClass);
    });
    // --------------------

    let ranks = { good: 0, fair: 0, avg: 0, bad: 0 };
    let totalScore = 0; let violationStats = {}; let sortedByScore = [];

    filteredStudents.forEach(s => {
        const d = getHKData(s); totalScore += d.final;
        if (d.final >= 80) ranks.good++; else if (d.final >= 65) ranks.fair++; else if (d.final >= 50) ranks.avg++; else ranks.bad++;
        sortedByScore.push({ name: s.split(' - ')[0], val: d.final });
        d.history.forEach(h => { if (h.val < 0) { const reason = h.desc.split('(')[0].trim(); violationStats[reason] = (violationStats[reason] || 0) + 1; } });
    });

    sortedByScore.sort((a, b) => b.val - a.val);
    const avgScore = filteredStudents.length ? (totalScore / filteredStudents.length).toFixed(1) : 0;
    const sortedViolations = Object.entries(violationStats).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const viewTitle = selectedClass ? `LỚP: ${selectedClass}` : "TOÀN TRƯỜNG";

    const html = `
    <h3 style="text-align:center; color:var(--text); opacity:0.8; letter-spacing:2px; margin-top:0; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px">THỐNG KÊ: ${viewTitle}</h3>
    <div class="stats-grid-top">
        <div class="stat-summary-card" style="color:var(--neon-purple)"><div class="stat-label">Sĩ số</div><div class="stat-value">${filteredStudents.length}</div></div>
        <div class="stat-summary-card" style="color:var(--neon-green)"><div class="stat-label">Điểm TB Lớp</div><div class="stat-value">${avgScore}</div></div>
        <div class="stat-summary-card" style="color:var(--neon-blue)"><div class="stat-label">Hạnh Kiểm Tốt</div><div class="stat-value">${ranks.good} <span style="font-size:14px; opacity:0.7">(${filteredStudents.length ? ((ranks.good/filteredStudents.length)*100).toFixed(0) : 0}%)</span></div></div>
        <div class="stat-summary-card" style="color:var(--neon-red)"><div class="stat-label">Cần Nhắc Nhở</div><div class="stat-value">${ranks.bad}</div></div>
    </div>
    <div class="charts-grid">
        <div class="chart-container"><div class="chart-header"><div class="chart-title">📊 Phân Bố Xếp Loại</div></div><canvas id="chartHKRank"></canvas></div>
        <div class="chart-container"><div class="chart-header"><div class="chart-title">🏆 Top 5 Điểm Cao Nhất</div></div><canvas id="chartHKTop"></canvas></div>
        <div class="chart-container" style="grid-column: 1 / -1;"><div class="chart-header"><div class="chart-title">⚠️ Các Lỗi Vi Phạm Thường Gặp</div></div><canvas id="chartHKViolations"></canvas></div>
    </div>`;

    container.innerHTML = html;
    setTimeout(() => {
        drawDoughnutChart('chartHKRank', ['Tốt', 'Khá', 'Đạt', 'Yếu'], [ranks.good, ranks.fair, ranks.avg, ranks.bad], ['#4ade80', '#22d3ee', '#fbbf24', '#f43f5e']);
        drawBarChart('chartHKTop', sortedByScore.slice(0, 5).map(i=>i.name), sortedByScore.slice(0, 5).map(i=>i.val), '#bd00ff', 'Điểm HK');
        drawBarChart('chartHKViolations', sortedViolations.map(i=>i[0]), sortedViolations.map(i=>i[1]), '#f43f5e', 'Số lần vi phạm');
    }, 100);
}

function renderAcadStats(container) {
    // --- LỌC THEO LỚP ---
    const selectedClass = $('classSelect').value;
    const filteredStudents = students.filter(s => {
        if (!selectedClass) return true;
        return s.includes(" - " + selectedClass) || s.endsWith(selectedClass);
    });
    // --------------------

    let subjOptions = ""; for(const [k, v] of Object.entries(SUBJECTS)) { subjOptions += `<option value="${k}" ${k===currentStatSubject ? 'selected' : ''}>${v}</option>`; }
    
    const viewLabel = selectedClass ? `<span style="color:var(--neon-gold); font-weight:bold; margin-right:15px; border:1px solid var(--neon-gold); padding:5px 10px; border-radius:5px">${selectedClass}</span>` : "";
    const controlsHtml = `<div class="stat-control-bar">${viewLabel}<div style="font-weight:bold; color:var(--neon-gold); margin-right:10px;">BỘ LỌC:</div><select id="statSubjSelect" class="search-box" onchange="updateAcadStatParams('subj', this.value)">${subjOptions}</select><select id="statGradeSelect" class="search-box" onchange="updateAcadStatParams('type', this.value)"><option value="tx1" ${currentStatGradeType==='tx1'?'selected':''}>Thường Xuyên 1</option><option value="tx2" ${currentStatGradeType==='tx2'?'selected':''}>Thường Xuyên 2</option><option value="tx3" ${currentStatGradeType==='tx3'?'selected':''}>Thường Xuyên 3</option><option value="tx4" ${currentStatGradeType==='tx4'?'selected':''}>Thường Xuyên 4</option><option value="gk1" ${currentStatGradeType==='gk1'?'selected':''}>Giữa Kỳ 1</option><option value="ck1" ${currentStatGradeType==='ck1'?'selected':''}>Cuối Kỳ 1</option><option value="gk2" ${currentStatGradeType==='gk2'?'selected':''}>Giữa Kỳ 2</option><option value="ck2" ${currentStatGradeType==='ck2'?'selected':''}>Cuối Kỳ 2</option></select><button class="btn green" onclick="renderStats()">🔄 Cập nhật</button></div>`;

    let totalWallet = 0; let dist = { gio: 0, kha: 0, tb: 0, yeu: 0, chuaNhap: 0 }; let listScores = []; let topWallet = [];
    filteredStudents.forEach(s => {
        const w = calculateWallet(s); totalWallet += w; topWallet.push({name: s.split(' - ')[0], val: w});
        const g = getGrades(s); const rawScore = g[currentStatGradeType]; const score = parseFloat(rawScore);
        if (!isNaN(score)) { listScores.push(score); if (score >= 8.0) dist.gio++; else if (score >= 6.5) dist.kha++; else if (score >= 5.0) dist.tb++; else dist.yeu++; } else { dist.chuaNhap++; }
    });
    topWallet.sort((a,b) => b.val - a.val);
    const avgGrade = listScores.length ? (listScores.reduce((a,b)=>a+b,0) / listScores.length).toFixed(2) : "---";

    const html = `${controlsHtml}<div class="stats-grid-top"><div class="stat-summary-card" style="color:var(--neon-gold)"><div class="stat-label">Tổng Kho Điểm</div><div class="stat-value">${totalWallet.toFixed(1)}</div></div><div class="stat-summary-card" style="color:var(--neon-cyan)"><div class="stat-label">TB Môn (${currentStatGradeType.toUpperCase()})</div><div class="stat-value">${avgGrade}</div></div><div class="stat-summary-card" style="color:var(--neon-green)"><div class="stat-label">Đạt Giỏi (>=8.0)</div><div class="stat-value">${dist.gio}</div></div><div class="stat-summary-card" style="color:var(--neon-red)"><div class="stat-label">Dưới TB (<5.0)</div><div class="stat-value">${dist.yeu}</div></div></div><div class="charts-grid"><div class="chart-container"><div class="chart-header"><div class="chart-title">📈 Phổ Điểm: ${SUBJECTS[currentStatSubject]} (${currentStatGradeType.toUpperCase()})</div></div><canvas id="chartAcadDist"></canvas></div><div class="chart-container"><div class="chart-header"><div class="chart-title">💰 Top "Đại Gia" Kho Điểm</div></div><canvas id="chartAcadWallet"></canvas></div></div>`;
    container.innerHTML = html;
    setTimeout(() => {
        drawBarChart('chartAcadDist', ['Giỏi (>=8)', 'Khá (6.5-7.9)', 'TB (5-6.4)', 'Yếu (<5)', 'Chưa nhập'], [dist.gio, dist.kha, dist.tb, dist.yeu, dist.chuaNhap], ['#4ade80', '#22d3ee', '#fbbf24', '#f43f5e', '#94a3b8'], 'Số lượng HS');
        drawBarChart('chartAcadWallet', topWallet.slice(0, 5).map(i=>i.name), topWallet.slice(0, 5).map(i=>i.val), '#fbbf24', 'Số điểm tích lũy');
    }, 100);
}
function updateAcadStatParams(key, val) { if (key === 'subj') currentStatSubject = val; if (key === 'type') currentStatGradeType = val; renderStats(); }
function destroyChart(id) { if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; } }
function drawDoughnutChart(canvasId, labels, data, colors) { destroyChart(canvasId); const ctx = document.getElementById(canvasId).getContext('2d'); chartInstances[canvasId] = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 10 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e2e8f0', padding: 20, font: {family: 'Quicksand'} } } }, cutout: '60%' } }); }
function drawBarChart(canvasId, labels, data, color, labelName) { destroyChart(canvasId); const ctx = document.getElementById(canvasId).getContext('2d'); const bgColors = Array.isArray(color) ? color : labels.map(() => color + '90'); const borderColors = Array.isArray(color) ? color : labels.map(() => color); chartInstances[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: labelName, data: data, backgroundColor: bgColors, borderColor: borderColors, borderWidth: 1, borderRadius: 4, barPercentage: 0.6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8', font: {family: 'Quicksand'} }, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { ticks: { color: '#e2e8f0', font: {family: 'Quicksand', weight: 'bold'} }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', titleColor: '#fff', bodyColor: '#fff', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, padding: 10 } } } }); }

// ======================================================
// 8. THÙNG RÁC (TRASH) & WHEEL & PRINT & TOAST
// ======================================================
function renderTrash() {
    const container = $('trashContainer');
    if (!document.getElementById('trashToolbar')) {
        container.innerHTML = `<div id="trashToolbar" class="trash-toolbar"><div class="trash-title"><span style="font-size:24px">🗑️</span> TRUNG TÂM TÁI CHẾ</div><input id="trashSearchInput" class="search-box" placeholder="🔍 Tìm tên HS..." style="background:rgba(0,0,0,0.3); border-color:var(--neon-red); color:white; min-width:200px" oninput="renderTrashGrid()"><div style="display:flex; gap:10px; flex-wrap:wrap"><button class="btn green" onclick="restoreSelectedTrash()">♻️ Khôi phục (<span id="trashSelCount">0</span>)</button><button class="btn" style="border-color:rgba(255,255,255,0.3)" onclick="toggleSelectAllTrash()">✅ Chọn tất cả</button><button class="btn red" onclick="deleteSelectedTrashForever()">🚫 Xóa vĩnh viễn</button><button class="btn red" style="background:var(--neon-red); color:white; font-weight:bold" onclick="emptyTrash()">🔥 HỦY DIỆT TOÀN BỘ</button></div></div><div id="trashGrid" class="trash-grid"></div>`;
    }
    trashSelection.clear(); updateTrashUI(); renderTrashGrid();
}
function renderTrashGrid() {
    const grid = $('trashGrid'); const searchTerm = $('trashSearchInput') ? $('trashSearchInput').value.toLowerCase() : "";
    grid.innerHTML = "";
    if (!trash || trash.length === 0) { grid.innerHTML = `<div class="trash-empty-state"><span style="font-size: 50px;">✨</span><span style="font-size: 18px;">Thùng rác trống trơn!</span></div>`; $('trashSelCount').innerText = "0"; return; }
    let hasItem = false;
    trash.forEach((item, index) => {
        let name = "", cls = "", id = "";
        if (typeof item === 'string') { id = item; const parts = item.split(" - "); name = parts[0]; cls = parts[1] || "Không xác định"; } else { id = item.id; const parts = item.id.split(" - "); name = parts[0]; cls = parts[1]; }
        if (searchTerm && !name.toLowerCase().includes(searchTerm)) return; hasItem = true;
        const isSel = trashSelection.has(index); const avt = avatars[id] || generateAvatar(name);
        const card = document.createElement('div'); card.className = `trash-card ${isSel ? 'selected' : ''}`; card.onclick = () => toggleTrashItem(index);
        card.innerHTML = `${isSel ? '<div class="trash-check-icon">✓</div>' : ''}<img src="${avt}" class="trash-avatar"><div class="trash-name">${name}</div><div class="trash-class">${cls}</div>`;
        grid.appendChild(card);
    });
    if (!hasItem) { grid.innerHTML = `<div class="trash-empty-state" style="opacity:0.3">Không tìm thấy kết quả nào...</div>`; } updateTrashUI();
}
function toggleTrashItem(index) { if (trashSelection.has(index)) trashSelection.delete(index); else trashSelection.add(index); renderTrashGrid(); }
function toggleSelectAllTrash() { const searchTerm = $('trashSearchInput').value.toLowerCase(); const visibleIndices = []; trash.forEach((item, index) => { const str = (typeof item === 'string') ? item : item.id; if (!searchTerm || str.toLowerCase().includes(searchTerm)) { visibleIndices.push(index); } }); const allSelected = visibleIndices.every(i => trashSelection.has(i)); if (allSelected) visibleIndices.forEach(i => trashSelection.delete(i)); else visibleIndices.forEach(i => trashSelection.add(i)); renderTrashGrid(); }
function updateTrashUI() { const el = $('trashSelCount'); if(el) el.innerText = trashSelection.size; }
function restoreSelectedTrash() {
    if (trashSelection.size === 0) return showToast("Chưa chọn học sinh nào để khôi phục!", "error");
    const indices = Array.from(trashSelection).sort((a, b) => b - a); let count = 0;
    indices.forEach(index => { if (index >= 0 && index < trash.length) { students.push(trash[index]); trash.splice(index, 1); count++; } });
    saveData(); trashSelection.clear(); updateTrashCount(); renderTrashGrid(); renderList(); showToast(`✅ Đã khôi phục thành công ${count} học sinh!`, "success");
}
function deleteSelectedTrashForever() {
    if (trashSelection.size === 0) return showToast("Chưa chọn học sinh nào để xóa!", "error");
    if (!confirm(`⚠️ CẢNH BÁO: Xóa vĩnh viễn ${trashSelection.size} học sinh?`)) return;
    const indices = Array.from(trashSelection).sort((a, b) => b - a); indices.forEach(index => { if (index >= 0 && index < trash.length) trash.splice(index, 1); });
    saveData(); trashSelection.clear(); updateTrashCount(); renderTrashGrid(); showToast("Đã xóa vĩnh viễn!", "info");
}
function emptyTrash() {
    if (trash.length === 0) return showToast("Thùng rác đang trống!", "info");
    if (confirm("🔥 BẠN CÓ CHẮC MUỐN ĐỐT SẠCH THÙNG RÁC?")) {
        trash = []; saveData(); trashSelection.clear(); updateTrashCount(); renderTrashGrid(); showToast("Đã dọn sạch thùng rác!", "success");
        if(appConfig.sound) { const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 1); g.gain.setValueAtTime(0.5, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1); osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 1); }
    }
}

// --- WHEEL & PRINT & TOAST ---
let prizes = []; let wheelCtx, wheelCanvas; let currentRotation = 0; let isSpinning = false; let currentWinnerIdx = -1; let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function loadPrizes() { const saved = localStorage.getItem(LS.wheel); prizes = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_PRIZES)); }
function openWheel() { $('wheelModal').style.display = 'flex'; $('wheelView').style.display = 'flex'; $('wheelSettings').style.display = 'none'; $('wheelBtnsMain').style.display = 'block'; $('wheelBtnsEdit').style.display = 'none'; $('wheelResult').innerText = "Sẵn sàng..."; $('btnRemoveWinner').style.display = 'none'; if(!wheelCanvas) { wheelCanvas = $('wheelCanvas'); wheelCtx = wheelCanvas.getContext('2d'); } drawWheel(); }
function openWheelSettings() { $('wheelView').style.display = 'none'; $('wheelSettings').style.display = 'block'; $('wheelBtnsMain').style.display = 'none'; $('wheelBtnsEdit').style.display = 'block'; $('wheelBulkInput').value = prizes.map(p => p.text).join('\n'); const cls = $('classSelect').value; $('btnLoadClass').innerText = cls ? `📥 Nạp danh sách ${cls}` : "📥 Nạp danh sách lớp"; }
function loadClassToWheel() { const cls = $('classSelect').value; if(!cls) return showToast("Chọn lớp trước!", "error"); const list = students.filter(s => s.includes(cls)).map(s => s.split(' - ')[0]); $('wheelBulkInput').value = list.join('\n'); }
function saveWheelSettings() { const lines = $('wheelBulkInput').value.trim().split('\n').map(l => l.trim()).filter(l => l); if(lines.length < 2) return showToast("Cần ít nhất 2 mục!", "error"); const colors = ['#bd00ff', '#00eaff', '#00ffcc', '#fbbf24', '#4ade80', '#f43f5e', '#3b82f6', '#ec4899']; prizes = lines.map((t, i) => ({ text: t, color: colors[i % colors.length] })); localStorage.setItem(LS.wheel, JSON.stringify(prizes)); $('wheelSettings').style.display = 'none'; $('wheelBtnsEdit').style.display = 'none'; $('wheelView').style.display = 'flex'; $('wheelBtnsMain').style.display = 'block'; drawWheel(); }
function resetWheelSettings() { prizes = JSON.parse(JSON.stringify(DEFAULT_PRIZES)); saveWheelSettings(); }
function drawWheel() { if(prizes.length === 0) return; const num = prizes.length; const arc = (2 * Math.PI) / num; const cx = 150, cy = 150, r = 145; wheelCtx.clearRect(0, 0, 300, 300); for (let i = 0; i < num; i++) { const angle = i * arc - Math.PI / 2; wheelCtx.beginPath(); wheelCtx.moveTo(cx, cy); wheelCtx.arc(cx, cy, r, angle, angle + arc); wheelCtx.lineTo(cx, cy); wheelCtx.fillStyle = prizes[i].color; wheelCtx.fill(); wheelCtx.stroke(); wheelCtx.save(); wheelCtx.translate(cx, cy); wheelCtx.rotate(angle + arc / 2); wheelCtx.textAlign = "right"; wheelCtx.fillStyle = "#fff"; wheelCtx.font = "bold 14px Quicksand"; wheelCtx.shadowColor = "rgba(0,0,0,0.5)"; wheelCtx.shadowBlur = 4; wheelCtx.fillText(prizes[i].text, r - 15, 5); wheelCtx.restore(); } }
function playTickSound() { if(!appConfig.sound) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.05); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.05); }
function playWinSound() { if(!appConfig.sound) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.5); }
function spin() { if (isSpinning) return; if (prizes.length < 2) return showToast("Cần ít nhất 2 lựa chọn!", "error"); if(audioCtx.state === 'suspended') audioCtx.resume(); isSpinning = true; $('wheelResult').innerText = "Đang quay..."; $('btnRemoveWinner').style.display = 'none'; const extraSpins = 5; const randomDegree = Math.floor(Math.random() * 360); const spinAngle = 360 * extraSpins + randomDegree; currentRotation += spinAngle; wheelCanvas.style.transition = "transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)"; wheelCanvas.style.transform = `rotate(${currentRotation}deg)`; let tickCount = 0; const maxTicks = 20; const tickInterval = setInterval(() => { tickCount++; if(tickCount < maxTicks || Math.random() > 0.7) playTickSound(); if(tickCount > 40) clearInterval(tickInterval); }, 100); setTimeout(() => { isSpinning = false; const actualAngle = currentRotation % 360; const arcDeg = 360 / prizes.length; let index = Math.floor((360 - actualAngle + 90) % 360 / arcDeg); index = index % prizes.length; currentWinnerIdx = index; const winner = prizes[index]; playWinSound(); $('wheelResult').innerHTML = `🎉 Kết quả: <span style="color:${winner.color}">${winner.text}</span>`; $('btnRemoveWinner').style.display = 'inline-block'; showCelebration(winner.text); }, 5000); }
function removeCurrentWinner() { if(currentWinnerIdx > -1 && prizes.length > 0) { const removed = prizes[currentWinnerIdx].text; if(confirm(`Xóa "${removed}"?`)) { prizes.splice(currentWinnerIdx, 1); drawWheel(); $('wheelResult').innerText = `Đã xóa: ${removed}`; $('btnRemoveWinner').style.display = 'none'; } } }

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return; 
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    let icon = 'ℹ️'; if (type === 'success') icon = '✅'; if (type === 'error') icon = '❌';
    toast.innerHTML = `<span class="t-icon">${icon}</span><span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('show'); if(appConfig.sound && typeof playTickSound === 'function') playTickSound(); }, 10);
    setTimeout(() => { toast.classList.remove('show'); toast.classList.add('hide'); setTimeout(() => { if(toast.parentElement) toast.remove(); }, 300); }, 3000);
}

function bulkPrintHK() {
    if (selectedStudents.size === 0) return showToast("Vui lòng chọn ít nhất một học sinh!", "error");

    const printArea = document.getElementById('printArea');
    printArea.innerHTML = ""; // Xóa cũ

    // Lấy tháng/năm đang chọn để lọc dữ liệu (Mặc định là hiện tại nếu chưa chọn)
    const vMonth = parseInt(document.getElementById('viewMonth').value) || (new Date().getMonth() + 1);
    const vYear = parseInt(document.getElementById('viewYear').value) || new Date().getFullYear();
    const currentDay = new Date().getDate();

    // Duyệt qua từng học sinh được chọn
    selectedStudents.forEach(id => {
        const [name, className] = id.split(" - ");
        const hkData = getHKData(id);

        // 1. Lọc lịch sử hành vi theo tháng/năm đã chọn
        const monthlyHistory = hkData.history.filter(h => {
            const hDate = new Date(h.time);
            return (hDate.getMonth() + 1) === vMonth && hDate.getFullYear() === vYear;
        });

        // 2. Phân loại Tích cực / Cần cải thiện
        let positiveRows = "";
        let negativeRows = "";
        let monthScore = hkData.base; // Điểm gốc
        let mPlus = 0;
        let mMinus = 0;

        monthlyHistory.forEach(h => {
            const dStr = new Date(h.time).getDate() + "/" + (new Date(h.time).getMonth() + 1);
            if (h.val > 0) {
                mPlus += h.val;
                positiveRows += `<tr><td>- ${h.desc} (${dStr})</td><td style="text-align:center">+${h.val}</td></tr>`;
            } else {
                mMinus += Math.abs(h.val);
                negativeRows += `<tr><td>- ${h.desc} (${dStr})</td><td style="text-align:center">${h.val}</td></tr>`;
            }
        });

        // Nếu không có dữ liệu thì ghi "Không"
        if (!positiveRows) positiveRows = `<tr><td style="font-style:italic; opacity:0.7">Không có ghi nhận</td><td style="text-align:center">-</td></tr>`;
        if (!negativeRows) negativeRows = `<tr><td style="font-style:italic; opacity:0.7">Không có ghi nhận</td><td style="text-align:center">-</td></tr>`;

        // 3. Tính điểm tổng kết tháng
        let finalScore = Math.max(0, Math.min(100, monthScore + mPlus - mMinus));
        
        // 4. Xếp loại
        let rank = "Chưa Đạt";
        if (finalScore >= 80) rank = "Tốt";
        else if (finalScore >= 65) rank = "Khá";
        else if (finalScore >= 50) rank = "Đạt";

        // 5. Lấy nhận xét tháng (nếu có)
        const timeKey = `${vMonth}-${vYear}`;
        const monthlyNote = (db.hk[id].monthlyNotes && db.hk[id].monthlyNotes[timeKey]) ? db.hk[id].monthlyNotes[timeKey] : "";

        // 6. Tạo mẫu HTML giống hệt file Word
        const template = `
        <div class="a4-page">
            <div class="report-header">
                <div class="report-school">TRƯỜNG THPT YERSIN – ĐÀ LẠT</div>
                <div class="report-title">PHIẾU BÁO HẠNH KIỂM HỌC SINH</div>
            </div>

            <div class="report-info">
                <div class="report-info-row">
                    <span style="font-weight:bold">Lớp: ${className || "..."}</span>
                    <span style="font-weight:bold">Tháng: ${vMonth}/${vYear}</span>
                </div>
                <div style="margin-top:5px">
                    <span style="font-weight:bold">Họ và tên học sinh: ${name}</span>
                </div>
            </div>

            <table class="report-table">
                <thead>
                    <tr>
                        <th style="text-align:left">Hành vi tích cực</th>
                        <th style="width:80px">Điểm cộng</th>
                    </tr>
                </thead>
                <tbody>
                    ${positiveRows}
                </tbody>
            </table>

            <table class="report-table">
                <thead>
                    <tr>
                        <th style="text-align:left">Hành vi cần cải thiện</th>
                        <th style="width:80px">Điểm trừ</th>
                    </tr>
                </thead>
                <tbody>
                    ${negativeRows}
                </tbody>
            </table>

            <div class="report-summary">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px">
                    <span>Tổng điểm hạnh kiểm:</span>
                    <span>${finalScore.toFixed(1)}</span>
                </div>
                <div style="display:flex; justify-content:space-between">
                    <span>Xếp loại hạnh kiểm:</span>
                    <span style="text-transform:uppercase">${rank}</span>
                </div>
            </div>

            <div style="margin-top:15px; font-weight:bold">Nhận xét của GVCN:</div>
            <div class="report-note">
                ${monthlyNote || ".........................................................................................................................................."}
            </div>

            <div class="report-footer">
                <div class="sign-block">
                    <div style="font-style:italic; margin-bottom:5px">&nbsp;</div>
                    <div class="sign-title">PHỤ HUYNH HỌC SINH</div>
                    <div class="sign-note">(Ký và ghi rõ họ tên)</div>
                </div>
                <div class="sign-block">
                    <div style="font-style:italic; margin-bottom:5px">Ngày ${currentDay} tháng ${vMonth} năm ${vYear}</div>
                    <div class="sign-title">GIÁO VIÊN CHỦ NHIỆM</div>
                    <div class="sign-note">(Ký và ghi rõ họ tên)</div>
                    <div class="sign-name">${appConfig.teacher || ""}</div>
                </div>
            </div>
        </div>
        `;

        printArea.innerHTML += template;
    });

    // Hiển thị Modal xem trước
    document.getElementById('printPreviewModal').style.display = 'flex';
}
function printReports() { window.print(); }
// --- HÀM MỚI: TẠO HTML PHIẾU HẠNH KIỂM (Dùng chung cho In và PDF) ---
function getStudentReportHTML(id, vMonth, vYear, currentDay) {
    const [name, className] = id.split(" - ");
    const hkData = getHKData(id);

    // Lọc lịch sử theo tháng/năm
    const monthlyHistory = hkData.history.filter(h => {
        const hDate = new Date(h.time);
        return (hDate.getMonth() + 1) === vMonth && hDate.getFullYear() === vYear;
    });

    let positiveRows = "";
    let negativeRows = "";
    let mPlus = 0;
    let mMinus = 0;

    monthlyHistory.forEach(h => {
        const dStr = new Date(h.time).getDate() + "/" + (new Date(h.time).getMonth() + 1);
        if (h.val > 0) {
            mPlus += h.val;
            positiveRows += `<tr><td>- ${h.desc} (${dStr})</td><td style="text-align:center">+${h.val}</td></tr>`;
        } else {
            mMinus += Math.abs(h.val);
            negativeRows += `<tr><td>- ${h.desc} (${dStr})</td><td style="text-align:center">${h.val}</td></tr>`;
        }
    });

    if (!positiveRows) positiveRows = `<tr><td style="font-style:italic; opacity:0.7">Không có ghi nhận</td><td style="text-align:center">-</td></tr>`;
    if (!negativeRows) negativeRows = `<tr><td style="font-style:italic; opacity:0.7">Không có ghi nhận</td><td style="text-align:center">-</td></tr>`;

    let finalScore = Math.max(0, Math.min(100, hkData.base + mPlus - mMinus));
    let rank = "Chưa Đạt";
    if (finalScore >= 80) rank = "Tốt";
    else if (finalScore >= 65) rank = "Khá";
    else if (finalScore >= 50) rank = "Đạt";

    const timeKey = `${vMonth}-${vYear}`;
    const monthlyNote = (db.hk[id].monthlyNotes && db.hk[id].monthlyNotes[timeKey]) ? db.hk[id].monthlyNotes[timeKey] : "";
    const teacherName = appConfig.teacher || "";

    // Trả về chuỗi HTML
    return `
        <div class="a4-page" style="width: 210mm; min-height: 297mm; padding: 20mm; background: white; color: black; font-family: 'Times New Roman', Times, serif; position: relative; box-sizing: border-box;">
            <div class="report-header" style="text-align: center; margin-bottom: 20px;">
                <div class="report-school" style="font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;">TRƯỜNG THPT YERSIN – ĐÀ LẠT</div>
                <div class="report-title" style="font-size: 18px; font-weight: bold; text-transform: uppercase; margin-top: 15px;">PHIẾU BÁO HẠNH KIỂM HỌC SINH</div>
            </div>

            <div class="report-info" style="margin-bottom: 15px; font-size: 14px; line-height: 1.5;">
                <div class="report-info-row" style="display: flex; justify-content: space-between;">
                    <span style="font-weight:bold">Lớp: ${className || "..."}</span>
                    <span style="font-weight:bold">Tháng: ${vMonth}/${vYear}</span>
                </div>
                <div style="margin-top:5px">
                    <span style="font-weight:bold">Họ và tên học sinh: ${name}</span>
                </div>
            </div>

            <table class="report-table" style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #000; padding: 8px; font-weight: bold; text-align: center; background: #f0f0f0;">Hành vi tích cực</th>
                        <th style="border: 1px solid #000; padding: 8px; font-weight: bold; text-align: center; background: #f0f0f0; width:80px">Điểm cộng</th>
                    </tr>
                </thead>
                <tbody>${positiveRows}</tbody>
            </table>

            <table class="report-table" style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #000; padding: 8px; font-weight: bold; text-align: center; background: #f0f0f0;">Hành vi cần cải thiện</th>
                        <th style="border: 1px solid #000; padding: 8px; font-weight: bold; text-align: center; background: #f0f0f0; width:80px">Điểm trừ</th>
                    </tr>
                </thead>
                <tbody>${negativeRows}</tbody>
            </table>

            <div class="report-summary" style="margin-top: 10px; font-size: 14px; font-weight: bold;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px">
                    <span>Tổng điểm hạnh kiểm:</span>
                    <span>${finalScore.toFixed(1)}</span>
                </div>
                <div style="display:flex; justify-content:space-between">
                    <span>Xếp loại hạnh kiểm:</span>
                    <span style="text-transform:uppercase">${rank}</span>
                </div>
            </div>

            <div style="margin-top:15px; font-weight:bold; font-size: 14px;">Nhận xét của GVCN:</div>
            <div class="report-note" style="margin-top: 10px; font-size: 14px; font-style: italic; border-bottom: 1px dotted #000; padding-bottom: 5px; min-height: 40px;">
                ${monthlyNote || ".........................................................................................................................................."}
            </div>

            <div class="report-footer" style="margin-top: 30px; display: flex; justify-content: space-between; text-align: center;">
                <div class="sign-block" style="width: 45%;">
                    <div style="font-style:italic; margin-bottom:5px; font-size: 12px;">&nbsp;</div>
                    <div class="sign-title" style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">PHỤ HUYNH HỌC SINH</div>
                    <div class="sign-note" style="font-style: italic; font-size: 12px; margin-bottom: 60px;">(Ký và ghi rõ họ tên)</div>
                </div>
                <div class="sign-block" style="width: 45%;">
                    <div style="font-style:italic; margin-bottom:5px; font-size: 12px;">Ngày ${currentDay} tháng ${vMonth} năm ${vYear}</div>
                    <div class="sign-title" style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">GIÁO VIÊN CHỦ NHIỆM</div>
                    <div class="sign-note" style="font-style: italic; font-size: 12px; margin-bottom: 60px;">(Ký và ghi rõ họ tên)</div>
                    <div class="sign-name" style="font-weight: bold; font-size: 14px;">${teacherName}</div>
                </div>
            </div>
        </div>
    `;
}

// --- HÀM CŨ ĐƯỢC CẬP NHẬT: bulkPrintHK ---
function bulkPrintHK() {
    $('contextMenu').style.display = 'none';
    if (selectedStudents.size === 0) return showToast("Vui lòng chọn ít nhất một học sinh!", "error");

    const printArea = document.getElementById('printArea');
    printArea.innerHTML = ""; 

    const vMonth = parseInt(document.getElementById('viewMonth').value) || (new Date().getMonth() + 1);
    const vYear = parseInt(document.getElementById('viewYear').value) || new Date().getFullYear();
    const currentDay = new Date().getDate();

    selectedStudents.forEach(id => {
        // Gọi hàm tạo HTML đã tách ở trên
        printArea.innerHTML += getStudentReportHTML(id, vMonth, vYear, currentDay);
    });

    document.getElementById('printPreviewModal').style.display = 'flex';
}

async function bulkExportPDF() {
    // 1. Ẩn menu chuột phải (nếu có)
    const ctx = document.getElementById('contextMenu');
    if (ctx) ctx.style.display = 'none';

    // 2. Kiểm tra danh sách
    if (selectedStudents.size === 0) return showToast("⚠️ Chưa chọn học sinh nào!", "error");

    // 3. Lấy thông tin ngày tháng
    const vMonth = parseInt(document.getElementById('viewMonth').value) || (new Date().getMonth() + 1);
    const vYear = parseInt(document.getElementById('viewYear').value) || new Date().getFullYear();
    const currentDay = new Date().getDate();

    showToast("⏳ Đang xử lý PDF... (Máy sẽ hơi lag 1 chút)", "info");

    // Lưu lại vị trí cuộn trang hiện tại
    const originalScrollPos = window.scrollY;

    try {
        if (!window.jspdf) throw new Error("Thư viện PDF lỗi. Hãy F5 lại trang.");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();

        // --- TẠO VÙNG CHỨA OFF-SCREEN (Ngoài màn hình) ---
        let tempDiv = document.getElementById('pdf-offscreen-render');
        if (tempDiv) tempDiv.remove(); // Xóa cái cũ nếu bị kẹt
        
        tempDiv = document.createElement('div');
        tempDiv.id = "pdf-offscreen-render";
        
        // CSS quan trọng: Đưa ra khỏi màn hình nhưng vẫn giữ kích thước thật
        Object.assign(tempDiv.style, {
            position: 'absolute',
            top: '0',
            left: '-10000px', // Đẩy sang trái cực xa để không ai thấy
            width: '210mm',   // Đúng khổ A4
            background: '#ffffff', // Nền trắng bắt buộc
            color: '#000000',      // Chữ đen bắt buộc
            zIndex: '99999'
        });
        document.body.appendChild(tempDiv);

        const studentsArr = Array.from(selectedStudents);
        let isFirstPage = true;

        // --- BẮT BUỘC: Cuộn lên đầu trang để html2canvas không bị lệch ---
        window.scrollTo(0, 0);

        for (let i = 0; i < studentsArr.length; i++) {
            const id = studentsArr[i];

            // 1. Render HTML của học sinh đó vào vùng tạm
            // Lưu ý: Hàm getStudentReportHTML cần trả về HTML sạch, không dính style dark mode
            tempDiv.innerHTML = getStudentReportHTML(id, vMonth, vYear, currentDay);

            // Cưỡng ép style cho vùng tạm (đề phòng style dark mode của web ám vào)
            const allElements = tempDiv.querySelectorAll('*');
            allElements.forEach(el => {
                el.style.color = 'black';
                el.style.borderColor = '#000';
                if(el.tagName === 'TABLE' || el.tagName === 'TD' || el.tagName === 'TH') {
                    el.style.borderColor = '#000';
                    el.style.color = '#000';
                }
            });

            // 2. Chờ tải ảnh/font (rất quan trọng)
            await new Promise(r => setTimeout(r, 200));

            // 3. Chụp ảnh từ vùng Off-screen
            const canvas = await html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff', // Ép nền trắng lần nữa
                windowWidth: 1600,
                x: 0, // Chụp từ tọa độ 0 của div đó
                y: 0
            });

            // 4. Đưa vào PDF
            const imgData = canvas.toDataURL('image/jpeg', 0.9); // Nén JPEG 0.9 cho nhẹ
            if (!isFirstPage) doc.addPage();
            doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            isFirstPage = false;

            // Báo tiến độ
            if(studentsArr.length > 5) {
                showToast(`Đã xong ${i + 1}/${studentsArr.length} phiếu...`, "info");
            }
        }

        // --- XUẤT FILE ---
        const fileName = `PhieuHK_Thang${vMonth}_${vYear}.pdf`;
        doc.save(fileName);
        
        showToast("✅ Xuất PDF thành công!", "success");

    } catch (err) {
        console.error(err);
        alert("Lỗi: " + err.message);
    } finally {
        // Dọn dẹp: Xóa vùng tạm và trả lại vị trí cuộn chuột cũ cho người dùng
        const t = document.getElementById("pdf-offscreen-render");
        if(t) t.remove();
        window.scrollTo(0, originalScrollPos);
    }
}
function createRipple(event) { const button = event.currentTarget; const circle = document.createElement("span"); const diameter = Math.max(button.clientWidth, button.clientHeight); const radius = diameter / 2; const rect = button.getBoundingClientRect(); circle.style.width = circle.style.height = `${diameter}px`; circle.style.left = `${event.clientX - rect.left - radius}px`; circle.style.top = `${event.clientY - rect.top - radius}px`; circle.classList.add("ripple"); const existingRipple = button.getElementsByClassName("ripple")[0]; if (existingRipple) existingRipple.remove(); button.appendChild(circle); }
function initAnimations() { const selectors = ['.btn', '.nav-item', '.student-card', '.holo-card', '.icon-btn', '.sub-tab-btn', '.spin-btn', '.theme-option']; document.querySelectorAll(selectors.join(', ')).forEach(btn => { btn.addEventListener('click', createRipple); }); const observer = new MutationObserver((mutations) => { mutations.forEach((mutation) => { mutation.addedNodes.forEach((node) => { if (node.nodeType === 1) { if (node.matches && node.matches(selectors.join(', '))) { node.addEventListener('click', createRipple); } selectors.forEach(sel => { node.querySelectorAll(sel).forEach(btn => { btn.addEventListener('click', createRipple); }); }); } }); }); }); observer.observe(document.body, { childList: true, subtree: true }); }
function showCelebration(name) { $('celWinner').innerText = name; $('celebrateModal').style.display = 'flex'; }
function closeCelebration() { $('celebrateModal').style.display = 'none'; }

// ======================================================
// 9. GAME CENTER LOGIC
// ======================================================
let gameWheelCtx, gameWheelCanvas;
let raceInterval;
let timerInterval, timerTime = 0;

// Override switchMode để xử lý tab Games và ẩn hiện công cụ header
switchMode = function(mode) {
    localStorage.setItem('yersin_saved_mode', mode);
    // 1. Xử lý ẩn/hiện thanh công cụ quản lý học sinh (Student Tools)
    const tools = document.getElementById('studentTools');
    if (tools) {
        if (mode === 'tkb' || mode === 'games') {
            tools.style.display = 'none';
        } else {
            tools.style.display = 'flex';
        }
    }

    // [MỚI] 2. Xử lý ẩn/hiện thanh Tuần trên Header
    const weekNav = document.getElementById('headerWeekNav');
    if (weekNav) {
        if (mode === 'tkb') {
            weekNav.style.display = 'flex'; // Chỉ hiện khi là TKB
            renderWeekInfo(); // Vẽ lại thông tin tuần
        } else {
            weekNav.style.display = 'none';
        }
    }

    // ... (Phần còn lại của hàm switchMode giữ nguyên logic cũ của bạn) ...
    // Logic cũ cho Games
    if(mode === 'games') {
        currentMode = 'games';
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'hk-mode', 'acad-mode', 'tkb-mode'));
        $('nav-games').classList.add('active');
        $('pageTitle').innerText = "TRUNG TÂM TIỆN ÍCH";
        $('pageTitle').style.color = "var(--neon-green)";
        $('pageTitle').style.textShadow = "0 0 10px var(--neon-green)";
        switchPage('games');
        initGameWheel();
        clearSelection();
        return;
    }

    // Logic cũ cho các tab còn lại
    currentMode = mode; 
    document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active', 'hk-mode', 'acad-mode', 'tkb-mode'); el.style.color = ''; el.style.borderColor = ''; el.style.textShadow = ''; });
    
    const rootStyles = getComputedStyle(document.documentElement); 
    const mainColor = rootStyles.getPropertyValue('--neon-purple').trim(); 
    const goldColor = rootStyles.getPropertyValue('--neon-gold').trim(); 
    const cyanColor = rootStyles.getPropertyValue('--neon-cyan').trim();
    
    let baseTitle = "";
    if(mode === 'hk') { 
        $('nav-hk').classList.add('active', 'hk-mode'); 
        $('nav-hk').style.color = mainColor; $('nav-hk').style.borderColor = mainColor; $('nav-hk').style.textShadow = `0 0 10px ${mainColor}`; 
        baseTitle = "QUẢN LÝ HẠNH KIỂM"; 
        $('pageTitle').style.color = mainColor; $('pageTitle').style.textShadow = `0 0 10px ${mainColor}`; 
        switchPage('home'); renderList(); 
    } 
    else if (mode === 'acad') { 
        $('nav-acad').classList.add('active', 'acad-mode'); 
        $('nav-acad').style.color = goldColor; $('nav-acad').style.borderColor = goldColor; $('nav-acad').style.textShadow = `0 0 10px ${goldColor}`; 
        baseTitle = "SỔ ĐIỂM"; 
        $('pageTitle').style.color = goldColor; $('pageTitle').style.textShadow = `0 0 10px ${goldColor}`; 
        switchPage('home'); renderList(); 
    } 
    else if (mode === 'tkb') { 
        $('nav-tkb').classList.add('active', 'tkb-mode'); 
        $('nav-tkb').style.color = cyanColor; $('nav-tkb').style.borderColor = cyanColor; $('nav-tkb').style.textShadow = `0 0 10px ${cyanColor}`; 
        baseTitle = "THỜI KHÓA BIỂU"; 
        $('pageTitle').style.color = cyanColor; $('pageTitle').style.textShadow = `0 0 10px ${cyanColor}`; 
        switchPage('tkb'); switchTkbView('teacher'); 
    }
    
    const finalTitle = appConfig.teacher ? `${appConfig.teacher} - ${baseTitle}` : baseTitle; 
    $('pageTitle').innerText = finalTitle; 
    clearSelection();
}
function getGameInputList() { return $('gameInputData').value.trim().split('\n').map(s => s.trim()).filter(s => s !== ""); }
function loadClassToGame() { 
    const cls = $('classSelect').value; 
    if(!cls) return showToast("Vui lòng chọn lớp ở menu trên cùng trước!", "error"); 
    const list = students.filter(s => s.includes(cls)).map(s => s.split(' - ')[0]); 
    $('gameInputData').value = list.join('\n'); 
    showToast(`Đã nạp ${list.length} học sinh từ ${cls}`, "success"); 
    
    // THÊM DÒNG NÀY ĐỂ VẼ LẠI VÒNG QUAY NGAY LẬP TỨC
    if(document.getElementById('tab-wheel').classList.contains('active')) {
        drawGameWheel();
    }
}
function switchGameTab(tabName) { document.querySelectorAll('.game-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.game-tab-btn').forEach(el => el.classList.remove('active')); $(`tab-${tabName}`).classList.add('active'); const btns = document.querySelectorAll('.game-tab-btn'); if(tabName === 'wheel') { btns[0].classList.add('active'); initGameWheel(); } if(tabName === 'race') btns[1].classList.add('active'); if(tabName === 'group') btns[2].classList.add('active'); if(tabName === 'timer') btns[3].classList.add('active'); }

// --- 1. WHEEL LOGIC ---
function initGameWheel() { gameWheelCanvas = $('gameWheelCanvas'); gameWheelCtx = gameWheelCanvas.getContext('2d'); drawGameWheel(); }
function drawGameWheel() { const list = getGameInputList(); const colors = ['#bd00ff', '#00eaff', '#00ffcc', '#fbbf24', '#4ade80', '#f43f5e', '#3b82f6']; const num = list.length > 0 ? list.length : 2; const data = list.length > 0 ? list : ["Nhập tên", "Để quay"]; const arc = (2 * Math.PI) / num; const cx = 200, cy = 200, r = 195; gameWheelCtx.clearRect(0, 0, 400, 400); for (let i = 0; i < num; i++) { const angle = i * arc - Math.PI / 2; gameWheelCtx.beginPath(); gameWheelCtx.moveTo(cx, cy); gameWheelCtx.arc(cx, cy, r, angle, angle + arc); gameWheelCtx.lineTo(cx, cy); gameWheelCtx.fillStyle = colors[i % colors.length]; gameWheelCtx.fill(); gameWheelCtx.stroke(); gameWheelCtx.save(); gameWheelCtx.translate(cx, cy); gameWheelCtx.rotate(angle + arc / 2); gameWheelCtx.textAlign = "right"; gameWheelCtx.fillStyle = "#fff"; gameWheelCtx.font = "bold 14px Quicksand"; gameWheelCtx.shadowColor = "black"; gameWheelCtx.shadowBlur = 4; gameWheelCtx.fillText(data[i].substring(0, 18), r - 20, 5); gameWheelCtx.restore(); } }
function spinGameWheel() { const list = getGameInputList(); if(list.length < 2) return showToast("Cần ít nhất 2 người để quay!", "error"); if(isSpinning) return; isSpinning = true; $('gameWheelResult').innerText = "Đang quay..."; let currentRot = 0; const spins = 10; const randomDeg = Math.floor(Math.random() * 360); const totalDeg = spins * 360 + randomDeg; gameWheelCanvas.style.transition = "transform 6s cubic-bezier(0.25, 0.1, 0.25, 1)"; gameWheelCanvas.style.transform = `rotate(${totalDeg}deg)`; let tickCount = 0; const intv = setInterval(()=>{ tickCount++; if(tickCount < 30) playTickSound(); else clearInterval(intv);}, 200); setTimeout(() => { isSpinning = false; const actualAngle = totalDeg % 360; const arcDeg = 360 / list.length; let index = Math.floor((360 - actualAngle + 90) % 360 / arcDeg); index = index % list.length; const winner = list[index]; playWinSound(); $('gameWheelResult').innerText = `🎉 NGƯỜI ĐƯỢC CHỌN: ${winner}`; showCelebration(winner); gameWheelCanvas.style.transition = 'none'; gameWheelCanvas.style.transform = `rotate(${actualAngle}deg)`; }, 6000); }

// --- 2. RACING LOGIC ---
function startSpaceRace() { const list = getGameInputList(); if(list.length < 2) return showToast("Cần ít nhất 2 tay đua!", "error"); const track = $('raceTrack'); track.innerHTML = ""; const racers = list.map(name => { return { name: name, pos: 0, speed: Math.random() * 0.5 + 0.2, finished: false }; }); const ships = ["🚀", "🛸", "🛰️", "🚤", "🏎️", "🛵"]; racers.forEach((r, idx) => { const lane = document.createElement('div'); lane.className = 'racer-lane'; const shipIcon = ships[idx % ships.length]; lane.innerHTML = `<div class="racer-ship" id="ship-${idx}"><span class="racer-name">${r.name}</span>${shipIcon}</div><div class="finish-line"></div>`; track.appendChild(lane); }); if(raceInterval) clearInterval(raceInterval); let rank = 1; raceInterval = setInterval(() => { let allFinished = true; racers.forEach((r, idx) => { if(!r.finished) { allFinished = false; r.pos += r.speed + (Math.random() * 0.5); const el = document.getElementById(`ship-${idx}`); if(el) el.style.left = Math.min(r.pos, 92) + '%'; if(r.pos >= 92) { r.finished = true; el.innerHTML += `<span style="position:absolute; right:-30px; top:5px; font-weight:bold; color:var(--neon-gold)">#${rank}</span>`; if(rank === 1) { playWinSound(); showCelebration(r.name); } rank++; } } }); if(allFinished) clearInterval(raceInterval); }, 50); }

// --- 3. RANDOM GROUP LOGIC ---
function generateGroups() { let list = getGameInputList(); if(list.length < 2) return showToast("Danh sách quá ngắn!", "error"); for (let i = list.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [list[i], list[j]] = [list[j], list[i]]; } const mode = $('groupMode').value; const val = parseInt($('groupValue').value); if(val < 1) return; let groups = []; if(mode === 'count') { const numGroups = val; for(let i=0; i<numGroups; i++) groups.push([]); list.forEach((name, idx) => { groups[idx % numGroups].push(name); }); } else { const size = val; for (let i = 0; i < list.length; i += size) { groups.push(list.slice(i, i + size)); } } const res = $('groupResult'); res.innerHTML = ""; const groupColors = ['#4ade80', '#22d3ee', '#bd00ff', '#fbbf24', '#f43f5e']; groups.forEach((g, idx) => { const color = groupColors[idx % groupColors.length]; const box = document.createElement('div'); box.className = 'group-box'; box.style.borderColor = color; let membersHtml = g.map(m => `<li>${m}</li>`).join(''); box.innerHTML = `<div class="group-title" style="color:${color}">NHÓM ${idx+1} (${g.length})</div><ul class="group-list">${membersHtml}</ul>`; res.appendChild(box); }); }

// --- 4. TIMER LOGIC ---
function startTimer() { if(timerInterval) clearInterval(timerInterval); const m = parseInt($('timerMin').value) || 0; const s = parseInt($('timerSec').value) || 0; if(timerTime === 0) timerTime = m * 60 + s; if(timerTime <= 0) return; $('timerMin').disabled = true; $('timerSec').disabled = true; timerInterval = setInterval(() => { timerTime--; updateTimerDisplay(); if(timerTime <= 0) { clearInterval(timerInterval); playWinSound(); $('displayTimer').style.color = 'var(--neon-red)'; $('displayTimer').classList.add('shake-anim'); alert("⏰ HẾT GIỜ!"); $('displayTimer').classList.remove('shake-anim'); } }, 1000); }
function pauseTimer() { clearInterval(timerInterval); }
function resetTimer() { clearInterval(timerInterval); timerTime = 0; $('timerMin').disabled = false; $('timerSec').disabled = false; $('displayTimer').innerText = "00:00"; $('displayTimer').style.color = "var(--neon-red)"; }
function updateTimerDisplay() { const m = Math.floor(timerTime / 60); const s = timerTime % 60; $('displayTimer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; $('displayTimer').style.color = timerTime < 10 ? 'red' : 'var(--neon-green)'; }

// Hàm làm đẹp nội dung ô TKB
function formatCellDisplay(val) {
    if (!val) return "";
    // Tách dòng dựa vào ký tự xuống dòng \n
    const lines = val.toString().split('\n');
    
    // Nếu có 2 dòng (Môn + GV)
    if (lines.length >= 2) {
        const subj = lines[0];
        // Ghép các dòng còn lại thành tên GV (bỏ dấu ngoặc đơn nếu muốn gọn hơn)
        let teach = lines.slice(1).join(' ').replace(/[()]/g, ''); 
        return `<div class="c-subj">${subj}</div><div class="c-teach">${teach}</div>`;
    }
    
    // Nếu chỉ có 1 dòng (chỉ có Môn hoặc sự kiện)
    return `<div class="c-subj" style="font-size:40px">${val}</div>`;
}

// ==========================================
// TRUNG TÂM NHẬN XÉT (LOGIC MỚI)
// ==========================================

let cmtCurrentTab = 'pending'; // 'pending' hoặc 'done'
let cmtCurrentID = null;

function openCommentManager() {
    // 1. Nạp năm hiện tại vào menu
    const now = new Date();
    const curY = now.getFullYear();
    const selY = $('cmtYear');
    selY.innerHTML = "";
    [curY-1, curY, curY+1].forEach(y => {
        const o = document.createElement('option');
        o.value = y; o.innerText = y; if(y===curY) o.selected=true;
        selY.appendChild(o);
    });
    $('cmtMonth').value = now.getMonth() + 1;

    // 2. Mở Modal
    $('commentManagerModal').style.display = 'flex';
    
    // 3. Render dữ liệu
    renderCommentManager();
}

function renderCommentManager() {
    const month = $('cmtMonth').value;
    const year = $('cmtYear').value;
    const keyDate = `${month}-${year}`; // Key lưu trữ: ví dụ "12-2025"
    
    const container = $('cmtStudentList');
    container.innerHTML = "";
    
    // Phân loại học sinh
    let listPending = [];
    let listDone = [];
    
    // Lọc theo lớp đang chọn bên ngoài
    const currentClass = $('classSelect').value;

    students.forEach(s => {
        // Kiểm tra lớp
        if (currentClass && !s.includes(currentClass) && !s.endsWith(currentClass)) return;

        // Đảm bảo cấu trúc dữ liệu tồn tại
        if (!db.hk[s].monthlyNotes) db.hk[s].monthlyNotes = {};
        
        // Kiểm tra đã có comment tháng này chưa
        const note = db.hk[s].monthlyNotes[keyDate];
        const [name, cls] = s.split(" - ");
        
        const itemObj = { id: s, name: name, class: cls, note: note };
        
        if (note && note.trim() !== "") {
            listDone.push(itemObj);
        } else {
            listPending.push(itemObj);
        }
    });

    // Cập nhật số lượng trên Tab
    $('countPending').innerText = listPending.length;
    $('countDone').innerText = listDone.length;

    // Vẽ danh sách dựa trên Tab đang chọn
    const listToShow = (cmtCurrentTab === 'pending') ? listPending : listDone;

    if(listToShow.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.5">Không có học sinh nào.</div>`;
    } else {
        listToShow.forEach(st => {
            const div = document.createElement('div');
            div.className = `cmt-item ${st.id === cmtCurrentID ? 'active' : ''} ${cmtCurrentTab==='done'?'done-item':''}`;
            div.onclick = () => selectStudentForComment(st.id);
            div.innerHTML = `
                <div style="font-weight:bold; font-size:14px">${st.name}</div>
                <div style="font-size:11px; opacity:0.7; margin-left:auto">${st.class}</div>
            `;
            container.appendChild(div);
        });
    }
    
    // Nếu ID đang chọn không còn trong list hiện tại (do vừa bị move), clear màn hình phải
    if (cmtCurrentID && !listToShow.find(x => x.id === cmtCurrentID)) {
        $('cmtEditorArea').style.display = 'none';
        $('cmtEmptyState').style.display = 'flex';
        cmtCurrentID = null;
    }
}

function switchCommentTab(tab) {
    cmtCurrentTab = tab;
    
    // Cập nhật giao diện Tab
    if(tab === 'pending') {
        $('tabPending').style.color = "var(--neon-red)";
        $('tabPending').style.borderBottomColor = "var(--neon-red)";
        $('tabPending').style.opacity = "1";
        
        $('tabDone').style.color = "var(--text)";
        $('tabDone').style.borderBottomColor = "transparent";
        $('tabDone').style.opacity = "0.5";
    } else {
        $('tabDone').style.color = "var(--neon-green)";
        $('tabDone').style.borderBottomColor = "var(--neon-green)";
        $('tabDone').style.opacity = "1";
        
        $('tabPending').style.color = "var(--text)";
        $('tabPending').style.borderBottomColor = "transparent";
        $('tabPending').style.opacity = "0.5";
    }
    
    // Reset lựa chọn
    cmtCurrentID = null;
    $('cmtEditorArea').style.display = 'none';
    $('cmtEmptyState').style.display = 'flex';
    
    renderCommentManager();
}

function selectStudentForComment(id) {
    cmtCurrentID = id;
    renderCommentManager(); // Để update trạng thái active class
    
    // Hiển thị khu vực nhập
    $('cmtEmptyState').style.display = 'none';
    $('cmtEditorArea').style.display = 'flex';
    
    // Load thông tin
    const [name, cls] = id.split(" - ");
    $('cmtName').innerText = name;
    $('cmtAvatar').src = avatars[id] || generateAvatar(name);
    
    const keyDate = `${$('cmtMonth').value}-${$('cmtYear').value}`;
    const savedNote = db.hk[id].monthlyNotes[keyDate] || "";
    $('cmtContent').value = savedNote;
    
    // Tính điểm tháng đó để GV tham khảo (Mẹo: dùng logic cũ)
    const fullData = getHKData(id);
    // (Ở đây ta tạm lấy điểm tổng hiện tại, nếu muốn chính xác điểm tháng thì cần hàm filter history như bài trước)
    $('cmtScoreInfo').innerText = `Điểm tổng kết hiện tại: ${fullData.final.toFixed(1)} - Xếp loại: ${fullData.final>=80?'Tốt':(fullData.final>=65?'Khá':'Đạt')}`;
    
    $('cmtContent').focus();
}

function saveMonthlyComment() {
    if(!cmtCurrentID) return;
    
    const content = $('cmtContent').value.trim();
    const keyDate = `${$('cmtMonth').value}-${$('cmtYear').value}`;
    
    // Lưu vào DB
    if (!db.hk[cmtCurrentID].monthlyNotes) db.hk[cmtCurrentID].monthlyNotes = {};
    db.hk[cmtCurrentID].monthlyNotes[keyDate] = content;
    
    // Lưu LocalStorage
    saveData();
    
    showToast("Đã lưu nhận xét!", "success");
    
    // LOGIC TỰ ĐỘNG CHUYỂN
    // Khi render lại, hàm renderCommentManager sẽ tự kiểm tra "note" có dữ liệu không
    // Nếu có -> Chuyển sang list Done. Nếu rỗng -> Về Pending.
    renderCommentManager();
    
    // Tự động chọn học sinh tiếp theo trong danh sách Pending (nếu đang ở tab Pending)
    if(cmtCurrentTab === 'pending') {
        // Tìm phần tử đầu tiên trong list Pending (đã được vẽ lại)
        const firstItem = document.querySelector('#cmtStudentList .cmt-item');
        if(firstItem) {
            firstItem.click(); // Tự động click vào em tiếp theo
        } else {
            $('cmtEditorArea').style.display = 'none';
            $('cmtEmptyState').innerHTML = `<h3>🎉 Chúc mừng! Bạn đã nhận xét hết lớp!</h3>`;
            $('cmtEmptyState').style.display = 'flex';
        }
    }
}

function skipComment() {
    // Chỉ đơn giản là chọn em tiếp theo mà không lưu
    const items = document.querySelectorAll('#cmtStudentList .cmt-item');
    let foundCurrent = false;
    for(let item of items) {
        if(foundCurrent) {
            item.click();
            return;
        }
        if(item.classList.contains('active')) foundCurrent = true;
    }
}
// --- HÀM XUẤT TKB RA EXCEL (CHUẨN FILE MẪU) ---
function exportCurrentTKB() {
    // 1. Xác định dữ liệu nguồn
    let dataSrc = {};
    let sheetTitle = "";
    
    if(tkbViewMode === 'teacher') {
        dataSrc = tkbData.teacher;
        sheetTitle = "THỜI KHÓA BIỂU GIÁO VIÊN";
    } else if(tkbViewMode === 'student') {
        dataSrc = tkbData.student;
        sheetTitle = "THỜI KHÓA BIỂU CÁC LỚP";
    } else if(tkbViewMode === 'grad') {
        dataSrc = tkbData.grad;
        sheetTitle = "LỊCH ÔN TỐT NGHIỆP";
    }

    const headers = Object.keys(dataSrc).sort();
    if (headers.length === 0) return showToast("Chưa có dữ liệu để xuất!", "error");

    showToast("Đang tạo file Excel chuẩn mẫu...", "info");

    // 2. Chuẩn bị dữ liệu cho Sheet
    // Dòng 1: Tiêu đề lớn
    const wsData = [
        [sheetTitle.toUpperCase(), "", "", ""], // A1
        ["(Áp dụng từ ngày ... đến ngày ...)", "", "", ""], // A2
        ["", "", "", ""], // A3 (Dòng trống)
        ["Thứ", "Tiết", ...headers] // A4: Header chính
    ];

    // Định nghĩa gộp ô (Merges)
    const merges = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: headers.length + 1 } }, // Gộp tiêu đề lớn
        { s: { r: 1, c: 0 }, e: { r: 1, c: headers.length + 1 } }  // Gộp ngày áp dụng
    ];

    // 3. Tạo dữ liệu các dòng (Từ Thứ 2 -> CN)
    let currentRowIndex = 4; // Bắt đầu từ dòng 5 (index 4)
    
    // Loop các ngày từ 2 đến 7 (hoặc 8)
    for (let day = 2; day <= 7; day++) {
        let dayName = "Thứ " + day;
        let startRow = currentRowIndex;

        // Loop 10 tiết (Sáng 1-5, Chiều 6-10)
        // Hoặc bạn có thể sửa thành loop 5 tiết nếu chỉ học sáng
        for (let period = 0; period < 10; period++) {
            
            // Xử lý ngắt nghỉ trưa (sau tiết 5) - Giống file mẫu nếu cần
            // Nếu muốn để trống dòng ngăn cách thì thêm logic ở đây.
            // Ở đây tôi làm liền mạch 1-10 cho gọn.

            let rowData = [dayName, period + 1]; // Cột A: Thứ, Cột B: Tiết

            // Loop qua từng Lớp/GV để lấy dữ liệu
            headers.forEach(target => {
                let cellContent = "";
                if (dataSrc[target] && dataSrc[target][day] && dataSrc[target][day][period]) {
                    // Lấy nội dung, thay thế xuống dòng bằng dấu cách cho gọn hoặc giữ nguyên
                    cellContent = dataSrc[target][day][period];
                    // Tùy chọn: Xóa tên GV trong ngoặc nếu muốn giống hệt mẫu chỉ hiện Môn
                    // cellContent = cellContent.split('\n')[0]; 
                }
                rowData.push(cellContent);
            });

            wsData.push(rowData);
            currentRowIndex++;
        }

        // Gộp ô cột "Thứ" cho ngày hiện tại (Từ tiết 1 đến tiết 10)
        // startRow là dòng bắt đầu ngày, currentRowIndex - 1 là dòng kết thúc
        merges.push({ s: { r: startRow, c: 0 }, e: { r: currentRowIndex - 1, c: 0 } });
    }

    // 4. Tạo Workbook & Worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Gán danh sách Merge vào Sheet
    ws['!merges'] = merges;

    // 5. Trang trí (Style) - Dùng thư viện xlsx-js-style đã tích hợp
    const borderStyle = { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} };
    const fontMain = { name: "Times New Roman", sz: 11 };
    const alignCenter = { vertical: "center", horizontal: "center", wrapText: true };

    // Style cho Tiêu đề lớn (A1)
    ws["A1"].s = { font: { name: "Times New Roman", sz: 16, bold: true }, alignment: alignCenter };
    // Style cho Ngày áp dụng (A2)
    ws["A2"].s = { font: { name: "Times New Roman", sz: 12, italic: true }, alignment: alignCenter };

    // Duyệt qua tất cả các ô từ dòng 4 trở đi để kẻ khung
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    for (let R = 3; R <= range.e.r; ++R) { // Bắt đầu từ dòng 4 (index 3)
        for (let C = 0; C <= range.e.c; ++C) {
            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
            if (!ws[cellRef]) ws[cellRef] = { v: "", t: "s" }; // Tạo ô rỗng nếu thiếu để kẻ khung đủ
            
            // Style chung
            let cellStyle = {
                font: fontMain,
                border: borderStyle,
                alignment: alignCenter
            };

            // Nếu là dòng Header (Thứ, Tiết, Tên Lớp...) -> In đậm, nền xám nhẹ
            if (R === 3) {
                cellStyle.font = { ...fontMain, bold: true };
                cellStyle.fill = { fgColor: { rgb: "E0E0E0" } };
            }
            // Nếu là cột "Thứ" hoặc "Tiết" -> In đậm
            if (C === 0 || C === 1) {
                cellStyle.font = { ...fontMain, bold: true };
            }

            ws[cellRef].s = cellStyle;
        }
    }

    // 6. Chỉnh độ rộng cột
    const wscols = [{wch:10}, {wch:5}]; // Cột Thứ, Tiết nhỏ
    headers.forEach(() => wscols.push({wch: 15})); // Các cột lớp rộng vừa phải
    ws['!cols'] = wscols;

    // 7. Xuất file
    XLSX.utils.book_append_sheet(wb, ws, "TKB_Sheet1");
    const timeStr = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, `TKB_Export_${timeStr}.xlsx`);
    
    showToast("✅ Đã xuất file TKB chuẩn mẫu!", "success");
}
// --- HÀM BẬT/TẮT MENU PHẢI ---
function toggleRightMenu() {
    const panel = document.getElementById('rsPanel');
    const overlay = document.getElementById('rsOverlay');
    
    if (panel.classList.contains('open')) {
        panel.classList.remove('open');
        overlay.style.display = 'none';
    } else {
        panel.classList.add('open');
        overlay.style.display = 'block';
    }
}
// --- LOGIC QUẢN LÝ TUẦN & TKB ---
let weekData = JSON.parse(localStorage.getItem("hk_v33_weeks") || "{}");
let isDateLocked = true; // Mặc định khóa

// === [LOGIC MỚI] TỰ ĐỘNG TÌM TUẦN XA NHẤT ===
// 1. Lấy tất cả các tuần đang có trong lịch sử (tkbHistory đã load ở đầu file)
const availableWeeks = Object.keys(tkbHistory).map(w => parseInt(w)).filter(w => !isNaN(w));

// 2. Tìm tuần lớn nhất. Nếu chưa có dữ liệu nào thì mặc định Tuần 1
let maxWeek = 1;
if (availableWeeks.length > 0) {
    maxWeek = Math.max(...availableWeeks);
}

// 3. Khởi tạo currentWeek bằng tuần xa nhất đó
let currentWeek = maxWeek;

// 4. Gọi hàm nạp dữ liệu ngay lập tức để hiển thị TKB của tuần này
loadDataForWeek(currentWeek);

// 5. Cập nhật hiển thị số tuần trên Header
renderWeekInfo();
// ============================================
// Hàm chuyển tuần
function changeWeek(delta) {
    let newWeek = currentWeek + delta;
    if (newWeek < 1) return; // Không cho về tuần < 1

    currentWeek = newWeek;
    
    // GỌI HÀM LOAD DỮ LIỆU TỪ LỊCH SỬ
    loadDataForWeek(currentWeek);
    
    renderWeekInfo();
}

// Hàm mới: Tải dữ liệu TKB của một tuần cụ thể
function loadDataForWeek(week) {
    // Kiểm tra xem trong History có dữ liệu của tuần này không
    if (tkbHistory[week]) {
        // Nếu có: Lấy ra và gán vào tkbData hiện tại
        tkbData = JSON.parse(JSON.stringify(tkbHistory[week]));
        saveData(); // Lưu lại trạng thái hiện tại
        
        // Vẽ lại giao diện
        // Nếu đang ở màn hình list -> vẽ lại list
        if(document.getElementById('tkbListView').style.display !== 'none') {
            renderTKBCards(); 
        } 
        // Nếu đang xem chi tiết -> vẽ lại chi tiết (nếu target còn tồn tại)
        else if(currentTkbTarget) {
            renderTKBTable(currentTkbTarget);
        }
        
        // Hiệu ứng báo cho người dùng biết đã load dữ liệu cũ
        const dateRange = weekData[week] || "";
        showToast(`Đã tải dữ liệu Tuần ${week} ${dateRange ? '('+dateRange+')' : ''}`, "success");
    } else {
        // Nếu KHÔNG có dữ liệu: Xóa trắng tkbData hiện tại để người dùng biết là chưa có file
        tkbData = { teacher: {}, student: {}, grad: {} };
        saveData();
        
        renderTKBCards();
        if(document.getElementById('tkbDetailView').style.display === 'block') {
            document.getElementById('tkbContent').innerHTML = `<div style="text-align:center; padding:50px; opacity:0.5">Chưa có dữ liệu TKB cho Tuần ${week}.<br>Vui lòng upload file Excel.</div>`;
        }
        
        showToast(`Tuần ${week} chưa có dữ liệu.`, "info");
    }
}



function saveWeekDate() {
    const val = document.getElementById('weekDateRange').value;
    weekData[currentWeek] = val;
    localStorage.setItem("hk_v33_weeks", JSON.stringify(weekData));
    showToast(`Đã lưu thời gian Tuần ${currentWeek}`, "success");
}

function toggleDateLock() {
    isDateLocked = !isDateLocked;
    const btn = document.getElementById('dateLockBtn');
    const txt = document.getElementById('lockStatusTxt');
    const icon = btn.querySelector('.lock-icon');
    
    // Trỏ tới input trên Header
    const input = document.getElementById('headerWeekDate');

    if (isDateLocked) {
        btn.classList.remove('green'); btn.classList.add('red');
        icon.innerText = "🔒"; txt.innerText = "ĐÃ KHÓA NGÀY";
        if(input) { 
            input.disabled = true; 
            input.classList.add('date-locked'); 
            input.style.borderBottom = "none"; // CSS inline reset
        }
        showToast("Đã KHÓA chỉnh sửa ngày tháng", "info");
    } else {
        btn.classList.remove('red'); btn.classList.add('green');
        icon.innerText = "🔓"; txt.innerText = "ĐANG MỞ KHÓA";
        if(input) { 
            input.disabled = false; 
            input.classList.remove('date-locked'); 
            input.style.borderBottom = "1px solid var(--neon-cyan)"; // Hiện dòng kẻ để biết đang nhập
            input.focus(); 
        }
        showToast("Đã MỞ khóa. Bạn có thể sửa ngày trên Header.", "success");
    }
}
function renderWeekInfo() {
    // Sửa ID trỏ tới phần tử trên Header
    const display = document.getElementById('headerWeekTitle');
    const input = document.getElementById('headerWeekDate');
    
    if(display) display.innerText = `TUẦN ${currentWeek}`;
    if(input) input.value = weekData[currentWeek] || "";
}

function saveWeekDate() {
    // Sửa ID trỏ tới input trên Header
    const val = document.getElementById('headerWeekDate').value;
    weekData[currentWeek] = val;
    localStorage.setItem("hk_v33_weeks", JSON.stringify(weekData));
    showToast(`Đã lưu thời gian Tuần ${currentWeek}`, "success");
}
// ======================================================
// ✅ CODE HỢP NHẤT: MENU CHUỘT PHẢI & QUÉT CHỌN KHUNG XANH
// ======================================================

// 1. Cấu hình biến chung (CHỈ KHAI BÁO 1 LẦN)
let isDragMode = false;
let dragStartX = 0, dragStartY = 0;
const dragBox = document.getElementById('selectionBox');
const ctxMenu = document.getElementById('contextMenu');
const homeArea = document.getElementById('home'); 


// Hàm kiểm tra thẻ nào nằm trong khung
function checkDragIntersection(x, y, w, h) {
    const cards = document.querySelectorAll('.student-card');
    cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const id = card.getAttribute('data-id');
        
        // Logic kiểm tra 2 hình chữ nhật giao nhau
        const isOverlapping = !(rect.right < x || rect.left > x + w || rect.bottom < y || rect.top > y + h);

        if (isOverlapping) {
            if (!selectedStudents.has(id)) {
                selectedStudents.add(id);
                card.classList.add('selected-active');
            }
        }
    });
}


// 4. Xử lý CHUỘT PHẢI (Context Menu)
document.addEventListener('contextmenu', function(e) {
    const card = e.target.closest('.student-card');
    const listArea = e.target.closest('#listContainer');

    // Chỉ hiện menu khi click vào thẻ HS hoặc vùng danh sách
    if (card || listArea) {
        e.preventDefault(); // Chặn menu mặc định trình duyệt

        // Nếu click phải vào thẻ chưa chọn -> Chọn thẻ đó luôn
        if (card) {
            const id = card.getAttribute('data-id');
            if (!selectedStudents.has(id)) {
                clearSelection(); // Bỏ chọn cũ
                selectedStudents.add(id);
                card.classList.add('selected-active');
            }
        }

        // Nếu chưa chọn ai cả mà click vùng trống -> Không hiện menu
        if (selectedStudents.size === 0 && !card) return;

        // Tính vị trí hiện menu (Tránh bị tràn màn hình)
        let x = e.clientX;
        let y = e.clientY;
        if (x + 220 > window.innerWidth) x = window.innerWidth - 230; // Chỉnh lại nếu sát lề phải
        
        ctxMenu.style.left = x + 'px';
        ctxMenu.style.top = y + 'px';
        ctxMenu.style.display = 'block';
    } else {
        ctxMenu.style.display = 'none';
    }
});

// Đóng menu khi click bất kỳ đâu
document.addEventListener('click', function(e) {
    if (!e.target.closest('#contextMenu')) {
        ctxMenu.style.display = 'none';
    }
});


// Hàm kiểm tra thẻ nào nằm trong khung quét
function checkIntersection(boxX, boxY, boxW, boxH) {
    const cards = document.querySelectorAll('.student-card');
    
    cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const id = card.getAttribute('data-id'); // Cần thêm data-id vào lúc render

        // Logic va chạm
        if (boxX < rect.right && boxX + boxW > rect.left &&
            boxY < rect.bottom && boxY + boxH > rect.top) {
            
            // Nếu va chạm -> Chọn
            if (!selectedStudents.has(id)) {
                selectedStudents.add(id);
                card.classList.add('selected-active');
            }
        } else {
            // Nếu đang kéo mà không giữ Ctrl thì ra khỏi vùng sẽ bỏ chọn (tùy chọn)
            // Ở đây ta giữ nguyên logic cộng dồn cho mượt
        }
    });
}

// 3. Xử lý Click đơn và Ctrl + Click trên thẻ học sinh
// Hàm này thay thế logic onclick cũ trong renderList
function handleCardClick(e, id) {
    // Ngăn chặn sự kiện nổi bọt lên container
    e.stopPropagation();

    if (e.ctrlKey) {
        // Nếu giữ Ctrl: Đảo ngược trạng thái chọn
        if (selectedStudents.has(id)) {
            selectedStudents.delete(id);
            e.currentTarget.classList.remove('selected-active');
        } else {
            selectedStudents.add(id);
            e.currentTarget.classList.add('selected-active');
        }
    } else {
        // Nếu click thường:
        // 1. Nếu chưa chọn -> Mở Profile (giữ logic cũ)
        // 2. Nếu muốn dùng click để chọn 1 cái duy nhất thì bỏ comment dòng dưới:
        // clearSelection(); selectedStudents.add(id); renderList();
        
        openProfile(id); // Mặc định click trái là mở chi tiết
    }
    updateBulkActionBar();
}

// 4. Xử lý Chuột Phải (Context Menu)
document.addEventListener('contextmenu', function(e) {
    // Chỉ hiện menu khi click chuột phải trong vùng listContainer hoặc lên thẻ HS
    const targetCard = e.target.closest('.student-card');
    const isInsideList = e.target.closest('#listContainer');

    if (isInsideList || targetCard) {
        e.preventDefault(); // Chặn menu mặc định trình duyệt

        // Logic thông minh:
        // Nếu click phải vào 1 thẻ chưa được chọn -> Chọn thẻ đó (và bỏ chọn các thẻ khác)
        if (targetCard) {
            const id = targetCard.getAttribute('data-id');
            if (!selectedStudents.has(id)) {
                clearSelection();
                selectedStudents.add(id);
                targetCard.classList.add('selected-active');
                updateBulkActionBar();
            }
        }

        // Hiện menu tại vị trí chuột
        // Kiểm tra xem có bị tràn màn hình không
        let x = e.pageX;
        let y = e.pageY;
        
        // Điều chỉnh nếu menu bị tràn ra ngoài màn hình phải/dưới
    if (x + 220 > window.innerWidth) x -= 220;

    const menu = document.getElementById('contextMenu'); // Khai báo chuẩn
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.style.display = 'block';
} else {
    // Ẩn menu nếu click ra ngoài
    const menu = document.getElementById('contextMenu'); // Lấy lại element để ẩn cho chắc
    if (menu) menu.style.display = 'none'; 
}
});

// Đóng menu khi click bất kỳ đâu
document.addEventListener('click', function(e) {
    if (!e.target.closest('#contextMenu')) {
        contextMenu.style.display = 'none';
    }
});
document.addEventListener('scroll', function() {
    contextMenu.style.display = 'none';
}, true); // Đóng khi cuộn trang

// ======================================================
// CẬP NHẬT LẠI HÀM RENDERLIST ĐỂ HỖ TRỢ
// ======================================================
// Bạn cần thay thế hàm renderList cũ bằng hàm này (hoặc sửa đoạn tạo thẻ card)
// --- HÀM TẠO AVATAR TỰ ĐỘNG ---
function getAutoAvatar(name) {
    // Sử dụng bộ sưu tập 'adventurer' (nhân vật hoạt hình) hoặc 'fun-emoji' (mặt cười)
    // Bạn có thể đổi 'adventurer' thành 'notionists', 'micah', 'bottts' để đổi phong cách
    return `https://api.dicebear.com/9.x/adventurer/svg?seed=${encodeURIComponent(name)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
}
function renderList() {
    const div = $('listContainer'); div.innerHTML = "";
    const cls = $('classSelect').value; 
    const txt = $('search').value.toLowerCase();
    const vMonth = $('viewMonth').value;
    const vYear = $('viewYear').value;
    const timeKey = `${vMonth}-${vYear}`;
    const rootStyles = getComputedStyle(document.documentElement); 
    const mainColor = rootStyles.getPropertyValue('--neon-purple').trim();

    students.forEach((s, idx) => {
        const parts = s.split(" - "); const name = parts[0]; const c = parts[1] || "Chưa xếp lớp";
        if (cls && c !== cls) return; 
        if (txt && !name.toLowerCase().includes(txt)) return;
        
        const hkData = getHKData(s);
        const score = hkData.final;

        let emojiIcon = "😐"; let bgStyle = "#2a2a4a";
        if (score >= 80) { emojiIcon = "😎"; bgStyle = "linear-gradient(135deg, #00b09b, #96c93d)"; } 
        else if (score >= 65) { emojiIcon = "🙂"; bgStyle = "linear-gradient(135deg, #4facfe, #00f2fe)"; } 
        else if (score >= 50) { emojiIcon = "🤔"; bgStyle = "linear-gradient(135deg, #f6d365, #fda085)"; } 
        else { emojiIcon = "😴"; bgStyle = "linear-gradient(135deg, #f43f5e, #33001b)"; }

        let avatarHTML = "";
// --- CẬP NHẬT: AVATAR MỚI ---
if (avatars[s]) {
    // Nếu đã upload ảnh riêng thì dùng ảnh đó
    avatarHTML = `<img src="${avatars[s]}" class="avatar-img">`;
} else {
    // Nếu chưa có, tự tạo avatar ngẫu nhiên theo tên
    const autoSrc = getAutoAvatar(name);
    // Vẫn giữ nền màu (bgStyle) để phân biệt điểm số (Giỏi/Khá/TB)
    avatarHTML = `<img src="${autoSrc}" class="avatar-img" style="background:${bgStyle}; padding: 3px; box-sizing:border-box">`;
}
        const themeClass = currentMode === 'hk' ? 'hk-theme' : 'acad-theme'; 
        const color = currentMode === 'hk' ? mainColor : 'var(--neon-gold)';
        
        let displayVal = "---";
        if(currentMode === 'hk') { displayVal = score.toFixed(1); } 
        else { const w = calculateWallet(s); displayVal = (w > 0 ? "+" : "") + w.toFixed(1); }
        
        const isSelected = selectedStudents.has(s);
        let hasCheck = false; let commentText = ""; const targetDB = currentMode === 'hk' ? db.hk : db.acad; 
        if (isShowReviewedMode && targetDB[s] && targetDB[s].monthlyNotes && targetDB[s].monthlyNotes[timeKey]) { hasCheck = true; commentText = targetDB[s].monthlyNotes[timeKey]; }

        const card = document.createElement("div"); 
        
        // --- QUAN TRỌNG: Thêm class selected-active nếu đang chọn ---
        card.className = `student-card ${themeClass} ${hasCheck ? 'has-monthly-check' : ''} ${isSelected ? 'selected-active' : ''}`;
        
        // --- QUAN TRỌNG: Thêm data-id để logic quét tìm thấy ---
        card.setAttribute('data-id', s);

        // Gán sự kiện click mới hỗ trợ Ctrl
        card.onclick = (e) => handleCardClick(e, s);

        card.innerHTML = `
            <div class="red-tick-badge">✓</div>
            <div class="card-stt" style="color:var(--text); opacity:0.3">#${idx+1}</div>
            <div class="avatar-container">
                ${avatarHTML} <div class="galaxy-system"><div class="g-layer-1"></div><div class="g-dust"></div></div>
            </div>
            <div style="font-weight:700; margin-bottom:5px; pointer-events:none">${name}</div>
            <div style="font-size:12px; opacity:0.7; margin-bottom:2px; pointer-events:none">${c}</div>
            <div class="marquee-container"><div class="marquee-text">💬 T${vMonth}: ${commentText}</div></div>
     
       <div class="card-score-badge" style="color:${color}; border:1px solid ${color}; box-shadow: 0 0 10px ${color}40">${displayVal}</div>
        `;
        
        // Giữ hiệu ứng hover cũ
        card.onmouseenter = function() { if(currentMode === 'hk' && !hasCheck && !isSelected) { this.style.borderColor = mainColor; this.style.boxShadow = `0 0 25px ${mainColor}`; }};
        card.onmouseleave = function() { if(!selectedStudents.has(s) && !hasCheck) { this.style.borderColor = 'rgba(255,255,255,0.08)'; this.style.boxShadow = 'none'; }};
        
        div.appendChild(card);
    });
}
// ======================================================
// 🔧 BẢN VÁ LỖI: MENU CHUỘT PHẢI & TÁC VỤ
// ======================================================

// 1. Sửa lỗi "updateBulkActionBar is not defined" hoặc lỗi tìm ID
// Hàm này giờ sẽ để trống vì bạn đã xóa thanh công cụ bên dưới
function updateBulkActionBar() {
    // Đã xóa thanh công cụ nên không cần làm gì ở đây
    // Giữ hàm rỗng để các logic khác không bị báo lỗi
}

// 2. Sửa tính năng "Hủy chọn"
function clearSelection() {
    selectedStudents.clear();
    renderList();
    // Ẩn menu và khung quét
    $('contextMenu').style.display = 'none';
    $('selectionBox').style.display = 'none';
}

// 3. Sửa tính năng "Xuất Excel" (Liên kết với Modal xuất)
function bulkExport() {
    $('contextMenu').style.display = 'none'; // Đóng menu
    if (selectedStudents.size === 0) return showToast("Chưa chọn học sinh nào!", "error");
    
    // Gọi hàm mở Modal xuất Excel (giống nút trên Header)
    openExportModal(); 
}

// 4. Sửa tính năng "Xóa học sinh"
function bulkDelete() { 
    $('contextMenu').style.display = 'none'; // Đóng menu
    if (selectedStudents.size === 0) return showToast("Chưa chọn học sinh!", "error");

    if (confirm(`⚠️ Bạn có chắc muốn xóa ${selectedStudents.size} học sinh đang chọn?`)) { 
        selectedStudents.forEach(id => { 
            const idx = students.indexOf(id); 
            if (idx > -1) { 
                students.splice(idx, 1); 
                trash.push(id); 
            }
        }); 
        saveData(); 
        showToast(`Đã chuyển ${selectedStudents.size} HS vào thùng rác`, "info");
        clearSelection(); // Gọi hàm này để làm mới danh sách
        if(typeof renderClassDropdown === 'function') renderClassDropdown(); 
        updateTrashCount();
    } 
}

// 5. Sửa tính năng "Nhận xét nhanh"
function bulkComment() { 
    $('contextMenu').style.display = 'none'; // Đóng menu
    if (selectedStudents.size === 0) return showToast("Chưa chọn HS!", "error"); 
    
    isBulkMode = true; 
    bulkActionType = 'note'; 
    $('cTitle').innerText = `NHẬN XÉT (${selectedStudents.size} HS)`; 
    $('cWarning').innerText = "⚠️ Nội dung sẽ thêm vào phần 'Nhận xét của GV'."; 
    $('cDesc').value = ""; 
    $('cVal').parentElement.style.display = 'none'; 
    $('cTime').parentElement.style.display = 'none'; 
    $('confirmModal').style.display = 'flex'; 
    $('cDesc').focus(); 
}

// 6. Đảm bảo click vào nút In cũng đóng menu
const originalBulkPrint = bulkPrintHK;
bulkPrintHK = function() {
    $('contextMenu').style.display = 'none';
    originalBulkPrint();
}

// ======================================================
// ⌨️ PHÍM TẮT (SHORTCUTS)
// ======================================================

document.addEventListener('keydown', function(e) {
    // Kiểm tra nếu phím bấm là TAB
    if (e.key === 'Tab') {
        // 1. Kiểm tra xem người dùng có đang gõ văn bản không
        // Nếu đang gõ trong ô Input hoặc Textarea -> Cho phép Tab bình thường (để chuyển ô)
        const activeTag = document.activeElement.tagName.toLowerCase();
        if (activeTag === 'input' || activeTag === 'textarea') return;

        // 2. Nếu không gõ gì cả -> Chặn hành động chuyển focus mặc định
        e.preventDefault(); 

        // 3. Gọi hàm bật/tắt chế độ xem "Đã nhận xét"
        toggleShowReviewed();
    }
});

// Hàm bật/tắt trạng thái quan trọng
// Hàm bật/tắt trạng thái quan trọng (Đã nâng cấp để lưu vĩnh viễn)
function toggleImportant(el, target, day, period) {
    // 1. Hiệu ứng thị giác ngay lập tức
    el.classList.toggle('cute-important');

    // 2. Kiểm tra và khởi tạo thùng chứa
    if (!tkbData.highlights) tkbData.highlights = {};
    
    // Tạo key duy nhất: Chế độ_Tên_Thứ_Tiết
    const key = `${tkbViewMode}_${target}_${day}_${period}`;

    // 3. Cập nhật dữ liệu vào biến tkbData hiện tại
    if (el.classList.contains('cute-important')) {
        tkbData.highlights[key] = true;
        showToast("Đã đánh dấu quan trọng! ⭐", "success");
    } else {
        delete tkbData.highlights[key];
        showToast("Đã bỏ đánh dấu.", "info");
    }
    
    // --- [QUAN TRỌNG] ĐỒNG BỘ VỚI LỊCH SỬ TUẦN ---
    // Bước này giúp khi F5, hệ thống nạp lại dữ liệu tuần sẽ không bị mất highlight cũ
    if (typeof tkbHistory !== 'undefined' && typeof currentWeek !== 'undefined') {
         // Cập nhật highlight vào lịch sử của tuần hiện tại
         tkbHistory[currentWeek] = JSON.parse(JSON.stringify(tkbData));
         
         // Lưu lịch sử xuống LocalStorage
         if(typeof LS_HISTORY !== 'undefined') {
            localStorage.setItem(LS_HISTORY, JSON.stringify(tkbHistory));
         }
    }

    // 4. Lưu tkbData chính xuống LocalStorage
    saveData();
}
// ======================================================
// 🖱️ DESKTOP SELECTION LOGIC (CHUẨN WINDOWS)
// ======================================================

// 1. Khai báo biến
let isSelecting = false;
let startX = 0;
let startY = 0;
const selectionBox = document.getElementById('selectionBox');
const mainArea = document.querySelector('.main-content'); // Chỉ quét trong vùng nội dung chính

// 2. BẮT ĐẦU KÉO (MouseDown)
// Gắn vào mainArea để không bị kích hoạt khi bấm vào Sidebar
mainArea.addEventListener('mousedown', function(e) {
    // Chỉ nhận chuột trái (button 0)
    if (e.button !== 0) return;

    // Bỏ qua nếu click vào: Thẻ học sinh, Menu chuột phải, Nút bấm, Input
    if (e.target.closest('.student-card') || 
        e.target.closest('#contextMenu') || 
        e.target.closest('.btn') || 
        e.target.closest('input') || 
        e.target.closest('select')) return;

    // Bắt đầu chế độ quét
    isSelecting = true;
    
    // Thêm class chặn bôi đen văn bản
    document.body.classList.add('noselect'); 
    // Ẩn menu chuột phải nếu đang hiện
    if(document.getElementById('contextMenu')) document.getElementById('contextMenu').style.display = 'none';

    // Lưu tọa độ bắt đầu
    startX = e.clientX;
    startY = e.clientY;

    // Reset vị trí khung quét
    selectionBox.style.display = 'block';
    selectionBox.style.width = '0px';
    selectionBox.style.height = '0px';
    selectionBox.style.left = startX + 'px';
    selectionBox.style.top = startY + 'px';

    // Nếu không giữ Ctrl thì xóa các lựa chọn cũ (Giống Windows)
    if (!e.ctrlKey) {
        clearSelection(); 
    }
});

// 3. DI CHUYỂN CHUỘT (MouseMove) - Gắn vào window để kéo ra ngoài vẫn nhận
window.addEventListener('mousemove', function(e) {
    if (!isSelecting) return;

    const currentX = e.clientX;
    const currentY = e.clientY;

    // Tính toán kích thước khung (Dương hóa giá trị âm)
    const width = Math.abs(currentX - startX);
    const height = Math.abs(currentY - startY);
    
    // Tính toán vị trí góc trên trái
    const newLeft = Math.min(currentX, startX);
    const newTop = Math.min(currentY, startY);

    // Cập nhật CSS cho khung
    selectionBox.style.width = width + 'px';
    selectionBox.style.height = height + 'px';
    selectionBox.style.left = newLeft + 'px';
    selectionBox.style.top = newTop + 'px';

    // Gọi hàm kiểm tra va chạm
    checkCollision(newLeft, newTop, width, height);
});

// 4. THẢ CHUỘT (MouseUp)
window.addEventListener('mouseup', function(e) {
    if (isSelecting) {
        isSelecting = false;
        // Ẩn khung
        selectionBox.style.display = 'none';
        selectionBox.style.width = '0';
        selectionBox.style.height = '0';
        
        // Trả lại khả năng chọn văn bản
        document.body.classList.remove('noselect');
        
        // Cập nhật thanh công cụ (nếu có)
        if(typeof updateBulkActionBar === 'function') updateBulkActionBar();
    }
});

// 5. HÀM KIỂM TRA VA CHẠM (COLLISION DETECTION)
function checkCollision(boxX, boxY, boxW, boxH) {
    // Chỉ lấy các thẻ đang hiển thị
    const cards = document.querySelectorAll('.student-card');
    
    cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const id = card.getAttribute('data-id');
        
        // Logic kiểm tra 2 hình chữ nhật giao nhau
        // (Khung quét vs Thẻ học sinh)
        const isOverlapping = !(rect.right < boxX || 
                                rect.left > boxX + boxW || 
                                rect.bottom < boxY || 
                                rect.top > boxY + boxH);

        if (isOverlapping) {
            // Nếu chạm nhau -> Chọn thẻ
            if (!selectedStudents.has(id)) {
                selectedStudents.add(id);
                card.classList.add('selected-active');
            }
        } else {
            // TÙY CHỌN: Nếu kéo khung ra khỏi thẻ thì bỏ chọn (Giống Windows)
            // Nếu muốn giữ chọn khi đã quét qua rồi (kiểu cộng dồn) thì xóa đoạn else này đi.
            // Hiện tại tôi để logic: Không giữ Ctrl thì kéo ra sẽ mất chọn.
            if (!window.event.ctrlKey && selectedStudents.has(id)) {
                // Tuy nhiên logic này hơi phức tạp nếu muốn hoàn hảo giống Windows 
                // (cần lưu trạng thái ban đầu). 
                // Để đơn giản và hiệu quả cho Web App: Chỉ cần chạm là chọn (Add Only).
            }
        }
    });
}
function openAddClassModal() {
    // Xóa trắng ô nhập cũ
    document.getElementById('modalNewClassName').value = "";
    
    // Hiện Modal nhập tên lớp
    document.getElementById('addClassModal').style.display = 'flex';
    
    // Tự động đưa con trỏ chuột vào ô nhập để bạn gõ được luôn
    setTimeout(() => {
        document.getElementById('modalNewClassName').focus();
    }, 100);
}

// --- SỬA LOGIC LƯU LỚP MỚI ---
function confirmAddClass() {
    // 1. Lấy dữ liệu từ ô nhập
    const block = document.getElementById('modalNewBlock').value;
    let name = document.getElementById('modalNewClassName').value.trim();
    
    // 2. Kiểm tra dữ liệu
    if (!name) {
        showToast("Vui lòng nhập tên lớp!", "error");
        document.getElementById('modalNewClassName').focus();
        return;
    }
    
    // Tự động thêm chữ "Lớp" nếu thiếu (VD: nhập "10A1" -> "Lớp 10A1")
    if (!name.toLowerCase().startsWith("lớp")) name = "Lớp " + name;
    
    // Tạo mảng khối nếu chưa có (đề phòng lỗi)
    if (!classData[block]) classData[block] = [];
    
    // Kiểm tra trùng tên lớp
    if (classData[block].includes(name)) {
        showToast("Lớp này đã tồn tại!", "error");
        return;
    }
    
    // 3. Lưu vào dữ liệu
    classData[block].push(name);
    classData[block].sort(); // Sắp xếp lại danh sách
    
    saveClasses(); // Lưu xuống bộ nhớ máy
    
    // 4. CẬP NHẬT GIAO DIỆN (PHẦN QUAN TRỌNG ĐÃ SỬA)
    
    // Đóng cái bảng nhỏ nhập tên lớp
    document.getElementById('addClassModal').style.display = 'none';
    
    // Gọi hàm vẽ lại BẢNG LƯỚI (Grid) để lớp mới hiện ra ngay lập tức
    renderClassGrid(); 
    
    // Đảm bảo bảng quản lý lớp to vẫn đang hiện
    document.getElementById('classManagerModal').style.display = 'flex';
    
    showToast(`Đã thêm thành công: ${name}`, "success");
}
// --- HÀM TỰ ĐỘNG QUÉT VÀ THÊM MÔN TỪ TKB ---
function syncSubjectsFromTKB() {
    let newCount = 0;
    
    // Các từ khóa cần loại bỏ (không phải môn học)
    const ignoreList = ["SHCN", "CHÀO CỜ", "TỰ HỌC", "SHTT", "NGOẠI KHÓA", "HĐTN", "SINH HOẠT"];

    // 1. Quét dữ liệu TKB Học Sinh (Lớp)
    Object.values(tkbData.student || {}).forEach(classData => {
        Object.values(classData).forEach(dayData => {
            Object.values(dayData).forEach(cellContent => {
                if(!cellContent) return;
                
                // Dùng hàm có sẵn parseCellContent để tách môn
                const parsed = parseCellContent(cellContent); 
                
                parsed.forEach(item => {
                    const rawSubj = item.subject.trim();
                    const upperSubj = rawSubj.toUpperCase();

                    // Kiểm tra: Tên môn phải dài > 1 ký tự và không nằm trong list loại trừ
                    if(rawSubj.length > 1 && !ignoreList.includes(upperSubj)) {
                        
                        // Tạo key (mã môn) từ tên môn
                        const key = toSlug(rawSubj);
                        
                        // Nếu môn này chưa có trong danh sách -> Thêm vào
                        if(!SUBJECTS[key]) {
                            SUBJECTS[key] = rawSubj;
                            newCount++;
                        }
                    }
                });
            });
        });
    });

    // 2. Nếu có môn mới, lưu lại vào LocalStorage
    if(newCount > 0) {
        localStorage.setItem("hk_v33_custom_subjects", JSON.stringify(SUBJECTS));
        showToast(`✅ Đã thêm ${newCount} môn mới từ TKB!`, "success");
        
        // Vẽ lại danh sách để cập nhật dropdown ở Sổ Điểm
        if(document.getElementById('profileModal').style.display === 'flex') {
            renderAcadProfile(); 
        }
    } else {
        console.log("Không tìm thấy môn học mới nào.");
    }
}
function exportAcadToExcel() {
    const subjKey = document.getElementById('exportSubject').value;
    const currentClass = $('classSelect').value;

    showToast("Đang tạo file Excel...", "info");
    const wb = XLSX.utils.book_new();
    
    // Nếu chọn 1 môn -> Xuất 3 Sheet
    if (subjKey !== 'all') {
        const ws1 = generateSubjectSheet(subjKey, currentClass, 'hk1');
        if (ws1) XLSX.utils.book_append_sheet(wb, ws1, "HỌC KỲ 1");

        const ws2 = generateSubjectSheet(subjKey, currentClass, 'hk2');
        if (ws2) XLSX.utils.book_append_sheet(wb, ws2, "HỌC KỲ 2");

        const ws3 = generateSubjectSheet(subjKey, currentClass, 'full');
        if (ws3) XLSX.utils.book_append_sheet(wb, ws3, "CẢ NĂM");

        if (!ws1 && !ws2 && !ws3) return showToast("Không có dữ liệu học sinh để xuất!", "error");
    } 
    // Nếu chọn tất cả môn
    else {
        Object.keys(SUBJECTS).forEach(key => {
            const ws = generateSubjectSheet(key, currentClass, 'full');
            if(ws) XLSX.utils.book_append_sheet(wb, ws, SUBJECTS[key]);
        });
    }

    const timeStr = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `SoDiem_${currentClass || 'All'}_${timeStr}.xlsx`);
    showToast("✅ Xuất file thành công!", "success");
}

function generateSubjectSheet(subjectKey, classNameFilter, mode = 'full') {
    // 1. Lọc học sinh
    let listStudents = students.filter(s => {
        if (classNameFilter && !s.includes(classNameFilter) && !s.endsWith(classNameFilter)) return false;
        return true;
    });
    if (listStudents.length === 0) return null;

    const subjectName = SUBJECTS[subjectKey].toUpperCase();
    const curYear = new Date().getFullYear();
    const nextYear = curYear + 1;

    // --- XỬ LÝ KHỐI ---
    let gradeLabel = "Khối THPT"; 
    if (classNameFilter) {
        if (classNameFilter.includes("10")) gradeLabel = "Khối 10";
        else if (classNameFilter.includes("11")) gradeLabel = "Khối 11";
        else if (classNameFilter.includes("12")) gradeLabel = "Khối 12";
    }

    // --- CẤU HÌNH HEADER VÀ DATA ---
    let headerTitle = mode === 'hk1' ? "HỌC KỲ 1" : (mode === 'hk2' ? "HỌC KỲ 2" : "CẢ NĂM");
    const fullTitle = `BẢNG ĐIỂM CHI TIẾT - MÔN ${subjectName} - ${headerTitle} - NĂM HỌC ${curYear}-${nextYear}`;

    let wsData = [
        ["SỞ GIÁO DỤC VÀ ĐÀO TẠO LÂM ĐỒNG"],
        ["TRƯỜNG THPT YERSIN ĐÀ LẠT"],
        [fullTitle],
        [`${gradeLabel} - Lớp ${classNameFilter || "Toàn trường"}`],
        [""], 
    ];

    let row6 = [], row7 = [];
    if (mode === 'hk1' || mode === 'hk2') {
        row6 = ["STT", "Mã học sinh", "Họ và tên", "", "Ngày sinh", "ĐĐGtx", "", "", "", "", "ĐĐGgk", "ĐĐGck", `ĐTB \n${mode==='hk1'?'HK1':'HK2'}`, "Nhận xét"];
        row7 = ["", "", "", "", "", "TX1", "TX2", "TX3", "TX4", "TX5", "GK1", "CK1", "", ""];
    } else {
        row6 = ["STT", "Mã học sinh", "Họ và tên", "", "Ngày sinh", "ĐTB HK1", "ĐTB HK2", "ĐTB Cả Năm", "Ghi chú"];
        row7 = ["", "", "", "", "", "", "", "", ""];
    }
    wsData.push(row6);
    wsData.push(row7);

    // --- HÀM TÍNH TOÁN TRỢ GIÚP ---
    // Trả về số thực hoặc null (để ô Excel trống thay vì chuỗi "")
    const parseNum = (val) => (val !== undefined && val !== "" && !isNaN(val)) ? parseFloat(val) : null;
    
    // Tính ĐTB bằng JS
    const calcAvg = (txArr, gk, ck) => {
        let sum = 0, count = 0;
        // txArr chứa các giá trị null hoặc số
        txArr.forEach(v => { if(v !== null) { sum += v; count++; } });
        if(gk !== null) { sum += gk * 2; count += 2; }
        if(ck !== null) { sum += ck * 3; count += 3; }
        return count > 0 ? parseFloat((sum / count).toFixed(1)) : null; // Trả về số hoặc null
    };

    // --- ĐỔ DỮ LIỆU ---
    listStudents.forEach((id, index) => {
        const parts = id.split(" - ");
        const fullName = parts[0];
        const lastSpaceIdx = fullName.lastIndexOf(" ");
        const lastName = lastSpaceIdx > 0 ? fullName.substring(0, lastSpaceIdx) : fullName;
        const firstName = lastSpaceIdx > 0 ? fullName.substring(lastSpaceIdx + 1) : "";
        
        const g = (grades[id] && grades[id][subjectKey]) ? grades[id][subjectKey] : {};

        // Lấy điểm dạng SỐ (quan trọng để Excel hiểu)
        const tx1Arr = ['tx1','tx2','tx3','tx4','tx5'].map(k => parseNum(g[k]));
        const tx2Arr = ['tx6','tx7','tx8','tx9','tx10'].map(k => parseNum(g[k]));
        const gk1 = parseNum(g['gk1']), ck1 = parseNum(g['ck1']);
        const gk2 = parseNum(g['gk2']), ck2 = parseNum(g['ck2']);

        if (mode === 'hk1' || mode === 'hk2') {
            const kTX = mode === 'hk1' ? tx1Arr : tx2Arr;
            const vGK = mode === 'hk1' ? gk1 : gk2;
            const vCK = mode === 'hk1' ? ck1 : ck2;
            
            // Tính trước kết quả hiển thị
            const preCalcVal = calcAvg(kTX, vGK, vCK);

            wsData.push([
                index + 1, "", lastName, firstName, "",
                kTX[0], kTX[1], kTX[2], kTX[3], kTX[4], 
                vGK, vCK, 
                preCalcVal, // Ghi giá trị tính sẵn vào đây luôn (để hiển thị ngay)
                ""
            ]);
        } else {
            // Cả năm
            const dtb1 = calcAvg(tx1Arr, gk1, ck1);
            const dtb2 = calcAvg(tx2Arr, gk2, ck2);
            let dtbCN = null;
            if (dtb1 !== null && dtb2 !== null) {
                dtbCN = parseFloat(((dtb1 + dtb2 * 2) / 3).toFixed(1));
            }

            wsData.push([
                index + 1, "", lastName, firstName, "",
                dtb1, dtb2, dtbCN, ""
            ]);
        }
    });

    // --- TẠO SHEET & STYLE ---
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const range = XLSX.utils.decode_range(ws['!ref']);
    const sBorder = { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} };
    const sFont = { name: "Times New Roman", sz: 12 };
    const sBold = { name: "Times New Roman", sz: 11, bold: true };

    for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellRef = XLSX.utils.encode_cell({r: R, c: C});
            if (!ws[cellRef]) continue;

            // Basic Style
            ws[cellRef].s = { font: sFont, border: sBorder, alignment: { vertical: "center", wrapText: true } };

            // Header (Rows 0-6)
            if (R < 7) {
                ws[cellRef].s.font = sBold;
                ws[cellRef].s.alignment = { horizontal: "center", vertical: "center", wrapText: true };
                if (R < 4) ws[cellRef].s.border = {}; 
                if ((R===0 || R===1) && C===0) ws[cellRef].s.alignment.horizontal = "left"; 
            }
            // Data Rows (7+)
            else {
                if (C !== 2 && C !== 3) ws[cellRef].s.alignment.horizontal = "center";
                
                // --- QUAN TRỌNG: GÁN CÔNG THỨC EXCEL ---
                // Chỉ gán công thức cho cột ĐTB (index 12) của HK1, HK2
                if ((mode === 'hk1' || mode === 'hk2') && C === 12) {
                    const rIdx = R + 1;
                    const fTX = `F${rIdx}:J${rIdx}`;
                    const fGK = `K${rIdx}`;
                    const fCK = `L${rIdx}`;
                    
                    // Gán công thức vào thuộc tính .f
                    // Lưu ý: Thuộc tính .v (giá trị) đã được gán lúc push wsData nên Excel sẽ hiện số đó trước
                    // Khi người dùng sửa điểm, .f (công thức) sẽ chạy đè lên.
                    ws[cellRef].f = `IFERROR(ROUND((SUM(${fTX})+${fGK}*2+${fCK}*3)/(COUNT(${fTX})+COUNT(${fGK})*2+COUNT(${fCK})*3),1),"")`;
                    ws[cellRef].t = 'n'; // Type number
                }
            }
        }
    }

    // Merge & Widths
    ws['!merges'] = [
        {s:{r:0,c:0}, e:{r:0,c:5}}, {s:{r:1,c:0}, e:{r:1,c:5}}, // Sở, Trường
        {s:{r:2,c:0}, e:{r:2,c:mode==='full'?8:12}}, // Title
        {s:{r:3,c:0}, e:{r:3,c:mode==='full'?8:12}}, // Lớp
        {s:{r:5,c:0}, e:{r:6,c:0}}, {s:{r:5,c:1}, e:{r:6,c:1}}, // STT, Mã
        {s:{r:5,c:2}, e:{r:5,c:3}}, // Họ tên
        {s:{r:5,c:4}, e:{r:6,c:4}}, // Ngày sinh
    ];

    if (mode === 'hk1' || mode === 'hk2') {
        ws['!merges'].push(
            {s:{r:5,c:5}, e:{r:5,c:9}}, // TX
            {s:{r:5,c:10}, e:{r:6,c:10}}, // GK
            {s:{r:5,c:11}, e:{r:6,c:11}}, // CK
            {s:{r:5,c:12}, e:{r:6,c:12}}, // ĐTB
            {s:{r:5,c:13}, e:{r:6,c:13}}  // Note
        );
        ws['!cols'] = [{wch: 5}, {wch: 10}, {wch: 20}, {wch: 10}, {wch: 12}, {wch: 5}, {wch: 5}, {wch: 5}, {wch: 5}, {wch: 5}, {wch: 6}, {wch: 6}, {wch: 8}, {wch: 10}];
    } else {
        ws['!merges'].push(
            {s:{r:5,c:5}, e:{r:6,c:5}}, {s:{r:5,c:6}, e:{r:6,c:6}}, {s:{r:5,c:7}, e:{r:6,c:7}}, {s:{r:5,c:8}, e:{r:6,c:8}}
        );
        ws['!cols'] = [{wch:5}, {wch:10}, {wch:20}, {wch:10}, {wch:12}, {wch:10}, {wch:10}, {wch:10}, {wch:15}];
    }

    return ws;
}
// ======================================================
// 10. HỆ THỐNG HƯỚNG DẪN (GUIDE SYSTEM) - PHIÊN BẢN ĐẦY ĐỦ
// ======================================================
const GUIDE_DATA = {
    // 1. TRANG CHỦ & TỔNG QUAN
    'home': `
        <div class="guide-section">
            <div class="guide-title">🚀 TRUNG TÂM ĐIỀU KHIỂN</div>
            <ul class="guide-list">
                <li><b>Điều hướng tuần:</b> Sử dụng thanh trên cùng để chuyển đổi giữa các Tuần học. Dữ liệu hạnh kiểm sẽ được lưu riêng theo từng tuần.</li>
                <li><b>Quản lý Lớp:</b> Bấm vào nút <span class="guide-highlight">🌐 Tất cả lớp</span> (hoặc tên lớp hiện tại) để tạo lớp mới, đổi tên lớp hoặc chuyển đổi qua lại giữa các lớp.</li>
                <li><b>Tìm kiếm:</b> Ô tìm kiếm hoạt động trên toàn bộ danh sách học sinh hiện có.</li>
            </ul>
        </div>
    `,

    // 2. HẠNH KIỂM (CẬP NHẬT TÊN NÚT MỚI)
    'hk': `
        <div class="guide-section">
            <div class="guide-title">📂 CÔNG CỤ DỮ LIỆU</div>
            <ul class="guide-list">
                <li>
                    <span class="guide-highlight">Nhập dữ liệu</span> (Nút Xanh): 
                    Nhập danh sách học sinh từ file Excel. 
                    <br>👉 <i>File cần có cột "Họ và tên" và "Lớp". Hệ thống tự động phân loại học sinh vào đúng lớp.</i>
                </li>
                <li>
                    <span class="guide-highlight">Xuất dữ liệu</span> (Nút Xanh): 
                    Xuất báo cáo tổng kết ra Excel để nộp hoặc in ấn.
                </li>
                <li>
                    <span class="guide-highlight">+ Thêm HS</span>: 
                    Thêm thủ công một học sinh vào lớp đang chọn.
                </li>
            </ul>
        </div>

        <div class="guide-section">
            <div class="guide-title">⚡ THAO TÁC NHANH</div>
            <ul class="guide-list">
                <li><b>Chấm điểm:</b> Bấm chuột trái vào thẻ học sinh để mở bảng cộng/trừ điểm và ghi chú.</li>
                <li><b>Menu Chuột Phải:</b> Bấm chuột phải lên thẻ học sinh để: Xem biểu đồ cá nhân, Nhận xét nhanh, In phiếu, Chuyển lớp hoặc Xóa.</li>
                <li><b>Chọn nhiều (Multi-select):</b> Giữ phím <span class="key-shortcut">Ctrl</span> và bấm chọn nhiều học sinh để chấm điểm hàng loạt.</li>
            </ul>
        </div>
    `,

    // 3. HỌC TẬP (SỔ ĐIỂM & KHO ĐIỂM)
    'acad': `
        <div class="guide-section">
            <div class="guide-title">📒 SỔ ĐIỂM & KHO ĐIỂM</div>
            <ul class="guide-list">
                <li><b>Kho Điểm (Wallet):</b> Nơi lưu trữ điểm cộng phát biểu, xung phong. Điểm này có thể tích lũy theo thời gian.</li>
                <li><b>Sổ Điểm (Gradebook):</b> Nơi nhập điểm chính thức (Miệng, 15p, 1 Tiết, Thi).</li>
                <li><b>Tính năng Quy Đổi:</b> Chuyển điểm từ "Kho Điểm" sang "Sổ Điểm". 
                    <br>👉 <i>Ví dụ: Đổi 5 lần phát biểu thành 1 điểm 10 cột Miệng.</i>
                </li>
            </ul>
        </div>
        <div class="guide-section">
            <div class="guide-title">⌨️ MẸO NHẬP LIỆU</div>
            <ul class="guide-list">
                <li>Sử dụng phím <span class="key-shortcut">Tab</span> để nhảy xuống ô dưới (nhập nhanh cho cả lớp).</li>
                <li>Dữ liệu điểm số được tự động tính toán điểm trung bình ngay khi nhập.</li>
            </ul>
        </div>
    `,

    // 4. THỜI KHÓA BIỂU (TKB) - ĐẦY ĐỦ 3 TAB
    'tkb': `
        <div class="guide-section">
            <div class="guide-title">📅 QUẢN LÝ THỜI KHÓA BIỂU</div>
            <div style="margin-bottom:10px; font-size:13px;">Hệ thống hỗ trợ 3 chế độ xem:</div>
            <ul class="guide-list">
                <li><b>👨‍🏫 Giáo Viên:</b> Xem lịch dạy của cá nhân GV.</li>
                <li><b>🎓 Lớp Học:</b> Xem TKB của từng lớp (để báo giảng/điểm danh).</li>
                <li><b>📚 Ôn Tốt Nghiệp:</b> Lịch ôn thi đặc biệt cho khối 12.</li>
            </ul>
        </div>

        <div class="guide-section">
            <div class="guide-title">⚙️ CÔNG CỤ TKB</div>
            <ul class="guide-list">
                <li>
                    <span class="guide-highlight">Nhập TKB Chính</span>: 
                    Nhập file Excel TKB toàn trường (Cấu trúc: Thứ, Tiết, Tên Lớp).
                </li>
                <li>
                    <span class="guide-highlight">🏫 XẾP TKB TOÀN TRƯỜNG</span>: 
                    Công cụ hỗ trợ xếp lịch tự động, kiểm tra trùng tiết.
                </li>
                <li><b>Highlight:</b> Click đúp (2 lần) vào ô tiết học để tô màu đỏ (đánh dấu quan trọng).</li>
                <li><b>Xuất ảnh:</b> Bấm icon 📸 để tải ảnh TKB về điện thoại/máy tính.</li>
            </ul>
        </div>
    `,

    // 5. TIỆN ÍCH (GAMES)
    'games': `
        <div class="guide-section">
            <div class="guide-title">🎮 TRUNG TÂM TIỆN ÍCH</div>
            <ul class="guide-list">
                <li>
                    <span class="guide-highlight">📥 Lớp hiện tại</span>: 
                    Bắt buộc bấm nút này trước khi chơi để nạp danh sách học sinh từ lớp đang chọn vào game.
                </li>
                <li><b>Vòng Quay May Mắn:</b> Gọi tên ngẫu nhiên trả bài hoặc nhận quà.</li>
                <li><b>Đua Phi Thuyền:</b> Minigame tạo không khí sôi nổi, đua top ngẫu nhiên.</li>
                <li><b>Chia Nhóm:</b> Tự động chia lớp thành các nhóm (2, 4, 6 nhóm...) ngẫu nhiên.</li>
                <li><b>Sơ Đồ Lớp:</b> (Nếu có) Sắp xếp chỗ ngồi trực quan.</li>
            </ul>
        </div>
    `,

    // 6. HỆ THỐNG & CLOUD (Dựa trên code saveToGoogleSheet)
    'settings': `
        <div class="guide-section">
            <div class="guide-title">☁️ ĐỒNG BỘ ĐÁM MÂY (CLOUD)</div>
            <ul class="guide-list">
                <li>
                    <b>Liên kết Google Sheet:</b> Dán ID của Google Sheet Script (Web App URL) vào phần cài đặt để kích hoạt tính năng lưu trữ online.
                </li>
                <li><b>Tự động lưu:</b> Khi bật chế độ này, mọi thao tác chấm điểm sẽ được đẩy lên Cloud ngay lập tức.</li>
                <li><b>Tải dữ liệu về:</b> Cho phép đồng bộ dữ liệu từ Cloud về máy khác để tiếp tục làm việc.</li>
            </ul>
        </div>
        <div class="guide-section">
            <div class="guide-title">⚠️ KHÔI PHỤC & RESET</div>
            <ul class="guide-list">
                <li><b>Xóa dữ liệu trình duyệt:</b> Xóa toàn bộ dữ liệu lưu trên máy này (Dùng khi máy bị lag hoặc lỗi dữ liệu nặng).</li>
            </ul>
        </div>
    `,

    // 7. THÙNG RÁC
    'trash': `
        <div class="guide-section">
            <div class="guide-title">♻️ QUẢN LÝ THÙNG RÁC</div>
            <ul class="guide-list">
                <li>Học sinh bị xóa từ màn hình chính sẽ được đưa vào đây.</li>
                <li>Bấm <span class="guide-highlight">Khôi phục</span> để đưa học sinh trở lại lớp cũ kèm theo toàn bộ điểm số.</li>
                <li>Nếu xóa tại đây, dữ liệu sẽ mất vĩnh viễn.</li>
            </ul>
        </div>
    `
};
// Hàm mở Modal Hướng Dẫn
function openContextGuide() {
    const contentDiv = document.getElementById('guideContent');
    
    // Lấy nội dung dựa trên currentMode (biến toàn cục đang có sẵn trong code của bạn)
    // Nếu không tìm thấy mode thì hiển thị mặc định của HK
    let html = GUIDE_DATA[currentMode] || GUIDE_DATA['hk'];
    
    // Nếu đang ở mode 'hk' nhưng lại đang mở Modal Profile -> Hiển thị hướng dẫn Profile
    if (document.getElementById('profileModal').style.display === 'flex') {
        html = `
            <div class="guide-section">
                <div class="guide-title">👤 Hồ Sơ Chi Tiết</div>
                <ul class="guide-list">
                    <li>Bấm nút <span class="guide-highlight">✏️ Sửa nút</span> để thay đổi tên và điểm số của các nút bấm nhanh.</li>
                    <li>Nhập ghi chú vào ô bên dưới cùng để lưu lại các vấn đề cần lưu ý.</li>
                    <li>Bấm vào ảnh đại diện để tải ảnh thẻ của học sinh lên.</li>
                </ul>
            </div>
        `;
    }

    contentDiv.innerHTML = html;
    document.getElementById('guideModal').style.display = 'flex';
}
// --- LOGIC QUẢN LÝ LỚP DẠNG GRID (MỚI) ---

function openClassManager() {
    renderClassGrid();
    $('classManagerModal').style.display = 'flex';
}

function renderClassGrid() {
    const container = document.getElementById('classGridContainer');
    container.innerHTML = "";
    
    const currentClass = document.getElementById('classSelect').value;
    
    // Duyệt qua từng khối (10, 11, 12, Khác)
    const blocks = ["Khối 10", "Khối 11", "Khối 12", "Khác"];
    
    // Đảm bảo dữ liệu classData đủ cấu trúc
    blocks.forEach(b => { if(!classData[b]) classData[b] = []; });

    blocks.forEach(block => {
        const classes = classData[block];
        if (classes.length === 0) return; // Khối nào không có lớp thì ẩn

        const section = document.createElement('div');
        section.className = 'block-section';
        
    // 👇 Đã tăng font-size lên 16px và chỉnh opacity rõ hơn
    const htmlTitle = `<div class="block-title">${block} <span style="opacity:0.9; font-size:16px; font-weight:bold; margin-left:auto; color:var(--neon-gold)">(${classes.length} Lớp)</span></div>`;
        
        let htmlGrid = `<div class="class-grid">`;
        
        classes.forEach(cls => {
            // Đếm số học sinh trong lớp
            const count = students.filter(s => s.includes(cls)).length;
            const isActive = (cls === currentClass) ? 'active' : '';
            
            htmlGrid += `
            <div class="class-card ${isActive}" onclick="selectClassAndClose('${cls}')">
                <div class="class-name">${cls.replace('Lớp ', '')}</div>
                <div class="class-count">👤 ${count} HS</div>
                
                <div class="class-actions" onclick="event.stopPropagation()">
                    <div class="action-mini-btn btn-edit" title="Đổi tên" onclick="editClassName('${block}', '${cls}')">✏️</div>
                    <div class="action-mini-btn btn-del" title="Xóa lớp" onclick="deleteClass('${block}', '${cls}')">🗑️</div>
                </div>
            </div>`;
        });
        
        htmlGrid += `</div>`;
        
        section.innerHTML = htmlTitle + htmlGrid;
        container.appendChild(section);
    });

    if (container.innerHTML === "") {
        container.innerHTML = `<div style="text-align:center; padding:50px; opacity:0.5">Chưa có lớp nào. Hãy nhập Excel hoặc thêm mới.</div>`;
    }
}

// Hàm chọn lớp và đóng modal
function selectClassAndClose(cls) {
    selectClass(cls); // Gọi hàm gốc để lọc danh sách
    $('classManagerModal').style.display = 'none';
}

// Hàm Sửa Tên Lớp (Cập nhật cả danh sách học sinh)
function editClassName(block, oldName) {
    const newName = prompt(`Đổi tên lớp "${oldName}" thành:`, oldName);
    if (!newName || newName === oldName) return;
    
    let finalName = newName.trim();
    if (!finalName.toLowerCase().startsWith("lớp")) finalName = "Lớp " + finalName;

    // 1. Cập nhật trong classData
    const idx = classData[block].indexOf(oldName);
    if (idx !== -1) {
        classData[block][idx] = finalName;
        classData[block].sort();
        saveClasses();
    }

    // 2. Cập nhật danh sách học sinh (Quan trọng)
    let updateCount = 0;
    students = students.map(s => {
        if (s.endsWith(" - " + oldName)) {
            updateCount++;
            return s.replace(" - " + oldName, " - " + finalName);
        }
        return s;
    });

    // 3. Cập nhật Trash (nếu cần thiết)
    trash = trash.map(t => {
        let s = (typeof t === 'string') ? t : t.id;
        if (s.endsWith(" - " + oldName)) {
            s = s.replace(" - " + oldName, " - " + finalName);
        }
        return (typeof t === 'string') ? s : {...t, id: s};
    });

    saveData(); // Lưu students mới
    
    // Nếu đang chọn lớp cũ -> chuyển sang chọn lớp mới
    if ($('classSelect').value === oldName) {
        selectClass(finalName);
    } else {
        renderClassGrid();
        renderList();
    }
    
    showToast(`Đã đổi tên lớp và cập nhật ${updateCount} học sinh!`, "success");
}
// --- LOGIC CHỈNH KÍCH THƯỚC CỬA SỔ PROFILE ---
function resizeProfileModal(scaleValue) {
    const modal = document.getElementById('pwWindow');
    if(modal) {
        // Dùng transform: scale để phóng to thu nhỏ toàn bộ cửa sổ
        modal.style.transform = `scale(${scaleValue})`;
        
        // Lưu lại cài đặt để lần sau mở lên vẫn giữ nguyên kích thước
        localStorage.setItem('yersin_modal_scale', scaleValue);
    }
}

// --- TỰ ĐỘNG KHÔI PHỤC KÍCH THƯỚC KHI MỞ CỬA SỔ ---
// Bạn tìm hàm openProfile(s) cũ và THÊM đoạn này vào cuối hàm đó:
/* const savedScale = localStorage.getItem('yersin_modal_scale');
   if(savedScale) {
       document.getElementById('modalZoomSlider').value = savedScale;
       resizeProfileModal(savedScale);
   }
*/
// ======================================================
// 12. HỆ THỐNG QUẢN LÝ TKB TOÀN TRƯỜNG (SCHOOL MANAGER)
// ======================================================

let teacherDatabase = []; // Lưu danh sách GV từ Excel
let globalAssignments = []; // Lưu bảng phân công: {teacher, subject, count, classes: []}


// 2. Xử lý file GVBM.xlsx
function processTeacherExcel(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1}); // Đọc dạng mảng
            
            teacherDatabase = [];
            
            // Duyệt từ dòng 1 (bỏ header dòng 0)
            // Cấu trúc file: [STT, Tên, Môn1, Tiết1, Môn2, Tiết2, Tổng]
            for(let i=1; i<rows.length; i++) {
                const row = rows[i];
                const name = row[1]; // Cột B: Tên GV
                if(!name) continue; // Bỏ qua dòng trống hoặc tiêu đề nhóm

                // Lấy thông tin môn học
                let subjects = [];
                // Môn chính (Cột C, D)
                if(row[2]) subjects.push({name: row[2], max: row[3] || 0});
                // Môn phụ (Cột E, F)
                if(row[4] && row[4] !== '-') subjects.push({name: row[4], max: row[5] || 0});

                teacherDatabase.push({
                    name: name,
                    subjects: subjects,
                    total: row[6]
                });
            }

            // Cập nhật giao diện
            $('teacherCountLabel').style.display = 'block';
            $('teacherCountLabel').innerText = `✅ Đã tải: ${teacherDatabase.length} Giáo viên`;
            
            // Đổ dữ liệu vào Dropdown
            updateTeacherSelect();
            showToast(`Đã nhập ${teacherDatabase.length} giáo viên!`, "success");

        } catch (err) {
            alert("Lỗi đọc file: " + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

// 3. Cập nhật các Dropdown
function updateTeacherSelect() {
    const sel = $('pccmTeacher');
    sel.innerHTML = "";
    teacherDatabase.forEach(t => {
        const op = document.createElement('option');
        op.value = t.name;
        op.innerText = t.name;
        sel.appendChild(op);
    });
    updateSubjectSelect();
}

function updateSubjectSelect() {
    const tName = $('pccmTeacher').value;
    const teacher = teacherDatabase.find(t => t.name === tName);
    const sel = $('pccmSubject');
    sel.innerHTML = "";
    
    if(teacher && teacher.subjects) {
        teacher.subjects.forEach(s => {
            const op = document.createElement('option');
            op.value = s.name;
            op.innerText = s.name;
            sel.appendChild(op);
        });
    }
}

// 4. Vẽ Checkbox Lớp (để chọn lớp áp dụng)
function renderClassCheckboxes() {
    const container = $('pccmClassList');
    container.innerHTML = "";
    
    // Gom tất cả lớp lại
    let allClasses = [];
    ['Khối 10', 'Khối 11', 'Khối 12', 'Khác'].forEach(block => {
        if(classData[block]) {
            classData[block].forEach(cls => {
                allClasses.push({name: cls, block: block});
            });
        }
    });

    allClasses.forEach(c => {
        const div = document.createElement('div');
        div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.gap = '5px';
        div.innerHTML = `
            <input type="checkbox" class="cls-check" value="${c.name}" data-block="${c.block}" style="accent-color:#8b5cf6">
            <span style="font-size:11px; color:#cbd5e1">${c.name.replace('Lớp ', '')}</span>
        `;
        container.appendChild(div);
    });
}

function toggleBlockClasses(blockName) {
    const checks = document.querySelectorAll('.cls-check');
    checks.forEach(c => {
        if(c.dataset.block === blockName) c.checked = !c.checked;
    });
}

// 5. Thêm Phân Công vào Danh Sách
function addAssignment() {
    const teacher = $('pccmTeacher').value;
    const subject = $('pccmSubject').value;
    const count = parseInt($('pccmCount').value);
    
    // Lấy danh sách lớp đang tick
    let selectedClasses = [];
    document.querySelectorAll('.cls-check:checked').forEach(c => {
        selectedClasses.push(c.value);
        c.checked = false; // Reset sau khi thêm
    });

    if(!teacher || selectedClasses.length === 0) {
        showToast("Vui lòng chọn Giáo viên và ít nhất 1 Lớp!", "error");
        return;
    }

    // Thêm vào mảng toàn cục
    globalAssignments.push({
        teacher: teacher,
        subject: subject,
        count: count,
        classes: selectedClasses
    });

    renderAssignmentTable();
    showToast(`Đã thêm phân công cho ${teacher}`, "success");
}

function renderAssignmentTable() {
    const tbody = $('assignmentTableBody');
    tbody.innerHTML = "";
    
    globalAssignments.forEach((a, idx) => {
        tbody.innerHTML += `
            <tr style="border-bottom:1px solid #e2e8f0; background:rgba(255,255,255,0.02)">
                <td style="padding:10px; font-weight:bold; cursor:pointer; color:#38bdf8; text-decoration:underline" 
                    onclick="editAssignment(${idx})" 
                    title="Bấm để đưa lên form sửa lại">
                    ✏️ ${a.teacher}
                </td>
                
                <td style="padding:10px">${a.subject}</td>
                <td style="padding:10px; text-align:center">${a.count}</td>
                
                <td style="padding:10px; font-size:11px; color:#cbd5e1; max-width:300px; overflow:hidden; text-overflow:ellipsis">
                    ${a.classes.join(', ')}
                </td>
                
                <td style="padding:10px; text-align:center">
                    <button class="btn red" style="padding:2px 8px; font-size:10px" onclick="removeAssignment(${idx})">🗑️</button>
                </td>
            </tr>
        `;
    });

    if(globalAssignments.length === 0) {
         tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8">Chưa có phân công nào.</td></tr>`;
    }
}

function removeAssignment(idx) {
    globalAssignments.splice(idx, 1);
    renderAssignmentTable();
}
// Hàm chỉnh sửa phân công: Đưa dữ liệu lên form và xóa dòng cũ
function editAssignment(idx) {
    const item = globalAssignments[idx];

    // 1. Điền tên Giáo viên
    $('pccmTeacher').value = item.teacher;

    // 2. Cập nhật lại danh sách môn học của GV này
    updateSubjectSelect();

    // 3. Điền Môn và Số tiết
    $('pccmSubject').value = item.subject;
    $('pccmCount').value = item.count;

    // 4. Reset toàn bộ checkbox lớp trước
    document.querySelectorAll('.cls-check').forEach(c => c.checked = false);

    // 5. Tick lại các lớp có trong dữ liệu
    item.classes.forEach(clsName => {
        // Tìm checkbox có value trùng tên lớp
        const chk = document.querySelector(`.cls-check[value="${clsName}"]`);
        if(chk) chk.checked = true;
    });

    // 6. Xóa dòng này khỏi bảng danh sách (để người dùng lưu lại thành dòng mới)
    globalAssignments.splice(idx, 1);
    renderAssignmentTable();

    // 7. Thông báo và cuộn lên trên
    showToast(`Đang sửa phân công của: ${item.teacher}. Hãy bấm "THÊM" sau khi sửa xong.`, "info");
    
    // Cuộn lên phần nhập liệu (nếu bảng quá dài)
    document.querySelector('.panel-section').scrollIntoView({ behavior: 'smooth' });
}

function clearAssignments() {
    if(confirm("Xóa toàn bộ danh sách phân công?")) {
        globalAssignments = [];
        renderAssignmentTable();
    }
}

/**
 * THUẬT TOÁN XẾP TKB TỐI ƯU (HEURISTIC + FAST BACKTRACKING)
 * Tốc độ: Nhanh hơn 10-20 lần so với bản cũ.
 * Logic: Ưu tiên xếp môn khó trước (Thể dục, QP, môn 2 tiết) -> Môn thường.
 */
function runSchoolScheduler() {
    // 1. Kiểm tra dữ liệu đầu vào
    if (typeof globalAssignments === 'undefined' || globalAssignments.length === 0) {
        alert("Chưa có dữ liệu phân công! Vui lòng nhập file Excel GVBM và Phân công trước.");
        return;
    }

    // Lấy thông tin tuần và log
    const week = document.getElementById('schWeek') ? document.getElementById('schWeek').value : (document.getElementById('globalWeek') ? document.getElementById('globalWeek').value : 1);
    const log = document.getElementById('schLogContent') || document.getElementById('schoolLog');
    
    // Cấu hình: Các ngày học (Thứ 2 đến Thứ 6)
    const configDays = [2, 3, 4, 5, 6]; 

    // --- CÁC HÀM HỖ TRỢ TỐI ƯU ---
    
    // Hàm xáo trộn mảng nhanh (Fisher-Yates) - Tốt hơn Math.random() - 0.5
    const fastShuffle = (array) => {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    };

    if (!confirm(`🚀 BẮT ĐẦU XẾP TKB TỐI ƯU (TUẦN ${week})?\n\n- Thuật toán: Heuristic Priority\n- Ưu tiên: Môn 2 tiết > TD/QP > GV dạy nhiều.\n- Tốc độ: Siêu nhanh.`)) return;

    // Hiển thị trạng thái đang chạy
    if(log) log.innerHTML = "<div>⏳ Đang phân tích và xếp lịch...</div>";

    // Dùng setTimeout để UI không bị đơ khi tính toán
    setTimeout(() => {
        const startTime = performance.now();
        
        // 2. Khởi tạo cấu trúc dữ liệu sạch
        if (!tkbHistory[week]) tkbHistory[week] = { student: {}, teacher: {}, grad: {} };
        
        // Cache đếm số tiết môn học trong ngày: countCache[Lớp][Thứ][Môn] = số tiết
        let countCache = {}; 
        
        let tasks = [];

        // 3. Chuyển đổi Phân công (Assignments) thành Nhiệm vụ (Tasks)
        globalAssignments.forEach(a => {
            a.classes.forEach(clsName => {
                // Init cache
                if (!tkbHistory[week].student[clsName]) tkbHistory[week].student[clsName] = {};
                if (!countCache[clsName]) countCache[clsName] = {};

                let subjectName = a.subject.trim();
                let totalPeriods = parseInt(a.count);
                
                // Nhận diện môn đặc biệt
                let isSport = /thể dục|gdqp|quốc phòng|giáo dục quốc phòng/i.test(subjectName);
                let isIT = /tin|công nghệ/i.test(subjectName);
                
                // Logic tách tiết:
                // - Môn Thể dục/QP/Tin/CN: Ưu tiên xếp cặp 2 tiết
                let pairs = 0;
                let singles = totalPeriods;

                if (isSport || isIT || totalPeriods >= 2) {
                    pairs = Math.floor(totalPeriods / 2);
                    singles = totalPeriods % 2;
                }

                // Tạo Task 2 tiết
                for (let i = 0; i < pairs; i++) {
                    tasks.push({ 
                        teacher: a.teacher, 
                        subject: subjectName, 
                        class: clsName, 
                        duration: 2, 
                        isRestricted: isSport // Cờ đánh dấu môn bị cấm tiết cuối
                    });
                }
                // Tạo Task 1 tiết
                for (let i = 0; i < singles; i++) {
                    tasks.push({ 
                        teacher: a.teacher, 
                        subject: subjectName, 
                        class: clsName, 
                        duration: 1, 
                        isRestricted: isSport 
                    });
                }
            });
        });

        // 4. SẮP XẾP NHIỆM VỤ (HEURISTIC SORT) - BÍ QUYẾT TĂNG TỐC
        // Nguyên tắc: Việc khó làm trước.
        tasks.sort((a, b) => {
            // 1. Ưu tiên môn 2 tiết (Duration lớn)
            if (b.duration !== a.duration) return b.duration - a.duration;
            // 2. Ưu tiên môn bị hạn chế (TD/QP)
            if (b.isRestricted !== a.isRestricted) return b.isRestricted - a.isRestricted;
            // 3. (Mở rộng) Có thể thêm ưu tiên GV dạy nhiều tiết ở đây nếu cần
            // 4. Random nhẹ để tạo sự khác biệt mỗi lần xếp
            return Math.random() - 0.5;
        });

        let success = 0;
        let fail = 0;
        let failDetails = [];

        // 5. THỰC HIỆN XẾP LỊCH (CORE LOOP)
        for (let task of tasks) {
            let placed = false;
            
            // Xáo trộn thứ tự ngày để môn học rải đều
            let daysToCheck = fastShuffle([...configDays]);

            for (let d of daysToCheck) {
                if (placed) break;

                // Init cache ngày
                if (!countCache[task.class][d]) countCache[task.class][d] = {};
                
                // Ràng buộc 1: Không quá 2 tiết/môn/ngày
                let currentSubjCount = countCache[task.class][d][task.subject] || 0;
                if (currentSubjCount + task.duration > 2) continue;

                // Duyệt qua 10 tiết (0-4: Sáng, 5-9: Chiều)
                for (let p = 0; p < 10; p++) {
                    // Ràng buộc 2: Thể dục/QP không học tiết 5 (p=4) và tiết 10 (p=9 - cuối buổi)
                    if (task.isRestricted && (p === 4 || p === 9)) continue;

                    // Kiểm tra Slot cho môn 2 tiết
                    if (task.duration === 2) {
                        let p2 = p + 1;
                        // Không vắt qua trưa (Tiết 5 là cuối sáng, Tiết 6 là đầu chiều -> Không liền)
                        // Tuy nhiên trong hệ 10 tiết, p=4 là tiết 5. p2=5 là tiết 1 chiều.
                        if (p === 4) continue; 
                        if (p2 >= 10) continue; // Vượt quá số tiết
                        
                        // Check slot trống (Lớp & GV) cho cả 2 tiết
                        if (!isSlotFree(week, task.class, task.teacher, d, p)) continue;
                        if (!isSlotFree(week, task.class, task.teacher, d, p2)) continue;

                        // Check lại ràng buộc TD cho tiết thứ 2
                        if (task.isRestricted && (p2 === 4 || p2 === 9)) continue;

                        // -> OK: Ghi dữ liệu
                        assignData(week, d, p, task.class, task.teacher, task.subject);
                        assignData(week, d, p2, task.class, task.teacher, task.subject);
                        
                        // Update cache
                        countCache[task.class][d][task.subject] = currentSubjCount + 2;
                        placed = true;
                        success++;
                        break;
                    } 
                    // Kiểm tra Slot cho môn 1 tiết
                    else {
                        if (!isSlotFree(week, task.class, task.teacher, d, p)) continue;

                        // -> OK: Ghi dữ liệu
                        assignData(week, d, p, task.class, task.teacher, task.subject);
                        
                        // Update cache
                        countCache[task.class][d][task.subject] = currentSubjCount + 1;
                        placed = true;
                        success++;
                        break;
                    }
                }
            }

            if (!placed) {
                fail++;
                failDetails.push(`${task.subject} - GV ${task.teacher} - Lớp ${task.class}`);
            }
        }

        // 6. KẾT THÚC & LƯU
        // Hàm lưu nội bộ
        function assignData(w, d, p, cls, tea, subj) {
            // Lưu cho học sinh
            if(!tkbHistory[w].student[cls][d]) tkbHistory[w].student[cls][d] = []; // Dùng mảng hoặc object đều ok
            tkbHistory[w].student[cls][d][p] = { subject: subj, teacher: tea };

            // Lưu cho giáo viên (để check trùng)
            if(tea) {
                if(!tkbHistory[w].teacher[tea]) tkbHistory[w].teacher[tea] = {};
                if(!tkbHistory[w].teacher[tea][d]) tkbHistory[w].teacher[tea][d] = [];
                tkbHistory[w].teacher[tea][d][p] = { class: cls, subject: subj };
            }
        }

        // Hàm check trống nhanh
        function isSlotFree(w, cls, tea, d, p) {
            // Check Lớp
            let sData = tkbHistory[w].student[cls][d];
            if (sData && sData[p]) return false; // Lớp đã có tiết

            // Check GV
            if (tea) {
                let tData = tkbHistory[w].teacher[tea];
                if (tData && tData[d] && tData[d][p]) return false; // GV đã bận
            }
            return true;
        }

        // Lưu vào LocalStorage
        localStorage.setItem("hk_v33_tkb_history", JSON.stringify(tkbHistory));
        
        // Render lại giao diện
        if (parseInt(document.getElementById('schWeek') ? document.getElementById('schWeek').value : 1) == week) {
            tkbData = tkbHistory[week];
            if (typeof saveData === 'function') saveData();
            if (typeof schRenderGrid === 'function') schRenderGrid();
            if (typeof renderTKBCards === 'function') renderTKBCards();
        }

        const endTime = performance.now();
        const duration = ((endTime - startTime)/1000).toFixed(2);

        // Báo cáo kết quả
        let msg = `✅ Hoàn tất trong ${duration}s! Thành công: ${success}/${tasks.length} tiết.`;
        if (fail > 0) msg += `<br>⚠️ Thất bại: ${fail} tiết (Xem log để chi tiết).`;
        
        if(log) {
            log.innerHTML = `
                <div style="padding:10px; border:1px solid #4ade80; background: rgba(74, 222, 128, 0.1); border-radius:5px">
                    ${msg}
                </div>
                ${fail > 0 ? `<div style="color:#f43f5e; margin-top:5px; font-size:0.9em">Chi tiết lỗi:<br>${failDetails.join('<br>')}</div>` : ''}
            `;
        }
        
        alert(`Xếp xong! Thời gian: ${duration} giây.\nSố tiết xếp được: ${success}`);

    }, 50);
}
// Hàm kiểm tra GV bận (Tối ưu truy xuất)
function checkTeacherBusyFast(week, teacherName, d, p) {
    // Truy xuất trực tiếp object, không dùng hàm find/filter chậm chạp
    const tData = tkbHistory[week].teacher[teacherName];
    if (!tData) return false;
    if (!tData[d]) return false;
    return !!tData[d][p]; // Trả về true nếu ô đó đã có dữ liệu
}
// Hàm phụ trợ: Ghi dữ liệu vào bộ nhớ
function writeToSchedule(week, d, p, className, teacher, subject) {
    // 1. Ghi cho học sinh
    if(!tkbHistory[week].student[className][d]) tkbHistory[week].student[className][d] = [];
    tkbHistory[week].student[className][d][p] = `${subject}\n(${teacher})`;

    // 2. Ghi cho giáo viên
    if(!tkbHistory[week].teacher[teacher]) tkbHistory[week].teacher[teacher] = {};
    if(!tkbHistory[week].teacher[teacher][d]) tkbHistory[week].teacher[teacher][d] = [];
    
    let current = tkbHistory[week].teacher[teacher][d][p] || "";
    let newVal = `${className} - ${subject}`;
    tkbHistory[week].teacher[teacher][d][p] = current ? `${current}, ${newVal}` : newVal;
}

// Helper: Check GV bận (Check trực tiếp trong tkbHistory đang xây dựng)
function checkTeacherConflictGlobal(teacherName, day, period, week) {
    if(tkbHistory[week].teacher && tkbHistory[week].teacher[teacherName]) {
        if(tkbHistory[week].teacher[teacherName][day] && tkbHistory[week].teacher[teacherName][day][period]) {
            return true;
        }
    }
    return false;
}
function getRankClass(xeploai) {
    // Chuẩn hóa chuỗi về chữ thường để so sánh
    const rank = xeploai.toLowerCase(); 
    if (rank.includes('tốt')) return 'rank-tot';
    if (rank.includes('khá')) return 'rank-kha';
    if (rank.includes('trung bình') || rank.includes('tb')) return 'rank-tb';
    if (rank.includes('yếu') || rank.includes('kém')) return 'rank-yeu';
    return ''; // Mặc định
}
// --- HÀM BẬT/TẮT GHIM MENU ---
function toggleSidebarPin() {
    document.body.classList.toggle('pinned-mode');
    
    // Lưu trạng thái vào bộ nhớ để F5 không bị mất
    const isPinned = document.body.classList.contains('pinned-mode');
    localStorage.setItem('yersin_sidebar_pinned', isPinned);
}
// --- FIX: TỰ ĐỘNG CUỘN TRANG (AUTO SCROLL) CHO GIAO DIỆN APP ---

let autoScrollSpeed = 0;
let autoScrollFrame;

// 1. Lắng nghe di chuyển chuột toàn màn hình
window.addEventListener('mousemove', function(e) {
    // Chỉ chạy khi đang giữ chuột trái (đang bôi đen/kéo)
    if (e.buttons !== 1) {
        autoScrollSpeed = 0;
        return;
    }

    const threshold = 100; // Khoảng cách 100px từ mép để kích hoạt
    const maxSpeed = 15;   // Tốc độ cuộn

    // Tính toán vùng mép dưới và trên của cửa sổ trình duyệt
    const h = window.innerHeight;
    
    if (e.clientY > h - threshold) {
        // Gần mép dưới -> Cuộn xuống (speed dương)
        autoScrollSpeed = maxSpeed * ((e.clientY - (h - threshold)) / threshold);
    } else if (e.clientY < threshold) {
        // Gần mép trên -> Cuộn lên (speed âm)
        autoScrollSpeed = -maxSpeed * ((threshold - e.clientY) / threshold);
    } else {
        autoScrollSpeed = 0;
    }

    // Kích hoạt vòng lặp nếu chưa chạy
    if (autoScrollSpeed !== 0 && !autoScrollFrame) {
        performCustomScroll();
    }
});

// 2. Dừng cuộn khi nhả chuột
window.addEventListener('mouseup', function() {
    autoScrollSpeed = 0;
    if (autoScrollFrame) {
        cancelAnimationFrame(autoScrollFrame);
        autoScrollFrame = null;
    }
});

// 3. Hàm thực hiện cuộn (Tìm đúng khung đang hiện để cuộn)
function performCustomScroll() {
    if (autoScrollSpeed === 0) {
        autoScrollFrame = null;
        return;
    }

    // --- ĐIỂM KHÁC BIỆT QUAN TRỌNG ---
    // Tìm khung nội dung đang hiển thị (có class .active)
    const activeContainer = document.querySelector('.page-view.active');
    
    if (activeContainer) {
        activeContainer.scrollTop += autoScrollSpeed;
    }
    // ----------------------------------

    autoScrollFrame = requestAnimationFrame(performCustomScroll);
}
// ==========================================
// ☁️ CLOUD SYNC LOGIC (GOOGLE SHEETS)
// ==========================================

function openCloudModal() {
    const modal = document.getElementById('cloudModal');
    const input = document.getElementById('cloudApiUrl');
    const HARD_URL = "https://script.google.com/macros/s/AKfycbyIgvtL-0LdiCMOrakYZFKuG7ov5-NZjIYwWYQwqjK6_vrq6MdMd7SZCWU31NlM5nTP/exec";

    if (modal) modal.style.display = 'flex';
    
    // Kiểm tra kỹ sự tồn tại của ô input trước khi gán giá trị
    if (input) {
        input.value = HARD_URL;
    }
}

function saveCloudConfig() {
    const url = $('cloudApiUrl').value.trim();
    if(url) {
        localStorage.setItem("hk_v33_cloud_url", url);
        showToast("Đã lưu API URL!", "success");
    }
}

// Hàm lấy toàn bộ dữ liệu hiện tại (giống hàm Backup)
function getFullDataJSON() {
    return JSON.stringify({
        students, trash, avatars, db, grades, appConfig, tkbData, quickButtons,
        // Lưu thêm các cấu hình mới nếu có
        weekData, classData
    });
}

// 1. GỬI LÊN (UPLOAD)
function syncToCloud() {
    const url = localStorage.getItem("hk_v33_cloud_url");
    if(!url) return showToast("Vui lòng nhập API URL trước!", "error");
    
    const btn = $('btnSyncUp');
    const status = $('cloudStatus');
    
    if(!confirm("Dữ liệu trên Cloud sẽ bị ghi đè bởi dữ liệu hiện tại của máy này. Tiếp tục?")) return;

    btn.disabled = true;
    btn.innerText = "⏳ Đang gửi...";
    status.innerText = "Đang nén và gửi dữ liệu lên Google Sheets...";
    status.style.color = "var(--neon-gold)";

    const dataPayload = getFullDataJSON();

    fetch(url, {
        method: "POST",
        mode: "no-cors", // Quan trọng để gửi được tới Google Script
        headers: { "Content-Type": "text/plain" },
        body: dataPayload
    })
    .then(() => {
        // Vì mode no-cors không trả về response đọc được, ta giả định thành công nếu không báo lỗi mạng
        // Tuy nhiên, Google Script cần thời gian xử lý
        setTimeout(() => {
            btn.disabled = false;
            btn.innerText = "⬆️ Gửi Dữ Liệu Lên Cloud";
            status.innerText = "✅ Đã gửi lệnh đồng bộ! Kiểm tra Sheet sau vài giây.";
            status.style.color = "var(--neon-green)";
            showToast("Đã gửi dữ liệu lên Cloud!", "success");
        }, 2000);
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerText = "⬆️ Gửi Dữ Liệu Lên Cloud";
        status.innerText = "❌ Lỗi kết nối: " + err.message;
        status.style.color = "var(--neon-red)";
    });
}

// ==========================================
// 🔄 AUTO SAVE LOGIC (LƯU TỰ ĐỘNG)
// ==========================================

let autoSaveTimer = null;

// Hàm bật tắt chế độ tự động
function toggleAutoSave() {
    const isChecked = document.getElementById('autoSaveToggle').checked;
    const status = document.getElementById('cloudStatus');
    
    if (isChecked) {
        // Lưu trạng thái vào bộ nhớ để lần sau mở web nó nhớ
        localStorage.setItem("hk_v33_autosave", "true");
        
        // Kích hoạt bộ đếm: Cứ 60000ms (60 giây) thì chạy hàm silentSync một lần
        startAutoSaveTimer();
        
        status.innerText = "✅ Đã bật chế độ tự động lưu (60s).";
        status.style.color = "var(--neon-green)";
    } else {
        localStorage.setItem("hk_v33_autosave", "false");
        
        // Tắt bộ đếm
        clearInterval(autoSaveTimer);
        
        status.innerText = "zzz Đã tắt tự động lưu.";
        status.style.color = "white";
    }
}



async function silentSyncToCloud() {
    // NẾU không có thay đổi gì trên máy này THÌ thoát ngay, không được đè lên Cloud
    if (!hasLocalChange) return; 

    const URL = "https://script.google.com/macros/s/AKfycbyIgvtL-0LdiCMOrakYZFKuG7ov5-NZjIYwWYQwqjK6_vrq6MdMd7SZCWU31NlM5nTP/exec";
    try {
        await fetch(URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data: db })
        });
        hasLocalChange = false; // Up xong thì reset trạng thái về "chưa có thay đổi"
        console.log("✅ Đã sao lưu bản mới nhất lên Cloud.");
    } catch (e) {
        console.error("Lỗi sao lưu:", e);
    }
}

// Kích hoạt lại trạng thái cũ khi tải lại trang
window.addEventListener('load', function() {
    const isAuto = localStorage.getItem("hk_v33_autosave");
    if (isAuto === "true") {
        document.getElementById('autoSaveToggle').checked = true;
        startAutoSaveTimer();
    }
});
// --- LOGIC CHỈNH SỬA HỒ SƠ GIÁO VIÊN ---
let currentEditingTeacher = null;

function openTeacherEdit(name) {
    
    // Ngăn sự kiện click lan ra ngoài
    if(window.event) window.event.stopPropagation();
    
    currentEditingTeacher = name;
    const profile = teacherProfiles[name] || {};
    
    // Điền thông tin vào Modal
    $('editTeacherName').value = name;
    $('editTeacherSubject').value = profile.subject || "";
    $('editTeacherRole').value = profile.role || "";
    
    // Load ảnh
    const defaultAvt = `https://ui-avatars.com/api/?name=${name}&background=334155&color=fff&size=128`;
    $('editTeacherAvt').src = profile.avatar || defaultAvt;
    
    // Reset file input
    $('teacherAvtInput').value = "";
    
    $('teacherEditModal').style.display = 'flex';
}

function previewTeacherAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            $('editTeacherAvt').src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function saveTeacherProfile() {
    if(!currentEditingTeacher) return;
    
    if(!teacherProfiles[currentEditingTeacher]) teacherProfiles[currentEditingTeacher] = {};
    
    // Lưu thông tin chữ
    teacherProfiles[currentEditingTeacher].subject = $('editTeacherSubject').value.trim();
    teacherProfiles[currentEditingTeacher].role = $('editTeacherRole').value.trim();
    
    // Lưu ảnh (nếu có thay đổi)
    // Nếu src là base64 (đã upload) thì lưu, nếu là link ui-avatars thì thôi (để tiết kiệm bộ nhớ)
    const currentSrc = $('editTeacherAvt').src;
    if(currentSrc.startsWith('data:image')) {
        teacherProfiles[currentEditingTeacher].avatar = currentSrc;
    }
    
    localStorage.setItem("hk_v33_teacher_profiles", JSON.stringify(teacherProfiles));
    showToast("Đã cập nhật hồ sơ giáo viên!", "success");
    $('teacherEditModal').style.display = 'none';
    renderTKBCards(); // Vẽ lại danh sách
}
// ======================================================
// HỆ THỐNG XẾP TKB THÔNG MINH - GALAXY SMART SCHEDULER
// ======================================================

// Dữ liệu tạm thời cho trình xếp TKB
let schData = {
    grid: {},        // Cấu trúc: { "10A1": { "2_0": {subj: "Toán", teacher: "T.Bảo", lock: false}, ... } }
    assignments: [], // Danh sách phân công: {teacher, subject, count, classes: []}
    classes: [],     // Danh sách lớp
    teachers: []     // Danh sách giáo viên
};

let schCurrentCell = null; // Ô đang chỉnh sửa {cls, day, period}
// 1. KHỞI TẠO & NHẬP DỮ LIỆU CŨ
function openSchoolManager() {
    $('schoolManagerModal').style.display = 'flex';
    $('schWeek').value = currentWeek || 1;
    schLog("Hệ thống đã sẵn sàng.");
    // Nếu chưa có dữ liệu grid, thử nạp từ TKB chính
    if (Object.keys(schData.grid).length === 0 && tkbData.student) {
        // Đã bỏ thông báo xác nhận, tự động nạp luôn
        loadCurrentTKBToScheduler(); 
    } else {
        renderSchedulerGrid();
    }
}

// Hàm ghi log ra màn hình
function schLog(msg) {
    const box = $('schLogContent');
    const time = new Date().toLocaleTimeString();
    box.innerHTML += `<div>[${time}] ${msg}</div>`;
    box.scrollTop = box.scrollHeight;
}

// HÀM NHẬP TKB TỪ FILE EXCEL (ĐÃ SỬA LỖI)
function schImportOldTKB(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            // Lấy sheet đầu tiên
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            // Chuyển sang mảng 2 chiều, giữ nguyên ô trống
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

            // 1. TÌM DÒNG TIÊU ĐỀ (Chứa: Thứ, Buổi, Tiết...)
            let headerRowIdx = -1;
            let colMap = {}; // Lưu vị trí cột của từng lớp: { "10A1": 3, "10A2": 4 ... }

            for (let i = 0; i < json.length; i++) {
                const row = json[i];
                // Dấu hiệu nhận biết dòng header: Cột 0 là "Thứ" và Cột 2 là "Tiết"
                if (row[0] && row[0].toString().trim().toLowerCase().includes('thứ') && 
                    row[2] && row[2].toString().trim().toLowerCase().includes('tiết')) {
                    headerRowIdx = i;
                    
                    // Duyệt các cột từ 3 trở đi để lấy tên Lớp
                    for (let c = 3; c < row.length; c++) {
                        const cellVal = row[c] ? row[c].toString().trim() : "";
                        if (cellVal && cellVal.toUpperCase() !== "TỔNG") { // Bỏ qua cột tổng nếu có
                            colMap[cellVal] = c;
                        }
                    }
                    break;
                }
            }

            if (headerRowIdx === -1) {
                alert("Lỗi: Không tìm thấy dòng tiêu đề (Thứ, Buổi, Tiết) trong file Excel!");
                return;
            }

            // 2. KHỞI TẠO DỮ LIỆU MỚI
            schData.grid = {};
            schData.classes = Object.keys(colMap);
            schData.classes.forEach(c => schData.grid[c] = {});

            // 3. DUYỆT DỮ LIỆU TỪNG DÒNG
            let lastThu = ""; // Lưu giá trị "Thứ" để fill-down (xử lý ô gộp)
            let lastBuoi = ""; // Lưu giá trị "Buổi"

            for (let i = headerRowIdx + 1; i < json.length; i++) {
                const row = json[i];
                let thu = row[0] ? row[0].toString() : lastThu;
                let buoi = row[1] ? row[1].toString().toUpperCase() : lastBuoi;
                let tiet = row[2] ? parseInt(row[2]) : 0;

                // Cập nhật giá trị fill-down
                if (row[0]) lastThu = row[0];
                if (row[1]) lastBuoi = row[1];

                if (!thu || !tiet) continue; // Bỏ qua dòng lỗi

                // Xử lý index Thứ (2->7) và Tiết (0->9)
                let d = parseInt(thu.replace(/\D/g, '')); // Lấy số từ "Thứ 2" -> 2
                if (isNaN(d)) continue;

                // Xử lý Tiết: Nếu Buổi CHIỀU mà tiết ghi là 1,2,3 -> Cộng thêm 5
                let p = tiet - 1; // Mặc định 1->0
                if (buoi.includes("CHIỀU") && p < 5) {
                    p += 5; // Tiết 1 chiều -> Tiết 6 (index 5)
                }

                const key = `${d}_${p}`;

                // Duyệt qua từng lớp để lấy môn học
                schData.classes.forEach(cls => {
                    const colIdx = colMap[cls];
                    let content = row[colIdx];

                    if (content) {
                        content = content.toString().trim();
                        // Phân tích nội dung ô: "Toán - T Nguyên" hoặc "Toán\n(T Nguyên)"
                        let parsed = parseCellContent(content);
                        
                        schData.grid[cls][key] = {
                            subj: parsed.subj,
                            teacher: parsed.teacher,
                            lock: true // Mặc định nhập từ file cũ thì khóa lại
                        };
                    }
                });
            }

            // 4. CẬP NHẬT GIAO DIỆN
            schRenderGrid();
            schLog(`Đã nhập thành công ${schData.classes.length} lớp từ file Excel.`);
            $('schDataStatus').style.display = 'block';
            $('schDataStatus').innerText = "✅ Đã nhập dữ liệu từ file Excel";
            
            // Xóa file trong input để cho phép chọn lại file đó lần sau
            input.value = '';

        } catch (err) {
            console.error(err);
            alert("Lỗi khi đọc file: " + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

// HÀM PHỤ TRỢ: Tách Môn và Tên GV từ nội dung ô Excel
function parseCellContent(text) {
    if (!text) return { subj: "", teacher: "" };

    let subj = text;
    let teacher = "";

    // Trường hợp 1: "Môn - GV" (Ví dụ: Toán - Thầy Lợi)
    if (text.includes("-")) {
        const parts = text.split("-");
        // Lấy phần đầu làm môn, phần sau cùng làm GV (đề phòng môn có dấu -)
        subj = parts[0].trim();
        teacher = parts.slice(1).join("-").trim();
    } 
    // Trường hợp 2: "Môn \n (GV)" hoặc "Môn (GV)"
    else if (text.includes("(")) {
        const match = text.match(/^(.*?)\s*\((.*?)\)/);
        if (match) {
            subj = match[1].trim(); // Phần trước ngoặc
            teacher = match[2].trim(); // Phần trong ngoặc
        }
    }
    // Trường hợp 3: Xuống dòng đơn thuần "Môn \n GV"
    else if (text.includes("\n")) {
        const parts = text.split("\n");
        subj = parts[0].trim();
        if(parts.length > 1) teacher = parts[1].trim();
    }

    return { subj, teacher };
}

function loadCurrentTKBToScheduler() {
    schData.grid = {};
    schData.classes = Object.keys(tkbData.student || {}).sort();
    
    schData.classes.forEach(cls => {
        schData.grid[cls] = {};
        const days = tkbData.student[cls] || {};
        for(let d in days) {
            days[d].forEach((val, pIdx) => {
                if(val) {
                    // Tách Môn và GV. Format cũ: "Môn\n(GV)" hoặc "Môn"
                    let subj = val.split('\n')[0];
                    let teach = "";
                    const match = val.match(/\((.*?)\)/);
                    if(match) teach = match[1];
                    
                    schData.grid[cls][`${d}_${pIdx}`] = {
                        subj: subj,
                        teacher: teach,
                        lock: true // Mặc định nạp vào thì khóa lại (người dùng mở nếu muốn AI sửa)
                    };
                }
            });
        }
    });
    renderSchedulerGrid();
    $('schDataStatus').style.display = 'block';
}

// 3. IMPORT PHÂN CÔNG CHUYÊN MÔN (PCCM)
function schImportPCCM(input) {
    // Hàm này đọc file Excel danh sách GVBM, môn dạy, số tiết
    // Format file: Cột A: Tên GV, Cột B: Môn, Cột C: Số tiết, Cột D: Các lớp dạy (cách nhau dấu phẩy)
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
        
        schData.assignments = [];
        for(let i=1; i<json.length; i++) {
            const row = json[i];
            if(row[0] && row[1]) {
                schData.assignments.push({
                    teacher: row[0],
                    subject: row[1],
                    count: row[2] || 2,
                    classes: row[3] ? row[3].toString().split(',').map(s=>s.trim()) : []
                });
            }
        }
        schLog(`Đã nhập ${schData.assignments.length} dòng phân công.`);
        alert(`Đã nhập ${schData.assignments.length} dòng phân công!`);
    };
    reader.readAsArrayBuffer(file);
}

// 4. HIỂN THỊ LƯỚI TKB (RENDER GRID)
function schRenderGrid() {
    const container = $('schGridContainer');
    container.innerHTML = "";
    
    const viewMode = $('schViewMode').value;
    const filter = $('schSearch').value.toLowerCase();
    
    // Header Tiết
    let html = `<table class="scheduler-table"><thead><tr><th style="min-width:100px">Lớp/Tiết</th>`;
    // Tạo Header Thứ 2 -> 7 (Sáng/Chiều)
    // Sáng: T2(1-5)... Chiều: T2(6-10)...
    // Để gọn, ta làm cột ngang là Tiết (1->10) của các ngày? Không, bảng TKB truyền thống là Ngày dọc hoặc Ngày ngang.
    // Format chuẩn: Cột dọc là Thứ/Tiết, Cột ngang là Lớp.
    
    // Render Header Lớp
    let visibleClasses = schData.classes.filter(c => c.toLowerCase().includes(filter));
    visibleClasses.forEach(c => {
        html += `<th>${c}</th>`;
    });
    html += `</tr></thead><tbody>`;
    
    // Render Body (Dòng là Thứ_Tiết)
    // Thứ 2->7 (Index 2->7), Tiết 0->9 (Sáng 0-4, Chiều 5-9)
    for(let d=2; d<=7; d++) {
        for(let p=0; p<10; p++) {
            // Chỉ hiện tiết phù hợp (VD user muốn ẩn tiết tối)
            const rowLabel = `Thứ ${d} - T${p+1}`;
            html += `<tr><td style="font-weight:bold; font-size:11px; color:#fbbf24">${rowLabel}</td>`;
            
            visibleClasses.forEach(cls => {
                const key = `${d}_${p}`;
                const cell = (schData.grid[cls] && schData.grid[cls][key]) || null;
                
                let cellHtml = "";
                let cssClass = "sch-cell";
                
                if(cell) {
                    cellHtml = `<div class="sch-subj">${cell.subj}</div>
                                <div class="sch-teacher">${cell.teacher}</div>`;
                    if(cell.lock) cssClass += " sch-locked";
                    // Check conflict (cơ bản)
                    if(cell.teacher && checkTeacherBusy(cell.teacher, d, p, cls)) {
                        cssClass += " sch-conflict";
                    }
                }
                
                html += `<td class="${cssClass}" onclick="schOpenEdit('${cls}', ${d}, ${p})">${cellHtml}</td>`;
            });
            html += `</tr>`;
            
            // Ngắt dòng giữa trưa
            if(p===4) html += `<tr style="background:#334155; height:5px;"><td colspan="${visibleClasses.length+1}"></td></tr>`;
        }
    }
    
    html += `</tbody></table>`;
    container.innerHTML = html;
}

// Kiểm tra GV trùng tiết (trong grid hiện tại)
function checkTeacherBusy(teacher, day, period, excludeClass) {
    if(!teacher) return false;
    for(let c in schData.grid) {
        if(c === excludeClass) continue;
        const cell = schData.grid[c][`${day}_${period}`];
        if(cell && cell.teacher === teacher) return true;
    }
    return false;
}

// 5. CHỈNH SỬA Ô (MANUAL EDIT)
function schOpenEdit(cls, d, p) {
    schCurrentCell = {cls, d, p};
    const key = `${d}_${p}`;
    const cell = (schData.grid[cls] && schData.grid[cls][key]) || {subj:"", teacher:"", lock:false};
    
    $('schEditInfo').innerText = `${cls} - Thứ ${d} - Tiết ${p+1}`;
    $('schEditSubj').value = cell.subj;
    $('schEditTeacher').value = cell.teacher;
    $('schEditLock').checked = cell.lock;
    
    $('schEditModal').style.display = 'flex';
    $('schEditSubj').focus();
}

function schSaveCell() {
    if(!schCurrentCell) return;
    const {cls, d, p} = schCurrentCell;
    const key = `${d}_${p}`;
    
    if(!schData.grid[cls]) schData.grid[cls] = {};
    schData.grid[cls][key] = {
        subj: $('schEditSubj').value.trim(),
        teacher: $('schEditTeacher').value.trim(),
        lock: $('schEditLock').checked
    };
    
    $('schEditModal').style.display = 'none';
    schRenderGrid(); // Vẽ lại 1 ô thì tốt hơn, nhưng vẽ lại hết cho chắc
}

function schDeleteCell() {
    if(!schCurrentCell) return;
    const {cls, d, p} = schCurrentCell;
    if(schData.grid[cls]) delete schData.grid[cls][`${d}_${p}`];
    $('schEditModal').style.display = 'none';
    schRenderGrid();
}

// 6. AI GENERATE (AUTO SCHEDULE)
function schRunAI() {
    schLog("Bắt đầu chạy AI xếp lịch...");
    
    // Lấy các ràng buộc
    const const_NoLast = $('aiConst_LastPeriod').checked;
    const const_Max2 = $('aiConst_Max2').checked;
    
    // 1. Chuẩn bị Pool nhiệm vụ (Từ PCCM hoặc tạo giả lập nếu chưa có)
    let tasks = [];
    if(schData.assignments.length > 0) {
        // Dùng dữ liệu phân công thật
        schData.assignments.forEach(a => {
            a.classes.forEach(cls => {
                for(let i=0; i<a.count; i++) tasks.push({cls: cls, subj: a.subject, teacher: a.teacher});
            });
        });
    } else {
        // Nếu không có phân công, AI sẽ tự điền vào các ô trống dựa trên xác suất (Giả lập)
        // Đây là tính năng "soạn random" như bạn yêu cầu cho các ô trống
        schLog("Chưa có phân công PCCM. Chạy chế độ lấp đầy ngẫu nhiên các ô trống...");
    }

    // 2. Duyệt qua từng lớp để điền
    schData.classes.forEach(cls => {
        if(!schData.grid[cls]) schData.grid[cls] = {};
        
        // Đếm số tiết đã có
        let dailySubjects = []; // Theo dõi môn trong ngày để check Max 2
        
        for(let d=2; d<=7; d++) {
            let subjectCounts = {}; // Reset đếm môn mỗi ngày
            
            for(let p=0; p<10; p++) {
                const key = `${d}_${p}`;
                // Nếu ô đã khóa hoặc có dữ liệu -> Bỏ qua
                if(schData.grid[cls][key]) {
                    const s = schData.grid[cls][key].subj;
                    subjectCounts[s] = (subjectCounts[s] || 0) + 1;
                    continue; 
                }
                
                // --- LOGIC CHỌN MÔN (AI) ---
                // Chọn ngẫu nhiên 1 môn từ danh sách môn học phổ thông
                const subjectsPool = [
                    {name:"Toán", w:10}, {name:"Văn", w:10}, {name:"Anh", w:8}, 
                    {name:"Lý", w:6}, {name:"Hóa", w:6}, {name:"Sinh", w:4},
                    {name:"Sử", w:4}, {name:"Địa", w:4}, {name:"GDCD", w:2},
                    {name:"Tin", w:2}, {name:"CN", w:2}, {name:"Thể dục", w:4}, {name:"GDQP", w:2}
                ];
                
                // Shuffle pool
                subjectsPool.sort(() => Math.random() - 0.5);
                
                let picked = null;
                for(let item of subjectsPool) {
                    // Check Ràng buộc 1: TD/QP không tiết 5 (index 4) hoặc 8 (index 7 - user nói tiết 8, trong code là index 7)
                    if(const_NoLast && (item.name === "Thể dục" || item.name === "GDQP")) {
                        if(p === 4 || p === 7 || p === 8 || p === 9) continue; 
                    }
                    
                    // Check Ràng buộc 2: Max 2 tiết/ngày
                    if(const_Max2) {
                        if((subjectCounts[item.name] || 0) >= 2) continue;
                    }
                    
                    picked = item;
                    break;
                }
                
                if(picked) {
                    // Gán vào Grid
                    schData.grid[cls][`${d}_${p}`] = {
                        subj: picked.name,
                        teacher: findTeacherBySubject(picked.name) || "", // Tự điền GV nếu biết
                        locked: false // Đánh dấu là AI điền (có thể xóa)
                    };
                    // Cập nhật bộ đếm
                    subjectCounts[picked.name] = (subjectCounts[picked.name] || 0) + 1;
                    dailySubjects.push(picked.name);
                }
            }
        }
    });
    
    renderSchedulerGrid();
    showToast("AI đã xếp xong! Hãy kiểm tra và chỉnh sửa.", "success");
}

// 7. ÁP DỤNG VÀO WEB & XUẤT CSV
function applySchedulerToMain() {
    if(confirm("Áp dụng TKB này vào hệ thống chính? (Dữ liệu cũ sẽ bị thay thế)")) {
        // 1. Chuyển đổi format schData -> tkbData.student
        let newStudentDB = {};
        let newTeacherDB = {};
        
        schData.classes.forEach(cls => {
            newStudentDB[cls] = {};
            for(let key in schData.grid[cls]) {
                const [d, p] = key.split('_');
                const cell = schData.grid[cls][key];
                if(cell && cell.subj) {
                    if(!newStudentDB[cls][d]) newStudentDB[cls][d] = [];
                    // Format: "Môn\n(GV)"
                    const val = cell.teacher ? `${cell.subj}\n(${cell.teacher})` : cell.subj;
                    newStudentDB[cls][d][p] = val;
                    
                    // Build Teacher DB ngược lại
                    if(cell.teacher) {
                        if(!newTeacherDB[cell.teacher]) newTeacherDB[cell.teacher] = {};
                        if(!newTeacherDB[cell.teacher][d]) newTeacherDB[cell.teacher][d] = [];
                        // Format cho GV: "Lớp - Môn"
                        newTeacherDB[cell.teacher][d][p] = `${cls} - ${cell.subj}`;
                    }
                }
            }
        });

        // 2. Update Global Data
        tkbData.student = newStudentDB;
        tkbData.teacher = newTeacherDB;
        saveData(); // Lưu LocalStorage

        // 3. Render lại Main View
        $('schoolManagerModal').style.display = 'none';
        renderTKBCards();
        showToast("Đã cập nhật TKB lên Web!", "success");
    }
}

// Helper UI
function updateDataStatus() {
    const clsCount = schData.classes.length;
    $('dataStatus').innerText = `✅ Đang quản lý: ${clsCount} lớp.`;
}
function clearSchedulerData() {
    if(confirm("Xóa toàn bộ dữ liệu đang soạn thảo?")) {
        schData.grid = {};
        renderSchedulerGrid();
    }
}
// Helper giả lập tìm GV (Nếu chưa có dữ liệu PCCM)
function findTeacherBySubject(subj) {
    // Trả về tên giáo viên ngẫu nhiên cho môn học (Demo)
    return ""; 
}
// ============================================================
// 🚀 NÂNG CẤP: LOGIC PHÂN CÔNG CHUYÊN MÔN (PCCM) TỰ ĐỘNG
// ============================================================

// 1. Biến toàn cục lưu danh sách giáo viên theo môn
let pccmMap = JSON.parse(localStorage.getItem('yersin_pccm') || "{}");

// 2. Hàm chuẩn hóa tên môn học (để "Toán (Đại số)" khớp với "Toán")
function normalizeSubjectName(name) {
    if (!name) return "";
    let n = name.toString().toUpperCase().trim();
    // Loại bỏ nội dung trong ngoặc đơn. VD: "TOÁN (ĐẠI SỐ)" -> "TOÁN"
    n = n.replace(/\(.*\)/g, "").trim();
    
    // Ánh xạ các từ viết tắt thông dụng trong TKB
    const mapping = {
        "VĂN": "NGỮ VĂN",
        "ANH": "TIẾNG ANH",
        "SỬ": "LỊCH SỬ",
        "ĐỊA": "ĐỊA LÍ",
        "GDCD": "GDKTPL",
        "LÍ": "VẬT LÍ",
        "LÝ": "VẬT LÍ",
        "TIN": "TIN HỌC",
        "THỂ DỤC": "GDTC",
        "QP": "GDQP"
    };
    return mapping[n] || n;
}

// 3. Hàm nhập file Phân Công Chuyên Môn (Thay thế hàm cũ)
function schImportPCCM(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            // Đọc file dưới dạng mảng để dễ xử lý
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

            pccmMap = {}; // Reset dữ liệu cũ
            let teacherCount = 0;

            // Duyệt từng dòng (Bỏ qua dòng tiêu đề, bắt đầu từ dòng chứa dữ liệu)
            rows.forEach(row => {
                // Cấu trúc file CSV của bạn: 
                // [0]: STT, [1]: Tên GV, [2]: Môn Chính, [3]: Số tiết, [4]: Môn Phụ
                
                const name = row[1];
                // Bỏ qua dòng tiêu đề hoặc dòng trống
                if (!name || typeof name !== 'string' || name.includes("Tên Thầy/Cô") || name.includes("NHÓM")) return;

                const subjects = [];
                
                // Xử lý Môn Chính (Cột 2)
                if (row[2]) {
                    // Tách dấu phẩy nếu một người dạy nhiều môn (VD: "Toán, Hóa")
                    row[2].toString().split(',').forEach(s => subjects.push(s.trim()));
                }

                // Xử lý Môn Phụ (Cột 4) - Nếu có và không phải dấu gạch ngang
                if (row[4] && row[4].toString().trim() !== '-') {
                    row[4].toString().split(',').forEach(s => subjects.push(s.trim()));
                }

                // Lưu vào bộ nhớ
                subjects.forEach(subj => {
                    const cleanSubj = normalizeSubjectName(subj);
                    if (!pccmMap[cleanSubj]) pccmMap[cleanSubj] = [];
                    // Chỉ thêm nếu chưa có tên
                    if (!pccmMap[cleanSubj].includes(name)) {
                        pccmMap[cleanSubj].push(name);
                    }
                });
                
                teacherCount++;
            });

            // Lưu xuống bộ nhớ trình duyệt để dùng lần sau không cần import lại
            localStorage.setItem('yersin_pccm', JSON.stringify(pccmMap));

            // Cập nhật giao diện
            showToast(`✅ Đã nhập PCCM cho ${teacherCount} giáo viên!`, "success");
            const statusEl = document.getElementById('schDataStatus');
            if(statusEl) {
                statusEl.style.display = 'block';
                statusEl.innerText = `✅ Đã có dữ liệu GV (${teacherCount} người)`;
            }
            
            // Xóa input file để chọn lại được file cũ nếu cần
            input.value = "";

        } catch (err) {
            console.error(err);
            showToast("❌ Lỗi đọc file PCCM: " + err.message, "error");
        }
    };
    reader.readAsArrayBuffer(file);
}

// 4. Hàm tìm giáo viên theo môn (Logic AI sẽ gọi hàm này)
function findTeacherBySubject(subj) {
    if (!subj) return "";
    
    // Chuẩn hóa tên môn cần tìm (VD: "Toán 10" -> "TOÁN")
    const cleanKey = normalizeSubjectName(subj.split(" ")[0]); // Lấy từ đầu tiên làm gốc
    
    // Tìm danh sách GV dạy môn này
    let teachers = pccmMap[cleanKey];
    
    // Nếu không tìm thấy chính xác, thử tìm gần đúng
    if (!teachers) {
        const keyMatch = Object.keys(pccmMap).find(k => k.includes(cleanKey) || cleanKey.includes(k));
        if (keyMatch) teachers = pccmMap[keyMatch];
    }

    if (teachers && teachers.length > 0) {
        // [CƠ CHẾ RANDOM THÔNG MINH]
        // Chọn ngẫu nhiên 1 giáo viên trong danh sách để phân bố đều tiết dạy
        const randomIndex = Math.floor(Math.random() * teachers.length);
        return teachers[randomIndex];
    }
    
    return ""; // Không tìm thấy GV nào
}

// 5. Tự động kiểm tra dữ liệu khi khởi động
document.addEventListener('DOMContentLoaded', () => {
    if (Object.keys(pccmMap).length > 0) {
        const statusEl = document.getElementById('schDataStatus');
        if(statusEl) {
            statusEl.style.display = 'block';
            statusEl.innerText = `✅ Đã có dữ liệu GV (Từ bộ nhớ)`;
        }
    }
});
// ============================================================
// 🚀 UPDATE V2: AI TỰ ĐỘNG PHÁT HIỆN MÔN HỌC TỪ FILE EXCEL
// ============================================================
// ============================================================
// 🚀 CẤU HÌNH SỐ TIẾT HỌC (CHỈNH SỬA TẠI ĐÂY)
// ============================================================

const SUBJECT_CONFIG = {
    // 1. Cấu hình chung (Mặc định cho toàn trường)
    "DEFAULT": {
        "TOÁN": 4, 
        "VĂN": 4, "NGỮ VĂN": 4,
        "ANH": 3, "TIẾNG ANH": 3,
        "LÝ": 2, "VẬT LÍ": 2, 
        "HÓA": 2, "HÓA HỌC": 2,
        "SINH": 1, "SINH HỌC": 1,
        "SỬ": 1, "LỊCH SỬ": 1, 
        "ĐỊA": 1, "ĐỊA LÍ": 1,
        "GDCD": 1, "GDKTPL": 1,
        "TIN": 1, "TIN HỌC": 1, 
        "CÔNG NGHỆ": 1,
        "THỂ DỤC": 2, "GDTC": 2, 
        "GDQP": 1,
        "HĐTN": 3, "SHL": 1, "CHÀO CỜ": 1,
        "STEM": 1 // Nếu muốn STEM mặc định 1 tiết
    },

    // 2. Cấu hình riêng cho từng KHỐI (Ghi đè lên mặc định)
    // Ví dụ: Khối 12 học nhiều Toán hơn, Khối 10 học nhiều Hóa hơn
    "KHOI_12": {
        "TOÁN": 5, // Khối 12 học 5 tiết Toán
        "LÝ": 3,   // Khối 12 học 3 tiết Lý
        "HÓA": 3,
        "VĂN": 5
    },
    
    "KHOI_11": {
        "TIN": 2 // Khối 11 học 2 tiết Tin
    },

    "KHOI_10": {
        "HĐTN": 3 // Khối 10 giữ nguyên 3 tiết HĐTN
    }
};

// Hàm lấy số tiết cho từng lớp cụ thể
function getSubjectCount(className, subjectName) {
    const cleanSubj = subjectName.toUpperCase().trim();
    
    // 1. Lấy số tiết mặc định
    let count = SUBJECT_CONFIG["DEFAULT"][cleanSubj] || 1; // Mặc định 1 nếu không tìm thấy

    // 2. Kiểm tra xem lớp thuộc khối nào để lấy cấu hình riêng
    if (className.startsWith("12")) {
        if (SUBJECT_CONFIG["KHOI_12"][cleanSubj] !== undefined) {
            count = SUBJECT_CONFIG["KHOI_12"][cleanSubj];
        }
    } else if (className.startsWith("11")) {
        if (SUBJECT_CONFIG["KHOI_11"][cleanSubj] !== undefined) {
            count = SUBJECT_CONFIG["KHOI_11"][cleanSubj];
        }
    } else if (className.startsWith("10")) {
        if (SUBJECT_CONFIG["KHOI_10"][cleanSubj] !== undefined) {
            count = SUBJECT_CONFIG["KHOI_10"][cleanSubj];
        }
    }

    return count;
}

// 🚀 CẬP NHẬT LOGIC AI (ĐỂ DÙNG HÀM TÍNH SỐ TIẾT MỚI)
function schRunAI() {
    if (Object.keys(pccmMap).length === 0) {
        alert("⚠️ CHƯA CÓ DỮ LIỆU GIÁO VIÊN! Vui lòng nhập file Excel trước.");
        return;
    }

    const week = document.getElementById('schWeek').value || 1;
    if(!confirm(`BẮT ĐẦU XẾP TKB (TUẦN ${week})?\n- Số tiết sẽ được tính toán tự động theo Khối Lớp.`)) return;

    const logEl = document.getElementById('schLogContent');
    logEl.innerHTML = "<div>⏳ Đang phân tích chương trình học...</div>";

    setTimeout(() => {
        // BƯỚC 1: LẤY DANH SÁCH LỚP
        let classes = [];
        if (typeof classData !== 'undefined') Object.values(classData).forEach(arr => classes.push(...arr));
        if (classes.length === 0) classes = ["10A1", "10A2", "11A1", "12A1"];

        // BƯỚC 2: TẠO NHIỆM VỤ (DỰA TRÊN CẤU HÌNH SỐ TIẾT MỚI)
        let tasks = [];
        const allSubjects = Object.keys(pccmMap); // Lấy danh sách môn từ file Excel
        
        classes.forEach(className => {
            allSubjects.forEach(subj => {
                // Tính số tiết cho lớp này môn này
                const count = getSubjectCount(className, subj);
                
                // Tìm giáo viên
                let teacherName = findTeacherBySubject(subj);
                if (!teacherName) teacherName = "Chưa PC";

                // Tạo nhiệm vụ xếp
                for(let i=0; i<count; i++) {
                    tasks.push({
                        class: className,
                        subject: subj,
                        teacher: teacherName
                    });
                }
            });
        });
        
        // --- BƯỚC 3 & 4: GIỮ NGUYÊN NHƯ CŨ ---
        // (Phần xếp lịch bên dưới không thay đổi, chỉ thay đổi cách tạo tasks ở trên)
        
        if (!tkbHistory[week]) tkbHistory[week] = { student: {}, teacher: {} };
        let successCount = 0;
        
        // Xáo trộn nhiệm vụ
        tasks.sort(() => Math.random() - 0.5);

        tasks.forEach(task => {
            let placed = false;
            let days = [2, 3, 4, 5, 6].sort(() => Math.random() - 0.5);

            for (let d of days) {
                if (placed) break;
                for (let p = 0; p < 10; p++) {
                    if (checkClassBusy(week, task.class, d, p)) continue;
                    if (task.teacher !== "Chưa PC" && checkTeacherBusy(week, task.teacher, d, p)) continue;
                    
                    // Ràng buộc môn thể dục/QP không học tiết 5, tiết 10 (tiết cuối buổi)
                    if ((task.subject.toUpperCase().includes("THỂ") || task.subject.toUpperCase().includes("QP")) && (p===4 || p===9)) continue;

                    assignCell(week, d, p, task.class, task.subject, task.teacher);
                    placed = true;
                    successCount++;
                    break;
                }
            }
        });

        tkbData = tkbHistory[week];
        saveData();
        logEl.innerHTML += `<div style="color:#4ade80">✅ Đã xếp xong!</div>`;
        if (typeof schRenderGrid === 'function') schRenderGrid();
        if (typeof renderTKBCards === 'function') renderTKBCards();

    }, 100);
}
function triggerCloudSync() {
    hasLocalChange = true;
    console.log("🚀 Đã kích hoạt đèn báo đồng bộ Cloud.");
}
// Khi tạo HTML trong vòng lặp:
// html += `<span class="badge-rank ${getRankClass(hs.hanhKiem)}">${hs.hanhKiem}</span>`;
$('search').oninput = renderList; 

// --- SỰ KIỆN QUAN TRỌNG: CẬP NHẬT STATS KHI CHỌN LỚP ---
$('classSelect').onchange = function() {
    renderList();
    if($('stats').classList.contains('active')) renderStats();
    if($('games').classList.contains('active')) { /* Optional: reload game list */ }
};

init();
</script>
<script>
// --- HỆ THỐNG ĐỒNG BỘ ỔN ĐỊNH (FINAL) ---

// Link Google Sheet của bạn
const SYNC_URL = "https://script.google.com/macros/s/AKfycbyIgvtL-0LdiCMOrakYZFKuG7ov5-NZjIYwWYQwqjK6_vrq6MdMd7SZCWU31NlM5nTP/exec";

async function runAutoSync() {
    // Nếu chưa có công tắc thì tạo mới (tránh lỗi)
    if (typeof window.hasLocalChange === 'undefined') window.hasLocalChange = false;

    // --- MÁY A: GỬI ĐI ---
    if (window.hasLocalChange === true) {
        try {
            await fetch(SYNC_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ data: db })
            });
            window.hasLocalChange = false; // Gửi xong thì tắt công tắc
            console.log("📤 [Máy A] Đã gửi dữ liệu thành công.");
        } catch (e) { console.error("Lỗi gửi:", e); }
    } 
    // --- MÁY B: TẢI VỀ ---
    else {
        try {
            const res = await fetch(SYNC_URL + "?t=" + new Date().getTime());
            const json = await res.json();
            if (json && json.data) {
                // Nếu dữ liệu khác nhau thì mới cập nhật
                if (JSON.stringify(db) !== JSON.stringify(json.data)) {
                    db = json.data;
                    localStorage.setItem("hk_v33_db", JSON.stringify(db));
                    if (typeof renderList === 'function') renderList();
                    if (typeof updateStats === 'function') updateStats();
                    console.log("📥 [Máy B] Đã nhận dữ liệu mới.");
                }
            }
        } catch (e) { }
    }
}

// Chạy bộ máy mỗi 10 giây
if (window.timerSync) clearInterval(window.timerSync);
window.timerSync = setInterval(runAutoSync, 10000);
</script>
</body>
</html>